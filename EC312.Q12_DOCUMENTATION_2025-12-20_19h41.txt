================================================================================
SCAN SELECTED FILES - 153 FILES
================================================================================

################################################################################
## FILE 1: supabase.sql
## Path: supabase.sql
################################################################################

-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.banners (
  banner_id integer NOT NULL DEFAULT nextval('banners_banner_id_seq'::regclass),
  title character varying,
  subtitle character varying,
  image_url character varying NOT NULL,
  mobile_image_url character varying,
  link_url character varying,
  button_text character varying,
  position character varying,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  valid_from timestamp without time zone,
  valid_to timestamp without time zone,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT banners_pkey PRIMARY KEY (banner_id)
);
CREATE TABLE public.blog_posts (
  post_id integer NOT NULL DEFAULT nextval('blog_posts_post_id_seq'::regclass),
  title character varying NOT NULL,
  slug character varying NOT NULL UNIQUE,
  content text NOT NULL,
  excerpt text,
  featured_image character varying,
  author_id integer,
  category character varying,
  tags text,
  view_count integer DEFAULT 0,
  is_published boolean DEFAULT false,
  published_at timestamp without time zone,
  meta_title character varying,
  meta_description text,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT blog_posts_pkey PRIMARY KEY (post_id)
);
CREATE TABLE public.brands (
  brand_id integer NOT NULL DEFAULT nextval('brands_brand_id_seq'::regclass),
  brand_name character varying NOT NULL,
  brand_slug character varying NOT NULL UNIQUE,
  logo_url character varying,
  description text,
  country_origin character varying,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT brands_pkey PRIMARY KEY (brand_id)
);
CREATE TABLE public.bundle_deals (
  bundle_id integer NOT NULL DEFAULT nextval('bundle_deals_bundle_id_seq'::regclass),
  bundle_name character varying NOT NULL,
  bundle_slug character varying NOT NULL UNIQUE,
  bundle_type character varying NOT NULL,
  buy_quantity integer,
  get_quantity integer,
  discount_percent numeric,
  discount_amount numeric,
  description text,
  is_active boolean DEFAULT true,
  valid_from timestamp without time zone NOT NULL,
  valid_to timestamp without time zone NOT NULL,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT bundle_deals_pkey PRIMARY KEY (bundle_id)
);
CREATE TABLE public.bundle_products (
  id integer NOT NULL DEFAULT nextval('bundle_products_id_seq'::regclass),
  bundle_id integer,
  product_id integer,
  quantity integer DEFAULT 1,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT bundle_products_pkey PRIMARY KEY (id),
  CONSTRAINT bundle_products_bundle_id_fkey FOREIGN KEY (bundle_id) REFERENCES public.bundle_deals(bundle_id),
  CONSTRAINT bundle_products_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.categories (
  category_id integer NOT NULL DEFAULT nextval('categories_category_id_seq'::regclass),
  category_name character varying NOT NULL,
  category_slug character varying NOT NULL UNIQUE,
  parent_category_id integer,
  description text,
  image_url character varying,
  icon_name character varying,
  display_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT categories_pkey PRIMARY KEY (category_id),
  CONSTRAINT categories_parent_category_id_fkey FOREIGN KEY (parent_category_id) REFERENCES public.categories(category_id)
);
CREATE TABLE public.contact_messages (
  id integer NOT NULL DEFAULT nextval('contact_messages_id_seq'::regclass),
  name character varying NOT NULL,
  email character varying NOT NULL,
  phone character varying,
  subject character varying,
  message text NOT NULL,
  status character varying DEFAULT 'pending'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT contact_messages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.coupons (
  coupon_id integer NOT NULL DEFAULT nextval('coupons_coupon_id_seq'::regclass),
  coupon_code character varying NOT NULL UNIQUE,
  coupon_type character varying NOT NULL,
  discount_value numeric NOT NULL,
  min_order_amount numeric,
  max_discount_amount numeric,
  usage_limit integer,
  used_count integer DEFAULT 0,
  valid_from timestamp without time zone NOT NULL,
  valid_to timestamp without time zone NOT NULL,
  is_active boolean DEFAULT true,
  description text,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT coupons_pkey PRIMARY KEY (coupon_id)
);
CREATE TABLE public.custom_designs (
  design_id integer NOT NULL DEFAULT nextval('custom_designs_design_id_seq'::regclass),
  user_id uuid,
  guest_email character varying,
  guest_name character varying,
  guest_phone character varying,
  template_id integer,
  phone_model character varying NOT NULL,
  design_data jsonb NOT NULL,
  preview_image_url text,
  high_res_image_url text,
  status character varying DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'submitted'::character varying, 'processing'::character varying, 'approved'::character varying, 'rejected'::character varying, 'printed'::character varying]::text[])),
  admin_notes text,
  order_id integer,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  submitted_at timestamp without time zone,
  processed_at timestamp without time zone,
  CONSTRAINT custom_designs_pkey PRIMARY KEY (design_id),
  CONSTRAINT custom_designs_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT custom_designs_template_id_fkey FOREIGN KEY (template_id) REFERENCES public.phone_templates(template_id),
  CONSTRAINT custom_designs_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.customer_addresses (
  address_id integer NOT NULL DEFAULT nextval('customer_addresses_address_id_seq'::regclass),
  customer_id integer,
  address_type character varying,
  full_name character varying,
  phone character varying,
  address_line1 character varying NOT NULL,
  address_line2 character varying,
  ward character varying,
  district character varying,
  city character varying NOT NULL,
  postal_code character varying,
  country character varying DEFAULT 'Vietnam'::character varying,
  is_default boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT customer_addresses_pkey PRIMARY KEY (address_id),
  CONSTRAINT customer_addresses_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id)
);
CREATE TABLE public.customers (
  customer_id integer NOT NULL DEFAULT nextval('customers_customer_id_seq'::regclass),
  email character varying NOT NULL UNIQUE,
  password_hash character varying NOT NULL,
  first_name character varying,
  last_name character varying,
  phone character varying,
  date_of_birth date,
  gender character varying,
  avatar_url character varying,
  is_verified boolean DEFAULT false,
  is_active boolean DEFAULT true,
  loyalty_points integer DEFAULT 0,
  total_spent numeric DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  last_login timestamp without time zone,
  CONSTRAINT customers_pkey PRIMARY KEY (customer_id)
);
CREATE TABLE public.design_collections (
  collection_id integer NOT NULL DEFAULT nextval('design_collections_collection_id_seq'::regclass),
  collection_name character varying NOT NULL,
  collection_slug character varying NOT NULL UNIQUE,
  description text,
  banner_image character varying,
  thumbnail_image character varying,
  theme_color character varying,
  is_featured boolean DEFAULT false,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  valid_from timestamp without time zone,
  valid_to timestamp without time zone,
  view_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT design_collections_pkey PRIMARY KEY (collection_id)
);
CREATE TABLE public.design_images (
  image_id integer NOT NULL DEFAULT nextval('design_images_image_id_seq'::regclass),
  design_id integer,
  original_url text NOT NULL,
  thumbnail_url text,
  file_name character varying,
  file_size integer,
  width integer,
  height integer,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT design_images_pkey PRIMARY KEY (image_id),
  CONSTRAINT design_images_design_id_fkey FOREIGN KEY (design_id) REFERENCES public.custom_designs(design_id)
);
CREATE TABLE public.flash_sales (
  flash_sale_id integer NOT NULL DEFAULT nextval('flash_sales_flash_sale_id_seq'::regclass),
  sale_name character varying NOT NULL,
  product_id integer,
  variant_id integer,
  original_price numeric NOT NULL,
  flash_price numeric NOT NULL,
  discount_percent numeric,
  quantity_limit integer,
  quantity_sold integer DEFAULT 0,
  start_time timestamp without time zone NOT NULL,
  end_time timestamp without time zone NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT flash_sales_pkey PRIMARY KEY (flash_sale_id),
  CONSTRAINT flash_sales_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT flash_sales_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id)
);
CREATE TABLE public.gift_emails (
  email_id uuid NOT NULL DEFAULT gen_random_uuid(),
  gift_id uuid,
  email_type character varying NOT NULL,
  sent_to character varying NOT NULL,
  sent_at timestamp with time zone DEFAULT now(),
  status character varying DEFAULT 'sent'::character varying,
  CONSTRAINT gift_emails_pkey PRIMARY KEY (email_id),
  CONSTRAINT gift_emails_gift_id_fkey FOREIGN KEY (gift_id) REFERENCES public.gifts(gift_id)
);
CREATE TABLE public.gifts (
  gift_id uuid NOT NULL DEFAULT gen_random_uuid(),
  sender_id uuid,
  sender_name character varying NOT NULL,
  sender_email character varying NOT NULL,
  sender_message text,
  recipient_name character varying NOT NULL,
  recipient_email character varying NOT NULL,
  recipient_phone character varying,
  recipient_address text,
  product_id integer NOT NULL,
  quantity integer DEFAULT 1,
  verification_code character varying NOT NULL,
  status character varying DEFAULT 'pending'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  verified_at timestamp with time zone,
  claimed_at timestamp with time zone,
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  notes text,
  CONSTRAINT gifts_pkey PRIMARY KEY (gift_id),
  CONSTRAINT gifts_sender_id_fkey FOREIGN KEY (sender_id) REFERENCES public.users(id),
  CONSTRAINT gifts_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.inventory (
  inventory_id integer NOT NULL DEFAULT nextval('inventory_inventory_id_seq'::regclass),
  product_id integer,
  variant_id integer,
  warehouse_location character varying,
  quantity_available integer DEFAULT 0,
  quantity_reserved integer DEFAULT 0,
  quantity_sold integer DEFAULT 0,
  reorder_level integer DEFAULT 10,
  reorder_quantity integer DEFAULT 50,
  last_restock_date timestamp without time zone,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT inventory_pkey PRIMARY KEY (inventory_id),
  CONSTRAINT inventory_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT inventory_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id)
);
CREATE TABLE public.inventory_transactions (
  transaction_id integer NOT NULL DEFAULT nextval('inventory_transactions_transaction_id_seq'::regclass),
  product_id integer,
  variant_id integer,
  transaction_type character varying NOT NULL,
  quantity integer NOT NULL,
  reference_type character varying,
  reference_id integer,
  note text,
  created_by character varying,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT inventory_transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT inventory_transactions_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT inventory_transactions_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id)
);
CREATE TABLE public.notifications (
  notification_id integer NOT NULL DEFAULT nextval('notifications_notification_id_seq'::regclass),
  customer_id integer,
  type character varying NOT NULL,
  title character varying NOT NULL,
  message text NOT NULL,
  link_url character varying,
  is_read boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT notifications_pkey PRIMARY KEY (notification_id),
  CONSTRAINT notifications_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id)
);
CREATE TABLE public.order_history (
  history_id integer NOT NULL DEFAULT nextval('order_history_history_id_seq'::regclass),
  order_id integer,
  status character varying NOT NULL,
  note text,
  created_by character varying,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT order_history_pkey PRIMARY KEY (history_id),
  CONSTRAINT order_history_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.order_items (
  order_item_id integer NOT NULL DEFAULT nextval('order_items_order_item_id_seq'::regclass),
  order_id integer,
  product_id integer,
  variant_id integer,
  product_name character varying NOT NULL,
  variant_name character varying,
  sku character varying NOT NULL,
  quantity integer NOT NULL,
  unit_price numeric NOT NULL,
  discount_amount numeric DEFAULT 0,
  total_price numeric NOT NULL,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT order_items_pkey PRIMARY KEY (order_item_id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id),
  CONSTRAINT order_items_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.orders (
  order_id integer NOT NULL DEFAULT nextval('orders_order_id_seq'::regclass),
  order_number character varying NOT NULL UNIQUE,
  order_status character varying DEFAULT 'pending'::character varying,
  payment_status character varying DEFAULT 'unpaid'::character varying,
  payment_method character varying,
  shipping_method character varying,
  subtotal numeric NOT NULL,
  discount_amount numeric DEFAULT 0,
  shipping_fee numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  total_amount numeric NOT NULL,
  coupon_code character varying,
  shipping_address_id integer,
  billing_address_id integer,
  customer_note text,
  admin_note text,
  tracking_number character varying,
  shipped_at timestamp without time zone,
  delivered_at timestamp without time zone,
  cancelled_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  shipping_full_name character varying,
  shipping_phone character varying,
  shipping_address text,
  shipping_ward character varying,
  shipping_district character varying,
  shipping_city character varying,
  customer_id uuid,
  CONSTRAINT orders_pkey PRIMARY KEY (order_id),
  CONSTRAINT orders_shipping_address_id_fkey FOREIGN KEY (shipping_address_id) REFERENCES public.customer_addresses(address_id),
  CONSTRAINT orders_billing_address_id_fkey FOREIGN KEY (billing_address_id) REFERENCES public.customer_addresses(address_id),
  CONSTRAINT orders_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.users(id)
);
CREATE TABLE public.payment_transactions (
  transaction_id integer NOT NULL DEFAULT nextval('payment_transactions_transaction_id_seq'::regclass),
  order_id integer,
  payment_gateway character varying NOT NULL,
  transaction_ref character varying UNIQUE,
  amount numeric NOT NULL,
  currency character varying DEFAULT 'VND'::character varying,
  status character varying NOT NULL,
  payment_date timestamp without time zone,
  response_data text,
  ip_address character varying,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT payment_transactions_pkey PRIMARY KEY (transaction_id),
  CONSTRAINT payment_transactions_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.phone_models (
  model_id integer NOT NULL DEFAULT nextval('phone_models_model_id_seq'::regclass),
  brand_name character varying NOT NULL,
  model_name character varying NOT NULL,
  model_code character varying,
  release_year integer,
  screen_size numeric,
  dimensions character varying,
  weight character varying,
  image_url character varying,
  is_popular boolean DEFAULT false,
  is_active boolean DEFAULT true,
  display_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT phone_models_pkey PRIMARY KEY (model_id)
);
CREATE TABLE public.phone_templates (
  template_id integer NOT NULL DEFAULT nextval('phone_templates_template_id_seq'::regclass),
  phone_model character varying NOT NULL,
  brand character varying NOT NULL,
  template_image_url text NOT NULL,
  print_width_mm numeric DEFAULT 70,
  print_height_mm numeric DEFAULT 150,
  canvas_width integer DEFAULT 700,
  canvas_height integer DEFAULT 1500,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT phone_templates_pkey PRIMARY KEY (template_id)
);
CREATE TABLE public.product_attributes (
  attribute_id integer NOT NULL DEFAULT nextval('product_attributes_attribute_id_seq'::regclass),
  product_id integer,
  attribute_name character varying NOT NULL,
  attribute_value text NOT NULL,
  CONSTRAINT product_attributes_pkey PRIMARY KEY (attribute_id),
  CONSTRAINT product_attributes_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.product_collections (
  id integer NOT NULL DEFAULT nextval('product_collections_id_seq'::regclass),
  product_id integer,
  collection_id integer,
  display_order integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_collections_pkey PRIMARY KEY (id),
  CONSTRAINT product_collections_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_collections_collection_id_fkey FOREIGN KEY (collection_id) REFERENCES public.design_collections(collection_id)
);
CREATE TABLE public.product_compatibility (
  compatibility_id integer NOT NULL DEFAULT nextval('product_compatibility_compatibility_id_seq'::regclass),
  product_id integer,
  phone_model_id integer,
  fit_type character varying DEFAULT 'exact'::character varying,
  notes text,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_compatibility_pkey PRIMARY KEY (compatibility_id),
  CONSTRAINT product_compatibility_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_compatibility_phone_model_id_fkey FOREIGN KEY (phone_model_id) REFERENCES public.phone_models(model_id)
);
CREATE TABLE public.product_images (
  image_id integer NOT NULL DEFAULT nextval('product_images_image_id_seq'::regclass),
  product_id integer,
  variant_id integer,
  image_url character varying NOT NULL,
  alt_text character varying,
  display_order integer DEFAULT 0,
  is_primary boolean DEFAULT false,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_images_pkey PRIMARY KEY (image_id),
  CONSTRAINT product_images_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_images_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id)
);
CREATE TABLE public.product_reviews (
  review_id integer NOT NULL DEFAULT nextval('product_reviews_review_id_seq'::regclass),
  product_id integer,
  customer_id integer,
  order_id integer,
  rating integer NOT NULL CHECK (rating >= 1 AND rating <= 5),
  title character varying,
  comment text,
  is_verified_purchase boolean DEFAULT false,
  is_approved boolean DEFAULT false,
  helpful_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_reviews_pkey PRIMARY KEY (review_id),
  CONSTRAINT product_reviews_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT product_reviews_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id),
  CONSTRAINT product_reviews_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id)
);
CREATE TABLE public.product_variants (
  variant_id integer NOT NULL DEFAULT nextval('product_variants_variant_id_seq'::regclass),
  product_id integer,
  sku character varying NOT NULL UNIQUE,
  variant_name character varying,
  color character varying,
  color_code character varying,
  size character varying,
  material character varying,
  price numeric,
  sale_price numeric,
  image_url character varying,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT product_variants_pkey PRIMARY KEY (variant_id),
  CONSTRAINT product_variants_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.products (
  product_id integer NOT NULL DEFAULT nextval('products_product_id_seq'::regclass),
  product_name character varying NOT NULL,
  product_slug character varying NOT NULL UNIQUE,
  category_id integer,
  brand_id integer,
  sku character varying NOT NULL UNIQUE,
  description text,
  short_description text,
  price numeric NOT NULL,
  sale_price numeric,
  cost_price numeric,
  is_featured boolean DEFAULT false,
  is_new boolean DEFAULT false,
  is_bestseller boolean DEFAULT false,
  is_trending boolean DEFAULT false,
  status character varying DEFAULT 'active'::character varying,
  meta_title character varying,
  meta_description text,
  meta_keywords text,
  view_count integer DEFAULT 0,
  rating_average numeric DEFAULT 0,
  review_count integer DEFAULT 0,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  image_url text,
  season text,
  CONSTRAINT products_pkey PRIMARY KEY (product_id),
  CONSTRAINT products_category_id_fkey FOREIGN KEY (category_id) REFERENCES public.categories(category_id),
  CONSTRAINT products_brand_id_fkey FOREIGN KEY (brand_id) REFERENCES public.brands(brand_id)
);
CREATE TABLE public.recently_viewed (
  id integer NOT NULL DEFAULT nextval('recently_viewed_id_seq'::regclass),
  customer_id integer,
  product_id integer,
  viewed_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT recently_viewed_pkey PRIMARY KEY (id),
  CONSTRAINT recently_viewed_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id),
  CONSTRAINT recently_viewed_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.refunds (
  refund_id integer NOT NULL DEFAULT nextval('refunds_refund_id_seq'::regclass),
  order_id integer,
  refund_amount numeric NOT NULL,
  refund_reason text NOT NULL,
  refund_status character varying DEFAULT 'pending'::character varying,
  refund_method character varying,
  processed_by integer,
  approved_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT refunds_pkey PRIMARY KEY (refund_id),
  CONSTRAINT refunds_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(order_id),
  CONSTRAINT refunds_processed_by_fkey FOREIGN KEY (processed_by) REFERENCES public.staff(staff_id)
);
CREATE TABLE public.review_images (
  review_image_id integer NOT NULL DEFAULT nextval('review_images_review_image_id_seq'::regclass),
  review_id integer,
  image_url character varying NOT NULL,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT review_images_pkey PRIMARY KEY (review_image_id),
  CONSTRAINT review_images_review_id_fkey FOREIGN KEY (review_id) REFERENCES public.product_reviews(review_id)
);
CREATE TABLE public.search_logs (
  search_id integer NOT NULL DEFAULT nextval('search_logs_search_id_seq'::regclass),
  customer_id integer,
  search_query character varying NOT NULL,
  results_count integer DEFAULT 0,
  clicked_product_id integer,
  search_date timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT search_logs_pkey PRIMARY KEY (search_id),
  CONSTRAINT search_logs_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id),
  CONSTRAINT search_logs_clicked_product_id_fkey FOREIGN KEY (clicked_product_id) REFERENCES public.products(product_id)
);
CREATE TABLE public.shipping_rates (
  rate_id integer NOT NULL DEFAULT nextval('shipping_rates_rate_id_seq'::regclass),
  zone_id integer,
  shipping_method character varying NOT NULL,
  min_order_amount numeric DEFAULT 0,
  max_order_amount numeric,
  shipping_fee numeric NOT NULL,
  estimated_days character varying,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT shipping_rates_pkey PRIMARY KEY (rate_id),
  CONSTRAINT shipping_rates_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.shipping_zones(zone_id)
);
CREATE TABLE public.shipping_zones (
  zone_id integer NOT NULL DEFAULT nextval('shipping_zones_zone_id_seq'::regclass),
  zone_name character varying NOT NULL,
  countries text,
  cities text,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT shipping_zones_pkey PRIMARY KEY (zone_id)
);
CREATE TABLE public.shopping_carts (
  cart_id integer NOT NULL DEFAULT nextval('shopping_carts_cart_id_seq'::regclass),
  customer_id uuid,
  product_id integer,
  variant_id integer,
  quantity integer NOT NULL DEFAULT 1,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT shopping_carts_pkey PRIMARY KEY (cart_id),
  CONSTRAINT shopping_carts_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT shopping_carts_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id),
  CONSTRAINT shopping_carts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.users(id)
);
CREATE TABLE public.staff (
  staff_id integer NOT NULL DEFAULT nextval('staff_staff_id_seq'::regclass),
  email character varying NOT NULL UNIQUE,
  password_hash character varying NOT NULL,
  full_name character varying NOT NULL,
  phone character varying,
  role character varying NOT NULL,
  permissions text,
  is_active boolean DEFAULT true,
  last_login timestamp without time zone,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT staff_pkey PRIMARY KEY (staff_id)
);
CREATE TABLE public.system_settings (
  setting_id integer NOT NULL DEFAULT nextval('system_settings_setting_id_seq'::regclass),
  setting_key character varying NOT NULL UNIQUE,
  setting_value text,
  setting_type character varying,
  description text,
  updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT system_settings_pkey PRIMARY KEY (setting_id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email character varying NOT NULL UNIQUE,
  password_hash text NOT NULL,
  full_name character varying,
  phone character varying,
  avatar_url text,
  address text,
  is_admin boolean DEFAULT false,
  role character varying DEFAULT 'user'::character varying,
  status character varying DEFAULT 'active'::character varying,
  email_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  last_login_at timestamp with time zone,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.wishlists (
  wishlist_id integer NOT NULL DEFAULT nextval('wishlists_wishlist_id_seq'::regclass),
  customer_id integer,
  product_id integer,
  variant_id integer,
  created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
  user_id uuid,
  CONSTRAINT wishlists_pkey PRIMARY KEY (wishlist_id),
  CONSTRAINT wishlists_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(customer_id),
  CONSTRAINT wishlists_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(product_id),
  CONSTRAINT wishlists_variant_id_fkey FOREIGN KEY (variant_id) REFERENCES public.product_variants(variant_id),
  CONSTRAINT wishlists_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);



################################################################################
## FILE 2: package.json
## Path: backend/package.json
################################################################################

{
  "name": "backend",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json"
  },
  "dependencies": {
    "@nestjs/common": "^11.0.1",
    "@nestjs/config": "^4.0.2",
    "@nestjs/core": "^11.0.1",
    "@nestjs/jwt": "^11.0.2",
    "@nestjs/passport": "^11.0.5",
    "@nestjs/platform-express": "^11.0.1",
    "@nestjs/serve-static": "^5.0.4",
    "@supabase/supabase-js": "^2.86.2",
    "@types/multer": "^2.0.0",
    "@types/nodemailer": "^7.0.4",
    "axios": "^1.13.2",
    "bcrypt": "^6.0.0",
    "cloudinary": "^2.8.0",
    "next-cloudinary": "^6.17.5",
    "nodemailer": "^7.0.11",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "sharp": "^0.34.5",
    "xmlrpc": "^1.3.2"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3.2.0",
    "@eslint/js": "^9.18.0",
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.1",
    "@types/bcrypt": "^6.0.0",
    "@types/express": "^5.0.0",
    "@types/jest": "^30.0.0",
    "@types/node": "^22.10.7",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "@types/xmlrpc": "^1.3.10",
    "eslint": "^9.18.0",
    "eslint-config-prettier": "^10.0.1",
    "eslint-plugin-prettier": "^5.2.2",
    "globals": "^16.0.0",
    "jest": "^30.0.0",
    "prettier": "^3.4.2",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.5",
    "ts-loader": "^9.5.2",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.3",
    "typescript-eslint": "^8.20.0"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s"
    ],
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}




################################################################################
## FILE 3: nest-cli.json
## Path: backend/nest-cli.json
################################################################################

{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}




################################################################################
## FILE 4: .env
## Path: backend/.env
################################################################################

SUPABASE_URL=https://zrmbsfzamyhbvufvdbwx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=sb_publishable_28J3II_QQBWQ1JXfZNhlwA_26Gpzmfu

EMAIL_USER=contact.goattech.vn@gmail.com
EMAIL_PASS=yxnc yvbt wuai upcp
FRONTEND_URL=http://localhost:3000

FACEBOOK_PAGE_ACCESS_TOKEN=EAAMYrxRF5q0BQAhNXe7PUWqQuOdCojzFgtONAEZCPjocgMHf99RH6UUE4ZA3visHYOjzpHpvklZBN4mZCZAZBnBqwDjxnLWGVM0BfSW1KqY6FjwSPTKkek37sqib6zkGnLxtiQhcTd7Os8aBqO64FJM8J0RuNWhZAudkACVkp3bCbaZBrzAbBjYZCAjaIlMTb1aVoLe6NzAhZBzQZDZD
FACEBOOK_VERIFY_TOKEN=vtmba11td



################################################################################
## FILE 5: create_wishlist.sql
## Path: backend/sql/create_wishlist.sql
################################################################################

-- Wishlists table (nếu chưa có)
-- Nếu bảng wishlists đã tồn tại, script này sẽ không chạy

-- Kiểm tra cấu trúc bảng wishlists hiện có
-- Cần có các cột: id, customer_id, product_id, variant_id, created_at

-- Ví dụ cấu trúc:
-- CREATE TABLE IF NOT EXISTS wishlists (
--     id SERIAL PRIMARY KEY,
--     customer_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
--     product_id INTEGER NOT NULL REFERENCES products(product_id) ON DELETE CASCADE,
--     variant_id INTEGER,
--     created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
--     UNIQUE(customer_id, product_id)
-- );

-- Index for faster queries
CREATE INDEX IF NOT EXISTS idx_wishlists_customer_id ON wishlists(customer_id);
CREATE INDEX IF NOT EXISTS idx_wishlists_product_id ON wishlists(product_id);




################################################################################
## FILE 6: create_messenger_orders.sql
## Path: backend/sql/create_messenger_orders.sql
################################################################################

-- =====================================================
-- Tạo bảng messenger_orders
-- Lưu trữ đơn hàng từ Facebook Messenger Bot
-- =====================================================

-- Tạo bảng messenger_orders
CREATE TABLE IF NOT EXISTS messenger_orders (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- Thông tin Facebook
    facebook_user_id VARCHAR(255) NOT NULL,
    
    -- Thông tin khách hàng
    customer_name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    address TEXT NOT NULL,
    
    -- Thông tin sản phẩm
    product_name VARCHAR(255) NOT NULL,
    product_price DECIMAL(12, 0) NOT NULL DEFAULT 0,
    quantity INTEGER NOT NULL DEFAULT 1,
    color VARCHAR(100),
    
    -- Tổng tiền
    total_price DECIMAL(12, 0) NOT NULL DEFAULT 0,
    
    -- Ghi chú
    notes TEXT,
    
    -- Trạng thái đơn hàng
    -- pending: Chờ xác nhận
    -- confirmed: Đã xác nhận  
    -- processing: Đang xử lý
    -- shipping: Đang giao hàng
    -- delivered: Đã giao hàng
    -- cancelled: Đã hủy
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    
    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Index để tìm kiếm nhanh theo facebook_user_id
CREATE INDEX IF NOT EXISTS idx_messenger_orders_facebook_user_id 
ON messenger_orders(facebook_user_id);

-- Index để tìm kiếm nhanh theo status
CREATE INDEX IF NOT EXISTS idx_messenger_orders_status 
ON messenger_orders(status);

-- Index để sắp xếp theo ngày tạo
CREATE INDEX IF NOT EXISTS idx_messenger_orders_created_at 
ON messenger_orders(created_at DESC);

-- Index để tìm kiếm theo số điện thoại
CREATE INDEX IF NOT EXISTS idx_messenger_orders_phone 
ON messenger_orders(phone);

-- Trigger tự động cập nhật updated_at
CREATE OR REPLACE FUNCTION update_messenger_orders_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Tạo trigger
DROP TRIGGER IF EXISTS trigger_update_messenger_orders_updated_at ON messenger_orders;
CREATE TRIGGER trigger_update_messenger_orders_updated_at
    BEFORE UPDATE ON messenger_orders
    FOR EACH ROW
    EXECUTE FUNCTION update_messenger_orders_updated_at();

-- Enable Row Level Security (RLS)
ALTER TABLE messenger_orders ENABLE ROW LEVEL SECURITY;

-- Policy cho phép service role đọc tất cả
CREATE POLICY "Service role can read all messenger_orders" 
ON messenger_orders FOR SELECT 
TO service_role 
USING (true);

-- Policy cho phép service role insert
CREATE POLICY "Service role can insert messenger_orders" 
ON messenger_orders FOR INSERT 
TO service_role 
WITH CHECK (true);

-- Policy cho phép service role update
CREATE POLICY "Service role can update messenger_orders" 
ON messenger_orders FOR UPDATE 
TO service_role 
USING (true);

-- Policy cho phép authenticated users đọc đơn của họ (nếu cần)
-- CREATE POLICY "Users can read their own messenger_orders" 
-- ON messenger_orders FOR SELECT 
-- TO authenticated 
-- USING (facebook_user_id = auth.uid()::text);

-- =====================================================
-- Insert dữ liệu mẫu (optional - có thể comment out)
-- =====================================================

-- INSERT INTO messenger_orders (
--     facebook_user_id,
--     customer_name,
--     phone,
--     address,
--     product_name,
--     product_price,
--     quantity,
--     color,
--     total_price,
--     status
-- ) VALUES 
-- (
--     '1234567890',
--     'Nguyễn Văn A',
--     '0912345678',
--     '123 Đường ABC, Quận 1, TP.HCM',
--     'Ốp Silicone',
--     150000,
--     2,
--     'Đen',
--     300000,
--     'pending'
-- ),
-- (
--     '0987654321',
--     'Trần Thị B',
--     '0909876543',
--     '456 Đường XYZ, Quận 7, TP.HCM',
--     'Ốp Leather',
--     200000,
--     1,
--     'Nâu',
--     200000,
--     'confirmed'
-- );

-- =====================================================
-- View thống kê đơn hàng (optional)
-- =====================================================

CREATE OR REPLACE VIEW messenger_orders_stats AS
SELECT 
    COUNT(*) as total_orders,
    COUNT(CASE WHEN status = 'pending' THEN 1 END) as pending_orders,
    COUNT(CASE WHEN status = 'confirmed' THEN 1 END) as confirmed_orders,
    COUNT(CASE WHEN status = 'processing' THEN 1 END) as processing_orders,
    COUNT(CASE WHEN status = 'shipping' THEN 1 END) as shipping_orders,
    COUNT(CASE WHEN status = 'delivered' THEN 1 END) as delivered_orders,
    COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled_orders,
    SUM(total_price) as total_revenue,
    SUM(CASE WHEN status = 'delivered' THEN total_price ELSE 0 END) as completed_revenue,
    DATE(created_at) as order_date
FROM messenger_orders
GROUP BY DATE(created_at)
ORDER BY order_date DESC;

-- =====================================================
-- Comment giải thích các cột
-- =====================================================

COMMENT ON TABLE messenger_orders IS 'Bảng lưu trữ đơn hàng từ Facebook Messenger Bot';
COMMENT ON COLUMN messenger_orders.facebook_user_id IS 'ID người dùng Facebook (PSID)';
COMMENT ON COLUMN messenger_orders.customer_name IS 'Tên khách hàng';
COMMENT ON COLUMN messenger_orders.phone IS 'Số điện thoại liên hệ';
COMMENT ON COLUMN messenger_orders.address IS 'Địa chỉ giao hàng';
COMMENT ON COLUMN messenger_orders.product_name IS 'Tên sản phẩm đặt mua';
COMMENT ON COLUMN messenger_orders.product_price IS 'Giá sản phẩm (VNĐ)';
COMMENT ON COLUMN messenger_orders.quantity IS 'Số lượng đặt mua';
COMMENT ON COLUMN messenger_orders.color IS 'Màu sắc sản phẩm';
COMMENT ON COLUMN messenger_orders.total_price IS 'Tổng tiền đơn hàng (VNĐ)';
COMMENT ON COLUMN messenger_orders.status IS 'Trạng thái đơn: pending, confirmed, processing, shipping, delivered, cancelled';




################################################################################
## FILE 7: create_gifts.sql
## Path: backend/sql/create_gifts.sql
################################################################################

-- Tạo bảng gifts để lưu thông tin quà tặng
CREATE TABLE IF NOT EXISTS gifts (
    gift_id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- Thông tin người gửi
    sender_id UUID REFERENCES users(user_id),
    sender_name VARCHAR(255) NOT NULL,
    sender_email VARCHAR(255) NOT NULL,
    sender_message TEXT,
    
    -- Thông tin người nhận
    recipient_name VARCHAR(255) NOT NULL,
    recipient_email VARCHAR(255) NOT NULL,
    recipient_phone VARCHAR(20),
    recipient_address TEXT,
    
    -- Thông tin sản phẩm
    product_id INTEGER REFERENCES products(product_id) NOT NULL,
    quantity INTEGER DEFAULT 1,
    
    -- Mã xác nhận
    verification_code VARCHAR(10) NOT NULL,
    
    -- Trạng thái: pending, verified, claimed, expired, cancelled
    status VARCHAR(20) DEFAULT 'pending',
    
    -- Thời gian
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    verified_at TIMESTAMP WITH TIME ZONE,
    claimed_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '7 days'),
    
    -- Ghi chú
    notes TEXT
);

-- Index để tìm kiếm nhanh
CREATE INDEX IF NOT EXISTS idx_gifts_recipient_email ON gifts(recipient_email);
CREATE INDEX IF NOT EXISTS idx_gifts_verification_code ON gifts(verification_code);
CREATE INDEX IF NOT EXISTS idx_gifts_status ON gifts(status);
CREATE INDEX IF NOT EXISTS idx_gifts_sender_id ON gifts(sender_id);

-- Bảng lưu lịch sử email đã gửi
CREATE TABLE IF NOT EXISTS gift_emails (
    email_id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    gift_id UUID REFERENCES gifts(gift_id) ON DELETE CASCADE,
    email_type VARCHAR(50) NOT NULL, -- notification, reminder, confirmation
    sent_to VARCHAR(255) NOT NULL,
    sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    status VARCHAR(20) DEFAULT 'sent' -- sent, failed, bounced
);

-- Comment
COMMENT ON TABLE gifts IS 'Bảng lưu thông tin quà tặng sản phẩm';
COMMENT ON COLUMN gifts.verification_code IS 'Mã 6 số để xác nhận nhận quà';
COMMENT ON COLUMN gifts.status IS 'pending: chờ xác nhận, verified: đã xác nhận email, claimed: đã nhận quà, expired: hết hạn, cancelled: đã hủy';




################################################################################
## FILE 8: create_designs.sql
## Path: backend/sql/create_designs.sql
################################################################################

-- Bảng lưu phone templates (các mẫu điện thoại có sẵn)
CREATE TABLE IF NOT EXISTS phone_templates (
    template_id SERIAL PRIMARY KEY,
    phone_model VARCHAR(100) NOT NULL, -- iPhone 15, Samsung S24, etc.
    brand VARCHAR(50) NOT NULL, -- Apple, Samsung, Xiaomi, etc.
    template_image_url TEXT NOT NULL, -- Ảnh template chuẩn (khung điện thoại)
    print_width_mm DECIMAL(10,2) DEFAULT 70, -- Chiều rộng vùng in (mm)
    print_height_mm DECIMAL(10,2) DEFAULT 150, -- Chiều cao vùng in (mm)
    canvas_width INT DEFAULT 700, -- Chiều rộng canvas (px)
    canvas_height INT DEFAULT 1500, -- Chiều cao canvas (px)
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Bảng lưu các thiết kế của khách hàng
CREATE TABLE IF NOT EXISTS custom_designs (
    design_id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL, -- Tham chiếu đến users(id) - UUID
    guest_email VARCHAR(255), -- Email khách vãng lai
    guest_name VARCHAR(100), -- Tên khách vãng lai
    guest_phone VARCHAR(20), -- SĐT khách vãng lai
    
    -- Thông tin template
    template_id INTEGER REFERENCES phone_templates(template_id),
    phone_model VARCHAR(100) NOT NULL,
    
    -- Dữ liệu thiết kế (JSON từ Fabric.js)
    design_data JSONB NOT NULL, -- Chứa toàn bộ canvas data
    preview_image_url TEXT, -- Ảnh preview chất lượng thấp
    high_res_image_url TEXT, -- Ảnh render chất lượng cao (sau khi xử lý)
    
    -- Trạng thái
    status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'processing', 'approved', 'rejected', 'printed')),
    admin_notes TEXT, -- Ghi chú của admin
    
    -- Thông tin đơn hàng (nếu có)
    order_id INTEGER REFERENCES orders(order_id) ON DELETE SET NULL,
    
    -- Timestamps
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    submitted_at TIMESTAMP WITHOUT TIME ZONE, -- Thời điểm gửi cho admin
    processed_at TIMESTAMP WITHOUT TIME ZONE -- Thời điểm admin xử lý xong
);

-- Bảng lưu các ảnh khách upload cho thiết kế
CREATE TABLE IF NOT EXISTS design_images (
    image_id SERIAL PRIMARY KEY,
    design_id INTEGER REFERENCES custom_designs(design_id) ON DELETE CASCADE,
    original_url TEXT NOT NULL, -- URL ảnh gốc full resolution
    thumbnail_url TEXT, -- URL ảnh thumbnail
    file_name VARCHAR(255),
    file_size INT, -- bytes
    width INT,
    height INT,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Index để query nhanh
CREATE INDEX IF NOT EXISTS idx_designs_user_id ON custom_designs(user_id);
CREATE INDEX IF NOT EXISTS idx_designs_status ON custom_designs(status);
CREATE INDEX IF NOT EXISTS idx_designs_order_id ON custom_designs(order_id);
CREATE INDEX IF NOT EXISTS idx_designs_created_at ON custom_designs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_design_images_design_id ON design_images(design_id);

-- Insert một số phone templates mẫu
INSERT INTO phone_templates (phone_model, brand, template_image_url, print_width_mm, print_height_mm) VALUES
('iPhone 15', 'Apple', '/templates/iphone15.svg', 71.6, 147.6),
('iPhone 15 Pro', 'Apple', '/templates/iphone15pro.svg', 70.6, 146.6),
('iPhone 15 Pro Max', 'Apple', '/templates/iphone15promax.svg', 76.7, 159.9),
('iPhone 14', 'Apple', '/templates/iphone14.svg', 71.5, 146.7),
('iPhone 14 Pro', 'Apple', '/templates/iphone14pro.svg', 71.5, 147.5),
('Samsung Galaxy S24', 'Samsung', '/templates/samsung-s24.svg', 70.6, 147.0),
('Samsung Galaxy S24 Ultra', 'Samsung', '/templates/samsung-s24-ultra.svg', 79.0, 162.3),
('Xiaomi 14', 'Xiaomi', '/templates/xiaomi14.svg', 71.5, 152.8),
('OPPO Find X7', 'OPPO', '/templates/oppo-findx7.svg', 74.2, 162.2)
ON CONFLICT DO NOTHING;




################################################################################
## FILE 9: create_contact_messages.sql
## Path: backend/sql/create_contact_messages.sql
################################################################################

-- Tạo bảng contact_messages để lưu tin nhắn liên hệ từ khách hàng
CREATE TABLE IF NOT EXISTS contact_messages (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    subject VARCHAR(255),
    message TEXT NOT NULL,
    status VARCHAR(50) DEFAULT 'pending', -- pending, replied, closed
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Tạo index cho tìm kiếm nhanh
CREATE INDEX idx_contact_messages_status ON contact_messages(status);
CREATE INDEX idx_contact_messages_created_at ON contact_messages(created_at DESC);

-- Enable RLS (Row Level Security)
ALTER TABLE contact_messages ENABLE ROW LEVEL SECURITY;

-- Policy cho phép insert từ bất kỳ ai (anonymous)
CREATE POLICY "Anyone can create contact messages" ON contact_messages
    FOR INSERT WITH CHECK (true);

-- Policy cho phép admin đọc tất cả
CREATE POLICY "Admin can view all contact messages" ON contact_messages
    FOR SELECT USING (true);

-- Policy cho phép admin update
CREATE POLICY "Admin can update contact messages" ON contact_messages
    FOR UPDATE USING (true);

-- Policy cho phép admin delete
CREATE POLICY "Admin can delete contact messages" ON contact_messages
    FOR DELETE USING (true);




################################################################################
## FILE 10: create_collections.sql
## Path: backend/sql/create_collections.sql
################################################################################

-- Tạo bảng collections (Bộ sưu tập)
CREATE TABLE IF NOT EXISTS collections (
    collection_id SERIAL PRIMARY KEY,
    collection_name VARCHAR(100) NOT NULL,
    collection_slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    image_url TEXT,
    gradient_color VARCHAR(100) DEFAULT 'from-purple-500 to-pink-500',
    icon_name VARCHAR(50) DEFAULT 'Sparkles',
    display_order INT DEFAULT 0,
    is_featured BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    collection_type VARCHAR(20) DEFAULT 'normal', -- normal, seasonal
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Tạo bảng liên kết product_collections (1 sản phẩm có thể thuộc nhiều bộ sưu tập)
CREATE TABLE IF NOT EXISTS product_collections (
    id SERIAL PRIMARY KEY,
    product_id INT NOT NULL REFERENCES products(product_id) ON DELETE CASCADE,
    collection_id INT NOT NULL REFERENCES collections(collection_id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(product_id, collection_id)
);

-- Tạo indexes
CREATE INDEX IF NOT EXISTS idx_collections_slug ON collections(collection_slug);
CREATE INDEX IF NOT EXISTS idx_collections_type ON collections(collection_type);
CREATE INDEX IF NOT EXISTS idx_product_collections_product ON product_collections(product_id);
CREATE INDEX IF NOT EXISTS idx_product_collections_collection ON product_collections(collection_id);

-- Enable RLS
ALTER TABLE collections ENABLE ROW LEVEL SECURITY;
ALTER TABLE product_collections ENABLE ROW LEVEL SECURITY;

-- Policies cho collections
CREATE POLICY "Anyone can view collections" ON collections FOR SELECT USING (true);
CREATE POLICY "Anyone can insert collections" ON collections FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can update collections" ON collections FOR UPDATE USING (true);
CREATE POLICY "Anyone can delete collections" ON collections FOR DELETE USING (true);

-- Policies cho product_collections
CREATE POLICY "Anyone can view product_collections" ON product_collections FOR SELECT USING (true);
CREATE POLICY "Anyone can insert product_collections" ON product_collections FOR INSERT WITH CHECK (true);
CREATE POLICY "Anyone can update product_collections" ON product_collections FOR UPDATE USING (true);
CREATE POLICY "Anyone can delete product_collections" ON product_collections FOR DELETE USING (true);

-- Insert các bộ sưu tập mặc định
INSERT INTO collections (collection_name, collection_slug, description, gradient_color, icon_name, display_order, is_featured, collection_type) VALUES
('Luxury Edition', 'luxury-edition', 'Bộ sưu tập cao cấp với chất liệu da thật và kim loại nguyên khối', 'from-amber-500 via-yellow-500 to-orange-500', 'Crown', 1, true, 'normal'),
('Minimalist', 'minimalist', 'Thiết kế tối giản, tinh tế cho người yêu thích sự đơn giản', 'from-gray-700 via-gray-800 to-gray-900', 'Gem', 2, false, 'normal'),
('Artistic Series', 'artistic-series', 'Họa tiết nghệ thuật độc đáo từ các nghệ sĩ hàng đầu', 'from-purple-500 via-pink-500 to-red-500', 'Palette', 3, false, 'normal'),
('Gaming Pro', 'gaming-pro', 'Dành cho game thủ với thiết kế RGB và grip chống trượt', 'from-green-400 via-cyan-500 to-blue-500', 'Zap', 4, false, 'normal'),
('Rugged Armor', 'rugged-armor', 'Bảo vệ tối đa với chuẩn quân đội, chống va đập cực tốt', 'from-slate-600 via-slate-700 to-slate-800', 'Shield', 5, false, 'normal'),
('Limited Edition', 'limited-edition', 'Phiên bản giới hạn, số lượng có hạn, thiết kế độc quyền', 'from-rose-500 via-pink-600 to-purple-600', 'Sparkles', 6, true, 'normal'),
('Giáng Sinh - Noel', 'giang-sinh-noel', 'Bộ sưu tập đặc biệt mùa Giáng sinh', 'from-red-600 to-green-600', 'Gift', 7, false, 'seasonal'),
('Valentine', 'valentine', 'Bộ sưu tập tình yêu cho ngày Valentine', 'from-red-400 to-pink-500', 'Heart', 8, false, 'seasonal'),
('Tết Nguyên Đán', 'tet-nguyen-dan', 'Bộ sưu tập đón Tết cổ truyền Việt Nam', 'from-yellow-500 to-red-500', 'Sparkles', 9, false, 'seasonal')
ON CONFLICT (collection_slug) DO NOTHING;




################################################################################
## FILE 11: alter_wishlists.sql
## Path: backend/sql/alter_wishlists.sql
################################################################################

-- Thêm cột user_id để hỗ trợ users table (UUID)
ALTER TABLE wishlists ADD COLUMN IF NOT EXISTS user_id UUID REFERENCES users(id) ON DELETE CASCADE;

-- Tạo unique index để tránh duplicate
CREATE UNIQUE INDEX IF NOT EXISTS idx_wishlists_user_product ON wishlists(user_id, product_id) WHERE user_id IS NOT NULL;




################################################################################
## FILE 12: add_season_column.sql
## Path: backend/sql/add_season_column.sql
################################################################################

-- Thêm cột season vào bảng products
-- Giá trị: NULL (không thuộc mùa nào), 'noel', 'valentine', 'tet'

ALTER TABLE products 
ADD COLUMN IF NOT EXISTS season VARCHAR(20) DEFAULT NULL;

-- Tạo index để query nhanh hơn
CREATE INDEX IF NOT EXISTS idx_products_season ON products(season);

-- Comment để giải thích
COMMENT ON COLUMN products.season IS 'Mùa lễ: noel, valentine, tet hoặc NULL';




################################################################################
## FILE 13: add_phone_model_to_cart.sql
## Path: backend/sql/add_phone_model_to_cart.sql
################################################################################

-- Thêm cột phone_model_id vào bảng shopping_carts
-- Để lưu dòng máy điện thoại người dùng chọn khi thêm ốp vào giỏ

ALTER TABLE public.shopping_carts
ADD COLUMN phone_model_id integer,
ADD COLUMN phone_model_name character varying(100);

-- Thêm foreign key (optional - có thể bỏ nếu muốn linh hoạt hơn)
-- ALTER TABLE public.shopping_carts
-- ADD CONSTRAINT shopping_carts_phone_model_id_fkey 
--   FOREIGN KEY (phone_model_id) 
--   REFERENCES public.phone_models(model_id);

-- Thêm cột phone_model vào order_items để lưu khi checkout
ALTER TABLE public.order_items
ADD COLUMN phone_model_id integer,
ADD COLUMN phone_model_name character varying(100);

COMMENT ON COLUMN public.shopping_carts.phone_model_id IS 'ID của dòng máy điện thoại được chọn';
COMMENT ON COLUMN public.shopping_carts.phone_model_name IS 'Tên dòng máy (backup)';
COMMENT ON COLUMN public.order_items.phone_model_id IS 'ID dòng máy đã chọn khi đặt hàng';
COMMENT ON COLUMN public.order_items.phone_model_name IS 'Tên dòng máy (backup)';




################################################################################
## FILE 14: supabase.service.ts
## Path: backend/src/supabase.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { createClient } from '@supabase/supabase-js';

@Injectable()
export class SupabaseService {
  private supabase = createClient(
    process.env.SUPABASE_URL || '',
    process.env.SUPABASE_SERVICE_ROLE_KEY || '',
  );

  // ============ USERS ============
  async getCustomers() {
    const { data, error } = await this.supabase.from('users').select('*');
    return { data, error };
  }

  async getCustomerById(customerId: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('id', customerId)
      .single();
    return { data, error };
  }

  async createCustomer(customerData: any) {
    const { data, error } = await this.supabase
      .from('users')
      .insert([customerData])
      .select();
    return { data, error };
  }

  async getCustomerByEmail(email: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .single();
    return { data, error };
  }

  async loginCustomer(email: string, password: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .eq('password_hash', password)
      .single();
    return { data, error };
  }

  async createCustomerAddress(addressData: any) {
    const { data, error } = await this.supabase
      .from('customer_addresses')
      .insert([addressData])
      .select();
    return { data, error };
  }

  async getCustomerAddresses(customerId: number) {
    const { data, error } = await this.supabase
      .from('customer_addresses')
      .select('*')
      .eq('customer_id', customerId)
      .order('is_default', { ascending: false });
    return { data, error };
  }

  // ============ PRODUCTS ============
  async getProducts(limit = 10) {
    const { data, error } = await this.supabase
      .from('products')
      .select(`
        *,
        categories (
          category_id,
          category_name
        ),
        product_images (
          image_id,
          image_url,
          is_primary,
          display_order
        )
      `)
      .neq('status', 'deleted')
      .limit(limit);

    const flattenedData = data?.map((p: any) => {
      // tìm ảnh chính
      const primaryImage =
        p.product_images?.find((img: any) => img.is_primary) ||
        p.product_images?.[0];

      return {
        ...p,
        category_name: p.categories?.category_name || 'Khác',
        image_url: primaryImage?.image_url || null,
        images: p.product_images || [],
      };
    });

    return { data: flattenedData, error };
  }


  async getProductById(productId: number) {
    const { data, error } = await this.supabase
      .from('products')
      .select(`
        *,
        categories (
          category_id,
          category_name
        )
      `)
      .eq('product_id', productId)
      .single();
    
    // Flatten category name
    const flattenedData = data ? {
      ...data,
      category_name: data.categories?.category_name || 'Khác'
    } : null;
    
    return { data: flattenedData, error };;
  }

  async createProduct(productData: any) {
    const { data, error } = await this.supabase
      .from('products')
      .insert([productData])
      .select();
    return { data, error };
  }

  async updateProduct(productId: number, productData: any) {
    const { data, error } = await this.supabase
      .from('products')
      .update(productData)
      .eq('product_id', productId)
      .select();
    return { data, error };
  }

  // Soft delete - đổi status thành 'deleted' thay vì xóa hẳn
  // Vì sản phẩm có thể đã có trong order_items
  async deleteProduct(productId: number) {
    const { data, error } = await this.supabase
      .from('products')
      .update({ status: 'deleted' })
      .eq('product_id', productId)
      .select();
    return { data, error };
  }

  async getProductsByCategory(categoryId: number) {
    const { data, error } = await this.supabase
      .from('products')
      .select('*')
      .eq('category_id', categoryId);
    return { data, error };
  }

  // ============ PRODUCTS BY SEASON ============
  async getProductsBySeason(season: string) {
    const { data, error } = await this.supabase
      .from('products')
      .select('*')
      .eq('season', season)
      .eq('status', 'active');
    return { data, error };
  }

  async getSeasonProductCounts() {
    const seasons = ['noel', 'valentine', 'tet'];
    const counts: Record<string, number> = {};
    
    for (const season of seasons) {
      const { data, error } = await this.supabase
        .from('products')
        .select('product_id', { count: 'exact' })
        .eq('season', season)
        .eq('status', 'active');
      
      counts[season] = data?.length || 0;
    }
    
    return counts;
  }

  // ============ ORDERS ============
  async getOrders(limit = 20) {
    const { data, error } = await this.supabase
      .from('orders')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);
    return { data, error };
  }

  async getOrderById(orderId: number) {
    const { data, error } = await this.supabase
      .from('orders')
      .select('*')
      .eq('order_id', orderId)
      .single();
    return { data, error };
  }

  async getOrdersByCustomer(customerId: number) {
    const { data, error } = await this.supabase
      .from('orders')
      .select('*')
      .eq('customer_id', customerId)
      .order('created_at', { ascending: false });
    return { data, error };
  }

  async createOrder(orderData: any) {
    const { data, error } = await this.supabase
      .from('orders')
      .insert([orderData])
      .select();
    return { data, error };
  }

  async updateOrderStatus(orderId: number, newStatus: string) {
    const { data, error } = await this.supabase
      .from('orders')
      .update({ order_status: newStatus, updated_at: new Date() })
      .eq('order_id', orderId)
      .select();
    return { data, error };
  }

  async updatePaymentStatus(orderId: number, paymentStatus: string) {
    const { data, error } = await this.supabase
      .from('orders')
      .update({ payment_status: paymentStatus, updated_at: new Date() })
      .eq('order_id', orderId)
      .select();
    return { data, error };
  }

  // ============ ORDER ITEMS ============
  async getOrderItems(orderId: number) {
    const { data, error } = await this.supabase
      .from('order_items')
      .select('*')
      .eq('order_id', orderId);
    return { data, error };
  }

  async createOrderItem(itemData: any) {
    const { data, error } = await this.supabase
      .from('order_items')
      .insert([itemData])
      .select();
    return { data, error };
  }
  // ============ ORDERS - ENHANCED ============

// Tạo order với đầy đủ thông tin
async createFullOrder(orderData: {
  customer_id: string;
  order_number: string;
  subtotal: number;
  discount_amount?: number;
  shipping_fee?: number;
  total_amount: number;
  payment_method?: string;
  shipping_address_id?: number;
  customer_note?: string;
  shipping_full_name?: string;
  shipping_phone?: string;
  shipping_address?: string;
  shipping_ward?: string;
  shipping_district?: string;
  shipping_city?: string;
}) {
  const { data, error } = await this.supabase
    .from('orders')
    .insert([{
      ...orderData,
      order_status: 'pending',
      payment_status: 'unpaid',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
    }])
    .select();
  return { data, error };
}

// Tạo order item với đầy đủ thông tin
async createFullOrderItem(itemData: {
  order_id: number;
  product_id: number;
  //variant_id?: number;
  product_name: string;
  variant_name?: string;
  sku: string;
  quantity: number;
  unit_price: number;
  discount_amount?: number;
  total_price: number;
  phone_model_id?: number | null;
  phone_model_name?: string | null;
}) {
  const { data, error } = await this.supabase
    .from('order_items')
    .insert([itemData])
    .select();
  return { data, error };
}

// Lấy order theo order_number
async getOrderByNumber(orderNumber: string) {
  const { data, error } = await this.supabase
    .from('orders')
    .select('*')
    .eq('order_number', orderNumber)
    .single();
  return { data, error };
}

// Lấy order với items
async getOrderWithItems(orderId: number) {
  const { data: order, error: orderError } = await this.supabase
    .from('orders')
    .select('*')
    .eq('order_id', orderId)
    .single();

  if (orderError) return { data: null, error: orderError };

  const { data: items, error: itemsError } = await this.supabase
    .from('order_items')
    .select(`
      *,
      products (
        product_id,
        product_name,
        product_slug,
        price,
        sale_price
      )
    `)
    .eq('order_id', orderId);

  if (itemsError) return { data: order, error: itemsError };

  return { 
    data: { ...order, items: items || [] }, 
    error: null 
  };
}

// Lấy order với items theo order_number
async getOrderWithItemsByNumber(orderNumber: string) {
  const { data: order, error: orderError } = await this.supabase
    .from('orders')
    .select('*')
    .eq('order_number', orderNumber)
    .single();

  if (orderError || !order) return { data: null, error: orderError };

  const { data: items, error: itemsError } = await this.supabase
    .from('order_items')
    .select(`
      *,
      products (
        product_id,
        product_name,
        product_slug
      )
    `)
    .eq('order_id', order.order_id);

  return { 
    data: { ...order, items: items || [] }, 
    error: itemsError 
  };
}

// ============ COLLECTIONS - ENHANCED ============

// Lấy tất cả collections (từ design_collections)
async getAllDesignCollections() {
  const { data, error } = await this.supabase
    .from('design_collections')
    .select('*')
    .eq('is_active', true)
    .order('display_order', { ascending: true });
  return { data, error };
}

// Lấy collection theo type
async getDesignCollectionsByType(type: string) {
  // type: 'normal' hoặc 'seasonal'
  const { data, error } = await this.supabase
    .from('design_collections')
    .select('*')
    .eq('is_active', true)
    .ilike('collection_name', type === 'seasonal' ? '%Noel%|%Valentine%|%Tết%' : '%')
    .order('display_order', { ascending: true });
  return { data, error };
}

// Lấy collection theo slug
async getDesignCollectionBySlug(slug: string) {
  const { data, error } = await this.supabase
    .from('design_collections')
    .select('*')
    .eq('collection_slug', slug)
    .eq('is_active', true)
    .single();
  return { data, error };
}

// Lấy sản phẩm trong collection
async getProductsByDesignCollection(collectionId: number) {
  const { data: pcData, error: pcError } = await this.supabase
    .from('product_collections')
    .select('product_id')
    .eq('collection_id', collectionId)
    .order('display_order', { ascending: true });

  if (pcError || !pcData || pcData.length === 0) {
    return { data: [], error: pcError };
  }

  const productIds = pcData.map(pc => pc.product_id);

  const { data: products, error: prodError } = await this.supabase
    .from('products')
    .select(`
      *,
      product_images (
        image_url,
        is_primary
      )
    `)
    .in('product_id', productIds)
    .eq('status', 'active');

  return { data: products || [], error: prodError };
}

// Đếm sản phẩm trong mỗi collection
async getDesignCollectionProductCounts() {
  const { data: collections, error: colError } = await this.supabase
    .from('design_collections')
    .select('collection_id, collection_name, collection_slug')
    .eq('is_active', true);

  if (colError) return { data: null, error: colError };

  const counts: Record<string, number> = {};
  
  for (const col of collections || []) {
    const { data: pcData } = await this.supabase
      .from('product_collections')
      .select('product_id', { count: 'exact' })
      .eq('collection_id', col.collection_id);
    
    counts[col.collection_slug] = pcData?.length || 0;
  }

  return { data: counts, error: null };
}
  // ============ PAYMENT TRANSACTIONS ============
  async createPaymentTransaction(transactionData: any) {
    const { data, error } = await this.supabase
      .from('payment_transactions')
      .insert([transactionData])
      .select();
    return { data, error };
  }

  async getPaymentTransactionsByOrder(orderId: number) {
    const { data, error } = await this.supabase
      .from('payment_transactions')
      .select('*')
      .eq('order_id', orderId);
    return { data, error };
  }

  // ============ INVENTORY ============
  async getInventory(productId: number) {
    const { data, error } = await this.supabase
      .from('inventory')
      .select('*')
      .eq('product_id', productId);
    return { data, error };
  }

  async updateInventory(inventoryId: number, updates: any) {
    const { data, error } = await this.supabase
      .from('inventory')
      .update(updates)
      .eq('inventory_id', inventoryId)
      .select();
    return { data, error };
  }

  // ============ CATEGORIES ============
  async getCategories() {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('is_active', true)
      .order('display_order', { ascending: true });
    return { data, error };
  }

  async getCategoriesWithProductCount() {
    // Lấy tất cả categories
    const { data: categories, error: catError } = await this.supabase
      .from('categories')
      .select('*')
      .eq('is_active', true)
      .order('display_order', { ascending: true });

    if (catError) return { data: null, error: catError };

    // Lấy tất cả sản phẩm (không lọc status để đếm hết)
    const { data: products, error: prodError } = await this.supabase
      .from('products')
      .select('category_id, status');

    if (prodError) return { data: categories, error: prodError };

    // Đếm số sản phẩm theo category_id (chấp nhận status: active, Active, hoặc không có status)
    const productCountMap: Record<number, number> = {};
    products?.forEach((p: any) => {
      if (p.category_id) {
        const status = (p.status || '').toLowerCase();
        // Đếm nếu status là active hoặc không có status
        if (status === 'active' || status === '' || !p.status) {
          productCountMap[p.category_id] = (productCountMap[p.category_id] || 0) + 1;
        }
      }
    });

    // Gắn số lượng sản phẩm vào từng category
    const categoriesWithCount = categories?.map((cat: any) => ({
      ...cat,
      product_count: productCountMap[cat.category_id] || 0
    }));

    return { data: categoriesWithCount, error: null };
  }

  async getCategoryById(categoryId: number) {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('category_id', categoryId)
      .single();
    return { data, error };
  }

  async getCategoryBySlug(slug: string) {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('category_slug', slug)
      .eq('is_active', true)
      .single();
    return { data, error };
  }

  async getRootCategories() {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .is('parent_category_id', null)
      .eq('is_active', true)
      .order('display_order', { ascending: true });
    return { data, error };
  }

  async getChildCategories(parentId: number) {
    const { data, error } = await this.supabase
      .from('categories')
      .select('*')
      .eq('parent_category_id', parentId)
      .eq('is_active', true)
      .order('display_order', { ascending: true });
    return { data, error };
  }

  async createCategory(categoryData: any) {
    const { data, error } = await this.supabase
      .from('categories')
      .insert([categoryData])
      .select();
    return { data, error };
  }

  async updateCategory(categoryId: number, categoryData: any) {
    const { data, error } = await this.supabase
      .from('categories')
      .update(categoryData)
      .eq('category_id', categoryId)
      .select();
    return { data, error };
  }

  // Soft delete - đổi is_active thành false thay vì xóa hẳn
  // Vì danh mục có thể đã có sản phẩm
  async deleteCategory(categoryId: number) {
    const { data, error } = await this.supabase
      .from('categories')
      .update({ is_active: false })
      .eq('category_id', categoryId)
      .select();
    return { data, error };
  }

  // ============ REVIEWS ============
  async getAllReviews(limit = 50) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);
    return { data, error };
  }

  async getProductReviews(productId: number) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .select('*')
      .eq('product_id', productId)
      .eq('is_approved', true)
      .order('created_at', { ascending: false });
    return { data, error };
  }

  async getReviewById(reviewId: number) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .select('*')
      .eq('review_id', reviewId)
      .single();
    return { data, error };
  }

  async createReview(reviewData: any) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .insert([reviewData])
      .select();
    return { data, error };
  }

  async updateReview(reviewId: number, reviewData: any) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .update(reviewData)
      .eq('review_id', reviewId)
      .select();
    return { data, error };
  }

  async deleteReview(reviewId: number) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .delete()
      .eq('review_id', reviewId);
    return { data, error };
  }

  async approveReview(reviewId: number, isApproved: boolean) {
    const { data, error } = await this.supabase
      .from('product_reviews')
      .update({ is_approved: isApproved })
      .eq('review_id', reviewId)
      .select();
    return { data, error };
  }

  // ============ WISHLIST ============
  async getWishlist(customerId: number) {
    const { data, error } = await this.supabase
      .from('wishlists')
      .select('*')
      .eq('customer_id', customerId);
    return { data, error };
  }

  async addToWishlist(customerId: number, productId: number, variantId?: number) {
    const { data, error } = await this.supabase
      .from('wishlists')
      .insert([{ customer_id: customerId, product_id: productId, variant_id: variantId || null }])
      .select();
    return { data, error };
  }

  async removeFromWishlist(customerId: number, productId: number) {
    const { error } = await this.supabase
      .from('wishlists')
      .delete()
      .eq('customer_id', customerId)
      .eq('product_id', productId);
    return { error };
  }

  // ============ COUPONS ============
  async getCoupon(couponCode: string) {
    const { data, error } = await this.supabase
      .from('coupons')
      .select('*')
      .eq('coupon_code', couponCode)
      .eq('is_active', true)
      .single();
    return { data, error };
  }

  // ============ GENERIC QUERY (for any table) ============
  async query(tableName: string, filters?: any, limit?: number) {
    let query = this.supabase.from(tableName).select('*');
    
    if (filters) {
      Object.keys(filters).forEach(key => {
        query = query.eq(key, filters[key]);
      });
    }

    if (limit) {
      query = query.limit(limit);
    }

    const { data, error } = await query;
    return { data, error };
  }

  // ============ CONTACT MESSAGES ============
  async getAllContactMessages(limit = 50) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit);
    return { data, error };
  }

  async getContactMessageById(id: number) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .select('*')
      .eq('id', id)
      .single();
    return { data, error };
  }

  async createContactMessage(messageData: any) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .insert([messageData])
      .select();
    return { data, error };
  }

  async updateContactMessageStatus(id: number, status: string) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .update({ status, updated_at: new Date().toISOString() })
      .eq('id', id)
      .select();
    return { data, error };
  }

  async deleteContactMessage(id: number) {
    const { data, error } = await this.supabase
      .from('contact_messages')
      .delete()
      .eq('id', id);
    return { data, error };
  }
    // ============ SHOPPING CART ============
  // async createProduct(productData: any) {
  //   const { data, error } = await this.supabase
  //     .from('products')
  //     .insert([productData])
  //     .select();
  //   return { data, error };
  // }
  // CREATE: thêm sản phẩm vào giỏ
  // async createShoppingCart(cartData: any) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .insert([cartData])
  //     .select();
  //     // .single();

  //   return { data, error };
  // }

  // // READ: lấy giỏ hàng theo customer
  // // async getShoppingCart(customerId: number) {
  // //   const { data, error } = await this.supabase
  // //     .from('shopping_carts')
  // //     .select('*')
  // //     .eq('customer_id', customerId)
  // //     .order('created_at', { ascending: false });

  // //   return { data, error };
  // // }

  // // UPDATE: cập nhật số lượng
  // async updateShoppingCart(
  //   cartId: number,
  //   quantity: number,
  // ) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .update({
  //       quantity,
  //       updated_at: new Date().toISOString(),
  //     })
  //     .eq('cart_id', cartId)
  //     .select()
  //     .single();

  //   return { data, error };
  // }

  // // DELETE: xóa sản phẩm khỏi giỏ
  // async deleteShoppingCart(cartId: number) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .delete()
  //     .eq('cart_id', cartId);

  //   return { data, error };
  // }
  // async getCartItemByUserAndProduct(
  //   userId: string,
  //   productId: number,
  // ) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .select('*')
  //     .eq('customer_id', userId)
  //     .eq('product_id', productId)
  //     .single();

  //   return { data, error };
  // }
  // async getCartItemById(cartId: string) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .select('*')
  //     .eq('cart_id', cartId)
  //     .single();

  //   return { data, error };
  // }
  // async getShoppingCart(customerId: string) {
  //   const { data, error } = await this.supabase
  //     .from('shopping_carts')
  //     .select('*')
  //     .eq('customer_id', customerId)
  //     .order('created_at', { ascending: false });

  //   return { data, error };
  // }
  // ============ SHOPPING CART (CẬP NHẬT) ============

/**
 * Lấy giỏ hàng theo user_id (UUID) - JOIN với products và product_images
 */
async getShoppingCartByUserId(userId: string) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .select(`
      cart_id,
      customer_id,
      product_id,
      variant_id,
      quantity,
      created_at,
      updated_at,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        status,
        product_images (
          image_url,
          is_primary
        )
      )
    `)
    .eq('customer_id', userId)
    .order('created_at', { ascending: false });

  return { data, error };
}

/**
 * Kiểm tra sản phẩm đã có trong giỏ chưa (có thể check theo phone_model_id)
 */
async getCartItemByUserAndProduct(userId: string, productId: number, phoneModelId?: number) {
  let query = this.supabase
    .from('shopping_carts')
    .select('*')
    .eq('customer_id', userId)
    .eq('product_id', productId);
    
  // Nếu có phoneModelId, check cả phone model
  if (phoneModelId) {
    query = query.eq('phone_model_id', phoneModelId);
  } else {
    query = query.is('phone_model_id', null);
  }

  const { data, error } = await query.maybeSingle();  // Dùng maybeSingle thay vì single để tránh lỗi khi không có data

  return { data, error };
}

/**
 * Thêm sản phẩm vào giỏ
 */
/**
 * Map từ users.id (UUID) sang customers.customer_id (INTEGER)
 * Vì 2 bảng liên kết qua email
 */
async createShoppingCartItem(cartData: {
  customer_id: string;  // UUID từ users.id
  product_id: number;
  variant_id?: number | null;
  phone_model_id?: number | null;
  phone_model_name?: string | null;
  quantity: number;
}) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .insert([{
      customer_id: cartData.customer_id,  // ✅ UUID trực tiếp, không cần map
      product_id: cartData.product_id,
      variant_id: cartData.variant_id || null,
      phone_model_id: cartData.phone_model_id || null,
      phone_model_name: cartData.phone_model_name || null,
      quantity: cartData.quantity,
    }])
    .select(`*`)
    .single();

  return { data, error };
}

/**
 * Cập nhật số lượng
 */
async updateShoppingCartQuantity(cartId: number, quantity: number) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .update({
      quantity,
      updated_at: new Date().toISOString(),
    })
    .eq('cart_id', cartId)
    .select(`
      cart_id,
      customer_id,
      product_id,
      quantity,
      products (
        product_id,
        product_name,
        price,
        sale_price
      )
    `)
    .single();

  return { data, error };
}

/**
 * Xóa item khỏi giỏ
 */
async deleteShoppingCartItem(cartId: number) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .delete()
    .eq('cart_id', cartId);

  return { data, error };
}

/**
 * Xóa toàn bộ giỏ hàng của user
 */
async clearShoppingCart(userId: string) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .delete()
    .eq('customer_id', userId);

  return { data, error };
}

/**
 * Lấy cart item theo ID (để verify ownership)
 */
async getCartItemById(cartId: number) {
  const { data, error } = await this.supabase
    .from('shopping_carts')
    .select('*')
    .eq('cart_id', cartId)
    .single();

  return { data, error };
}

// ============ WISHLIST ============

/**
 * Lấy danh sách yêu thích của user (dùng user_id UUID)
 */
async getWishlistByUserId(userId: string) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .select(`
      wishlist_id,
      product_id,
      created_at,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        image_url,
        description
      )
    `)
    .eq('user_id', userId)
    .order('created_at', { ascending: false });

  return { data, error };
}

/**
 * Lấy danh sách product_id trong wishlist của user
 */
async getWishlistProductIds(userId: string) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .select('product_id')
    .eq('user_id', userId);

  return { data, error };
}

/**
 * Thêm sản phẩm vào wishlist (user_id dạng UUID)
 */
async addProductToWishlist(userId: string, productId: number) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .insert({
      user_id: userId,
      product_id: productId,
    })
    .select()
    .single();

  return { data, error };
}

/**
 * Xóa sản phẩm khỏi wishlist (user_id dạng UUID)
 */
async removeProductFromWishlist(userId: string, productId: number) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .delete()
    .eq('user_id', userId)
    .eq('product_id', productId);

  return { data, error };
}

/**
 * Kiểm tra sản phẩm có trong wishlist không
 */
async getWishlistItem(userId: string, productId: number) {
  const { data, error } = await this.supabase
    .from('wishlists')
    .select('wishlist_id')
    .eq('user_id', userId)
    .eq('product_id', productId)
    .single();

  return { data, error };
}

// ============ GIFTS ============

/**
 * Tạo quà tặng mới
 */
async createGift(giftData: {
  sender_id?: string;
  sender_name: string;
  sender_email: string;
  sender_message?: string;
  recipient_name: string;
  recipient_email: string;
  recipient_phone?: string;
  recipient_address?: string;
  product_id: number;
  quantity: number;
  verification_code: string;
}) {
  const { data, error } = await this.supabase
    .from('gifts')
    .insert(giftData)
    .select()
    .single();
  return { data, error };
}

/**
 * Lấy thông tin quà tặng theo ID
 */
async getGiftById(giftId: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      *,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        image_url,
        product_images (
          image_url,
          is_primary
        )
      )
    `)
    .eq('gift_id', giftId)
    .single();
  return { data, error };
}

/**
 * Lấy thông tin quà tặng công khai (không có verification_code)
 */
async getGiftPublicInfo(giftId: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      gift_id,
      sender_name,
      sender_message,
      recipient_name,
      recipient_email,
      status,
      created_at,
      expires_at,
      products (
        product_id,
        product_name,
        price,
        sale_price,
        image_url,
        product_images (
          image_url,
          is_primary
        )
      )
    `)
    .eq('gift_id', giftId)
    .single();
  return { data, error };
}

/**
 * Cập nhật trạng thái quà tặng
 */
async updateGiftStatus(giftId: string, status: string, extraData?: any) {
  const updateData: any = { status, ...extraData };
  
  if (status === 'verified') {
    updateData.verified_at = new Date().toISOString();
  } else if (status === 'claimed') {
    updateData.claimed_at = new Date().toISOString();
  }

  const { data, error } = await this.supabase
    .from('gifts')
    .update(updateData)
    .eq('gift_id', giftId)
    .select()
    .single();
  return { data, error };
}

/**
 * Lưu lịch sử email quà tặng
 */
async createGiftEmail(emailData: {
  gift_id: string;
  email_type: string;
  sent_to: string;
  status?: string;
}) {
  const { data, error } = await this.supabase
    .from('gift_emails')
    .insert(emailData)
    .select()
    .single();
  return { data, error };
}

/**
 * Lấy danh sách quà đã gửi theo user
 */
async getSentGifts(userId: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      *,
      products (
        product_name,
        price,
        sale_price,
        image_url,
        product_images (image_url, is_primary)
      )
    `)
    .eq('sender_id', userId)
    .order('created_at', { ascending: false });
  return { data, error };
}

/**
 * Lấy danh sách quà đã nhận theo email
 */
async getReceivedGifts(email: string) {
  const { data, error } = await this.supabase
    .from('gifts')
    .select(`
      *,
      products (
        product_name,
        price,
        sale_price,
        image_url,
        product_images (image_url, is_primary)
      )
    `)
    .eq('recipient_email', email)
    .order('created_at', { ascending: false });
  return { data, error };
}

// ============ PHONE TEMPLATES ============

/**
 * Lấy danh sách phone templates
 */
async getPhoneTemplates() {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .select('*')
    .eq('is_active', true)
    .order('brand', { ascending: true });
  return { data, error };
}

/**
 * Lấy phone template theo ID
 */
async getPhoneTemplateById(templateId: number) {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .select('*')
    .eq('template_id', templateId)
    .single();
  return { data, error };
}

/**
 * Tạo phone template mới
 */
async createPhoneTemplate(templateData: any) {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .insert(templateData)
    .select()
    .single();
  return { data, error };
}

/**
 * Cập nhật phone template
 */
async updatePhoneTemplate(templateId: number, templateData: any) {
  const { data, error } = await this.supabase
    .from('phone_templates')
    .update(templateData)
    .eq('template_id', templateId)
    .select()
    .single();
  return { data, error };
}

/**
 * Xóa phone template
 */
async deletePhoneTemplate(templateId: number) {
  const { error } = await this.supabase
    .from('phone_templates')
    .delete()
    .eq('template_id', templateId);
  return { error };
}

// ============ CUSTOM DESIGNS ============

/**
 * Tạo thiết kế mới
 */
async createDesign(designData: any) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .insert(designData)
    .select()
    .single();
  return { data, error };
}

/**
 * Lấy thiết kế theo ID
 */
async getDesignById(designId: number) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .select(`
      *,
      phone_templates (
        phone_model,
        brand,
        template_image_url
      )
    `)
    .eq('design_id', designId)
    .single();
  return { data, error };
}

/**
 * Cập nhật thiết kế
 */
async updateDesign(designId: number, updateData: any) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .update(updateData)
    .eq('design_id', designId)
    .select()
    .single();
  return { data, error };
}

/**
 * Lấy danh sách thiết kế của user
 */
async getUserDesigns(userId: string) {
  const { data, error } = await this.supabase
    .from('custom_designs')
    .select(`
      *,
      phone_templates (
        phone_model,
        brand,
        template_image_url
      )
    `)
    .eq('user_id', userId)
    .order('created_at', { ascending: false });
  return { data, error };
}

/**
 * Lấy tất cả thiết kế (admin)
 */
async getAllDesigns(status?: string) {
  let query = this.supabase
    .from('custom_designs')
    .select(`
      *,
      phone_templates (
        phone_model,
        brand,
        template_image_url
      ),
      users (
        full_name,
        email,
        phone
      )
    `)
    .order('submitted_at', { ascending: false, nullsFirst: false });

  if (status) {
    query = query.eq('status', status);
  }

  const { data, error } = await query;
  return { data, error };
}

/**
 * Xóa thiết kế
 */
async deleteDesign(designId: number) {
  const { error } = await this.supabase
    .from('custom_designs')
    .delete()
    .eq('design_id', designId);
  return { error };
}

/**
 * Lưu ảnh thiết kế
 */
async createDesignImage(imageData: any) {
  const { data, error } = await this.supabase
    .from('design_images')
    .insert(imageData)
    .select()
    .single();
  return { data, error };
}

/**
 * Lấy danh sách ảnh của thiết kế
 */
async getDesignImages(designId: number) {
  const { data, error } = await this.supabase
    .from('design_images')
    .select('*')
    .eq('design_id', designId)
    .order('created_at', { ascending: true });
  return { data, error };
}

}




################################################################################
## FILE 15: main.ts
## Path: backend/src/main.ts
################################################################################

import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { json, urlencoded } from 'express';
import { NestExpressApplication } from '@nestjs/platform-express';
import { join } from 'path';

async function bootstrap() {
  const app = await NestFactory.create<NestExpressApplication>(AppModule);

  // Tăng giới hạn body size để upload ảnh base64
  app.use(json({ limit: '50mb' }));
  app.use(urlencoded({ extended: true, limit: '50mb' }));

  // Serve static files từ thư mục uploads
  app.useStaticAssets(join(process.cwd(), 'uploads'), {
    prefix: '/uploads/',
  });

  app.enableCors({
    origin: 'http://localhost:3000',
    credentials: true,
  });

  await app.listen(process.env.PORT ?? 3001);
}
bootstrap();




################################################################################
## FILE 16: app.service.ts
## Path: backend/src/app.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from './supabase.service';

@Injectable()
export class AppService {
  constructor(private readonly supabaseService: SupabaseService) {}

  getHello(): string {
    return 'Hello World!';
  }

  // Tổng hợp số liệu dashboard admin
  async getAdminDashboard() {
    // Tổng doanh thu
    const ordersRes = await this.supabaseService.getOrders(1000);
    const orders = ordersRes.data || [];
    const totalRevenue = orders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
    // Số đơn hàng
    const orderCount = orders.length;
    // Số sản phẩm
    const productsRes = await this.supabaseService.getProducts(1000);
    const products = productsRes.data || [];
    const productCount = products.length;
    // Số khách hàng
    const customersRes = await this.supabaseService.getCustomers();
    const customers = customersRes.data || [];
    const customerCount = customers.length;
    // Doanh thu 7 ngày qua
    const now = new Date();
    const revenue7Days = Array(7).fill(0);
    for (const o of orders) {
      if (o.created_at) {
        const d = new Date(o.created_at);
        const diff = Math.floor((now.getTime() - d.getTime()) / (1000*60*60*24));
        if (diff >= 0 && diff < 7) {
          revenue7Days[6-diff] += o.total_amount || 0;
        }
      }
    }
    // Top sản phẩm bán chạy
    const productSales: Record<string, {name: string, sold: number, revenue: number}> = {};
    for (const o of orders) {
      if (Array.isArray(o.products)) {
        for (const p of o.products) {
          const key = String(p.id);
          if (!productSales[key]) {
            const prod = products.find(pr => pr.id == p.id) || {};
            productSales[key] = { name: prod.name || '', sold: 0, revenue: 0 };
          }
          productSales[key].sold += p.quantity || 0;
          productSales[key].revenue += (p.quantity || 0) * (p.price || 0);
        }
      }
    }
    const bestSellers = Object.entries(productSales)
      .sort((a,b) => b[1].sold - a[1].sold)
      .slice(0,5)
      .map(([id, info]) => ({ id, ...info }));

    return {
      totalRevenue,
      orderCount,
      productCount,
      customerCount,
      revenue7Days,
      bestSellers
    };
  }
}




################################################################################
## FILE 17: app.module.ts
## Path: backend/src/app.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { ServeStaticModule } from '@nestjs/serve-static';
import { join } from 'path';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PaymentController } from './payment/payment.controller';
import { SupabaseService } from './supabase.service';
import { AuthModule } from './auth/auth.module';
import { ProductModule } from './product/product.module';
import { OrderModule } from './order/order.module';
import { CategoryModule } from './category/category.module';
import { UsersModule } from './users/users.module';
import { ReviewModule } from './review/review.module';
import { ContactModule } from './contact/contact.module';
import { CollectionModule } from './collection/collection.module';
import { ShoppingCartModule } from './shopping-cart/shopping-cart.module';
import { WishlistModule } from './wishlist/wishlist.module';
import { GiftModule } from './gift/gift.module';
import { DesignModule } from './design/design.module';
import { MessengerModule } from './messenger/messenger.module';
import { PhoneModelModule } from './phone-model/phone-model.module';

@Module({
  imports: [
    ConfigModule.forRoot(),
    ServeStaticModule.forRoot({
      rootPath: join(__dirname, '..', 'uploads'),
      serveRoot: '/uploads',
    }),
    AuthModule,
    ProductModule,
    OrderModule,
    CategoryModule,
    UsersModule,
    ReviewModule,
    ContactModule,
    CollectionModule,
    ShoppingCartModule,
    WishlistModule,
    GiftModule,
    DesignModule,
    MessengerModule,
    PhoneModelModule,
  ],
  controllers: [AppController, PaymentController],
  providers: [AppService, SupabaseService],
})
export class AppModule {}




################################################################################
## FILE 18: app.controller.ts
## Path: backend/src/app.controller.ts
################################################################################

import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }

  // API tổng hợp số liệu dashboard admin
  @Get('admin/dashboard')
  async getAdminDashboard() {
    return await this.appService.getAdminDashboard();
  }
}




################################################################################
## FILE 19: app.controller.spec.ts
## Path: backend/src/app.controller.spec.ts
################################################################################

import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});




################################################################################
## FILE 20: supabase.strategy.ts
## Path: backend/src/auth/supabase.strategy.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class SupabaseStrategy extends PassportStrategy(Strategy, 'jwt') {
  constructor(private readonly configService: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      ignoreExpiration: false,
      secretOrKey: configService.get<string>('SUPABASE_JWT_SECRET')!,
    });
  }

  async validate(payload: any) {
    // Trả về object user với role mặc định là customer nếu chưa có
    return { 
      userId: payload.sub, 
      email: payload.email,
      role: payload.user_metadata?.role || 'customer',
    };
  }
}



################################################################################
## FILE 21: auth.service.ts
## Path: backend/src/auth/auth.service.ts
################################################################################

import { 
  Injectable, 
  UnauthorizedException, 
  BadRequestException, 
  Logger,
  ConflictException 
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import * as bcrypt from 'bcrypt';
import { UserRole } from '../common';
import type { AuthenticatedUser } from '../common';
import { JwtService } from '@nestjs/jwt';

@Injectable()
export class AuthService {
  private readonly logger = new Logger(AuthService.name);
  private supabase: SupabaseClient;
  private readonly SALT_ROUNDS = 10;

  constructor(
    private configService: ConfigService,
    private jwtService: JwtService,
  ) {
    this.supabase = createClient(
      this.configService.get<string>('SUPABASE_URL')!,
      this.configService.get<string>('SUPABASE_SERVICE_ROLE_KEY')!,
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // ĐĂNG KÝ TÀI KHOẢN MỚI
  // ═══════════════════════════════════════════════════════════════════════════
  
  async register(userData: {
    email: string;
    password: string;
    full_name: string;
    phone?: string;
  }) {
    try {
      const { email, password, full_name, phone } = userData;

      // 1. Validate input
      if (!email || !password || !full_name) {
        throw new BadRequestException('Email, password và họ tên là bắt buộc');
      }

      if (password.length < 6) {
        throw new BadRequestException('Mật khẩu phải có ít nhất 6 ký tự');
      }

      // 2. Kiểm tra email đã tồn tại chưa
      const { data: existingUser, error: checkError } = await this.supabase
        .from('users')
        .select('id')
        .eq('email', email.toLowerCase().trim())
        .single();

      if (existingUser) {
        throw new ConflictException('Email đã được sử dụng');
      }

      // 3. Hash password với bcrypt
      const hashedPassword = await bcrypt.hash(password, this.SALT_ROUNDS);

      // 4. Tạo user mới trong bảng users
      const { data: newUser, error: insertError } = await this.supabase
        .from('users')
        .insert({
          email: email.toLowerCase().trim(),
          password_hash: hashedPassword,
          full_name: full_name.trim(),
          phone: phone?.trim() || null,
          role: 'customer',
          status: 'active',
          email_verified: false,
          is_admin: false,
        })
        .select()
        .single();

      if (insertError) {
        this.logger.error(`Register insert error: ${insertError.message}`);
        throw new BadRequestException(`Không thể tạo tài khoản: ${insertError.message}`);
      }

      this.logger.log(`User registered successfully: ${email}`);

      return {
        success: true,
        message: 'Đăng ký thành công! Bạn có thể đăng nhập ngay.',
        user: {
          id: newUser.id,
          email: newUser.email,
          full_name: newUser.full_name,
          phone: newUser.phone,
          role: newUser.role,
          created_at: newUser.created_at,
        },
      };

    } catch (error: any) {
      this.logger.error(`Register error: ${error.message}`);
      
      if (error instanceof BadRequestException || error instanceof ConflictException) {
        throw error;
      }
      
      throw new BadRequestException(error.message || 'Đăng ký thất bại');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // ĐĂNG NHẬP
  // ═══════════════════════════════════════════════════════════════════════════

  async login(email: string, password: string) {
    try {
      // 1. Validate input
      if (!email || !password) {
        throw new BadRequestException('Email và mật khẩu là bắt buộc');
      }

      // 2. Tìm user theo email
      const { data: userData, error: dbError } = await this.supabase
        .from('users')
        .select('*')
        .eq('email', email.toLowerCase().trim())
        .single();

      if (dbError || !userData) {
        this.logger.warn(`Login failed: User not found - ${email}`);
        throw new UnauthorizedException('Email hoặc mật khẩu không đúng');
      }

      // 3. Kiểm tra status
      if (userData.status !== 'active') {
        throw new UnauthorizedException('Tài khoản đã bị khóa');
      }

      // 4. So sánh password với bcrypt
      const isPasswordValid = await bcrypt.compare(password, userData.password_hash);

      if (!isPasswordValid) {
        this.logger.warn(`Login failed: Wrong password - ${email}`);
        throw new UnauthorizedException('Email hoặc mật khẩu không đúng');
      }

      // 5. Tạo JWT payload
      const payload = {
        sub: userData.id,              // userId
        email: userData.email,
        role: userData.is_admin ? 'admin' : userData.role,
      };

      // 6. Sign JWT
      const access_token = this.jwtService.sign(payload);

      // 7. Cập nhật last_login_at
      await this.supabase
        .from('users')
        .update({ last_login_at: new Date().toISOString() })
        .eq('id', userData.id);

      this.logger.log(`User logged in successfully: ${email}`);

      // 8. Trả về thông tin user (không có password)
      return {
        success: true,
        message: 'Đăng nhập thành công',
        access_token,
        user: {
          id: userData.id,
          email: userData.email,
          full_name: userData.full_name,
          phone: userData.phone,
          avatar_url: userData.avatar_url,
          address: userData.address,
          role: userData.role,
          is_admin: userData.is_admin,
          created_at: userData.created_at,
        },
        role: userData.is_admin ? 'admin' : userData.role,
      };

    } catch (error: any) {
      this.logger.error(`Login error: ${error.message}`);
      
      if (error instanceof UnauthorizedException || error instanceof BadRequestException) {
        throw error;
      }
      
      throw new UnauthorizedException('Đăng nhập thất bại');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // VALIDATE TOKEN (SỬA ĐỂ DÙNG CUSTOM JWT)
  // ═══════════════════════════════════════════════════════════════════════════

  async validateToken(token: string): Promise<AuthenticatedUser> {
    try {
      // 🔧 SỬA: Verify Custom JWT thay vì dùng Supabase Auth
      let payload: any;
      
      try {
        payload = this.jwtService.verify(token);
      } catch (jwtError: any) {
        this.logger.error(`JWT verify error: ${jwtError.message}`);
        throw new UnauthorizedException('Token không hợp lệ hoặc đã hết hạn');
      }

      // Kiểm tra payload có đủ thông tin không
      if (!payload.sub || !payload.email) {
        throw new UnauthorizedException('Token không chứa đủ thông tin');
      }

      // Lấy thông tin user từ bảng users để đảm bảo user còn tồn tại và active
      const { data: userData, error: dbError } = await this.supabase
        .from('users')
        .select('*')
        .eq('id', payload.sub)
        .single();

      if (dbError || !userData) {
        this.logger.error(`User not found for token: ${payload.sub}`);
        throw new UnauthorizedException('Không tìm thấy thông tin user');
      }

      // Kiểm tra user còn active không
      if (userData.status !== 'active') {
        throw new UnauthorizedException('Tài khoản đã bị khóa');
      }

      return {
        id: userData.id,
        email: userData.email,
        fullName: userData.full_name,
        phone: userData.phone,
        role: userData.is_admin ? UserRole.ADMIN : UserRole.CUSTOMER,
        createdAt: new Date(userData.created_at),
      };

    } catch (error: any) {
      this.logger.error(`Token validation error: ${error.message}`);
      
      if (error instanceof UnauthorizedException) {
        throw error;
      }
      
      throw new UnauthorizedException('Token không hợp lệ');
    }
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // HELPER METHODS
  // ═══════════════════════════════════════════════════════════════════════════

  async getUserById(userId: string) {
    const { data, error } = await this.supabase
      .from('users')
      .select('*')
      .eq('id', userId)
      .single();

    if (error || !data) {
      return null;
    }

    return data;
  }

  async changePassword(userId: string, oldPassword: string, newPassword: string) {
    try {
      // 1. Lấy user hiện tại
      const user = await this.getUserById(userId);
      if (!user) {
        throw new BadRequestException('Không tìm thấy user');
      }

      // 2. Verify old password
      const isOldPasswordValid = await bcrypt.compare(oldPassword, user.password_hash);
      if (!isOldPasswordValid) {
        throw new BadRequestException('Mật khẩu cũ không đúng');
      }

      // 3. Hash new password
      const hashedNewPassword = await bcrypt.hash(newPassword, this.SALT_ROUNDS);

      // 4. Update password
      const { error } = await this.supabase
        .from('users')
        .update({ 
          password_hash: hashedNewPassword,
          updated_at: new Date().toISOString()
        })
        .eq('id', userId);

      if (error) {
        throw new BadRequestException('Không thể đổi mật khẩu');
      }

      return { success: true, message: 'Đổi mật khẩu thành công' };

    } catch (error: any) {
      throw new BadRequestException(error.message || 'Đổi mật khẩu thất bại');
    }
  }
}



################################################################################
## FILE 22: auth.module.ts
## Path: backend/src/auth/auth.module.ts
################################################################################

// import { Module } from '@nestjs/common';
// import { PassportModule } from '@nestjs/passport';
// import { ConfigModule } from '@nestjs/config';
// import { AuthController } from './auth.controller';
// import { AuthService } from './auth.service';
// import { SupabaseService } from '../supabase.service';

// @Module({
//   imports: [PassportModule, ConfigModule],
//   controllers: [AuthController],
//   providers: [AuthService, SupabaseService],
//   exports: [AuthService],
// })
// export class AuthModule {}
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { ConfigModule , ConfigService } from '@nestjs/config';

import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { JwtAuthGuard, RolesGuard, CustomerGuard } from './guards';

@Module({
  imports: [ConfigModule,PassportModule,JwtModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        secret: config.get('JWT_SECRET') || 'jwt-secret-key',
        signOptions: { expiresIn: '7d' },
      }),
    }),
  ],
  controllers: [AuthController],
  providers: [
    AuthService,
    JwtAuthGuard,
    RolesGuard,
    CustomerGuard,
    
  ],
  exports: [
    AuthService,
    JwtAuthGuard,
    RolesGuard,
    CustomerGuard,
  ],
})
export class AuthModule {}



################################################################################
## FILE 23: auth.controller.ts
## Path: backend/src/auth/auth.controller.ts
################################################################################



import {
  Controller,
  Get,
  Post,
  Put,
  Body,
  Headers,
  UseGuards,
  UnauthorizedException,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { AuthService } from './auth.service';
import { JwtAuthGuard, CustomerGuard, RolesGuard } from './guards';
import { Roles, CurrentUser, CustomerOnly } from './decorators';
import { UserRole } from '../common';
import type { AuthenticatedUser } from '../common';

// DTOs
class RegisterDto {
  email: string;
  password: string;
  full_name: string;
  phone?: string;
}

class LoginDto {
  email: string;
  password: string;
}

class ChangePasswordDto {
  oldPassword: string;
  newPassword: string;
}

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  // ═══════════════════════════════════════════════════════════════════════════
  // PUBLIC ENDPOINTS (không cần authentication)
  // ═══════════════════════════════════════════════════════════════════════════

  /**
   * POST /auth/register - Đăng ký tài khoản mới
   */
  @Post('register')
  @HttpCode(HttpStatus.CREATED)
  async register(@Body() body: RegisterDto) {
    return await this.authService.register(body);
  }

  /**
   * POST /auth/login - Đăng nhập
   */
  @Post('login')
  @HttpCode(HttpStatus.OK)
  async login(@Body() body: LoginDto) {
    return await this.authService.login(body.email, body.password);
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // PROTECTED ENDPOINTS (cần authentication)
  // ═══════════════════════════════════════════════════════════════════════════

  /**
   * GET /auth/me - Lấy thông tin user hiện tại
   * Yêu cầu: Đã đăng nhập
   */
  @Get('me')
  @UseGuards(JwtAuthGuard)
  async getCurrentUser(@CurrentUser() user: AuthenticatedUser) {
    return {
      success: true,
      data: {
        id: user.id,
        email: user.email,
        fullName: user.fullName,
        phone: user.phone,
        role: user.role,
      },
    };
  }

  /**
   * POST /auth/validate - Validate token và trả về user info
   * Dùng cho frontend để kiểm tra token còn hợp lệ không
   */
  @Post('validate')
  @HttpCode(HttpStatus.OK)
  async validateToken(@Headers('authorization') authHeader: string) {
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      throw new UnauthorizedException('Token không hợp lệ');
    }

    const token = authHeader.substring(7);
    const user = await this.authService.validateToken(token);

    return {
      valid: true,
      user: {
        id: user.id,
        email: user.email,
        fullName: user.fullName,
        role: user.role,
      },
    };
  }

  /**
   * PUT /auth/change-password - Đổi mật khẩu
   * Yêu cầu: Đã đăng nhập
   */
  @Put('change-password')
  @UseGuards(JwtAuthGuard)
  @HttpCode(HttpStatus.OK)
  async changePassword(
    @CurrentUser('id') userId: string,
    @Body() body: ChangePasswordDto,
  ) {
    return await this.authService.changePassword(
      userId,
      body.oldPassword,
      body.newPassword,
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // TEST ENDPOINTS
  // ═══════════════════════════════════════════════════════════════════════════

  /**
   * GET /auth/customer-only-test - Test endpoint chỉ cho customer
   */
  @Get('customer-only-test')
  @CustomerOnly()
  async customerOnlyTest(@CurrentUser() user: AuthenticatedUser) {
    return {
      success: true,
      message: '✅ Bạn đang truy cập với vai trò CUSTOMER',
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
      },
    };
  }

  /**
   * GET /auth/admin-only-test - Test endpoint chỉ cho admin
   */
  @Get('admin-only-test')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  async adminOnlyTest(@CurrentUser() user: AuthenticatedUser) {
    return {
      success: true,
      message: '✅ Bạn đang truy cập với vai trò ADMIN',
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
      },
    };
  }
}



################################################################################
## FILE 24: roles.decorator.ts
## Path: backend/src/auth/decorators/roles.decorator.ts
################################################################################

// import { SetMetadata } from '@nestjs/common';
// export const ROLES_KEY = 'roles';
// export const Roles = (...roles: string[]) =>
//   SetMetadata(ROLES_KEY, roles);
import { SetMetadata } from '@nestjs/common';
import { UserRole } from '../../common';

export const ROLES_KEY = 'roles';

/**
 * Decorator để chỉ định roles được phép truy cập
 * Sử dụng: @Roles(UserRole.ADMIN) hoặc @Roles(UserRole.CUSTOMER, UserRole.ADMIN)
 */
export const Roles = (...roles: UserRole[]) => SetMetadata(ROLES_KEY, roles);



################################################################################
## FILE 25: index.ts
## Path: backend/src/auth/decorators/index.ts
################################################################################

export * from './roles.decorator';
export * from './customer-only.decorator';
export * from './current-user.decorator';




################################################################################
## FILE 26: customer-only.decorator.ts
## Path: backend/src/auth/decorators/customer-only.decorator.ts
################################################################################

import { applyDecorators, UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from '../guards/jwt-auth.guard';
import { CustomerGuard } from '../guards/customer.guard';

/**
 * Decorator kết hợp để bảo vệ endpoint chỉ cho CUSTOMER
 * Sử dụng: @CustomerOnly() thay vì @UseGuards(JwtAuthGuard, CustomerGuard)
 */
export function CustomerOnly() {
  return applyDecorators(
    UseGuards(JwtAuthGuard, CustomerGuard)
  );
}



################################################################################
## FILE 27: current-user.decorator.ts
## Path: backend/src/auth/decorators/current-user.decorator.ts
################################################################################

import { createParamDecorator, ExecutionContext } from '@nestjs/common';
import { AuthenticatedUser } from '../../common';

/**
 * Decorator để lấy user hiện tại từ request
 * 
 * Sử dụng:
 * - @CurrentUser() user: AuthenticatedUser  -> Lấy toàn bộ user
 * - @CurrentUser('id') userId: string       -> Chỉ lấy id
 * - @CurrentUser('role') role: UserRole     -> Chỉ lấy role
 */
export const CurrentUser = createParamDecorator(
  (data: keyof AuthenticatedUser | undefined, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    const user = request.user as AuthenticatedUser;

    if (!user) return null;

    return data ? user[data] : user;
  },
);
        



################################################################################
## FILE 28: roles.guard.ts
## Path: backend/src/auth/guards/roles.guard.ts
################################################################################

// import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
// import { Reflector } from '@nestjs/core';
// import { ROLES_KEY } from '../decorators/roles.decorator';

// @Injectable()
// export class RolesGuard implements CanActivate {
//   constructor(private reflector: Reflector) {}

//   canActivate(context: ExecutionContext): boolean {
//     const requiredRoles =
//       this.reflector.getAllAndOverride<string[]>(ROLES_KEY, [
//         context.getHandler(),
//         context.getClass(),
//       ]);

//     // Không yêu cầu role → cho phép
//     if (!requiredRoles || requiredRoles.length === 0) {
//       return true;
//     }

//     const { user } = context.switchToHttp().getRequest();

//     return requiredRoles.some(
//       (role) => user?.role === role
//     );
//   }
// }
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { UserRole } from '../../common';
import { ROLES_KEY } from '../decorators/roles.decorator';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // Lấy danh sách roles được phép từ decorator
    const requiredRoles = this.reflector.getAllAndOverride<UserRole[]>(
      ROLES_KEY,
      [context.getHandler(), context.getClass()]
    );

    // Nếu không có decorator @Roles(), cho phép tất cả
    if (!requiredRoles || requiredRoles.length === 0) {
      return true;
    }

    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) {
      throw new ForbiddenException('Chưa xác thực');
    }

    const hasRole = requiredRoles.includes(user.role);

    if (!hasRole) {
      throw new ForbiddenException(
        `Bạn cần quyền ${requiredRoles.join(' hoặc ')} để thực hiện thao tác này`
      );
    }

    return true;
  }
}



################################################################################
## FILE 29: jwt-auth.guard.ts
## Path: backend/src/auth/guards/jwt-auth.guard.ts
################################################################################

// import { Injectable } from '@nestjs/common';
// import { AuthGuard } from '@nestjs/passport';

// @Injectable()
// export class JwtAuthGuard extends AuthGuard('jwt') {}
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  UnauthorizedException,
} from '@nestjs/common';
import { AuthService } from '../auth.service';

@Injectable()
export class JwtAuthGuard implements CanActivate {
  constructor(private authService: AuthService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const authHeader = request.headers.authorization;

    if (!authHeader) {
      throw new UnauthorizedException('Không tìm thấy token xác thực');
    }

    if (!authHeader.startsWith('Bearer ')) {
      throw new UnauthorizedException('Token không đúng định dạng');
    }

    const token = authHeader.substring(7); // Bỏ "Bearer "

    try {
      const user = await this.authService.validateToken(token);
      request.user = user; // Gắn user vào request để sử dụng sau
      return true;
    } catch (error) {
      throw new UnauthorizedException(error.message || 'Token không hợp lệ');
    }
  }
}



################################################################################
## FILE 30: index.ts
## Path: backend/src/auth/guards/index.ts
################################################################################

export * from './jwt-auth.guard';
export * from './roles.guard';
export * from './customer.guard';




################################################################################
## FILE 31: customer.guard.ts
## Path: backend/src/auth/guards/customer.guard.ts
################################################################################

import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { UserRole } from '../../common';

/**
 * Guard chỉ cho phép CUSTOMER truy cập
 * Sử dụng: @UseGuards(JwtAuthGuard, CustomerGuard)
 */
@Injectable()
export class CustomerGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) {
      throw new ForbiddenException('Chưa đăng nhập');
    }

    if (user.role !== UserRole.CUSTOMER) {
      throw new ForbiddenException(
        'Chỉ khách hàng (customer) mới được thực hiện thao tác này'
      );
    }

    return true;
  }
}



################################################################################
## FILE 32: category.service.ts
## Path: backend/src/category/category.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class CategoryService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getCategories() {
    const result = await this.supabaseService.getCategories();
    return result.data || [];
  }

  async getCategoriesWithProductCount() {
    const result = await this.supabaseService.getCategoriesWithProductCount();
    return result.data || [];
  }

  async getRootCategories() {
    const result = await this.supabaseService.getRootCategories();
    return result.data || [];
  }

  async getCategoryBySlug(slug: string) {
    const result = await this.supabaseService.getCategoryBySlug(slug);
    return result.data || null;
  }

  async getChildCategories(parentId: number) {
    const result = await this.supabaseService.getChildCategories(parentId);
    return result.data || [];
  }

  async getCategoryById(categoryId: number) {
    const result = await this.supabaseService.getCategoryById(categoryId);
    return result.data || null;
  }

  async createCategory(categoryData: any) {
    const result = await this.supabaseService.createCategory(categoryData);
    return result;
  }

  async updateCategory(categoryId: number, categoryData: any) {
    const result = await this.supabaseService.updateCategory(categoryId, categoryData);
    return result;
  }

  async deleteCategory(categoryId: number) {
    const result = await this.supabaseService.deleteCategory(categoryId);
    return result;
  }
}




################################################################################
## FILE 33: category.module.ts
## Path: backend/src/category/category.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { CategoryController } from './category.controller';
import { CategoryService } from './category.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [CategoryController],
  providers: [CategoryService, SupabaseService],
  exports: [CategoryService],
})
export class CategoryModule {}




################################################################################
## FILE 34: category.controller.ts
## Path: backend/src/category/category.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Param, Body } from '@nestjs/common';
import { CategoryService } from './category.service';

@Controller('categories')
export class CategoryController {
  constructor(private readonly categoryService: CategoryService) {}

  @Get()
  async getCategories() {
    return await this.categoryService.getCategories();
  }

  @Get('with-count')
  async getCategoriesWithProductCount() {
    return await this.categoryService.getCategoriesWithProductCount();
  }

  @Get('root')
  async getRootCategories() {
    return await this.categoryService.getRootCategories();
  }

  @Get('slug/:slug')
  async getCategoryBySlug(@Param('slug') slug: string) {
    return await this.categoryService.getCategoryBySlug(slug);
  }

  @Get(':id/children')
  async getChildCategories(@Param('id') id: string) {
    return await this.categoryService.getChildCategories(parseInt(id));
  }

  @Get(':id')
  async getCategoryById(@Param('id') id: string) {
    return await this.categoryService.getCategoryById(parseInt(id));
  }

  @Post()
  async createCategory(@Body() categoryData: any) {
    return await this.categoryService.createCategory(categoryData);
  }

  @Put(':id')
  async updateCategory(@Param('id') id: string, @Body() categoryData: any) {
    return await this.categoryService.updateCategory(parseInt(id), categoryData);
  }

  @Delete(':id')
  async deleteCategory(@Param('id') id: string) {
    return await this.categoryService.deleteCategory(parseInt(id));
  }
}




################################################################################
## FILE 35: cloudinary.service.ts
## Path: backend/src/cloudinary/cloudinary.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { v2 as cloudinary } from 'cloudinary';

@Injectable()
export class CloudinaryService {
  constructor() {
    cloudinary.config({
      cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
      api_key: process.env.CLOUDINARY_API_KEY,
      api_secret: process.env.CLOUDINARY_API_SECRET,
    });
  }

  async uploadImage(
    fileBuffer: Buffer,
    folder = 'products',
  ): Promise<string> {
    return new Promise((resolve, reject) => {
      cloudinary.uploader
        .upload_stream(
          {
            folder,
            resource_type: 'image',
            format: 'webp',
            quality: 'auto:good',
          },
          (error, result) => {
            if (error) return reject(error);
            // resolve(result.secure_url);
            console.log('ok');
          },
        )
        .end(fileBuffer);
    });
  }
}




################################################################################
## FILE 36: cloudinary.module.ts
## Path: backend/src/cloudinary/cloudinary.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { CloudinaryService } from './cloudinary.service';
import { ProductModule } from 'src/product/product.module';

@Module({
    imports: [ProductModule],
  providers: [CloudinaryService],
  exports: [CloudinaryService],
})
export class CloudinaryModule {}




################################################################################
## FILE 37: collection.service.ts
## Path: backend/src/collection/collection.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { createClient } from '@supabase/supabase-js';

@Injectable()
export class CollectionService {
  private supabase = createClient(
    process.env.SUPABASE_URL || '',
    process.env.SUPABASE_SERVICE_ROLE_KEY || '',
  );

  // Lấy tất cả bộ sưu tập
  async getAllCollections() {
    try {
      const { data, error } = await this.supabase
        .from('collections')
        .select('*')
        .eq('is_active', true)
        .order('display_order', { ascending: true });

      if (error) {
        console.error('getAllCollections error:', error.message);
        return []; // Trả về mảng rỗng
      }
      return data || [];
    } catch (error: any) {
      console.error('getAllCollections error:', error.message);
      return [];
    }
  }

  // Lấy bộ sưu tập theo loại (main, seasonal)
  async getCollectionsByType(type: string) {
    try {
      const { data, error } = await this.supabase
        .from('collections')
        .select('*')
        .eq('collection_type', type)
        .eq('is_active', true)
        .order('display_order', { ascending: true });

      if (error) {
        console.error('getCollectionsByType error:', error.message);
        return [];
      }
      return data || [];
    } catch (error: any) {
      console.error('getCollectionsByType error:', error.message);
      return [];
    }
  }

  // Lấy bộ sưu tập theo slug
  async getCollectionBySlug(slug: string) {
    const { data, error } = await this.supabase
      .from('collections')
      .select('*')
      .eq('collection_slug', slug)
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Lấy số lượng sản phẩm trong mỗi bộ sưu tập
  async getCollectionProductCounts() {
    try {
      // Lấy tất cả collections
      const { data: collections, error: collectionsError } = await this.supabase
        .from('collections')
        .select('collection_id, collection_slug')
        .eq('is_active', true);

      if (collectionsError) {
        console.error('Collections table error:', collectionsError.message);
        return {}; // Trả về object rỗng nếu table không tồn tại
      }

      // Đếm sản phẩm cho mỗi collection
      const counts: Record<string, number> = {};
      
      for (const collection of collections || []) {
        const { count, error } = await this.supabase
          .from('product_collections')
          .select('*', { count: 'exact', head: true })
          .eq('collection_id', collection.collection_id);

        if (!error) {
          counts[collection.collection_slug] = count || 0;
        }
      }

      return counts;
    } catch (error: any) {
      console.error('getCollectionProductCounts error:', error.message);
      return {}; // Trả về object rỗng khi có lỗi
    }
  }

  // Lấy sản phẩm trong một bộ sưu tập
  async getProductsByCollection(slug: string) {
    // Lấy collection_id từ slug
    const { data: collection, error: collectionError } = await this.supabase
      .from('collections')
      .select('collection_id')
      .eq('collection_slug', slug)
      .single();

    if (collectionError || !collection) {
      throw new Error('Collection not found');
    }

    // Lấy product_ids từ product_collections
    const { data: productCollections, error: pcError } = await this.supabase
      .from('product_collections')
      .select('product_id')
      .eq('collection_id', collection.collection_id)
      .order('display_order', { ascending: true });

    if (pcError) {
      throw new Error(pcError.message);
    }

    if (!productCollections || productCollections.length === 0) {
      return [];
    }

    const productIds = productCollections.map(pc => pc.product_id);

    // Lấy thông tin sản phẩm
    const { data: products, error: productsError } = await this.supabase
      .from('products')
      .select('*')
      .in('product_id', productIds);

    if (productsError) {
      throw new Error(productsError.message);
    }

    return products;
  }

  // Thêm sản phẩm vào bộ sưu tập
  async addProductToCollection(productId: number, collectionId: number, displayOrder: number = 0) {
    const { data, error } = await this.supabase
      .from('product_collections')
      .insert({
        product_id: productId,
        collection_id: collectionId,
        display_order: displayOrder,
      })
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Xóa sản phẩm khỏi bộ sưu tập
  async removeProductFromCollection(productId: number, collectionId: number) {
    const { error } = await this.supabase
      .from('product_collections')
      .delete()
      .eq('product_id', productId)
      .eq('collection_id', collectionId);

    if (error) {
      throw new Error(error.message);
    }
    return { success: true };
  }

  // Cập nhật các bộ sưu tập của sản phẩm (xóa cũ, thêm mới)
  async updateProductCollections(productId: number, collectionIds: number[]) {
    // Xóa tất cả liên kết cũ
    const { error: deleteError } = await this.supabase
      .from('product_collections')
      .delete()
      .eq('product_id', productId);

    if (deleteError) {
      throw new Error(deleteError.message);
    }

    // Thêm các liên kết mới
    if (collectionIds.length > 0) {
      const inserts = collectionIds.map((collectionId, index) => ({
        product_id: productId,
        collection_id: collectionId,
        display_order: index,
      }));

      const { error: insertError } = await this.supabase
        .from('product_collections')
        .insert(inserts);

      if (insertError) {
        throw new Error(insertError.message);
      }
    }

    return { success: true };
  }

  // Lấy các bộ sưu tập của một sản phẩm
  async getProductCollections(productId: number) {
    const { data, error } = await this.supabase
      .from('product_collections')
      .select(`
        collection_id,
        collections (
          collection_id,
          collection_name,
          collection_slug,
          collection_type
        )
      `)
      .eq('product_id', productId);

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Tạo bộ sưu tập mới
  async createCollection(collectionData: {
    collection_name: string;
    collection_slug: string;
    collection_description?: string;
    collection_image?: string;
    collection_gradient?: string;
    collection_icon?: string;
    collection_type?: string;
    display_order?: number;
  }) {
    const { data, error } = await this.supabase
      .from('collections')
      .insert(collectionData)
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Cập nhật bộ sưu tập
  async updateCollection(collectionId: number, collectionData: Partial<{
    collection_name: string;
    collection_description: string;
    collection_image: string;
    collection_gradient: string;
    collection_icon: string;
    collection_type: string;
    display_order: number;
    is_active: boolean;
  }>) {
    const { data, error } = await this.supabase
      .from('collections')
      .update(collectionData)
      .eq('collection_id', collectionId)
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }
    return data;
  }

  // Xóa bộ sưu tập
  async deleteCollection(collectionId: number) {
    // Xóa liên kết với sản phẩm trước
    await this.supabase
      .from('product_collections')
      .delete()
      .eq('collection_id', collectionId);

    // Xóa bộ sưu tập
    const { error } = await this.supabase
      .from('collections')
      .delete()
      .eq('collection_id', collectionId);

    if (error) {
      throw new Error(error.message);
    }
    return { success: true };
  }
}




################################################################################
## FILE 38: collection.module.ts
## Path: backend/src/collection/collection.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { CollectionService } from './collection.service';
import { CollectionController } from './collection.controller';

@Module({
  controllers: [CollectionController],
  providers: [CollectionService],
})
export class CollectionModule {}




################################################################################
## FILE 39: collection.controller.ts
## Path: backend/src/collection/collection.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Param, Body, Query } from '@nestjs/common';
import { CollectionService } from './collection.service';

@Controller('collections')
export class CollectionController {
  constructor(private readonly collectionService: CollectionService) {}

  // GET /collections - Lấy tất cả bộ sưu tập
  @Get()
  async getAllCollections() {
    return this.collectionService.getAllCollections();
  }

  // GET /collections/type/:type - Lấy bộ sưu tập theo loại (main, seasonal)
  @Get('type/:type')
  async getCollectionsByType(@Param('type') type: string) {
    return this.collectionService.getCollectionsByType(type);
  }

  // GET /collections/counts - Lấy số lượng sản phẩm trong mỗi bộ sưu tập
  @Get('counts')
  async getCollectionProductCounts() {
    return this.collectionService.getCollectionProductCounts();
  }

  // GET /collections/slug/:slug - Lấy bộ sưu tập theo slug
  @Get('slug/:slug')
  async getCollectionBySlug(@Param('slug') slug: string) {
    return this.collectionService.getCollectionBySlug(slug);
  }

  // GET /collections/slug/:slug/products - Lấy sản phẩm trong bộ sưu tập
  @Get('slug/:slug/products')
  async getProductsByCollection(@Param('slug') slug: string) {
    return this.collectionService.getProductsByCollection(slug);
  }

  // GET /collections/product/:productId - Lấy các bộ sưu tập của sản phẩm
  @Get('product/:productId')
  async getProductCollections(@Param('productId') productId: number) {
    return this.collectionService.getProductCollections(productId);
  }

  // POST /collections - Tạo bộ sưu tập mới
  @Post()
  async createCollection(
    @Body() collectionData: {
      collection_name: string;
      collection_slug: string;
      collection_description?: string;
      collection_image?: string;
      collection_gradient?: string;
      collection_icon?: string;
      collection_type?: string;
      display_order?: number;
    },
  ) {
    return this.collectionService.createCollection(collectionData);
  }

  // POST /collections/product - Thêm sản phẩm vào bộ sưu tập
  @Post('product')
  async addProductToCollection(
    @Body() data: { productId: number; collectionId: number; displayOrder?: number },
  ) {
    return this.collectionService.addProductToCollection(
      data.productId,
      data.collectionId,
      data.displayOrder || 0,
    );
  }

  // PUT /collections/:id - Cập nhật bộ sưu tập
  @Put(':id')
  async updateCollection(
    @Param('id') id: number,
    @Body() collectionData: Partial<{
      collection_name: string;
      collection_description: string;
      collection_image: string;
      collection_gradient: string;
      collection_icon: string;
      collection_type: string;
      display_order: number;
      is_active: boolean;
    }>,
  ) {
    return this.collectionService.updateCollection(id, collectionData);
  }

  // PUT /collections/product/:productId - Cập nhật các bộ sưu tập của sản phẩm
  @Put('product/:productId')
  async updateProductCollections(
    @Param('productId') productId: number,
    @Body() data: { collectionIds: number[] },
  ) {
    return this.collectionService.updateProductCollections(productId, data.collectionIds);
  }

  // DELETE /collections/:id - Xóa bộ sưu tập
  @Delete(':id')
  async deleteCollection(@Param('id') id: number) {
    return this.collectionService.deleteCollection(id);
  }

  // DELETE /collections/product - Xóa sản phẩm khỏi bộ sưu tập
  @Delete('product')
  async removeProductFromCollection(
    @Body() data: { productId: number; collectionId: number },
  ) {
    return this.collectionService.removeProductFromCollection(data.productId, data.collectionId);
  }
}




################################################################################
## FILE 40: index.ts
## Path: backend/src/common/index.ts
################################################################################

export * from './enums/user-role.enum';
export * from './interfaces/authenticated-user.interface';



################################################################################
## FILE 41: user-role.enum.ts
## Path: backend/src/common/enums/user-role.enum.ts
################################################################################

export enum UserRole {
  ADMIN = 'admin',
  CUSTOMER = 'customer',
  GUEST = 'guest',
}




################################################################################
## FILE 42: authenticated-user.interface.ts
## Path: backend/src/common/interfaces/authenticated-user.interface.ts
################################################################################

import { UserRole } from '../enums/user-role.enum';

export interface AuthenticatedUser {
  id: string;           // UUID từ Supabase Auth
  email: string;
  fullName?: string;
  phone?: string;
  role: UserRole;
  createdAt?: Date;
}




################################################################################
## FILE 43: contact.service.ts
## Path: backend/src/contact/contact.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ContactService {
  constructor(private supabaseService: SupabaseService) {}

  async getAllMessages() {
    return this.supabaseService.getAllContactMessages();
  }

  async getMessageById(id: number) {
    return this.supabaseService.getContactMessageById(id);
  }

  async createMessage(messageData: any) {
    return this.supabaseService.createContactMessage(messageData);
  }

  async updateMessageStatus(id: number, status: string) {
    return this.supabaseService.updateContactMessageStatus(id, status);
  }

  async deleteMessage(id: number) {
    return this.supabaseService.deleteContactMessage(id);
  }
}




################################################################################
## FILE 44: contact.module.ts
## Path: backend/src/contact/contact.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ContactService } from './contact.service';
import { ContactController } from './contact.controller';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [ContactController],
  providers: [ContactService, SupabaseService],
})
export class ContactModule {}




################################################################################
## FILE 45: contact.controller.ts
## Path: backend/src/contact/contact.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { ContactService } from './contact.service';

@Controller('contacts')
export class ContactController {
  constructor(private readonly contactService: ContactService) {}

  @Get()
  async getAllMessages(@Query('limit') limit?: number) {
    const result = await this.contactService.getAllMessages();
    return result.data || [];
  }

  @Get(':id')
  async getMessageById(@Param('id') id: string) {
    const result = await this.contactService.getMessageById(parseInt(id));
    return result.data;
  }

  @Post()
  async createMessage(@Body() body: any) {
    const messageData = {
      name: body.name,
      email: body.email,
      phone: body.phone || null,
      subject: body.subject || 'Liên hệ',
      message: body.message,
      status: 'pending',
      created_at: new Date().toISOString(),
    };
    const result = await this.contactService.createMessage(messageData);
    return { success: !result.error, data: result.data, error: result.error };
  }

  @Put(':id/status')
  async updateStatus(@Param('id') id: string, @Body() body: any) {
    const result = await this.contactService.updateMessageStatus(parseInt(id), body.status);
    return { success: !result.error, data: result.data, error: result.error };
  }

  @Delete(':id')
  async deleteMessage(@Param('id') id: string) {
    const result = await this.contactService.deleteMessage(parseInt(id));
    return { success: !result.error, error: result.error };
  }
}




################################################################################
## FILE 46: design.service.ts
## Path: backend/src/design/design.service.ts
################################################################################

import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';
import sharp from 'sharp';
import * as path from 'path';
import * as fs from 'fs';

export interface CreateDesignDto {
  userId?: string;
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
  templateId?: number;
  phoneModel: string;
  designData: any; // JSON từ Fabric.js
  previewImageBase64?: string; // Ảnh preview dạng base64
}

export interface UpdateDesignDto {
  designData?: any;
  previewImageBase64?: string;
  status?: string;
  adminNotes?: string;
}

export interface SubmitDesignDto {
  designId: number;
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
}

@Injectable()
export class DesignService {
  private uploadDir = path.join(process.cwd(), 'uploads', 'designs');

  constructor(private supabaseService: SupabaseService) {
    // Tạo thư mục upload nếu chưa tồn tại
    if (!fs.existsSync(this.uploadDir)) {
      fs.mkdirSync(this.uploadDir, { recursive: true });
    }
  }

  // Lấy danh sách phone templates
  async getPhoneTemplates() {
    return this.supabaseService.getPhoneTemplates();
  }

  // Lấy template theo ID
  async getTemplateById(templateId: number) {
    const { data, error } = await this.supabaseService.getPhoneTemplateById(templateId);
    if (error || !data) {
      throw new NotFoundException('Template không tồn tại');
    }
    return data;
  }

  // Tạo template mới
  async createTemplate(dto: any) {
    // Xử lý ảnh base64 nếu có
    let imageUrl = dto.template_image_url;
    if (imageUrl && imageUrl.startsWith('data:image')) {
      imageUrl = await this.saveBase64Image(imageUrl, 'template');
    }

    const { data, error } = await this.supabaseService.createPhoneTemplate({
      phone_model: dto.phone_model,
      brand: dto.brand,
      template_image_url: imageUrl || null,
      print_width_mm: dto.print_width_mm || 70,
      print_height_mm: dto.print_height_mm || 150,
      canvas_width: dto.canvas_width || 700,
      canvas_height: dto.canvas_height || 1500,
      is_active: dto.is_active !== false,
    });

    if (error) {
      throw new BadRequestException('Không thể tạo template: ' + error.message);
    }

    return { success: true, message: 'Đã tạo template!', template: data };
  }

  // Cập nhật template
  async updateTemplate(templateId: number, dto: any) {
    // Xử lý ảnh base64 nếu có
    let imageUrl = dto.template_image_url;
    if (imageUrl && imageUrl.startsWith('data:image')) {
      imageUrl = await this.saveBase64Image(imageUrl, 'template');
    }

    const updateData: any = {};
    if (dto.phone_model !== undefined) updateData.phone_model = dto.phone_model;
    if (dto.brand !== undefined) updateData.brand = dto.brand;
    // Chỉ update image nếu có giá trị mới (không phải empty string)
    if (imageUrl && imageUrl.trim() !== '') {
      updateData.template_image_url = imageUrl;
    }
    if (dto.print_width_mm !== undefined) updateData.print_width_mm = dto.print_width_mm;
    if (dto.print_height_mm !== undefined) updateData.print_height_mm = dto.print_height_mm;
    if (dto.canvas_width !== undefined) updateData.canvas_width = dto.canvas_width;
    if (dto.canvas_height !== undefined) updateData.canvas_height = dto.canvas_height;
    if (dto.is_active !== undefined) updateData.is_active = dto.is_active;

    const { data, error } = await this.supabaseService.updatePhoneTemplate(templateId, updateData);

    if (error) {
      console.error('Update template error:', error);
      throw new BadRequestException('Không thể cập nhật template: ' + error.message);
    }

    return { success: true, message: 'Đã cập nhật template!', template: data };
  }

  // Xóa template
  async deleteTemplate(templateId: number) {
    const { error } = await this.supabaseService.deletePhoneTemplate(templateId);

    if (error) {
      throw new BadRequestException('Không thể xóa template: ' + error.message);
    }

    return { success: true, message: 'Đã xóa template!' };
  }

  // Tạo thiết kế mới
  async createDesign(dto: CreateDesignDto) {
    // Lưu preview image nếu có
    let previewImageUrl: string | null = null;
    if (dto.previewImageBase64) {
      previewImageUrl = await this.saveBase64Image(dto.previewImageBase64, 'preview');
    }

    const { data, error } = await this.supabaseService.createDesign({
      user_id: dto.userId || null,
      guest_email: dto.guestEmail || null,
      guest_name: dto.guestName || null,
      guest_phone: dto.guestPhone || null,
      template_id: dto.templateId || null,
      phone_model: dto.phoneModel,
      design_data: dto.designData,
      preview_image_url: previewImageUrl,
      status: 'draft',
    });

    if (error) {
      console.error('Create design error:', error);
      throw new BadRequestException('Không thể tạo thiết kế: ' + error.message);
    }

    return {
      success: true,
      message: 'Tạo thiết kế thành công',
      design: data,
    };
  }

  // Cập nhật thiết kế
  async updateDesign(designId: number, dto: UpdateDesignDto) {
    // Kiểm tra thiết kế tồn tại
    const { data: existing, error: existError } = await this.supabaseService.getDesignById(designId);
    if (existError || !existing) {
      throw new NotFoundException('Thiết kế không tồn tại');
    }

    // Không cho phép sửa nếu đã submitted
    if (existing.status !== 'draft' && !dto.status && !dto.adminNotes) {
      throw new BadRequestException('Không thể sửa thiết kế đã gửi');
    }

    const updateData: any = {};

    if (dto.designData) {
      updateData.design_data = dto.designData;
    }

    if (dto.previewImageBase64) {
      updateData.preview_image_url = await this.saveBase64Image(dto.previewImageBase64, 'preview');
    }

    if (dto.status) {
      updateData.status = dto.status;
      if (dto.status === 'submitted') {
        updateData.submitted_at = new Date().toISOString();
      }
      if (['approved', 'rejected', 'printed'].includes(dto.status)) {
        updateData.processed_at = new Date().toISOString();
      }
    }

    if (dto.adminNotes !== undefined) {
      updateData.admin_notes = dto.adminNotes;
    }

    const { data, error } = await this.supabaseService.updateDesign(designId, updateData);

    if (error) {
      throw new BadRequestException('Không thể cập nhật thiết kế: ' + error.message);
    }

    return {
      success: true,
      message: 'Cập nhật thiết kế thành công',
      design: data,
    };
  }

  // Gửi thiết kế cho admin duyệt
  async submitDesign(dto: SubmitDesignDto) {
    const { data: existing, error: existError } = await this.supabaseService.getDesignById(dto.designId);
    if (existError || !existing) {
      throw new NotFoundException('Thiết kế không tồn tại');
    }

    if (existing.status !== 'draft') {
      throw new BadRequestException('Thiết kế đã được gửi trước đó');
    }

    // Render ảnh chất lượng cao
    let highResUrl: string | null = null;
    try {
      highResUrl = await this.renderHighResImage(existing.design_data, existing.phone_model);
    } catch (renderError) {
      console.error('Render high-res error:', renderError);
      // Vẫn tiếp tục submit dù không render được
    }

    const { data, error } = await this.supabaseService.updateDesign(dto.designId, {
      status: 'submitted',
      submitted_at: new Date().toISOString(),
      high_res_image_url: highResUrl,
      guest_email: dto.guestEmail || existing.guest_email,
      guest_name: dto.guestName || existing.guest_name,
      guest_phone: dto.guestPhone || existing.guest_phone,
    });

    if (error) {
      throw new BadRequestException('Không thể gửi thiết kế: ' + error.message);
    }

    return {
      success: true,
      message: 'Thiết kế đã được gửi! Admin sẽ xem xét và liên hệ với bạn.',
      design: data,
    };
  }

  // Lấy thiết kế theo ID
  async getDesignById(designId: number) {
    const { data, error } = await this.supabaseService.getDesignById(designId);
    if (error || !data) {
      throw new NotFoundException('Thiết kế không tồn tại');
    }
    return data;
  }

  // Lấy danh sách thiết kế của user
  async getUserDesigns(userId: string) {
    return this.supabaseService.getUserDesigns(userId);
  }

  // Lấy danh sách thiết kế cho admin
  async getAllDesigns(status?: string) {
    return this.supabaseService.getAllDesigns(status);
  }

  // Admin duyệt thiết kế
  async approveDesign(designId: number, adminNotes?: string) {
    return this.updateDesign(designId, {
      status: 'approved',
      adminNotes,
    });
  }

  // Admin từ chối thiết kế
  async rejectDesign(designId: number, adminNotes: string) {
    if (!adminNotes) {
      throw new BadRequestException('Vui lòng nhập lý do từ chối');
    }
    return this.updateDesign(designId, {
      status: 'rejected',
      adminNotes,
    });
  }

  // Lưu ảnh base64
  private async saveBase64Image(base64Data: string, prefix: string): Promise<string> {
    try {
      // Xóa header base64 nếu có
      const base64Image = base64Data.replace(/^data:image\/\w+;base64,/, '');
      const buffer = Buffer.from(base64Image, 'base64');

      const fileName = `${prefix}_${Date.now()}_${Math.random().toString(36).substring(7)}.png`;
      const filePath = path.join(this.uploadDir, fileName);

      // Optimize image với sharp
      await sharp(buffer)
        .png({ quality: 90 })
        .toFile(filePath);

      // Trả về URL relative
      return `/uploads/designs/${fileName}`;
    } catch (error) {
      console.error('Save image error:', error);
      throw new BadRequestException('Không thể lưu ảnh');
    }
  }

  // Render ảnh chất lượng cao (300dpi) từ design data
  private async renderHighResImage(designData: any, phoneModel: string): Promise<string> {
    try {
      // Kích thước chuẩn cho in ấn (300 DPI)
      // Giả sử kích thước ốp là 70mm x 150mm
      // 70mm * (300/25.4) ≈ 827 pixels
      // 150mm * (300/25.4) ≈ 1772 pixels
      const DPI = 300;
      const MM_TO_INCH = 25.4;
      const printWidth = Math.round(70 * DPI / MM_TO_INCH); // ~827px
      const printHeight = Math.round(150 * DPI / MM_TO_INCH); // ~1772px

      // Tạo canvas trắng với kích thước in
      const canvas = sharp({
        create: {
          width: printWidth,
          height: printHeight,
          channels: 4,
          background: { r: 255, g: 255, b: 255, alpha: 1 }
        }
      });

      const composites: any[] = [];

      // Xử lý từng object trong design data
      if (designData.objects && Array.isArray(designData.objects)) {
        for (const obj of designData.objects) {
          if (obj.type === 'image' && obj.src) {
            try {
              // Download và resize ảnh
              const response = await fetch(obj.src);
              const arrayBuffer = await response.arrayBuffer();
              const imageBuffer = Buffer.from(arrayBuffer);

              // Tính toán scale từ canvas sang print size
              const scaleX = printWidth / (designData.width || 700);
              const scaleY = printHeight / (designData.height || 1500);

              const width = Math.round((obj.width || 100) * (obj.scaleX || 1) * scaleX);
              const height = Math.round((obj.height || 100) * (obj.scaleY || 1) * scaleY);
              const left = Math.round((obj.left || 0) * scaleX);
              const top = Math.round((obj.top || 0) * scaleY);

              const resizedImage = await sharp(imageBuffer)
                .resize(width, height, { fit: 'fill' })
                .toBuffer();

              composites.push({
                input: resizedImage,
                left: Math.max(0, left),
                top: Math.max(0, top),
              });
            } catch (imgError) {
              console.error('Process image error:', imgError);
            }
          }
        }
      }

      // Composite tất cả ảnh
      const finalImage = await canvas
        .composite(composites)
        .png({ quality: 100 })
        .toBuffer();

      // Lưu file
      const fileName = `highres_${Date.now()}_${Math.random().toString(36).substring(7)}.png`;
      const filePath = path.join(this.uploadDir, fileName);
      await sharp(finalImage).toFile(filePath);

      return `/uploads/designs/${fileName}`;
    } catch (error) {
      console.error('Render high-res error:', error);
      throw error;
    }
  }

  // Upload ảnh cho thiết kế
  async uploadDesignImage(designId: number, file: any) {
    // Kiểm tra thiết kế tồn tại
    const { data: existing } = await this.supabaseService.getDesignById(designId);
    if (!existing) {
      throw new NotFoundException('Thiết kế không tồn tại');
    }

    // Tạo thumbnail
    const thumbnailBuffer = await sharp(file.buffer)
      .resize(200, 200, { fit: 'cover' })
      .jpeg({ quality: 80 })
      .toBuffer();

    // Lưu ảnh gốc
    const originalFileName = `original_${Date.now()}_${file.originalname}`;
    const originalPath = path.join(this.uploadDir, originalFileName);
    await sharp(file.buffer).toFile(originalPath);

    // Lưu thumbnail
    const thumbnailFileName = `thumb_${Date.now()}_${file.originalname}`;
    const thumbnailPath = path.join(this.uploadDir, thumbnailFileName);
    await sharp(thumbnailBuffer).toFile(thumbnailPath);

    // Lấy metadata
    const metadata = await sharp(file.buffer).metadata();

    // Lưu vào database
    const { data, error } = await this.supabaseService.createDesignImage({
      design_id: designId,
      original_url: `/uploads/designs/${originalFileName}`,
      thumbnail_url: `/uploads/designs/${thumbnailFileName}`,
      file_name: file.originalname,
      file_size: file.size,
      width: metadata.width,
      height: metadata.height,
    });

    if (error) {
      throw new BadRequestException('Không thể lưu ảnh: ' + error.message);
    }

    return {
      success: true,
      image: data,
    };
  }

  // Lấy danh sách ảnh của thiết kế
  async getDesignImages(designId: number) {
    return this.supabaseService.getDesignImages(designId);
  }

  // Xóa thiết kế
  async deleteDesign(designId: number) {
    const { error } = await this.supabaseService.deleteDesign(designId);
    if (error) {
      throw new BadRequestException('Không thể xóa thiết kế: ' + error.message);
    }
    return { success: true, message: 'Đã xóa thiết kế' };
  }
}




################################################################################
## FILE 47: design.module.ts
## Path: backend/src/design/design.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { MulterModule } from '@nestjs/platform-express';
import { DesignController } from './design.controller';
import { DesignService } from './design.service';
import { SupabaseService } from '../supabase.service';

@Module({
  imports: [
    MulterModule.register({
      limits: {
        fileSize: 10 * 1024 * 1024, // 10MB max
      },
    }),
  ],
  controllers: [DesignController],
  providers: [DesignService, SupabaseService],
  exports: [DesignService],
})
export class DesignModule {}




################################################################################
## FILE 48: design.controller.ts
## Path: backend/src/design/design.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  UseInterceptors,
  UploadedFile,
  ParseIntPipe,
} from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { DesignService } from './design.service';
import type { CreateDesignDto, UpdateDesignDto, SubmitDesignDto } from './design.service';

@Controller('designs')
export class DesignController {
  constructor(private readonly designService: DesignService) {}

  // ============ PHONE TEMPLATES ============

  // Lấy danh sách templates
  @Get('templates')
  async getTemplates() {
    return this.designService.getPhoneTemplates();
  }

  // Lấy template theo ID
  @Get('templates/:templateId')
  async getTemplateById(@Param('templateId', ParseIntPipe) templateId: number) {
    return this.designService.getTemplateById(templateId);
  }

  // Tạo template mới
  @Post('templates')
  async createTemplate(@Body() dto: any) {
    return this.designService.createTemplate(dto);
  }

  // Cập nhật template
  @Put('templates/:templateId')
  async updateTemplate(
    @Param('templateId', ParseIntPipe) templateId: number,
    @Body() dto: any,
  ) {
    return this.designService.updateTemplate(templateId, dto);
  }

  // Xóa template
  @Delete('templates/:templateId')
  async deleteTemplate(@Param('templateId', ParseIntPipe) templateId: number) {
    return this.designService.deleteTemplate(templateId);
  }

  // ============ DESIGNS ============

  // Tạo thiết kế mới
  @Post()
  async createDesign(@Body() dto: CreateDesignDto) {
    return this.designService.createDesign(dto);
  }

  // Lấy thiết kế theo ID
  @Get(':designId')
  async getDesignById(@Param('designId', ParseIntPipe) designId: number) {
    return this.designService.getDesignById(designId);
  }

  // Cập nhật thiết kế
  @Put(':designId')
  async updateDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body() dto: UpdateDesignDto,
  ) {
    return this.designService.updateDesign(designId, dto);
  }

  // Gửi thiết kế cho admin
  @Post(':designId/submit')
  async submitDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body() dto: Omit<SubmitDesignDto, 'designId'>,
  ) {
    return this.designService.submitDesign({ ...dto, designId });
  }

  // Lấy thiết kế của user
  @Get('user/:userId')
  async getUserDesigns(@Param('userId') userId: string) {
    return this.designService.getUserDesigns(userId);
  }

  // Xóa thiết kế
  @Delete(':designId')
  async deleteDesign(@Param('designId', ParseIntPipe) designId: number) {
    return this.designService.deleteDesign(designId);
  }

  // ============ ADMIN ============

  // Lấy tất cả thiết kế (admin)
  @Get('admin/all')
  async getAllDesigns(@Query('status') status?: string) {
    return this.designService.getAllDesigns(status);
  }

  // Duyệt thiết kế
  @Put('admin/:designId/approve')
  async approveDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body('adminNotes') adminNotes?: string,
  ) {
    return this.designService.approveDesign(designId, adminNotes);
  }

  // Từ chối thiết kế
  @Put('admin/:designId/reject')
  async rejectDesign(
    @Param('designId', ParseIntPipe) designId: number,
    @Body('adminNotes') adminNotes: string,
  ) {
    return this.designService.rejectDesign(designId, adminNotes);
  }

  // ============ IMAGES ============

  // Upload ảnh cho thiết kế
  @Post(':designId/images')
  @UseInterceptors(FileInterceptor('file'))
  async uploadImage(
    @Param('designId', ParseIntPipe) designId: number,
    @UploadedFile() file: any,
  ) {
    return this.designService.uploadDesignImage(designId, file);
  }

  // Lấy danh sách ảnh của thiết kế
  @Get(':designId/images')
  async getDesignImages(@Param('designId', ParseIntPipe) designId: number) {
    return this.designService.getDesignImages(designId);
  }
}




################################################################################
## FILE 49: gift.service.ts
## Path: backend/src/gift/gift.service.ts
################################################################################

import { Injectable, BadRequestException, NotFoundException } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';
import * as nodemailer from 'nodemailer';

export interface SendGiftDto {
  senderName: string;
  senderEmail: string;
  senderMessage?: string;
  senderId?: string;
  recipientName: string;
  recipientEmail: string;
  recipientPhone?: string;
  recipientAddress?: string;
  productId: number;
  quantity?: number;
}

export interface VerifyGiftDto {
  giftId: string;
  verificationCode: string;
}

export interface ClaimGiftDto {
  giftId: string;
  recipientAddress: string;
  recipientPhone: string;
}

@Injectable()
export class GiftService {
  private transporter: nodemailer.Transporter;

  constructor(private supabaseService: SupabaseService) {
    // Cấu hình email transporter
    // Sử dụng Gmail SMTP - Bạn cần tạo App Password trong Google Account
    console.log('📧 Email config:', {
      user: process.env.EMAIL_USER || 'NOT SET',
      passLength: process.env.EMAIL_PASS ? process.env.EMAIL_PASS.length : 0,
    });
    
    this.transporter = nodemailer.createTransport({
      service: 'gmail',
      auth: {
        user: process.env.EMAIL_USER || 'your-email@gmail.com',
        pass: process.env.EMAIL_PASS || 'your-app-password',
      },
    });
  }

  // Tạo mã xác nhận 6 số
  private generateVerificationCode(): string {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  // Gửi quà tặng
  async sendGift(dto: SendGiftDto) {
    // Kiểm tra sản phẩm tồn tại
    const { data: product, error: productError } = await this.supabaseService.getProductById(dto.productId);

    if (productError || !product) {
      throw new NotFoundException('Sản phẩm không tồn tại');
    }

    // Tạo mã xác nhận
    const verificationCode = this.generateVerificationCode();

    // Lưu thông tin quà tặng
    const { data: gift, error: giftError } = await this.supabaseService.createGift({
      sender_id: dto.senderId || undefined,
      sender_name: dto.senderName,
      sender_email: dto.senderEmail,
      sender_message: dto.senderMessage || '',
      recipient_name: dto.recipientName,
      recipient_email: dto.recipientEmail,
      recipient_phone: dto.recipientPhone || '',
      recipient_address: dto.recipientAddress || '',
      product_id: dto.productId,
      quantity: dto.quantity || 1,
      verification_code: verificationCode,
    });

    if (giftError) {
      console.error('Gift insert error:', giftError);
      throw new BadRequestException('Không thể tạo quà tặng: ' + giftError.message);
    }

    // Lấy ảnh sản phẩm
    const productImage = product.image_url || 
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      'https://via.placeholder.com/200';

    // Gửi email cho người nhận
    try {
      console.log('📧 Sending email to:', dto.recipientEmail);
      await this.sendGiftNotificationEmail({
        recipientEmail: dto.recipientEmail,
        recipientName: dto.recipientName,
        senderName: dto.senderName,
        senderMessage: dto.senderMessage || '',
        productName: product.product_name,
        productImage: productImage,
        productPrice: product.sale_price || product.price,
        giftId: gift.gift_id,
        verificationCode: verificationCode,
      });

      // Lưu lịch sử email
      await this.supabaseService.createGiftEmail({
        gift_id: gift.gift_id,
        email_type: 'notification',
        sent_to: dto.recipientEmail,
        status: 'sent',
      });

    } catch (emailError) {
      console.error('❌ Email send error:', emailError);
      console.error('❌ Email error message:', (emailError as any).message);
      // Vẫn return success vì gift đã được tạo
    }

    return {
      success: true,
      message: 'Quà tặng đã được gửi! Email xác nhận đã được gửi đến người nhận.',
      giftId: gift.gift_id,
    };
  }

  // Gửi email thông báo quà tặng
  private async sendGiftNotificationEmail(data: {
    recipientEmail: string;
    recipientName: string;
    senderName: string;
    senderMessage: string;
    productName: string;
    productImage: string;
    productPrice: number;
    giftId: string;
    verificationCode: string;
  }) {
    const frontendUrl = process.env.FRONTEND_URL || 'http://localhost:3000';
    const claimUrl = `${frontendUrl}/gift/claim/${data.giftId}`;

    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #ec4899, #f43f5e); padding: 40px 20px; text-align: center; }
        .header h1 { color: white; margin: 0; font-size: 28px; }
        .header p { color: rgba(255,255,255,0.9); margin: 10px 0 0; }
        .gift-icon { font-size: 60px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .message-box { background: #fdf2f8; border-left: 4px solid #ec4899; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .product-card { display: flex; gap: 20px; background: #f9fafb; padding: 20px; border-radius: 12px; margin: 20px 0; }
        .product-image { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; }
        .product-info h3 { margin: 0 0 10px; color: #1f2937; }
        .product-price { color: #ec4899; font-size: 24px; font-weight: bold; }
        .verification-box { background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; }
        .verification-code { font-size: 32px; font-weight: bold; letter-spacing: 8px; color: #d97706; margin: 10px 0; }
        .claim-btn { display: inline-block; background: linear-gradient(135deg, #ec4899, #f43f5e); color: white; padding: 16px 40px; border-radius: 50px; text-decoration: none; font-weight: bold; font-size: 18px; margin: 20px 0; }
        .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; font-size: 14px; }
        .footer a { color: #ec4899; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <div class="gift-icon">🎁</div>
          <h1>Bạn Nhận Được Quà Tặng!</h1>
          <p>Từ ${data.senderName}</p>
        </div>
        
        <div class="content">
          <p style="font-size: 18px; color: #374151;">
            Xin chào <strong>${data.recipientName}</strong>,
          </p>
          
          <p style="color: #6b7280; line-height: 1.6;">
            <strong>${data.senderName}</strong> đã gửi tặng bạn một món quà đặc biệt từ GoatTech! 🎉
          </p>
          
          ${data.senderMessage ? `
          <div class="message-box">
            <p style="margin: 0; color: #831843; font-style: italic;">
              "${data.senderMessage}"
            </p>
            <p style="margin: 10px 0 0; color: #9d174d; font-size: 14px;">
              — ${data.senderName}
            </p>
          </div>
          ` : ''}
          
          <h2 style="color: #1f2937;">🎁 Quà tặng của bạn:</h2>
          
          <div class="product-card">
            <img src="${data.productImage}" alt="${data.productName}" class="product-image">
            <div class="product-info">
              <h3>${data.productName}</h3>
              <p class="product-price">${data.productPrice.toLocaleString('vi-VN')}₫</p>
            </div>
          </div>
          
          <div class="verification-box">
            <p style="margin: 0; color: #92400e;">🔐 Mã xác nhận của bạn:</p>
            <div class="verification-code">${data.verificationCode}</div>
            <p style="margin: 0; color: #92400e; font-size: 14px;">
              Sử dụng mã này để nhận quà
            </p>
          </div>
          
          <div style="text-align: center;">
            <a href="${claimUrl}" class="claim-btn">
              🎁 Nhận Quà Ngay
            </a>
          </div>
          
          <p style="color: #9ca3af; font-size: 14px; text-align: center;">
            Hoặc truy cập: <a href="${claimUrl}" style="color: #ec4899;">${claimUrl}</a>
          </p>
          
          <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <p style="margin: 0; color: #991b1b; font-size: 14px;">
              ⏰ <strong>Lưu ý:</strong> Quà tặng có hiệu lực trong 7 ngày. 
              Vui lòng nhận quà trước khi hết hạn!
            </p>
          </div>
        </div>
        
        <div class="footer">
          <p>© 2025 GoatTech - Phụ kiện điện thoại cao cấp</p>
          <p>
            Email này được gửi tự động. Nếu bạn không yêu cầu, vui lòng bỏ qua.
          </p>
        </div>
      </div>
    </body>
    </html>
    `;

    console.log('📧 Attempting to send email...');
    console.log('📧 From:', `"GoatTech Gift 🎁" <${process.env.EMAIL_USER || 'noreply@goattech.vn'}>`);
    console.log('📧 To:', data.recipientEmail);
    
    const result = await this.transporter.sendMail({
      from: `"GoatTech Gift 🎁" <${process.env.EMAIL_USER || 'noreply@goattech.vn'}>`,
      to: data.recipientEmail,
      subject: `🎁 ${data.senderName} đã gửi tặng bạn một món quà!`,
      html: htmlContent,
    });
    
    console.log('✅ Email sent successfully!', result);
  }

  // Xác nhận mã để nhận quà
  async verifyGift(dto: VerifyGiftDto) {
    const { data: gift, error } = await this.supabaseService.getGiftById(dto.giftId);

    if (error || !gift) {
      throw new NotFoundException('Không tìm thấy quà tặng');
    }

    if (gift.status === 'claimed') {
      throw new BadRequestException('Quà tặng đã được nhận');
    }

    if (gift.status === 'expired' || new Date(gift.expires_at) < new Date()) {
      throw new BadRequestException('Quà tặng đã hết hạn');
    }

    if (gift.verification_code !== dto.verificationCode) {
      throw new BadRequestException('Mã xác nhận không đúng');
    }

    // Cập nhật trạng thái
    await this.supabaseService.updateGiftStatus(dto.giftId, 'verified');

    return {
      success: true,
      message: 'Xác nhận thành công!',
      gift: {
        ...gift,
        verification_code: undefined, // Không trả về mã
      },
    };
  }

  // Nhận quà (sau khi đã xác nhận)
  async claimGift(dto: ClaimGiftDto) {
    const { data: gift, error } = await this.supabaseService.getGiftById(dto.giftId);

    if (error || !gift) {
      throw new NotFoundException('Không tìm thấy quà tặng');
    }

    if (gift.status === 'claimed') {
      throw new BadRequestException('Quà tặng đã được nhận');
    }

    if (gift.status !== 'verified') {
      throw new BadRequestException('Vui lòng xác nhận mã trước khi nhận quà');
    }

    // Tạo đơn hàng cho quà tặng
    const { data: order, error: orderError } = await this.supabaseService.createOrder({
      user_id: null, // Guest order
      total_amount: 0, // Free gift
      status: 'confirmed',
      payment_method: 'gift',
      payment_status: 'paid',
      shipping_address: dto.recipientAddress,
      phone: dto.recipientPhone,
      notes: `Quà tặng từ ${gift.sender_name} (${gift.sender_email})`,
    });

    if (orderError || !order) {
      throw new BadRequestException('Không thể tạo đơn hàng');
    }

    const orderData = order as any;
    const orderId = Array.isArray(orderData) ? orderData[0]?.order_id : orderData.order_id;

    // Thêm sản phẩm vào đơn hàng
    await this.supabaseService.createOrderItem({
      order_id: orderId,
      product_id: gift.product_id,
      quantity: gift.quantity,
      price: 0, // Free
    });

    // Cập nhật trạng thái gift
    await this.supabaseService.updateGiftStatus(dto.giftId, 'claimed', {
      recipient_address: dto.recipientAddress,
      recipient_phone: dto.recipientPhone,
    });

    // Gửi email xác nhận cho người nhận
    try {
      await this.sendClaimConfirmationEmail({
        recipientEmail: gift.recipient_email,
        recipientName: gift.recipient_name,
        productName: gift.products.product_name,
        orderId: orderId,
      });
    } catch (e) {
      console.error('Failed to send confirmation email:', e);
    }

    return {
      success: true,
      message: 'Nhận quà thành công! Đơn hàng đã được tạo.',
      orderId: orderId,
    };
  }

  // Email xác nhận đã nhận quà
  private async sendClaimConfirmationEmail(data: {
    recipientEmail: string;
    recipientName: string;
    productName: string;
    orderId: number;
  }) {
    const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #10b981, #059669); padding: 40px 20px; text-align: center; color: white; }
        .content { padding: 30px; }
        .order-box { background: #f0fdf4; padding: 20px; border-radius: 12px; text-align: center; }
        .footer { background: #1f2937; color: #9ca3af; padding: 20px; text-align: center; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>✅ Nhận Quà Thành Công!</h1>
        </div>
        <div class="content">
          <p>Xin chào <strong>${data.recipientName}</strong>,</p>
          <p>Bạn đã nhận thành công quà tặng:</p>
          <div class="order-box">
            <h3>${data.productName}</h3>
            <p>Mã đơn hàng: <strong>#${data.orderId}</strong></p>
          </div>
          <p>Chúng tôi sẽ sớm giao hàng đến địa chỉ của bạn!</p>
        </div>
        <div class="footer">
          <p>© 2025 GoatTech</p>
        </div>
      </div>
    </body>
    </html>
    `;

    await this.transporter.sendMail({
      from: `"GoatTech" <${process.env.EMAIL_USER}>`,
      to: data.recipientEmail,
      subject: `✅ Bạn đã nhận quà thành công - Đơn hàng #${data.orderId}`,
      html: htmlContent,
    });
  }

  // Lấy thông tin quà tặng (public - không cần auth)
  async getGiftInfo(giftId: string) {
    const { data: gift, error } = await this.supabaseService.getGiftPublicInfo(giftId);

    if (error || !gift) {
      throw new NotFoundException('Không tìm thấy quà tặng');
    }

    return gift;
  }

  // Lấy danh sách quà đã gửi (cho user)
  async getSentGifts(userId: string) {
    const { data, error } = await this.supabaseService.getSentGifts(userId);

    if (error) {
      throw new BadRequestException('Không thể lấy danh sách quà tặng');
    }

    return data;
  }

  // Lấy danh sách quà đã nhận (theo email)
  async getReceivedGifts(email: string) {
    const { data, error } = await this.supabaseService.getReceivedGifts(email);

    if (error) {
      throw new BadRequestException('Không thể lấy danh sách quà tặng');
    }

    return data;
  }
}




################################################################################
## FILE 50: gift.module.ts
## Path: backend/src/gift/gift.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { GiftController } from './gift.controller';
import { GiftService } from './gift.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [GiftController],
  providers: [GiftService, SupabaseService],
  exports: [GiftService],
})
export class GiftModule {}




################################################################################
## FILE 51: gift.controller.ts
## Path: backend/src/gift/gift.controller.ts
################################################################################

import {
  Controller,
  Post,
  Get,
  Body,
  Param,
  Query,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { GiftService } from './gift.service';

// DTOs
class SendGiftDto {
  senderName: string;
  senderEmail: string;
  senderMessage?: string;
  senderId?: string;
  recipientName: string;
  recipientEmail: string;
  recipientPhone?: string;
  recipientAddress?: string;
  productId: number;
  quantity?: number;
}

class VerifyGiftDto {
  giftId: string;
  verificationCode: string;
}

class ClaimGiftDto {
  giftId: string;
  recipientAddress: string;
  recipientPhone: string;
}

@Controller('gift')
export class GiftController {
  constructor(private readonly giftService: GiftService) {}

  // POST /gift/send - Gửi quà tặng
  @Post('send')
  @HttpCode(HttpStatus.CREATED)
  async sendGift(@Body() dto: SendGiftDto) {
    return this.giftService.sendGift(dto);
  }

  // POST /gift/verify - Xác nhận mã
  @Post('verify')
  @HttpCode(HttpStatus.OK)
  async verifyGift(@Body() dto: VerifyGiftDto) {
    return this.giftService.verifyGift(dto);
  }

  // POST /gift/claim - Nhận quà
  @Post('claim')
  @HttpCode(HttpStatus.OK)
  async claimGift(@Body() dto: ClaimGiftDto) {
    return this.giftService.claimGift(dto);
  }

  // GET /gift/:giftId - Lấy thông tin quà (public)
  @Get(':giftId')
  async getGiftInfo(@Param('giftId') giftId: string) {
    return this.giftService.getGiftInfo(giftId);
  }

  // GET /gift/sent/:userId - Lấy quà đã gửi
  @Get('sent/:userId')
  async getSentGifts(@Param('userId') userId: string) {
    return this.giftService.getSentGifts(userId);
  }

  // GET /gift/received?email=xxx - Lấy quà đã nhận
  @Get('received/by-email')
  async getReceivedGifts(@Query('email') email: string) {
    return this.giftService.getReceivedGifts(email);
  }
}




################################################################################
## FILE 52: messenger.types.ts
## Path: backend/src/messenger/messenger.types.ts
################################################################################

/**
 * Facebook Messenger Bot Types
 * Định nghĩa các kiểu dữ liệu cho Messenger Bot
 */

// Trạng thái của cuộc hội thoại đặt hàng
export enum ConversationState {
  IDLE = 'IDLE',                           // Chờ người dùng bắt đầu
  WAITING_PRODUCT = 'WAITING_PRODUCT',     // Đang chờ chọn sản phẩm
  WAITING_PHONE_MODEL = 'WAITING_PHONE_MODEL', // Đang chờ chọn dòng máy điện thoại
  WAITING_QUANTITY = 'WAITING_QUANTITY',   // Đang chờ nhập số lượng
  WAITING_COLOR = 'WAITING_COLOR',         // Đang chờ chọn màu sắc
  WAITING_NAME = 'WAITING_NAME',           // Đang chờ nhập tên
  WAITING_PHONE = 'WAITING_PHONE',         // Đang chờ nhập số điện thoại
  WAITING_ADDRESS = 'WAITING_ADDRESS',     // Đang chờ nhập địa chỉ
  WAITING_CONFIRM = 'WAITING_CONFIRM',     // Đang chờ xác nhận đơn hàng
}

// Thông tin sản phẩm
export interface Product {
  id: string;
  name: string;
  price: number;
  emoji: string;
  description?: string;
  colors?: string[];
  image_url?: string;
  stock_quantity?: number;
}

// Thông tin dòng máy điện thoại
export interface PhoneModelInfo {
  model_id: number;
  brand_name: string;
  model_name: string;
}

// Dữ liệu phiên đặt hàng của khách
export interface UserSession {
  state: ConversationState;
  selectedProduct?: Product;
  selectedPhoneModel?: PhoneModelInfo;
  quantity?: number;
  color?: string;
  customerName?: string;
  phone?: string;
  address?: string;
  notes?: string;
  createdAt: Date;
  updatedAt: Date;
}

// Đơn hàng từ Messenger
export interface MessengerOrder {
  id?: string;
  facebook_user_id: string;
  customer_name: string;
  phone: string;
  address: string;
  product_name: string;
  product_price: number;
  quantity: number;
  color?: string;
  phone_model_id?: number;
  phone_model_name?: string;
  notes?: string;
  total_price: number;
  status: OrderStatus;
  created_at?: Date;
  updated_at?: Date;
}

// Trạng thái đơn hàng
export enum OrderStatus {
  PENDING = 'pending',
  CONFIRMED = 'confirmed',
  PROCESSING = 'processing',
  SHIPPING = 'shipping',
  DELIVERED = 'delivered',
  CANCELLED = 'cancelled',
}

// Payload từ Facebook Webhook
export interface FacebookWebhookPayload {
  object: string;
  entry: FacebookEntry[];
}

export interface FacebookEntry {
  id: string;
  time: number;
  messaging: FacebookMessaging[];
}

export interface FacebookMessaging {
  sender: { id: string };
  recipient: { id: string };
  timestamp: number;
  message?: FacebookMessage;
  postback?: FacebookPostback;
}

export interface FacebookMessage {
  mid: string;
  text?: string;
  quick_reply?: {
    payload: string;
  };
  attachments?: any[];
}

export interface FacebookPostback {
  title: string;
  payload: string;
}

// Quick Reply Button
export interface QuickReply {
  content_type: 'text';
  title: string;
  payload: string;
}

// Generic Template Element
export interface GenericElement {
  title: string;
  subtitle?: string;
  image_url?: string;
  buttons?: Button[];
}

// Button types
export interface Button {
  type: 'postback' | 'web_url' | 'phone_number';
  title: string;
  payload?: string;
  url?: string;
}

// Response message types
export interface TextMessage {
  text: string;
  quick_replies?: QuickReply[];
}

export interface TemplateMessage {
  attachment: {
    type: 'template';
    payload: {
      template_type: 'generic' | 'button' | 'receipt';
      elements?: GenericElement[];
      text?: string;
      buttons?: Button[];
    };
  };
}

// Webhook để gửi đến hệ thống quản lý
export interface WebhookOrderPayload {
  customer_name: string;
  phone: string;
  address: string;
  product: string;
  quantity: number;
  color?: string;
  notes?: string;
  total_price: number;
  facebook_user_id: string;
  order_id?: string;
  created_at: string;
}




################################################################################
## FILE 53: messenger.service.ts
## Path: backend/src/messenger/messenger.service.ts
################################################################################

/**
 * Messenger Service
 * Xử lý logic chính của Facebook Messenger Bot
 */

import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import axios from 'axios';
import {
  ConversationState,
  UserSession,
  Product,
  MessengerOrder,
  OrderStatus,
  FacebookWebhookPayload,
  FacebookMessaging,
  QuickReply,
  WebhookOrderPayload,
  PhoneModelInfo,
} from './messenger.types';

// Interface cho Phone Model từ database
interface PhoneModel {
  model_id: number;
  brand_name: string;
  model_name: string;
  model_code?: string;
  is_popular: boolean;
  is_active: boolean;
}

@Injectable()
export class MessengerService {
  private readonly logger = new Logger(MessengerService.name);
  private supabase: SupabaseClient;
  
  // Lưu trữ session của người dùng (trong production nên dùng Redis)
  private userSessions: Map<string, UserSession> = new Map();
  
  // Cache sản phẩm từ database (refresh mỗi 5 phút)
  private productsCache: Product[] = [];
  private productsCacheTime: Date | null = null;
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 phút

  // Cache phone models
  private phoneModelsCache: PhoneModel[] = [];
  private phoneModelsCacheTime: Date | null = null;

  // Facebook API URL
  private readonly FB_API_URL = 'https://graph.facebook.com/v18.0/me/messages';

  constructor(private configService: ConfigService) {
    // Khởi tạo Supabase client
    this.supabase = createClient(
      this.configService.get('SUPABASE_URL') || '',
      this.configService.get('SUPABASE_SERVICE_ROLE_KEY') || '',
    );
    this.logger.log('MessengerService đã được khởi tạo');
    
    // Load sản phẩm từ database khi khởi tạo
    this.loadProductsFromDatabase();
    // Load phone models
    this.loadPhoneModelsFromDatabase();
  }

  /**
   * Lấy sản phẩm từ database với cache
   */
  private async loadProductsFromDatabase(): Promise<Product[]> {
    try {
      // Kiểm tra cache còn hiệu lực không
      if (
        this.productsCache.length > 0 &&
        this.productsCacheTime &&
        Date.now() - this.productsCacheTime.getTime() < this.CACHE_DURATION
      ) {
        return this.productsCache;
      }

      this.logger.log('Đang tải sản phẩm từ database...');

      // Lấy sản phẩm kèm variants để có màu sắc
      const { data, error } = await this.supabase
        .from('products')
        .select(`
          product_id,
          product_name,
          price,
          sale_price,
          description,
          image_url,
          status,
          categories (
            category_name
          ),
          product_variants (
            color,
            is_active
          ),
          inventory (
            quantity_available
          )
        `)
        .eq('status', 'active')
        .order('product_name');

      if (error) {
        this.logger.error(`Lỗi lấy sản phẩm: ${error.message}`);
        return this.productsCache; // Trả về cache cũ nếu lỗi
      }

      // Chuyển đổi sang format Product
      this.productsCache = (data || [])
        .filter((p: any) => {
          // Lọc sản phẩm còn hàng
          const totalStock = (p.inventory || []).reduce((sum: number, inv: any) => sum + (inv.quantity_available || 0), 0);
          return totalStock > 0 || p.inventory?.length === 0; // Nếu không có inventory thì vẫn hiện
        })
        .map((p: any): Product => {
          // Lấy danh sách màu từ variants
          const colors: string[] = (p.product_variants || [])
            .filter((v: any) => v.is_active && v.color)
            .map((v: any) => v.color as string);
          
          // Tính tổng stock
          const totalStock = (p.inventory || []).reduce((sum: number, inv: any) => sum + (inv.quantity_available || 0), 0);

          return {
            id: p.product_id.toString(),
            name: p.product_name,
            price: p.sale_price || p.price,
            emoji: this.getProductEmoji(p.categories?.category_name || ''),
            description: p.description || 'Sản phẩm chất lượng cao',
            colors: colors.length > 0 ? [...new Set(colors)] as string[] : ['Mặc định'], // Unique colors
            image_url: p.image_url,
            stock_quantity: totalStock,
          };
        });

      this.productsCacheTime = new Date();
      this.logger.log(`Đã tải ${this.productsCache.length} sản phẩm từ database`);

      return this.productsCache;
    } catch (error) {
      this.logger.error(`Lỗi loadProductsFromDatabase: ${error.message}`);
      return this.productsCache;
    }
  }

  /**
   * Lấy phone models từ database với cache
   */
  private async loadPhoneModelsFromDatabase(): Promise<PhoneModel[]> {
    try {
      // Kiểm tra cache còn hiệu lực không
      if (
        this.phoneModelsCache.length > 0 &&
        this.phoneModelsCacheTime &&
        Date.now() - this.phoneModelsCacheTime.getTime() < this.CACHE_DURATION
      ) {
        return this.phoneModelsCache;
      }

      this.logger.log('Đang tải phone models từ database...');

      const { data, error } = await this.supabase
        .from('phone_models')
        .select('model_id, brand_name, model_name, model_code, is_popular, is_active')
        .eq('is_active', true)
        .order('is_popular', { ascending: false })
        .order('brand_name')
        .order('model_name');

      if (error) {
        this.logger.error(`Lỗi lấy phone models: ${error.message}`);
        return this.phoneModelsCache;
      }

      this.phoneModelsCache = data || [];
      this.phoneModelsCacheTime = new Date();
      this.logger.log(`Đã tải ${this.phoneModelsCache.length} phone models từ database`);

      return this.phoneModelsCache;
    } catch (error) {
      this.logger.error(`Lỗi loadPhoneModelsFromDatabase: ${error.message}`);
      return this.phoneModelsCache;
    }
  }

  /**
   * Lấy danh sách brands từ phone models
   */
  private async getPhoneBrands(): Promise<string[]> {
    const models = await this.loadPhoneModelsFromDatabase();
    const brands = [...new Set(models.map(m => m.brand_name))];
    return brands;
  }

  /**
   * Lấy phone models theo brand
   */
  private async getPhoneModelsByBrand(brandName: string): Promise<PhoneModel[]> {
    const models = await this.loadPhoneModelsFromDatabase();
    return models.filter(m => m.brand_name.toLowerCase() === brandName.toLowerCase());
  }

  /**
   * Lấy danh sách phone models (public API)
   */
  async getPhoneModelList(): Promise<{ brand: string; models: PhoneModel[] }[]> {
    const models = await this.loadPhoneModelsFromDatabase();
    
    // Group by brand
    const groupedByBrand: { [key: string]: PhoneModel[] } = {};
    models.forEach((model) => {
      if (!groupedByBrand[model.brand_name]) {
        groupedByBrand[model.brand_name] = [];
      }
      groupedByBrand[model.brand_name].push(model);
    });

    // Convert to array format
    return Object.entries(groupedByBrand).map(([brand, brandModels]) => ({
      brand,
      models: brandModels,
    }));
  }

  /**
   * Lấy emoji theo category
   */
  private getProductEmoji(categoryName: string): string {
    const emojiMap: Record<string, string> = {
      'Ốp lưng': '📱',
      'Ốp điện thoại': '📱',
      'Phụ kiện': '🎧',
      'Sạc': '🔌',
      'Cáp': '🔗',
      'Tai nghe': '🎧',
      'Bao da': '👜',
      'Kính cường lực': '✨',
      'Giá đỡ': '📐',
    };
    
    for (const [key, emoji] of Object.entries(emojiMap)) {
      if (categoryName.toLowerCase().includes(key.toLowerCase())) {
        return emoji;
      }
    }
    return '📦'; // Default emoji
  }

  /**
   * Lấy danh sách sản phẩm (public)
   */
  async getProducts(): Promise<Product[]> {
    return this.loadProductsFromDatabase();
  }

  /**
   * Xác minh webhook từ Facebook
   */
  verifyWebhook(mode: string, token: string, challenge: string): string | null {
    const verifyToken = this.configService.get('FACEBOOK_VERIFY_TOKEN');
    
    this.logger.log(`Xác minh webhook - Mode: ${mode}, Token: ${token}`);
    
    if (mode === 'subscribe' && token === verifyToken) {
      this.logger.log('Webhook đã được xác minh thành công!');
      return challenge;
    }
    
    this.logger.warn('Xác minh webhook thất bại!');
    return null;
  }

  /**
   * Xử lý webhook event từ Facebook
   */
  async handleWebhook(payload: FacebookWebhookPayload): Promise<void> {
    try {
      this.logger.log(`Nhận webhook: ${JSON.stringify(payload)}`);

      if (payload.object !== 'page') {
        this.logger.warn('Không phải page event, bỏ qua');
        return;
      }

      // Xử lý từng entry
      for (const entry of payload.entry) {
        for (const event of entry.messaging) {
          await this.processMessagingEvent(event);
        }
      }
    } catch (error) {
      this.logger.error(`Lỗi xử lý webhook: ${error.message}`, error.stack);
      throw error;
    }
  }

  /**
   * Xử lý từng messaging event
   */
  private async processMessagingEvent(event: FacebookMessaging): Promise<void> {
    const senderId = event.sender.id;
    
    this.logger.log(`Xử lý event từ user: ${senderId}`);

    // Xử lý postback (khi user click button)
    if (event.postback) {
      await this.handlePostback(senderId, event.postback.payload);
      return;
    }

    // Xử lý tin nhắn
    if (event.message) {
      // Xử lý quick reply
      if (event.message.quick_reply) {
        await this.handleQuickReply(senderId, event.message.quick_reply.payload);
        return;
      }

      // Xử lý tin nhắn text thông thường
      if (event.message.text) {
        await this.handleTextMessage(senderId, event.message.text);
        return;
      }
    }
  }

  /**
   * Xử lý postback (button clicks)
   */
  private async handlePostback(senderId: string, payload: string): Promise<void> {
    this.logger.log(`Postback từ ${senderId}: ${payload}`);

    switch (payload) {
      case 'GET_STARTED':
        await this.sendWelcomeMessage(senderId);
        break;
      case 'VIEW_PRODUCTS':
        await this.sendProductList(senderId);
        break;
      case 'VIEW_ORDERS':
        await this.sendOrderHistory(senderId);
        break;
      case 'CONTACT_SUPPORT':
        await this.sendSupportInfo(senderId);
        break;
      default:
        // Xử lý chọn sản phẩm
        if (payload.startsWith('PRODUCT_')) {
          const productId = payload.replace('PRODUCT_', '');
          await this.handleProductSelection(senderId, productId);
        }
        break;
    }
  }

  /**
   * Xử lý quick reply
   */
  private async handleQuickReply(senderId: string, payload: string): Promise<void> {
    this.logger.log(`Quick reply từ ${senderId}: ${payload}`);

    // Xử lý xác nhận đơn hàng
    if (payload === 'CONFIRM_ORDER') {
      await this.confirmOrder(senderId);
      return;
    }
    if (payload === 'CANCEL_ORDER') {
      await this.cancelOrder(senderId);
      return;
    }

    // Xử lý chọn sản phẩm
    if (payload.startsWith('PRODUCT_')) {
      const productId = payload.replace('PRODUCT_', '');
      await this.handleProductSelection(senderId, productId);
      return;
    }

    // Xử lý chọn màu sắc
    if (payload.startsWith('COLOR_')) {
      const color = payload.replace('COLOR_', '');
      await this.handleColorSelection(senderId, color);
      return;
    }

    // Xử lý chọn brand điện thoại
    if (payload.startsWith('BRAND_')) {
      const brand = payload.replace('BRAND_', '');
      await this.handleBrandSelection(senderId, brand);
      return;
    }

    // Xử lý chọn dòng máy điện thoại
    if (payload.startsWith('PHONEMODEL_')) {
      const modelId = payload.replace('PHONEMODEL_', '');
      await this.handlePhoneModelSelection(senderId, parseInt(modelId));
      return;
    }

    // Xử lý menu sản phẩm
    if (payload === 'MENU_PRODUCTS' || payload === 'VIEW_PRODUCTS') {
      await this.sendProductList(senderId);
      return;
    }

    // Xử lý xem đơn hàng
    if (payload === 'VIEW_ORDERS') {
      await this.sendOrderHistory(senderId);
      return;
    }

    // Xử lý hỗ trợ
    if (payload === 'CONTACT_SUPPORT') {
      await this.sendSupportInfo(senderId);
      return;
    }

    // Xử lý menu
    if (payload === 'MENU') {
      await this.sendMainMenu(senderId);
      return;
    }
  }

  /**
   * Xử lý tin nhắn text
   */
  private async handleTextMessage(senderId: string, text: string): Promise<void> {
    const normalizedText = text.toLowerCase().trim();
    this.logger.log(`Tin nhắn từ ${senderId}: ${text}`);

    // Lấy session hiện tại của user
    const session = this.getUserSession(senderId);

    // Xử lý các lệnh cơ bản
    if (['menu', 'hi', 'hello', 'xin chào', 'chào', 'start', 'bắt đầu'].includes(normalizedText)) {
      await this.sendWelcomeMessage(senderId);
      return;
    }

    if (['sản phẩm', 'xem sản phẩm', 'mua hàng', 'products'].includes(normalizedText)) {
      await this.sendProductList(senderId);
      return;
    }

    if (['đơn hàng', 'xem đơn', 'orders', 'lịch sử'].includes(normalizedText)) {
      await this.sendOrderHistory(senderId);
      return;
    }

    if (['hỗ trợ', 'support', 'liên hệ', 'contact'].includes(normalizedText)) {
      await this.sendSupportInfo(senderId);
      return;
    }

    if (['hủy', 'cancel', 'bỏ', 'dừng'].includes(normalizedText)) {
      await this.cancelOrder(senderId);
      return;
    }

    // Xử lý theo trạng thái conversation
    switch (session.state) {
      case ConversationState.WAITING_QUANTITY:
        await this.handleQuantityInput(senderId, text);
        break;
      case ConversationState.WAITING_NAME:
        await this.handleNameInput(senderId, text);
        break;
      case ConversationState.WAITING_PHONE:
        await this.handlePhoneInput(senderId, text);
        break;
      case ConversationState.WAITING_ADDRESS:
        await this.handleAddressInput(senderId, text);
        break;
      case ConversationState.WAITING_CONFIRM:
        await this.handleConfirmInput(senderId, text);
        break;
      default:
        // Không hiểu tin nhắn, gửi menu
        await this.sendUnknownMessage(senderId);
        break;
    }
  }

  /**
   * Gửi tin nhắn chào mừng
   */
  private async sendWelcomeMessage(senderId: string): Promise<void> {
    // Reset session
    this.resetUserSession(senderId);

    const welcomeText = `Xin chào! 👋 Chào mừng bạn đến với Cửa hàng Ốp điện thoại & Phụ kiện! 📱

🛍️ Chúng tôi chuyên cung cấp:
• Ốp lưng điện thoại cao cấp
• Phụ kiện chính hãng
• Giá cả hợp lý, chất lượng đảm bảo

Bạn muốn làm gì hôm nay?`;

    await this.sendMessage(senderId, { text: welcomeText });
    await this.sendMainMenu(senderId);
  }

  /**
   * Gửi menu chính
   */
  private async sendMainMenu(senderId: string): Promise<void> {
    const quickReplies: QuickReply[] = [
      { content_type: 'text', title: '📱 Xem sản phẩm', payload: 'MENU_PRODUCTS' },
      { content_type: 'text', title: '📦 Đơn hàng của tôi', payload: 'VIEW_ORDERS' },
      { content_type: 'text', title: '💬 Hỗ trợ', payload: 'CONTACT_SUPPORT' },
    ];

    await this.sendMessage(senderId, {
      text: 'Chọn một trong các tùy chọn bên dưới:',
      quick_replies: quickReplies,
    });
  }

  /**
   * Gửi danh sách sản phẩm
   */
  private async sendProductList(senderId: string): Promise<void> {
    // Cập nhật trạng thái
    this.updateUserSession(senderId, { state: ConversationState.WAITING_PRODUCT });

    // Lấy sản phẩm từ database
    const products = await this.loadProductsFromDatabase();

    if (products.length === 0) {
      await this.sendMessage(senderId, {
        text: '😔 Hiện tại chưa có sản phẩm nào. Vui lòng quay lại sau!',
      });
      await this.sendMainMenu(senderId);
      return;
    }

    // Giới hạn 10 sản phẩm (Facebook quick reply tối đa 13)
    const displayProducts = products.slice(0, 10);

    const productText = `📱 DANH SÁCH SẢN PHẨM 📱

${displayProducts.map((p, i) => `${i + 1}. ${p.emoji} ${p.name} - ${this.formatPrice(p.price)}`).join('\n')}

Chọn sản phẩm bạn muốn mua:`;

    // Rút gọn tên nếu quá dài (Facebook giới hạn 20 ký tự cho title)
    const quickReplies: QuickReply[] = displayProducts.map((p) => ({
      content_type: 'text' as const,
      title: this.truncateText(`${p.emoji} ${p.name}`, 20),
      payload: `PRODUCT_${p.id}`,
    }));

    await this.sendMessage(senderId, {
      text: productText,
      quick_replies: quickReplies,
    });
  }

  /**
   * Rút gọn text nếu quá dài
   */
  private truncateText(text: string, maxLength: number): string {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength - 3) + '...';
  }

  /**
   * Xử lý khi khách chọn sản phẩm
   */
  private async handleProductSelection(senderId: string, productId: string): Promise<void> {
    const products = await this.loadProductsFromDatabase();
    const product = products.find((p) => p.id === productId);
    
    if (!product) {
      await this.sendMessage(senderId, { text: '❌ Sản phẩm không tồn tại. Vui lòng chọn lại.' });
      await this.sendProductList(senderId);
      return;
    }

    // Lưu sản phẩm đã chọn
    this.updateUserSession(senderId, {
      selectedProduct: product,
      state: ConversationState.WAITING_PHONE_MODEL,
    });

    this.logger.log(`User ${senderId} đã chọn sản phẩm: ${product.name}`);

    // Gửi thông tin sản phẩm và hỏi chọn dòng máy
    const productInfo = `✅ Bạn đã chọn: ${product.emoji} ${product.name}
💰 Giá: ${this.formatPrice(product.price)}
📝 Mô tả: ${product.description}

📱 Vui lòng chọn HÃNG điện thoại của bạn:`;

    // Lấy danh sách brands
    const brands = await this.getPhoneBrands();
    
    if (brands.length === 0) {
      // Nếu không có phone models trong database, bỏ qua bước này
      this.updateUserSession(senderId, {
        state: ConversationState.WAITING_COLOR,
      });
      await this.sendColorSelection(senderId, product);
      return;
    }

    // Giới hạn 10 brands (Facebook quick reply tối đa 13)
    const displayBrands = brands.slice(0, 10);
    
    const brandReplies: QuickReply[] = displayBrands.map((brand) => ({
      content_type: 'text' as const,
      title: this.getBrandEmoji(brand) + ' ' + this.truncateText(brand, 17),
      payload: `BRAND_${brand}`,
    }));

    await this.sendMessage(senderId, {
      text: productInfo,
      quick_replies: brandReplies,
    });
  }

  /**
   * Lấy emoji cho brand điện thoại
   */
  private getBrandEmoji(brand: string): string {
    const emojiMap: Record<string, string> = {
      'Apple': '🍎',
      'Samsung': '📱',
      'Xiaomi': '🔷',
      'OPPO': '💚',
      'Vivo': '💙',
      'Realme': '💛',
      'Huawei': '🔴',
      'OnePlus': '🔴',
      'Google': '🔵',
      'Sony': '⚫',
    };
    return emojiMap[brand] || '📱';
  }

  /**
   * Xử lý khi khách chọn brand điện thoại
   */
  private async handleBrandSelection(senderId: string, brandName: string): Promise<void> {
    this.logger.log(`User ${senderId} đã chọn brand: ${brandName}`);

    const models = await this.getPhoneModelsByBrand(brandName);
    
    if (models.length === 0) {
      await this.sendMessage(senderId, { 
        text: `❌ Không tìm thấy dòng máy cho ${brandName}. Vui lòng chọn hãng khác.` 
      });
      // Gửi lại danh sách brands
      const brands = await this.getPhoneBrands();
      const brandReplies: QuickReply[] = brands.slice(0, 10).map((brand) => ({
        content_type: 'text' as const,
        title: this.getBrandEmoji(brand) + ' ' + this.truncateText(brand, 17),
        payload: `BRAND_${brand}`,
      }));
      await this.sendMessage(senderId, {
        text: '📱 Chọn hãng điện thoại:',
        quick_replies: brandReplies,
      });
      return;
    }

    // Giới hạn 10 models (Facebook quick reply tối đa 13)
    const displayModels = models.slice(0, 10);
    
    const modelText = `📱 Dòng máy ${brandName}:

${displayModels.map((m, i) => `${i + 1}. ${m.model_name}${m.is_popular ? ' ⭐' : ''}`).join('\n')}

Chọn dòng máy của bạn:`;

    const modelReplies: QuickReply[] = displayModels.map((model) => ({
      content_type: 'text' as const,
      title: this.truncateText(model.model_name, 20),
      payload: `PHONEMODEL_${model.model_id}`,
    }));

    await this.sendMessage(senderId, {
      text: modelText,
      quick_replies: modelReplies,
    });
  }

  /**
   * Xử lý khi khách chọn dòng máy điện thoại
   */
  private async handlePhoneModelSelection(senderId: string, modelId: number): Promise<void> {
    const models = await this.loadPhoneModelsFromDatabase();
    const selectedModel = models.find(m => m.model_id === modelId);
    
    if (!selectedModel) {
      await this.sendMessage(senderId, { text: '❌ Dòng máy không tồn tại. Vui lòng chọn lại.' });
      return;
    }

    // Lưu dòng máy đã chọn
    this.updateUserSession(senderId, {
      selectedPhoneModel: {
        model_id: selectedModel.model_id,
        brand_name: selectedModel.brand_name,
        model_name: selectedModel.model_name,
      },
      state: ConversationState.WAITING_COLOR,
    });

    this.logger.log(`User ${senderId} đã chọn dòng máy: ${selectedModel.brand_name} ${selectedModel.model_name}`);

    // Chuyển sang chọn màu
    const session = this.getUserSession(senderId);
    if (session.selectedProduct) {
      await this.sendMessage(senderId, {
        text: `✅ Dòng máy: ${selectedModel.brand_name} ${selectedModel.model_name}`,
      });
      await this.sendColorSelection(senderId, session.selectedProduct);
    }
  }

  /**
   * Gửi lựa chọn màu sắc
   */
  private async sendColorSelection(senderId: string, product: Product): Promise<void> {
    const colorText = `🎨 Vui lòng chọn màu sắc:`;

    const colorReplies: QuickReply[] = (product.colors || []).map((color) => ({
      content_type: 'text' as const,
      title: color,
      payload: `COLOR_${color}`,
    }));

    await this.sendMessage(senderId, {
      text: colorText,
      quick_replies: colorReplies,
    });
  }

  /**
   * Xử lý khi khách chọn màu sắc
   */
  private async handleColorSelection(senderId: string, color: string): Promise<void> {
    this.updateUserSession(senderId, {
      color: color,
      state: ConversationState.WAITING_QUANTITY,
    });

    this.logger.log(`User ${senderId} đã chọn màu: ${color}`);

    await this.sendMessage(senderId, {
      text: `🎨 Màu sắc: ${color}\n\n📦 Vui lòng nhập số lượng bạn muốn mua (1-99):`,
    });
  }

  /**
   * Xử lý nhập số lượng
   */
  private async handleQuantityInput(senderId: string, text: string): Promise<void> {
    const quantity = parseInt(text.trim(), 10);

    // Validate số lượng
    if (isNaN(quantity) || quantity < 1 || quantity > 99) {
      await this.sendMessage(senderId, {
        text: '❌ Số lượng không hợp lệ. Vui lòng nhập số từ 1 đến 99:',
      });
      return;
    }

    this.updateUserSession(senderId, {
      quantity: quantity,
      state: ConversationState.WAITING_NAME,
    });

    this.logger.log(`User ${senderId} đã nhập số lượng: ${quantity}`);

    await this.sendMessage(senderId, {
      text: `📦 Số lượng: ${quantity}\n\n👤 Vui lòng nhập HỌ VÀ TÊN người nhận hàng:`,
    });
  }

  /**
   * Xử lý nhập tên
   */
  private async handleNameInput(senderId: string, text: string): Promise<void> {
    const name = text.trim();

    // Validate tên
    if (name.length < 2 || name.length > 100) {
      await this.sendMessage(senderId, {
        text: '❌ Tên không hợp lệ. Vui lòng nhập họ tên đầy đủ (2-100 ký tự):',
      });
      return;
    }

    this.updateUserSession(senderId, {
      customerName: name,
      state: ConversationState.WAITING_PHONE,
    });

    this.logger.log(`User ${senderId} đã nhập tên: ${name}`);

    await this.sendMessage(senderId, {
      text: `👤 Tên: ${name}\n\n📞 Vui lòng nhập SỐ ĐIỆN THOẠI liên hệ (10-11 số):`,
    });
  }

  /**
   * Xử lý nhập số điện thoại
   */
  private async handlePhoneInput(senderId: string, text: string): Promise<void> {
    const phone = text.replace(/\s/g, '').trim();

    // Validate số điện thoại Việt Nam
    const phoneRegex = /^(0|84|\+84)?[3-9][0-9]{8}$/;
    if (!phoneRegex.test(phone)) {
      await this.sendMessage(senderId, {
        text: '❌ Số điện thoại không hợp lệ. Vui lòng nhập số điện thoại Việt Nam (VD: 0912345678):',
      });
      return;
    }

    // Chuẩn hóa số điện thoại
    let normalizedPhone = phone;
    if (phone.startsWith('+84')) {
      normalizedPhone = '0' + phone.slice(3);
    } else if (phone.startsWith('84')) {
      normalizedPhone = '0' + phone.slice(2);
    }

    this.updateUserSession(senderId, {
      phone: normalizedPhone,
      state: ConversationState.WAITING_ADDRESS,
    });

    this.logger.log(`User ${senderId} đã nhập SĐT: ${normalizedPhone}`);

    await this.sendMessage(senderId, {
      text: `📞 SĐT: ${normalizedPhone}\n\n🏠 Vui lòng nhập ĐỊA CHỈ giao hàng chi tiết (số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố):`,
    });
  }

  /**
   * Xử lý nhập địa chỉ
   */
  private async handleAddressInput(senderId: string, text: string): Promise<void> {
    const address = text.trim();

    // Validate địa chỉ
    if (address.length < 10 || address.length > 500) {
      await this.sendMessage(senderId, {
        text: '❌ Địa chỉ không hợp lệ. Vui lòng nhập địa chỉ chi tiết hơn (10-500 ký tự):',
      });
      return;
    }

    this.updateUserSession(senderId, {
      address: address,
      state: ConversationState.WAITING_CONFIRM,
    });

    this.logger.log(`User ${senderId} đã nhập địa chỉ: ${address}`);

    // Hiển thị xác nhận đơn hàng
    await this.sendOrderConfirmation(senderId);
  }

  /**
   * Gửi xác nhận đơn hàng
   */
  private async sendOrderConfirmation(senderId: string): Promise<void> {
    const session = this.getUserSession(senderId);
    const totalPrice = (session.selectedProduct?.price || 0) * (session.quantity || 0);

    // Tạo chuỗi hiển thị dòng máy nếu có
    const phoneModelText = session.selectedPhoneModel 
      ? `📱 Dòng máy: ${session.selectedPhoneModel.brand_name} ${session.selectedPhoneModel.model_name}\n` 
      : '';

    const confirmText = `📋 XÁC NHẬN ĐƠN HÀNG 📋
━━━━━━━━━━━━━━━━━━━━━

📱 Sản phẩm: ${session.selectedProduct?.emoji} ${session.selectedProduct?.name}
${phoneModelText}🎨 Màu sắc: ${session.color}
📦 Số lượng: ${session.quantity}
💰 Đơn giá: ${this.formatPrice(session.selectedProduct?.price || 0)}

━━━━━━━━━━━━━━━━━━━━━
💵 TỔNG TIỀN: ${this.formatPrice(totalPrice)}
━━━━━━━━━━━━━━━━━━━━━

👤 Người nhận: ${session.customerName}
📞 Điện thoại: ${session.phone}
🏠 Địa chỉ: ${session.address}

━━━━━━━━━━━━━━━━━━━━━
🚚 Phí ship: MIỄN PHÍ
💳 Thanh toán: Khi nhận hàng (COD)

Bạn xác nhận đặt hàng?`;

    const quickReplies: QuickReply[] = [
      { content_type: 'text', title: '✅ Xác nhận đặt hàng', payload: 'CONFIRM_ORDER' },
      { content_type: 'text', title: '❌ Hủy đơn', payload: 'CANCEL_ORDER' },
    ];

    await this.sendMessage(senderId, {
      text: confirmText,
      quick_replies: quickReplies,
    });
  }

  /**
   * Xử lý input xác nhận (text)
   */
  private async handleConfirmInput(senderId: string, text: string): Promise<void> {
    const normalizedText = text.toLowerCase().trim();

    if (['có', 'yes', 'ok', 'đồng ý', 'xác nhận', 'confirm'].includes(normalizedText)) {
      await this.confirmOrder(senderId);
    } else if (['không', 'no', 'hủy', 'cancel', 'bỏ'].includes(normalizedText)) {
      await this.cancelOrder(senderId);
    } else {
      await this.sendMessage(senderId, {
        text: 'Vui lòng chọn "Xác nhận đặt hàng" hoặc "Hủy đơn"',
      });
      await this.sendOrderConfirmation(senderId);
    }
  }

  /**
   * Xác nhận và lưu đơn hàng
   */
  private async confirmOrder(senderId: string): Promise<void> {
    const session = this.getUserSession(senderId);

    // Kiểm tra session có đủ thông tin không
    if (!session.selectedProduct || !session.customerName || !session.phone || !session.address) {
      await this.sendMessage(senderId, {
        text: '❌ Thông tin đơn hàng không đầy đủ. Vui lòng bắt đầu lại.',
      });
      await this.sendProductList(senderId);
      return;
    }

    try {
      const totalPrice = (session.selectedProduct.price || 0) * (session.quantity || 0);

      // Tạo đơn hàng
      const order: MessengerOrder = {
        facebook_user_id: senderId,
        customer_name: session.customerName,
        phone: session.phone,
        address: session.address,
        product_name: session.selectedProduct.name,
        product_price: session.selectedProduct.price,
        quantity: session.quantity || 1,
        color: session.color,
        phone_model_id: session.selectedPhoneModel?.model_id,
        phone_model_name: session.selectedPhoneModel 
          ? `${session.selectedPhoneModel.brand_name} ${session.selectedPhoneModel.model_name}` 
          : undefined,
        total_price: totalPrice,
        status: OrderStatus.PENDING,
      };

      // Lưu vào Supabase (bảng orders chính)
      const savedOrder = await this.saveOrderToSupabase(order);
      this.logger.log(`Đã lưu đơn hàng: ${JSON.stringify(savedOrder)}`);

      // Gửi webhook đến hệ thống quản lý
      await this.sendWebhookToAdmin(order, savedOrder?.order_number || savedOrder?.id);

      // Gửi thông báo thành công
      await this.sendMessage(senderId, {
        text: `🎉 ĐẶT HÀNG THÀNH CÔNG! 🎉
━━━━━━━━━━━━━━━━━━━━━

📦 Mã đơn hàng: #${savedOrder?.order_number || savedOrder?.id || 'N/A'}
💵 Tổng tiền: ${this.formatPrice(totalPrice)}

📞 Chúng tôi sẽ liên hệ xác nhận đơn hàng trong vòng 30 phút!

🚚 Dự kiến giao hàng: 2-3 ngày

Cảm ơn bạn đã mua hàng! ❤️`,
      });

      // Reset session
      this.resetUserSession(senderId);

      // Gửi menu tiếp tục mua hàng
      await this.sendMessage(senderId, {
        text: 'Bạn có muốn tiếp tục mua sắm không?',
        quick_replies: [
          { content_type: 'text', title: '📱 Xem sản phẩm', payload: 'MENU_PRODUCTS' },
          { content_type: 'text', title: '📦 Xem đơn hàng', payload: 'VIEW_ORDERS' },
        ],
      });
    } catch (error) {
      this.logger.error(`Lỗi lưu đơn hàng: ${error.message}`, error.stack);
      await this.sendMessage(senderId, {
        text: '❌ Có lỗi xảy ra khi xử lý đơn hàng. Vui lòng thử lại sau hoặc liên hệ hotline: 0123456789',
      });
    }
  }

  /**
   * Hủy đơn hàng
   */
  private async cancelOrder(senderId: string): Promise<void> {
    this.resetUserSession(senderId);

    await this.sendMessage(senderId, {
      text: '❌ Đã hủy đơn hàng.\n\nBạn có thể tiếp tục mua sắm bất cứ lúc nào!',
    });

    await this.sendMainMenu(senderId);
  }

  /**
   * Tạo mã đơn hàng duy nhất
   */
  private generateOrderNumber(): string {
    const date = new Date();
    const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
    const random = Math.random().toString(36).substring(2, 8).toUpperCase();
    return `MSG${dateStr}${random}`;
  }

  /**
   * Lưu đơn hàng vào bảng orders chính của hệ thống
   */
  private async saveOrderToSupabase(order: MessengerOrder): Promise<any> {
    try {
      const session = this.getUserSession(order.facebook_user_id);
      const orderNumber = this.generateOrderNumber();

      // 1. Tạo đơn hàng trong bảng orders chính
      const { data: orderData, error: orderError } = await this.supabase
        .from('orders')
        .insert([
          {
            order_number: orderNumber,
            // customer_id để null vì khách từ Messenger chưa có tài khoản
            // Facebook ID được lưu trong customer_note để tra cứu
            subtotal: order.total_price,
            discount_amount: 0,
            shipping_fee: 0,
            total_amount: order.total_price,
            payment_method: 'cod', // Thanh toán khi nhận hàng
            order_status: 'pending',
            payment_status: 'unpaid',
            shipping_full_name: order.customer_name,
            shipping_phone: order.phone,
            shipping_address: order.address,
            // Lưu Facebook ID ở đầu để dễ tra cứu
            customer_note: `[FB:${order.facebook_user_id}] ${order.customer_name} - ${order.phone}${order.phone_model_name ? ` | Dòng máy: ${order.phone_model_name}` : ''}${order.color ? ` | Màu: ${order.color}` : ''}`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          },
        ])
        .select()
        .single();

      if (orderError) {
        this.logger.error(`Lỗi tạo order: ${orderError.message}`);
        throw orderError;
      }

      this.logger.log(`Đã tạo đơn hàng #${orderData.order_id}`);

      // 2. Tạo order_items
      const { data: itemData, error: itemError } = await this.supabase
        .from('order_items')
        .insert([
          {
            order_id: orderData.order_id,
            product_id: parseInt(session.selectedProduct?.id || '0', 10),
            product_name: order.product_name,
            variant_name: order.color || null, // Lưu màu vào variant_name
            phone_model_id: order.phone_model_id || null,
            phone_model_name: order.phone_model_name || null,
            sku: `MSG-${Date.now()}`, // SKU tạm
            quantity: order.quantity,
            unit_price: order.product_price,
            discount_amount: 0,
            total_price: order.total_price,
          },
        ])
        .select();

      if (itemError) {
        this.logger.error(`Lỗi tạo order_item: ${itemError.message}`);
        // Không throw, vẫn tiếp tục
      }

      // 3. Cập nhật stock sản phẩm
      if (session.selectedProduct?.id) {
        const productId = parseInt(session.selectedProduct.id, 10);
        const { error: stockError } = await this.supabase.rpc('decrement_stock', {
          p_product_id: productId,
          p_quantity: order.quantity,
        });
        
        if (stockError) {
          this.logger.warn(`Không thể giảm stock: ${stockError.message}`);
          // Thử cách khác nếu function không tồn tại
          const { data: product } = await this.supabase
            .from('products')
            .select('stock_quantity')
            .eq('product_id', productId)
            .single();
          
          if (product) {
            await this.supabase
              .from('products')
              .update({ stock_quantity: Math.max(0, product.stock_quantity - order.quantity) })
              .eq('product_id', productId);
          }
        }
      }

      // Clear cache để lấy stock mới
      this.productsCacheTime = null;

      return {
        id: orderData.order_id,
        order_number: orderNumber,
        ...orderData,
      };
    } catch (error) {
      this.logger.error(`Lỗi lưu đơn hàng: ${error.message}`);
      throw error;
    }
  }

  /**
   * Gửi webhook đến hệ thống quản lý với retry logic
   */
  private async sendWebhookToAdmin(order: MessengerOrder, orderId?: string): Promise<void> {
    const webhookUrl = this.configService.get('WEBHOOK_URL');
    
    if (!webhookUrl) {
      this.logger.warn('WEBHOOK_URL chưa được cấu hình');
      return;
    }

    const payload: WebhookOrderPayload = {
      customer_name: order.customer_name,
      phone: order.phone,
      address: order.address,
      product: order.product_name,
      quantity: order.quantity,
      color: order.color,
      notes: order.notes,
      total_price: order.total_price,
      facebook_user_id: order.facebook_user_id,
      order_id: orderId,
      created_at: new Date().toISOString(),
    };

    // Retry 3 lần
    const maxRetries = 3;
    const retryDelay = 2000; // 2 giây

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        this.logger.log(`Gửi webhook (lần ${attempt}/${maxRetries}): ${webhookUrl}`);
        
        const response = await axios.post(webhookUrl, payload, {
          timeout: 5000, // 5 giây timeout
          headers: {
            'Content-Type': 'application/json',
          },
        });

        this.logger.log(`Webhook thành công: ${response.status}`);
        return;
      } catch (error) {
        this.logger.error(`Webhook thất bại (lần ${attempt}/${maxRetries}): ${error.message}`);
        
        if (attempt < maxRetries) {
          this.logger.log(`Chờ ${retryDelay}ms trước khi thử lại...`);
          await this.delay(retryDelay);
        }
      }
    }

    this.logger.error(`Webhook thất bại sau ${maxRetries} lần thử!`);
  }

  /**
   * Gửi lịch sử đơn hàng (lấy từ bảng orders chính)
   */
  private async sendOrderHistory(senderId: string): Promise<void> {
    try {
      // Tìm đơn hàng theo ghi chú có chứa Facebook ID [FB:xxxxx]
      const { data: orders, error } = await this.supabase
        .from('orders')
        .select(`
          order_id,
          order_number,
          total_amount,
          order_status,
          payment_status,
          created_at,
          order_items (
            product_name,
            quantity,
            variant_name
          )
        `)
        .ilike('customer_note', `%[FB:${senderId}]%`)
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) {
        throw error;
      }

      if (!orders || orders.length === 0) {
        await this.sendMessage(senderId, {
          text: '📦 Bạn chưa có đơn hàng nào.\n\nHãy bắt đầu mua sắm ngay!',
          quick_replies: [
            { content_type: 'text', title: '📱 Xem sản phẩm', payload: 'MENU_PRODUCTS' },
          ],
        });
        return;
      }

      let orderText = '📦 ĐƠN HÀNG CỦA BẠN 📦\n━━━━━━━━━━━━━━━━━━━━━\n\n';

      orders.forEach((order: any, index: number) => {
        const statusEmoji = this.getStatusEmoji(order.order_status);
        const items = order.order_items || [];
        const itemInfo = items.map((item: any) => `${item.product_name} x${item.quantity}`).join(', ');
        
        orderText += `${index + 1}. #${order.order_number || order.order_id}\n`;
        orderText += `   📱 ${itemInfo || 'Sản phẩm'}\n`;
        orderText += `   💵 ${this.formatPrice(order.total_amount)}\n`;
        orderText += `   ${statusEmoji} ${this.getStatusText(order.order_status)}\n\n`;
      });

      await this.sendMessage(senderId, {
        text: orderText,
        quick_replies: [
          { content_type: 'text', title: '📱 Mua thêm', payload: 'MENU_PRODUCTS' },
          { content_type: 'text', title: '💬 Hỗ trợ', payload: 'CONTACT_SUPPORT' },
        ],
      });
    } catch (error) {
      this.logger.error(`Lỗi lấy lịch sử đơn hàng: ${error.message}`);
      await this.sendMessage(senderId, {
        text: '❌ Có lỗi xảy ra. Vui lòng thử lại sau.',
      });
    }
  }

  /**
   * Gửi thông tin hỗ trợ
   */
  private async sendSupportInfo(senderId: string): Promise<void> {
    await this.sendMessage(senderId, {
      text: `💬 THÔNG TIN HỖ TRỢ 💬
━━━━━━━━━━━━━━━━━━━━━

📞 Hotline: 0123 456 789
📧 Email: support@shop.com
⏰ Giờ làm việc: 8:00 - 22:00

📍 Địa chỉ cửa hàng:
123 Đường ABC, Quận XYZ
TP. Hồ Chí Minh

Nhân viên sẽ hỗ trợ bạn sớm nhất! ❤️`,
      quick_replies: [
        { content_type: 'text', title: '📱 Xem sản phẩm', payload: 'MENU_PRODUCTS' },
        { content_type: 'text', title: '🏠 Menu chính', payload: 'MENU' },
      ],
    });
  }

  /**
   * Gửi tin nhắn không hiểu
   */
  private async sendUnknownMessage(senderId: string): Promise<void> {
    await this.sendMessage(senderId, {
      text: '🤔 Xin lỗi, tôi chưa hiểu ý bạn.\n\nVui lòng chọn từ menu bên dưới hoặc gõ "menu" để xem các tùy chọn.',
      quick_replies: [
        { content_type: 'text', title: '📱 Xem sản phẩm', payload: 'MENU_PRODUCTS' },
        { content_type: 'text', title: '📦 Đơn hàng', payload: 'VIEW_ORDERS' },
        { content_type: 'text', title: '💬 Hỗ trợ', payload: 'CONTACT_SUPPORT' },
      ],
    });
  }

  /**
   * Gửi tin nhắn đến Facebook
   */
  private async sendMessage(recipientId: string, message: any): Promise<void> {
    const accessToken = this.configService.get('FACEBOOK_PAGE_ACCESS_TOKEN');

    if (!accessToken) {
      this.logger.error('FACEBOOK_PAGE_ACCESS_TOKEN chưa được cấu hình!');
      return;
    }

    try {
      const response = await axios.post(
        this.FB_API_URL,
        {
          recipient: { id: recipientId },
          message: message,
        },
        {
          params: { access_token: accessToken },
          timeout: 5000, // 5 giây timeout theo yêu cầu webhook
        },
      );

      this.logger.log(`Đã gửi tin nhắn đến ${recipientId}: ${response.status}`);
    } catch (error) {
      this.logger.error(`Lỗi gửi tin nhắn: ${error.response?.data || error.message}`);
      throw error;
    }
  }

  // ==================== HELPER FUNCTIONS ====================

  /**
   * Lấy session của user
   */
  private getUserSession(userId: string): UserSession {
    if (!this.userSessions.has(userId)) {
      this.resetUserSession(userId);
    }
    return this.userSessions.get(userId)!;
  }

  /**
   * Cập nhật session của user
   */
  private updateUserSession(userId: string, updates: Partial<UserSession>): void {
    const session = this.getUserSession(userId);
    this.userSessions.set(userId, {
      ...session,
      ...updates,
      updatedAt: new Date(),
    });
  }

  /**
   * Reset session của user
   */
  private resetUserSession(userId: string): void {
    this.userSessions.set(userId, {
      state: ConversationState.IDLE,
      createdAt: new Date(),
      updatedAt: new Date(),
    });
  }

  /**
   * Format giá tiền VNĐ
   */
  private formatPrice(price: number): string {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND',
    }).format(price);
  }

  /**
   * Lấy emoji theo trạng thái đơn hàng
   */
  private getStatusEmoji(status: string): string {
    const emojis: Record<string, string> = {
      pending: '⏳',
      confirmed: '✅',
      processing: '🔄',
      shipping: '🚚',
      delivered: '📦',
      cancelled: '❌',
    };
    return emojis[status] || '❓';
  }

  /**
   * Lấy text theo trạng thái đơn hàng
   */
  private getStatusText(status: string): string {
    const texts: Record<string, string> = {
      pending: 'Chờ xác nhận',
      confirmed: 'Đã xác nhận',
      processing: 'Đang xử lý',
      shipping: 'Đang giao hàng',
      delivered: 'Đã giao hàng',
      cancelled: 'Đã hủy',
    };
    return texts[status] || 'Không xác định';
  }

  /**
   * Delay helper
   */
  private delay(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  /**
   * Lấy danh sách sản phẩm (public API)
   */
  async getProductList(): Promise<Product[]> {
    return this.loadProductsFromDatabase();
  }

  /**
   * Lấy đơn hàng theo ID (public API)
   */
  async getOrderById(orderId: string): Promise<any> {
    const { data, error } = await this.supabase
      .from('orders')
      .select(`
        *,
        order_items (*)
      `)
      .eq('id', orderId)
      .single();

    if (error) {
      this.logger.error(`Lỗi lấy đơn hàng: ${error.message}`);
      return null;
    }

    return data;
  }

  /**
   * Lấy tất cả đơn hàng (admin API)
   */
  async getAllOrders(limit = 50, offset = 0): Promise<any> {
    const { data, error, count } = await this.supabase
      .from('messenger_orders')
      .select('*', { count: 'exact' })
      .order('created_at', { ascending: false })
      .range(offset, offset + limit - 1);

    if (error) {
      this.logger.error(`Lỗi lấy danh sách đơn hàng: ${error.message}`);
      return { orders: [], total: 0 };
    }

    return { orders: data, total: count };
  }

  /**
   * Cập nhật trạng thái đơn hàng (admin API)
   */
  async updateOrderStatus(orderId: string, status: OrderStatus): Promise<any> {
    const { data, error } = await this.supabase
      .from('messenger_orders')
      .update({ status, updated_at: new Date().toISOString() })
      .eq('id', orderId)
      .select()
      .single();

    if (error) {
      this.logger.error(`Lỗi cập nhật trạng thái: ${error.message}`);
      throw error;
    }

    return data;
  }
}




################################################################################
## FILE 54: messenger.module.ts
## Path: backend/src/messenger/messenger.module.ts
################################################################################

/**
 * Messenger Module
 * Module chứa các thành phần của Messenger Bot
 */

import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { MessengerController } from './messenger.controller';
import { MessengerService } from './messenger.service';

@Module({
  imports: [ConfigModule],
  controllers: [MessengerController],
  providers: [MessengerService],
  exports: [MessengerService],
})
export class MessengerModule {}




################################################################################
## FILE 55: messenger.dto.ts
## Path: backend/src/messenger/messenger.dto.ts
################################################################################

/**
 * Messenger DTOs
 * Data Transfer Objects cho Messenger Controller
 */

// DTO cho Facebook Webhook Entry Messaging
export class FacebookMessagingDto {
  sender: { id: string };
  recipient: { id: string };
  timestamp: number;
  message?: {
    mid: string;
    text?: string;
    quick_reply?: { payload: string };
    attachments?: any[];
  };
  postback?: {
    title: string;
    payload: string;
  };
}

// DTO cho Facebook Webhook Entry
export class FacebookEntryDto {
  id: string;
  time: number;
  messaging: FacebookMessagingDto[];
}

// DTO cho Facebook Webhook Payload
export class FacebookWebhookPayloadDto {
  object: string;
  entry: FacebookEntryDto[];
}

// DTO cho cập nhật trạng thái đơn hàng
export class UpdateOrderStatusDto {
  status: string;
}

// DTO cho query params lấy đơn hàng
export class GetOrdersQueryDto {
  limit?: string;
  offset?: string;
}




################################################################################
## FILE 56: messenger.controller.ts
## Path: backend/src/messenger/messenger.controller.ts
################################################################################

/**
 * Messenger Controller
 * API endpoints cho Facebook Messenger Webhook và quản lý đơn hàng
 */

import {
  Controller,
  Get,
  Post,
  Put,
  Body,
  Query,
  Param,
  HttpCode,
  HttpStatus,
  Logger,
  BadRequestException,
  NotFoundException,
} from '@nestjs/common';
import { MessengerService } from './messenger.service';
import { OrderStatus } from './messenger.types';
import { FacebookWebhookPayloadDto } from './messenger.dto';

@Controller('messenger')
export class MessengerController {
  private readonly logger = new Logger(MessengerController.name);

  constructor(private readonly messengerService: MessengerService) {}

  /**
   * GET /messenger/webhook
   * Xác minh webhook từ Facebook
   * Facebook sẽ gọi endpoint này khi cấu hình webhook
   */
  @Get('webhook')
  verifyWebhook(
    @Query('hub.mode') mode: string,
    @Query('hub.verify_token') token: string,
    @Query('hub.challenge') challenge: string,
  ): string {
    this.logger.log(`Nhận yêu cầu xác minh webhook - Mode: ${mode}`);

    if (!mode || !token) {
      this.logger.warn('Thiếu mode hoặc token');
      throw new BadRequestException('Missing mode or token');
    }

    const result = this.messengerService.verifyWebhook(mode, token, challenge);

    if (result) {
      this.logger.log('Xác minh webhook thành công');
      return result;
    }

    this.logger.warn('Xác minh webhook thất bại - Token không khớp');
    throw new BadRequestException('Verification failed');
  }

  /**
   * POST /messenger/webhook
   * Nhận sự kiện từ Facebook Messenger
   * Tất cả tin nhắn, postback sẽ được gửi đến đây
   */
  @Post('webhook')
  @HttpCode(HttpStatus.OK)
  async handleWebhook(@Body() payload: FacebookWebhookPayloadDto): Promise<string> {
    this.logger.log(`Nhận webhook event: ${JSON.stringify(payload).substring(0, 200)}...`);

    // Phản hồi ngay trong 5 giây theo yêu cầu của Facebook
    // Xử lý async để không block
    setImmediate(async () => {
      try {
        await this.messengerService.handleWebhook(payload as any);
      } catch (error) {
        this.logger.error(`Lỗi xử lý webhook: ${error.message}`, error.stack);
      }
    });

    // Trả về ngay để Facebook không timeout
    return 'EVENT_RECEIVED';
  }

  // ==================== API QUẢN LÝ ĐƠN HÀNG ====================

  /**
   * GET /messenger/products
   * Lấy danh sách sản phẩm
   */
  @Get('products')
  async getProducts() {
    this.logger.log('Lấy danh sách sản phẩm');
    const products = await this.messengerService.getProductList();
    return {
      success: true,
      data: products,
    };
  }

  /**
   * GET /messenger/phone-models
   * Lấy danh sách dòng máy điện thoại cho bot
   */
  @Get('phone-models')
  async getPhoneModels(): Promise<{ success: boolean; data: any[] }> {
    this.logger.log('Lấy danh sách phone models cho bot');
    const models = await this.messengerService.getPhoneModelList();
    return {
      success: true,
      data: models,
    };
  }

  /**
   * GET /messenger/orders
   * Lấy danh sách tất cả đơn hàng (admin)
   */
  @Get('orders')
  async getAllOrders(
    @Query('limit') limit?: string,
    @Query('offset') offset?: string,
  ) {
    this.logger.log(`Lấy danh sách đơn hàng - Limit: ${limit}, Offset: ${offset}`);
    
    const result = await this.messengerService.getAllOrders(
      parseInt(limit || '50', 10),
      parseInt(offset || '0', 10),
    );

    return {
      success: true,
      data: result.orders,
      total: result.total,
    };
  }

  /**
   * GET /messenger/orders/:id
   * Lấy chi tiết đơn hàng theo ID
   */
  @Get('orders/:id')
  async getOrderById(@Param('id') id: string) {
    this.logger.log(`Lấy đơn hàng: ${id}`);

    const order = await this.messengerService.getOrderById(id);

    if (!order) {
      throw new NotFoundException('Không tìm thấy đơn hàng');
    }

    return {
      success: true,
      data: order,
    };
  }

  /**
   * PUT /messenger/orders/:id/status
   * Cập nhật trạng thái đơn hàng
   */
  @Put('orders/:id/status')
  async updateOrderStatus(
    @Param('id') id: string,
    @Body('status') status: OrderStatus,
  ) {
    this.logger.log(`Cập nhật trạng thái đơn ${id}: ${status}`);

    // Validate status
    const validStatuses = Object.values(OrderStatus);
    if (!validStatuses.includes(status)) {
      throw new BadRequestException(`Trạng thái không hợp lệ. Chấp nhận: ${validStatuses.join(', ')}`);
    }

    try {
      const updatedOrder = await this.messengerService.updateOrderStatus(id, status);
      return {
        success: true,
        message: 'Cập nhật trạng thái thành công',
        data: updatedOrder,
      };
    } catch (error) {
      this.logger.error(`Lỗi cập nhật trạng thái: ${error.message}`);
      throw new BadRequestException('Không thể cập nhật trạng thái đơn hàng');
    }
  }

  /**
   * POST /messenger/orders/webhook
   * Nhận đơn hàng từ webhook (endpoint cho hệ thống quản lý)
   */
  @Post('orders/webhook')
  @HttpCode(HttpStatus.OK)
  async receiveOrderWebhook(@Body() orderData: any) {
    this.logger.log(`Nhận webhook đơn hàng: ${JSON.stringify(orderData)}`);

    // Validate dữ liệu cơ bản
    if (!orderData.customer_name || !orderData.phone || !orderData.product) {
      throw new BadRequestException('Thiếu thông tin bắt buộc: customer_name, phone, product');
    }

    return {
      success: true,
      message: 'Đã nhận đơn hàng',
      received_at: new Date().toISOString(),
    };
  }

  /**
   * GET /messenger/health
   * Kiểm tra trạng thái service
   */
  @Get('health')
  healthCheck() {
    return {
      status: 'ok',
      service: 'messenger-bot',
      timestamp: new Date().toISOString(),
    };
  }
}




################################################################################
## FILE 57: order.service.ts
## Path: backend/src/order/order.service.ts
################################################################################

import { Injectable, BadRequestException } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

interface CreateOrderDto {
  items: {
    product_id: number;
    variant_id?: number;
    phone_model_id?: number;
    phone_model_name?: string;
    product_name: string;
    quantity: number;
    unit_price: number;
    discount_amount?: number;
  }[];

  shipping_address: {
    full_name: string;
    phone: string;
    address_line1: string;
    ward?: string;
    district?: string;
    city: string;
  };

  subtotal: number;
  discount_amount?: number;
  shipping_fee?: number;
  tax_amount?: number;
  total_amount: number;

  payment_method?: string;
  coupon_code?: string;
  customer_note?: string;
}


@Injectable()
export class OrderService {
  constructor(private readonly supabaseService: SupabaseService) {}

  // Tạo mã đơn hàng unique
  private generateOrderNumber(): string {
    const timestamp = Date.now().toString(36).toUpperCase();
    const random = Math.random().toString(36).substring(2, 6).toUpperCase();
    return `GT${timestamp}${random}`;
  }

  /**
   * Tạo đơn hàng mới - LUỒNG CHÍNH
   */
  async createOrder(userId: string, orderDto: CreateOrderDto) {
    try {
      const {
        items,
        shipping_address,
        subtotal,
        discount_amount = 0,
        shipping_fee = 0,
        tax_amount = 0,
        total_amount,
        payment_method,
        coupon_code,
        customer_note,
      } = orderDto;

      if (!items || items.length === 0) {
        throw new BadRequestException('Giỏ hàng trống');
      }

      // ❌ XÓA: let subtotal = 0;
      // ❌ XÓA: toàn bộ reduce + tính lại tiền

      // 1️⃣ Generate order number
      const orderNumber = this.generateOrderNumber();

      // 2️⃣ Create order
      const { data: orderData, error: orderError } =
        await this.supabaseService.createFullOrder({
          customer_id: userId,
          order_number: orderNumber,
          subtotal,
          discount_amount,
          shipping_fee,
          // tax_amount,
          total_amount,
          payment_method,
          // coupon_code,
          customer_note,
          shipping_full_name: shipping_address.full_name,
          shipping_phone: shipping_address.phone,
          shipping_address: shipping_address.address_line1,
          shipping_ward: shipping_address.ward,
          shipping_district: shipping_address.district,
          shipping_city: shipping_address.city,
        });

      if (orderError || !orderData || orderData.length === 0) {
        throw new BadRequestException(orderError?.message || 'Không thể tạo đơn hàng');
      }

      const orderId = orderData[0].order_id;

      // 3️⃣ Create order items
      for (const item of items) {
        const { data: itemData, error: itemError } = await this.supabaseService.createFullOrderItem({
          order_id: orderId,
          product_id: item.product_id,
          product_name: item.product_name,
          sku: `SKU-${item.product_id}`,
          quantity: item.quantity,
          unit_price: item.unit_price,
          discount_amount: item.discount_amount || 0,
          total_price: item.unit_price * item.quantity - (item.discount_amount || 0),
          phone_model_id: item.phone_model_id || null,
          phone_model_name: item.phone_model_name || null,
        });

        // THÊM LOG ĐỂ DEBUG
        if (itemError) {
          console.error('Order item insert error:', itemError);
          throw new BadRequestException(`Không thể tạo order item: ${itemError.message}`);
        }
      }
      

      await this.supabaseService.clearShoppingCart(userId);

      return {
        success: true,
        data: {
          order_id: orderId,
          order_number: orderNumber,
          total_amount,
        },
      };
    } catch (error: any) {
      throw new BadRequestException(error.message || 'Lỗi tạo đơn hàng');
    }
  }


  /**
   * Lấy tất cả orders (ADMIN)
   */
  async getAllOrders() {
    const { data, error } = await this.supabaseService.getOrders();
    if (error) throw new BadRequestException(error.message);
    return data;
  }

  /**
   * Lấy orders của customer
   */
  async getOrdersByUserId(userId: string) {
    const { data, error } = await this.supabaseService.getOrdersByCustomer(userId as any);
    if (error) throw new BadRequestException(error.message);
    return data;
  }

  /**
   * Lấy chi tiết order theo ID
   */
  async getOrderById(orderId: string) {
    const { data, error } = await this.supabaseService.getOrderWithItems(Number(orderId));
    if (error) throw new BadRequestException(error.message);
    return data;
  }

  /**
   * Lấy chi tiết order theo Order Number
   */
  async getOrderByNumber(orderNumber: string) {
    const { data, error } = await this.supabaseService.getOrderWithItemsByNumber(orderNumber);
    if (error) throw new BadRequestException(error.message);
    if (!data) throw new BadRequestException('Không tìm thấy đơn hàng');
    return data;
  }

  /**
   * Cập nhật trạng thái đơn hàng
   */
  async updateOrderStatus(orderId: string, newStatus: string) {
    const { data, error } = await this.supabaseService.updateOrderStatus(Number(orderId), newStatus);
    if (error) return { success: false, message: error.message };
    return { success: true, data };
  }

  /**
   * Cập nhật trạng thái thanh toán
   */
  async updatePaymentStatus(orderId: string, paymentStatus: string) {
    const { data, error } = await this.supabaseService.updatePaymentStatus(Number(orderId), paymentStatus);
    if (error) return { success: false, message: error.message };
    return { success: true, data };
  }
}



################################################################################
## FILE 58: order.module.ts
## Path: backend/src/order/order.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { OrderController } from './order.controller';
import { OrderService } from './order.service';
import { SupabaseService } from '../supabase.service';
import { AuthModule } from '../auth/auth.module';

@Module({
  imports: [AuthModule], 
  controllers: [OrderController],
  providers: [OrderService, SupabaseService],
  exports: [OrderService],
})
export class OrderModule {}




################################################################################
## FILE 59: order.controller.ts
## Path: backend/src/order/order.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Put,
  Body,
  Param,
  UseGuards,
  BadRequestException,
} from '@nestjs/common';
import { OrderService } from './order.service';
import { JwtAuthGuard, RolesGuard, CustomerGuard } from '../auth/guards';
import { Roles, CurrentUser, CustomerOnly } from '../auth/decorators';
import { UserRole } from '../common';
import type { AuthenticatedUser } from '../common';

@Controller('orders')
export class OrderController {
  constructor(private readonly orderService: OrderService) {}

  /**
   * POST /orders - Tạo đơn hàng mới
   * Yêu cầu: CUSTOMER only (phải đăng nhập)
   */
  @Post()
  @CustomerOnly()
  async createOrder(
    @CurrentUser() user: AuthenticatedUser,
    @Body() body: {
      items: {
    product_id: number;
    variant_id?: number;
    product_name: string;
    quantity: number;
    unit_price: number;
    discount_amount?: number;
  }[];

  shipping_address: {
    full_name: string;
    phone: string;
    address_line1: string;
    ward?: string;
    district?: string;
    city: string;
  };

  subtotal: number;
  discount_amount?: number;
  shipping_fee?: number;
  tax_amount?: number;
  total_amount: number;

  payment_method?: string;
  coupon_code?: string;
  customer_note?: string;
    },
  ) {
    if (!body.items || body.items.length === 0) {
      throw new BadRequestException('Giỏ hàng trống');
    }

    return this.orderService.createOrder(user.id, body);
  }

  /**
   * GET /orders - Lấy danh sách orders
   * - Admin: xem tất cả
   * - Customer: chỉ xem của mình
   */
  @Get()
  @UseGuards(JwtAuthGuard)
  async getOrders(@CurrentUser() user: AuthenticatedUser) {
    if (user.role === UserRole.ADMIN) {
      return this.orderService.getAllOrders();
    }
    return this.orderService.getOrdersByUserId(user.id);
  }

  /**
   * GET /orders/number/:orderNumber - Lấy order theo mã đơn hàng
   * Dùng cho trang order success và order detail
   */
  @Get('number/:orderNumber')
  async getOrderByNumber(@Param('orderNumber') orderNumber: string) {
    return this.orderService.getOrderByNumber(orderNumber);
  }

  /**
   * GET /orders/:id - Xem chi tiết đơn hàng theo ID
   */
  @Get(':id')
  @UseGuards(JwtAuthGuard)
  async getOrderById(
    @CurrentUser() user: AuthenticatedUser,
    @Param('id') orderId: string,
  ) {
    const order = await this.orderService.getOrderById(orderId);

    // Customer chỉ xem được order của mình
    if (user.role === UserRole.CUSTOMER && order.customer_id !== user.id) {
      throw new BadRequestException('Không có quyền xem đơn hàng này');
    }

    return order;
  }

  /**
   * PUT /orders/:id/status - Cập nhật trạng thái (ADMIN only)
   */
  @Put(':id/status')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  async updateOrderStatus(
    @Param('id') orderId: string,
    @Body('status') status: string,
  ) {
    return this.orderService.updateOrderStatus(orderId, status);
  }

  /**
   * PUT /orders/:id/payment - Cập nhật trạng thái thanh toán
   */
  @Put(':id/payment')
  @UseGuards(JwtAuthGuard, RolesGuard)
  @Roles(UserRole.ADMIN)
  async updatePaymentStatus(
    @Param('id') orderId: string,
    @Body('payment_status') paymentStatus: string,
  ) {
    return this.orderService.updatePaymentStatus(orderId, paymentStatus);
  }

  /**
   * GET /orders/admin/all - Xem tất cả orders (ADMIN only)
   * Tạm thời bỏ guard để test
   */
  @Get('admin/all')
  async getAllOrders() {
    return this.orderService.getAllOrders();
  }
}



################################################################################
## FILE 60: payment.service.ts
## Path: backend/src/payment/payment.service.ts
################################################################################

// backend/src/payment/payment.service.ts
import { Injectable, BadRequestException } from '@nestjs/common';
import axios from 'axios';
import * as crypto from 'crypto';
import { SupabaseService } from '../supabase.service';
import { OrderService } from '../order/order.service';

interface MomoConfig {
  accessKey: string;
  secretKey: string;
  partnerCode: string;
  endpoint: string;
}

@Injectable()
export class PaymentService {
  private momoConfig: MomoConfig = {
    accessKey: 'F8BBA842ECF85',
    secretKey: 'K951B6PE1waDMi640xX08PD3vg6EkVlz',
    partnerCode: 'MOMO',
    endpoint: 'https://test-payment.momo.vn/v2/gateway/api',
  };

  constructor(
    private readonly supabaseService: SupabaseService,
    private readonly orderService: OrderService,
  ) {}

  // ================== UTILS ==================
  private sign(raw: string): string {
    return crypto
      .createHmac('sha256', this.momoConfig.secretKey)
      .update(raw)
      .digest('hex');
  }

  // ================== CREATE PAYMENT ==================
  async createMomoPayment(payload: {
    amount: string;
    orderId: string;
    orderInfo: string;
    redirectUrl: string;
    ipnUrl: string;
    extraData?: string;
  }) {
    const {
      accessKey,
      partnerCode,
      endpoint,
    } = this.momoConfig;

    const requestType = 'payWithMethod';
    const requestId = payload.orderId;
    const autoCapture = true;
    const lang = 'vi';
    const extraData = payload.extraData || '';

    const rawSignature =
      `accessKey=${accessKey}` +
      `&amount=${payload.amount}` +
      `&extraData=${extraData}` +
      `&ipnUrl=${payload.ipnUrl}` +
      `&orderId=${payload.orderId}` +
      `&orderInfo=${payload.orderInfo}` +
      `&partnerCode=${partnerCode}` +
      `&redirectUrl=${payload.redirectUrl}` +
      `&requestId=${requestId}` +
      `&requestType=${requestType}`;

    const signature = this.sign(rawSignature);

    const body = {
      partnerCode,
      partnerName: 'GoatTech Store',
      storeId: 'GoatTechStore',
      requestId,
      amount: payload.amount,
      orderId: payload.orderId,
      orderInfo: payload.orderInfo,
      redirectUrl: payload.redirectUrl,
      ipnUrl: payload.ipnUrl,
      requestType,
      autoCapture,
      lang,
      extraData,
      signature,
    };

    const response = await axios.post(`${endpoint}/create`, body, {
      headers: { 'Content-Type': 'application/json' },
    });

    return response.data;
  }

  // ================== IPN ==================
  async handleMomoIPN(body: any) {
    const {
      partnerCode,
      orderId,
      requestId,
      amount,
      orderInfo,
      orderType,
      transId,
      resultCode,
      message,
      payType,
      responseTime,
      extraData,
      signature,
    } = body;

    const rawSignature =
      `accessKey=${this.momoConfig.accessKey}` +
      `&amount=${amount}` +
      `&extraData=${extraData}` +
      `&message=${message}` +
      `&orderId=${orderId}` +
      `&orderInfo=${orderInfo}` +
      `&orderType=${orderType}` +
      `&partnerCode=${partnerCode}` +
      `&payType=${payType}` +
      `&requestId=${requestId}` +
      `&responseTime=${responseTime}` +
      `&resultCode=${resultCode}` +
      `&transId=${transId}`;

    const expected = this.sign(rawSignature);
    if (expected !== signature) {
      throw new BadRequestException('Invalid MoMo signature');
    }

    // 1️⃣ Ghi payment_transactions
    await this.supabaseService.createPaymentTransaction({
      order_id: null, // map bằng order_number phía dưới
      payment_gateway: 'momo',
      transaction_ref: transId,
      amount,
      currency: 'VND',
      status: resultCode === 0 ? 'success' : 'failed',
      payment_date: new Date().toISOString(),
      response_data: JSON.stringify(body),
    });

    // 2️⃣ Update order
    if (resultCode === 0) {
      await this.orderService.updatePaymentStatus(orderId, 'paid');
    } else {
      await this.orderService.updatePaymentStatus(orderId, 'failed');
    }

    return {
      partnerCode,
      orderId,
      requestId,
      resultCode: 0,
      message: 'success',
      responseTime: Date.now(),
    };
  }

  // ================== CHECK STATUS ==================
  async checkMomoStatus(orderId: string) {
    const { accessKey, partnerCode, endpoint } = this.momoConfig;
    const requestId = orderId;

    const rawSignature =
      `accessKey=${accessKey}` +
      `&orderId=${orderId}` +
      `&partnerCode=${partnerCode}` +
      `&requestId=${requestId}`;

    const signature = this.sign(rawSignature);

    const body = {
      partnerCode,
      requestId,
      orderId,
      lang: 'vi',
      signature,
    };

    const response = await axios.post(`${endpoint}/query`, body, {
      headers: { 'Content-Type': 'application/json' },
    });

    return response.data;
  }

  // ================== REFUND ==================
  async refundMomo(payload: {
    orderId: string;
    transId: string;
    amount: string;
    description?: string;
  }) {
    const { accessKey, partnerCode, endpoint } = this.momoConfig;
    const requestId = `REFUND_${Date.now()}`;
    const description = payload.description || 'Hoàn tiền đơn hàng';

    const rawSignature =
      `accessKey=${accessKey}` +
      `&amount=${payload.amount}` +
      `&description=${description}` +
      `&orderId=${payload.orderId}` +
      `&partnerCode=${partnerCode}` +
      `&requestId=${requestId}` +
      `&transId=${payload.transId}`;

    const signature = this.sign(rawSignature);

    const body = {
      partnerCode,
      requestId,
      orderId: payload.orderId,
      amount: payload.amount,
      transId: payload.transId,
      description,
      lang: 'vi',
      signature,
    };

    const response = await axios.post(`${endpoint}/refund`, body, {
      headers: { 'Content-Type': 'application/json' },
    });

    return response.data;
  }
}




################################################################################
## FILE 61: payment.module.ts
## Path: backend/src/payment/payment.module.ts
################################################################################

// backend/src/payment/payment.module.ts
import { Module } from '@nestjs/common';
import { PaymentController } from './payment.controller';
import { PaymentService } from './payment.service';
import { SupabaseService } from '../supabase.service';
import { OrderModule } from '../order/order.module';

@Module({
  imports: [OrderModule],
  controllers: [PaymentController],
  providers: [
    PaymentService,
    SupabaseService,
  ],
  exports: [PaymentService],
})
export class PaymentModule {}




################################################################################
## FILE 62: payment.controller.ts
## Path: backend/src/payment/payment.controller.ts
################################################################################

import { Controller, Post, Body, Res, Get, Query } from '@nestjs/common';
import axios from 'axios';
import type { Response } from 'express';
import * as crypto from 'crypto';

interface MomoConfig {
  accessKey: string;
  secretKey: string;
  partnerCode: string;
  endpoint: string;
}

@Controller('payment')
export class PaymentController {
  private momoConfig: MomoConfig = {
    accessKey: 'F8BBA842ECF85',
    secretKey: 'K951B6PE1waDMi640xX08PD3vg6EkVlz',
    partnerCode: 'MOMO',
    endpoint: 'https://test-payment.momo.vn/v2/gateway/api',
  };

  // Tạo chữ ký HMAC SHA256
  private createSignature(rawSignature: string): string {
    return crypto
      .createHmac('sha256', this.momoConfig.secretKey)
      .update(rawSignature)
      .digest('hex');
  }

  // POST /payment/momo - Tạo thanh toán MoMo
  @Post('momo')
  async createMomoPayment(@Body() body: any, @Res() res: Response) {
    try {
      const { accessKey, secretKey, partnerCode, endpoint } = this.momoConfig;
      
      const orderInfo = body.orderInfo || 'Thanh toán đơn hàng GoatTech';
      const redirectUrl = body.redirectUrl || 'http://localhost:3000/payment-result';
      const ipnUrl = body.ipnUrl || 'http://localhost:3001/payment/momo/ipn';
      const requestType = 'payWithMethod';
      const amount = String(body.amount || '50000');
      const orderId = body.orderId || `${partnerCode}${Date.now()}`;
      const requestId = orderId;
      const extraData = body.extraData || '';
      const autoCapture = true;
      const lang = 'vi';

      // Build raw signature theo thứ tự alphabet
      const rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&ipnUrl=${ipnUrl}&orderId=${orderId}&orderInfo=${orderInfo}&partnerCode=${partnerCode}&redirectUrl=${redirectUrl}&requestId=${requestId}&requestType=${requestType}`;
      
      const signature = this.createSignature(rawSignature);

      console.log('📝 MoMo Payment Request:');
      console.log('- Order ID:', orderId);
      console.log('- Amount:', amount);
      console.log('- Raw Signature:', rawSignature);

      // Build request body
      const requestBody = {
        partnerCode,
        partnerName: 'GoatTech Store',
        storeId: 'GoatTechStore',
        requestId,
        amount,
        orderId,
        orderInfo,
        redirectUrl,
        ipnUrl,
        lang,
        requestType,
        autoCapture,
        extraData,
        signature,
      };

      // Call MoMo API
      const response = await axios.post(
        `${endpoint}/create`,
        requestBody,
        {
          headers: { 'Content-Type': 'application/json' },
        },
      );

      console.log('✅ MoMo Response:', response.data);

      return res.status(200).json({
        success: true,
        data: response.data,
      });
    } catch (error: any) {
      console.error('❌ MoMo Payment Error:', error?.response?.data || error.message);
      return res.status(500).json({
        success: false,
        message: 'Lỗi tạo thanh toán MoMo',
        error: error?.response?.data || error?.message,
      });
    }
  }

  // POST /payment/momo/ipn - Nhận thông báo từ MoMo (IPN - Instant Payment Notification)
  @Post('momo/ipn')
  async handleMomoIPN(@Body() body: any, @Res() res: Response) {
    try {
      console.log('🔔 MoMo IPN Received:', body);

      const { 
        partnerCode, orderId, requestId, amount, orderInfo, 
        orderType, transId, resultCode, message, payType,
        responseTime, extraData, signature 
      } = body;

      // Verify signature
      const { accessKey } = this.momoConfig;
      const rawSignature = `accessKey=${accessKey}&amount=${amount}&extraData=${extraData}&message=${message}&orderId=${orderId}&orderInfo=${orderInfo}&orderType=${orderType}&partnerCode=${partnerCode}&payType=${payType}&requestId=${requestId}&responseTime=${responseTime}&resultCode=${resultCode}&transId=${transId}`;
      
      const expectedSignature = this.createSignature(rawSignature);

      if (signature !== expectedSignature) {
        console.error('❌ Invalid signature!');
        return res.status(400).json({ message: 'Invalid signature' });
      }

      // Xử lý kết quả thanh toán
      if (resultCode === 0) {
        console.log('✅ Payment Success!');
        console.log('- Transaction ID:', transId);
        console.log('- Order ID:', orderId);
        console.log('- Amount:', amount);
        
        // TODO: Cập nhật trạng thái đơn hàng trong database
        // await this.orderService.updatePaymentStatus(orderId, 'paid', transId);
      } else {
        console.log('❌ Payment Failed:', message);
        // TODO: Cập nhật trạng thái đơn hàng thất bại
      }

      // Phản hồi MoMo
      return res.status(200).json({
        partnerCode,
        requestId,
        orderId,
        resultCode: 0,
        message: 'success',
        responseTime: Date.now(),
      });
    } catch (error: any) {
      console.error('❌ IPN Error:', error.message);
      return res.status(500).json({ message: 'IPN processing failed' });
    }
  }

  // POST /payment/momo/check-status - Kiểm tra trạng thái thanh toán
  @Post('momo/check-status')
  async checkPaymentStatus(@Body() body: any, @Res() res: Response) {
    try {
      const { accessKey, secretKey, partnerCode, endpoint } = this.momoConfig;
      
      const orderId = body.orderId;
      const requestId = orderId;
      const lang = 'vi';

      if (!orderId) {
        return res.status(400).json({
          success: false,
          message: 'orderId is required',
        });
      }

      // Build raw signature
      const rawSignature = `accessKey=${accessKey}&orderId=${orderId}&partnerCode=${partnerCode}&requestId=${requestId}`;
      const signature = this.createSignature(rawSignature);

      const requestBody = {
        partnerCode,
        requestId,
        orderId,
        lang,
        signature,
      };

      const response = await axios.post(
        `${endpoint}/query`,
        requestBody,
        {
          headers: { 'Content-Type': 'application/json' },
        },
      );

      console.log('📊 Payment Status:', response.data);

      return res.status(200).json({
        success: true,
        data: response.data,
      });
    } catch (error: any) {
      console.error('❌ Check Status Error:', error?.response?.data || error.message);
      return res.status(500).json({
        success: false,
        message: 'Lỗi kiểm tra trạng thái',
        error: error?.response?.data || error?.message,
      });
    }
  }

  // POST /payment/momo/refund - Hoàn tiền
  @Post('momo/refund')
  async refundPayment(@Body() body: any, @Res() res: Response) {
    try {
      const { accessKey, partnerCode, endpoint } = this.momoConfig;
      
      const orderId = body.orderId;
      const transId = body.transId;
      const amount = String(body.amount);
      const requestId = `REFUND${Date.now()}`;
      const description = body.description || 'Hoàn tiền đơn hàng';
      const lang = 'vi';

      if (!orderId || !transId || !amount) {
        return res.status(400).json({
          success: false,
          message: 'orderId, transId và amount là bắt buộc',
        });
      }

      // Build raw signature
      const rawSignature = `accessKey=${accessKey}&amount=${amount}&description=${description}&orderId=${orderId}&partnerCode=${partnerCode}&requestId=${requestId}&transId=${transId}`;
      const signature = this.createSignature(rawSignature);

      const requestBody = {
        partnerCode,
        requestId,
        orderId,
        amount,
        transId,
        description,
        lang,
        signature,
      };

      const response = await axios.post(
        `${endpoint}/refund`,
        requestBody,
        {
          headers: { 'Content-Type': 'application/json' },
        },
      );

      console.log('💰 Refund Response:', response.data);

      return res.status(200).json({
        success: true,
        data: response.data,
      });
    } catch (error: any) {
      console.error('❌ Refund Error:', error?.response?.data || error.message);
      return res.status(500).json({
        success: false,
        message: 'Lỗi hoàn tiền',
        error: error?.response?.data || error?.message,
      });
    }
  }

  // GET /payment/momo/result - Trang kết quả thanh toán (redirect từ MoMo)
  @Get('momo/result')
  async paymentResult(@Query() query: any, @Res() res: Response) {
    console.log('🔄 Payment Result Query:', query);
    
    const { resultCode, orderId, message, transId, amount } = query;
    
    // Redirect về frontend với kết quả
    const frontendUrl = `http://localhost:3000/payment-result?resultCode=${resultCode}&orderId=${orderId}&message=${encodeURIComponent(message || '')}&transId=${transId || ''}&amount=${amount || ''}`;
    
    return res.redirect(frontendUrl);
  }
}




################################################################################
## FILE 63: phone-model.service.ts
## Path: backend/src/phone-model/phone-model.service.ts
################################################################################

/**
 * Phone Model Service
 * Quản lý dòng máy điện thoại tương thích với sản phẩm
 */

import { Injectable, Logger } from '@nestjs/common';
import { createClient, SupabaseClient } from '@supabase/supabase-js';

// Interface cho Phone Model
export interface PhoneModel {
  model_id: number;
  brand_name: string;
  model_name: string;
  model_code?: string;
  release_year?: number;
  screen_size?: number;
  image_url?: string;
  is_popular: boolean;
  is_active: boolean;
  display_order: number;
}

// Interface cho Product Compatibility
export interface ProductCompatibility {
  compatibility_id: number;
  product_id: number;
  phone_model_id: number;
  fit_type: string;
  notes?: string;
  phone_model?: PhoneModel;
}

@Injectable()
export class PhoneModelService {
  private readonly logger = new Logger(PhoneModelService.name);
  private supabase: SupabaseClient;

  constructor() {
    this.supabase = createClient(
      process.env.SUPABASE_URL || '',
      process.env.SUPABASE_SERVICE_ROLE_KEY || '',
    );
  }

  /**
   * Lấy tất cả dòng máy (grouped by brand)
   */
  async getAllPhoneModels(): Promise<{ brand: string; models: PhoneModel[] }[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .order('brand_name')
        .order('display_order')
        .order('model_name');

      if (error) {
        this.logger.error(`Lỗi lấy phone models: ${error.message}`);
        throw error;
      }

      // Group by brand
      const groupedByBrand: { [key: string]: PhoneModel[] } = {};
      (data || []).forEach((model: PhoneModel) => {
        if (!groupedByBrand[model.brand_name]) {
          groupedByBrand[model.brand_name] = [];
        }
        groupedByBrand[model.brand_name].push(model);
      });

      // Convert to array format: [{ brand: 'Apple', models: [...] }, ...]
      const result = Object.entries(groupedByBrand).map(([brand, models]) => ({
        brand,
        models,
      }));

      return result;
    } catch (error) {
      this.logger.error(`Lỗi getAllPhoneModels: ${error.message}`);
      throw error;
    }
  }

  /**
   * Lấy dòng máy theo brand
   */
  async getPhoneModelsByBrand(brandName: string): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .eq('brand_name', brandName)
        .order('display_order')
        .order('model_name');

      if (error) {
        this.logger.error(`Lỗi lấy phone models by brand: ${error.message}`);
        throw error;
      }

      return data || [];
    } catch (error) {
      this.logger.error(`Lỗi getPhoneModelsByBrand: ${error.message}`);
      throw error;
    }
  }

  /**
   * Lấy dòng máy phổ biến
   */
  async getPopularPhoneModels(): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .eq('is_popular', true)
        .order('brand_name')
        .order('display_order')
        .limit(20);

      if (error) {
        this.logger.error(`Lỗi lấy popular phone models: ${error.message}`);
        throw error;
      }

      return data || [];
    } catch (error) {
      this.logger.error(`Lỗi getPopularPhoneModels: ${error.message}`);
      throw error;
    }
  }

  /**
   * Lấy dòng máy tương thích với sản phẩm
   */
  async getCompatibleModels(productId: number): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('product_compatibility')
        .select(`
          *,
          phone_models (*)
        `)
        .eq('product_id', productId);

      if (error) {
        this.logger.error(`Lỗi lấy compatible models: ${error.message}`);
        throw error;
      }

      // Extract phone models từ kết quả
      const models = (data || [])
        .map((c: any) => c.phone_models)
        .filter((m: any) => m && m.is_active);

      return models;
    } catch (error) {
      this.logger.error(`Lỗi getCompatibleModels: ${error.message}`);
      throw error;
    }
  }

  /**
   * Lấy chi tiết một dòng máy
   */
  async getPhoneModelById(modelId: number): Promise<PhoneModel | null> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .eq('model_id', modelId)
        .single();

      if (error) {
        this.logger.error(`Lỗi lấy phone model: ${error.message}`);
        return null;
      }

      return data;
    } catch (error) {
      this.logger.error(`Lỗi getPhoneModelById: ${error.message}`);
      return null;
    }
  }

  /**
   * Tìm kiếm dòng máy
   */
  async searchPhoneModels(keyword: string): Promise<PhoneModel[]> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .select('*')
        .or(`model_name.ilike.%${keyword}%,brand_name.ilike.%${keyword}%,model_code.ilike.%${keyword}%`)
        .order('is_popular', { ascending: false })
        .order('brand_name')
        .limit(20);

      if (error) {
        this.logger.error(`Lỗi search phone models: ${error.message}`);
        throw error;
      }

      return data || [];
    } catch (error) {
      this.logger.error(`Lỗi searchPhoneModels: ${error.message}`);
      throw error;
    }
  }

  // ==================== ADMIN FUNCTIONS ====================

  /**
   * Tạo dòng máy mới (Admin)
   */
  async createPhoneModel(modelData: Partial<PhoneModel>): Promise<PhoneModel> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .insert([modelData])
        .select()
        .single();

      if (error) {
        this.logger.error(`Lỗi tạo phone model: ${error.message}`);
        throw error;
      }

      this.logger.log(`Đã tạo phone model: ${data.model_name}`);
      return data;
    } catch (error) {
      this.logger.error(`Lỗi createPhoneModel: ${error.message}`);
      throw error;
    }
  }

  /**
   * Cập nhật dòng máy (Admin)
   */
  async updatePhoneModel(modelId: number, modelData: Partial<PhoneModel>): Promise<PhoneModel> {
    try {
      const { data, error } = await this.supabase
        .from('phone_models')
        .update(modelData)
        .eq('model_id', modelId)
        .select()
        .single();

      if (error) {
        this.logger.error(`Lỗi cập nhật phone model: ${error.message}`);
        throw error;
      }

      this.logger.log(`Đã cập nhật phone model: ${modelId}`);
      return data;
    } catch (error) {
      this.logger.error(`Lỗi updatePhoneModel: ${error.message}`);
      throw error;
    }
  }

  /**
   * Xóa dòng máy (Admin) - soft delete
   */
  async deletePhoneModel(modelId: number): Promise<boolean> {
    try {
      const { error } = await this.supabase
        .from('phone_models')
        .update({ is_active: false })
        .eq('model_id', modelId);

      if (error) {
        this.logger.error(`Lỗi xóa phone model: ${error.message}`);
        throw error;
      }

      this.logger.log(`Đã xóa phone model: ${modelId}`);
      return true;
    } catch (error) {
      this.logger.error(`Lỗi deletePhoneModel: ${error.message}`);
      throw error;
    }
  }

  /**
   * Thêm tương thích sản phẩm - dòng máy (Admin)
   */
  async addProductCompatibility(
    productId: number,
    phoneModelId: number,
    fitType: string = 'exact',
    notes?: string,
  ): Promise<ProductCompatibility> {
    try {
      const { data, error } = await this.supabase
        .from('product_compatibility')
        .insert([
          {
            product_id: productId,
            phone_model_id: phoneModelId,
            fit_type: fitType,
            notes: notes,
          },
        ])
        .select()
        .single();

      if (error) {
        this.logger.error(`Lỗi thêm compatibility: ${error.message}`);
        throw error;
      }

      return data;
    } catch (error) {
      this.logger.error(`Lỗi addProductCompatibility: ${error.message}`);
      throw error;
    }
  }

  /**
   * Xóa tương thích sản phẩm - dòng máy (Admin)
   */
  async removeProductCompatibility(productId: number, phoneModelId: number): Promise<boolean> {
    try {
      const { error } = await this.supabase
        .from('product_compatibility')
        .delete()
        .eq('product_id', productId)
        .eq('phone_model_id', phoneModelId);

      if (error) {
        this.logger.error(`Lỗi xóa compatibility: ${error.message}`);
        throw error;
      }

      return true;
    } catch (error) {
      this.logger.error(`Lỗi removeProductCompatibility: ${error.message}`);
      throw error;
    }
  }

  /**
   * Bulk thêm tương thích cho sản phẩm (Admin)
   */
  async setProductCompatibility(
    productId: number,
    phoneModelIds: number[],
  ): Promise<void> {
    try {
      // Xóa tất cả compatibility cũ
      await this.supabase
        .from('product_compatibility')
        .delete()
        .eq('product_id', productId);

      // Thêm compatibility mới
      if (phoneModelIds.length > 0) {
        const inserts = phoneModelIds.map((modelId) => ({
          product_id: productId,
          phone_model_id: modelId,
          fit_type: 'exact',
        }));

        const { error } = await this.supabase
          .from('product_compatibility')
          .insert(inserts);

        if (error) {
          this.logger.error(`Lỗi bulk insert compatibility: ${error.message}`);
          throw error;
        }
      }

      this.logger.log(`Đã set ${phoneModelIds.length} compatible models cho product ${productId}`);
    } catch (error) {
      this.logger.error(`Lỗi setProductCompatibility: ${error.message}`);
      throw error;
    }
  }
}




################################################################################
## FILE 64: phone-model.module.ts
## Path: backend/src/phone-model/phone-model.module.ts
################################################################################

/**
 * Phone Model Module
 * Module quản lý dòng máy điện thoại
 */

import { Module } from '@nestjs/common';
import { PhoneModelController } from './phone-model.controller';
import { PhoneModelService } from './phone-model.service';

@Module({
  controllers: [PhoneModelController],
  providers: [PhoneModelService],
  exports: [PhoneModelService],
})
export class PhoneModelModule {}




################################################################################
## FILE 65: phone-model.controller.ts
## Path: backend/src/phone-model/phone-model.controller.ts
################################################################################

/**
 * Phone Model Controller
 * API endpoints cho dòng máy điện thoại
 */

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  Query,
  Logger,
  BadRequestException,
  NotFoundException,
} from '@nestjs/common';
import { PhoneModelService, PhoneModel } from './phone-model.service';

@Controller('phone-models')
export class PhoneModelController {
  private readonly logger = new Logger(PhoneModelController.name);

  constructor(private readonly phoneModelService: PhoneModelService) {}

  /**
   * GET /phone-models
   * Lấy tất cả dòng máy (grouped by brand)
   */
  @Get()
  async getAllPhoneModels() {
    this.logger.log('Lấy tất cả phone models');
    try {
      const result = await this.phoneModelService.getAllPhoneModels();
      return {
        success: true,
        data: result,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể lấy danh sách dòng máy');
    }
  }

  /**
   * GET /phone-models/popular
   * Lấy dòng máy phổ biến
   */
  @Get('popular')
  async getPopularPhoneModels() {
    this.logger.log('Lấy popular phone models');
    try {
      const models = await this.phoneModelService.getPopularPhoneModels();
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể lấy dòng máy phổ biến');
    }
  }

  /**
   * GET /phone-models/search?keyword=iphone
   * Tìm kiếm dòng máy
   */
  @Get('search')
  async searchPhoneModels(@Query('keyword') keyword: string) {
    if (!keyword || keyword.length < 2) {
      throw new BadRequestException('Keyword phải có ít nhất 2 ký tự');
    }

    this.logger.log(`Tìm kiếm phone models: ${keyword}`);
    try {
      const models = await this.phoneModelService.searchPhoneModels(keyword);
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể tìm kiếm dòng máy');
    }
  }

  /**
   * GET /phone-models/brand/:brandName
   * Lấy dòng máy theo brand
   */
  @Get('brand/:brandName')
  async getPhoneModelsByBrand(@Param('brandName') brandName: string) {
    this.logger.log(`Lấy phone models theo brand: ${brandName}`);
    try {
      const models = await this.phoneModelService.getPhoneModelsByBrand(brandName);
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể lấy dòng máy theo hãng');
    }
  }

  /**
   * GET /phone-models/product/:productId
   * Lấy dòng máy tương thích với sản phẩm
   */
  @Get('product/:productId')
  async getCompatibleModels(@Param('productId') productId: string) {
    const id = parseInt(productId, 10);
    if (isNaN(id)) {
      throw new BadRequestException('Product ID không hợp lệ');
    }

    this.logger.log(`Lấy compatible models cho product: ${id}`);
    try {
      const models = await this.phoneModelService.getCompatibleModels(id);
      return {
        success: true,
        data: models,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể lấy dòng máy tương thích');
    }
  }

  /**
   * GET /phone-models/:id
   * Lấy chi tiết dòng máy
   */
  @Get(':id')
  async getPhoneModelById(@Param('id') id: string) {
    const modelId = parseInt(id, 10);
    if (isNaN(modelId)) {
      throw new BadRequestException('Model ID không hợp lệ');
    }

    this.logger.log(`Lấy phone model: ${modelId}`);
    try {
      const model = await this.phoneModelService.getPhoneModelById(modelId);
      if (!model) {
        throw new NotFoundException('Không tìm thấy dòng máy');
      }
      return {
        success: true,
        data: model,
      };
    } catch (error) {
      if (error instanceof NotFoundException) throw error;
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể lấy thông tin dòng máy');
    }
  }

  // ==================== ADMIN ENDPOINTS ====================

  /**
   * POST /phone-models
   * Tạo dòng máy mới (Admin)
   */
  @Post()
  async createPhoneModel(@Body() modelData: Partial<PhoneModel>) {
    if (!modelData.brand_name || !modelData.model_name) {
      throw new BadRequestException('Thiếu brand_name hoặc model_name');
    }

    this.logger.log(`Tạo phone model: ${modelData.model_name}`);
    try {
      const model = await this.phoneModelService.createPhoneModel(modelData);
      return {
        success: true,
        message: 'Tạo dòng máy thành công',
        data: model,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể tạo dòng máy');
    }
  }

  /**
   * PUT /phone-models/:id
   * Cập nhật dòng máy (Admin)
   */
  @Put(':id')
  async updatePhoneModel(
    @Param('id') id: string,
    @Body() modelData: Partial<PhoneModel>,
  ) {
    const modelId = parseInt(id, 10);
    if (isNaN(modelId)) {
      throw new BadRequestException('Model ID không hợp lệ');
    }

    this.logger.log(`Cập nhật phone model: ${modelId}`);
    try {
      const model = await this.phoneModelService.updatePhoneModel(modelId, modelData);
      return {
        success: true,
        message: 'Cập nhật dòng máy thành công',
        data: model,
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể cập nhật dòng máy');
    }
  }

  /**
   * DELETE /phone-models/:id
   * Xóa dòng máy (Admin)
   */
  @Delete(':id')
  async deletePhoneModel(@Param('id') id: string) {
    const modelId = parseInt(id, 10);
    if (isNaN(modelId)) {
      throw new BadRequestException('Model ID không hợp lệ');
    }

    this.logger.log(`Xóa phone model: ${modelId}`);
    try {
      await this.phoneModelService.deletePhoneModel(modelId);
      return {
        success: true,
        message: 'Xóa dòng máy thành công',
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể xóa dòng máy');
    }
  }

  /**
   * POST /phone-models/product/:productId/compatibility
   * Set dòng máy tương thích cho sản phẩm (Admin)
   */
  @Post('product/:productId/compatibility')
  async setProductCompatibility(
    @Param('productId') productId: string,
    @Body() body: { phoneModelIds: number[] },
  ) {
    const id = parseInt(productId, 10);
    if (isNaN(id)) {
      throw new BadRequestException('Product ID không hợp lệ');
    }

    if (!Array.isArray(body.phoneModelIds)) {
      throw new BadRequestException('phoneModelIds phải là mảng');
    }

    this.logger.log(`Set compatibility cho product ${id}: ${body.phoneModelIds.length} models`);
    try {
      await this.phoneModelService.setProductCompatibility(id, body.phoneModelIds);
      return {
        success: true,
        message: 'Cập nhật tương thích thành công',
      };
    } catch (error) {
      this.logger.error(`Lỗi: ${error.message}`);
      throw new BadRequestException('Không thể cập nhật tương thích');
    }
  }
}




################################################################################
## FILE 66: product.service.ts
## Path: backend/src/product/product.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ProductService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getProducts(limit = 10) {
    const result = await this.supabaseService.getProducts(limit);
    return result.data || [];
  }

  async getProductById(productId: number) {
    const result = await this.supabaseService.getProductById(productId);
    return result.data || null;
  }

  async createProduct(productData: any) {
    const result = await this.supabaseService.createProduct(productData);
    if (result.error) {
      return { success: false, message: result.error.message };
    }
    return { success: true, data: result.data };
  }

  async updateProduct(productId: number, productData: any) {
    const result = await this.supabaseService.updateProduct(productId, productData);
    if (result.error) {
      return { success: false, message: result.error.message };
    }
    return { success: true, data: result.data };
  }

  async deleteProduct(productId: number) {
    const result = await this.supabaseService.deleteProduct(productId);
    if (result.error) {
      return { success: false, message: result.error.message };
    }
    return { success: true, message: 'Đã ẩn sản phẩm thành công' };
  }

  async getProductsBySeason(season: string) {
    const result = await this.supabaseService.getProductsBySeason(season);
    return result.data || [];
  }

  async getSeasonProductCounts() {
    return await this.supabaseService.getSeasonProductCounts();
  }
}




################################################################################
## FILE 67: product.module.ts
## Path: backend/src/product/product.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ProductController } from './product.controller';
import { ProductService } from './product.service';
import { SupabaseService } from '../supabase.service';
import { CloudinaryModule } from 'src/cloudinary/cloudinary.module';

@Module({
  // imports:[CloudinaryModule],
  controllers: [ProductController],
  providers: [ProductService, SupabaseService],
  exports: [ProductService],
})
export class ProductModule {}




################################################################################
## FILE 68: product.controller.ts
## Path: backend/src/product/product.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Query, Param, Body,UploadedFile, UseInterceptors } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import { ProductService } from './product.service';
import { CloudinaryService } from '../cloudinary/cloudinary.service';
@Controller('products')
export class ProductController {
  constructor(
    // private readonly cloudinaryService: CloudinaryService,
    private readonly productService: ProductService
  ) {}

  @Get()
  async getProducts(@Query('limit') limit: string = '10') {
    return await this.productService.getProducts(parseInt(limit));
  }

  // Season routes - đặt trước :id để tránh conflict
  @Get('season/counts')
  async getSeasonProductCounts() {
    return await this.productService.getSeasonProductCounts();
  }

  @Get('season/:season')
  async getProductsBySeason(@Param('season') season: string) {
    return await this.productService.getProductsBySeason(season);
  }

  @Get(':id')
  async getProductById(@Param('id') id: string) {
    return await this.productService.getProductById(parseInt(id));
  }

  @Post()
  async createProduct(@Body() productData: any) {
    return await this.productService.createProduct(productData);
  }

  @Put(':id')
  async updateProduct(@Param('id') id: string, @Body() productData: any) {
    return await this.productService.updateProduct(parseInt(id), productData);
  }

  @Delete(':id')
  async deleteProduct(@Param('id') id: string) {
    return await this.productService.deleteProduct(parseInt(id));
  }

  // @Post('upload')
  // @UseInterceptors(FileInterceptor('image'))
  // async uploadProduct(
  //   @UploadedFile() file: Express.Multer.File,
  //   @Body('name') name: string,
  // ) {
  //   const imageUrl = await this.cloudinaryService.uploadImage(
  //     file.buffer,
  //     'products',
  //   );

  //   return this.productService.create({
  //     name,
  //     image_url: imageUrl,
  //   });
  // }
}




################################################################################
## FILE 69: review.service.ts
## Path: backend/src/review/review.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ReviewService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getAllReviews(limit = 50) {
    const result = await this.supabaseService.getAllReviews(limit);
    return result;
  }

  async getProductReviews(productId: number) {
    const result = await this.supabaseService.getProductReviews(productId);
    return result;
  }

  async getReviewById(reviewId: number) {
    const result = await this.supabaseService.getReviewById(reviewId);
    return result;
  }

  async createReview(reviewData: any) {
    const result = await this.supabaseService.createReview(reviewData);
    return result;
  }

  async updateReview(reviewId: number, reviewData: any) {
    const result = await this.supabaseService.updateReview(reviewId, reviewData);
    return result;
  }

  async deleteReview(reviewId: number) {
    const result = await this.supabaseService.deleteReview(reviewId);
    return result;
  }

  async approveReview(reviewId: number, isApproved: boolean) {
    const result = await this.supabaseService.approveReview(reviewId, isApproved);
    return result;
  }
}




################################################################################
## FILE 70: review.module.ts
## Path: backend/src/review/review.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ReviewController } from './review.controller';
import { ReviewService } from './review.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [ReviewController],
  providers: [ReviewService, SupabaseService],
  exports: [ReviewService],
})
export class ReviewModule {}




################################################################################
## FILE 71: review.controller.ts
## Path: backend/src/review/review.controller.ts
################################################################################

import { Controller, Get, Post, Put, Delete, Param, Body, Query } from '@nestjs/common';
import { ReviewService } from './review.service';

@Controller('reviews')
export class ReviewController {
  constructor(private readonly reviewService: ReviewService) {}

  // Lấy tất cả đánh giá (cho admin)
  @Get()
  async getAllReviews(@Query('limit') limit?: string) {
    return await this.reviewService.getAllReviews(limit ? parseInt(limit) : 50);
  }

  // Lấy đánh giá theo sản phẩm
  @Get('product/:productId')
  async getProductReviews(@Param('productId') productId: string) {
    return await this.reviewService.getProductReviews(parseInt(productId));
  }

  // Lấy đánh giá theo ID
  @Get(':id')
  async getReviewById(@Param('id') id: string) {
    return await this.reviewService.getReviewById(parseInt(id));
  }

  // Tạo đánh giá mới (khách hàng gửi)
  @Post()
  async createReview(@Body() reviewData: {
    product_id: number;
    customer_id?: number;
    customer_name: string;
    customer_email?: string;
    rating: number;
    review_title?: string;
    review_text: string;
    is_approved?: boolean;
  }) {
    // Mặc định chưa duyệt
    const data = {
      ...reviewData,
      is_approved: reviewData.is_approved ?? false,
      created_at: new Date().toISOString()
    };
    return await this.reviewService.createReview(data);
  }

  // Cập nhật đánh giá
  @Put(':id')
  async updateReview(@Param('id') id: string, @Body() reviewData: any) {
    return await this.reviewService.updateReview(parseInt(id), reviewData);
  }

  // Duyệt/từ chối đánh giá
  @Put(':id/approve')
  async approveReview(@Param('id') id: string, @Body() body: { is_approved: boolean }) {
    return await this.reviewService.approveReview(parseInt(id), body.is_approved);
  }

  // Xóa đánh giá
  @Delete(':id')
  async deleteReview(@Param('id') id: string) {
    return await this.reviewService.deleteReview(parseInt(id));
  }
}




################################################################################
## FILE 72: shopping-cart.service.ts
## Path: backend/src/shopping-cart/shopping-cart.service.ts
################################################################################

import { Injectable, ForbiddenException, BadRequestException, Logger } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class ShoppingCartService {
  private readonly logger = new Logger(ShoppingCartService.name);

  constructor(private readonly supabaseService: SupabaseService) {}

  /**
   * Lấy giỏ hàng của user (có JOIN products)
   */
  async getCartByUserId(userId: string) {
    this.logger.log(`Getting cart for user: ${userId}`);

    const { data, error } = await this.supabaseService.getShoppingCartByUserId(userId);

    if (error) {
      this.logger.error(`Get cart error: ${error.message}`);
      return { success: false, message: error.message, data: [] };
    }

    // Transform data để frontend dễ sử dụng
    const cartItems = (data || []).map((item: any) => {
      // Lấy ảnh primary hoặc ảnh đầu tiên từ product_images
      const images = item.products?.product_images || [];
      const primaryImage = images.find((img: any) => img.is_primary) || images[0];
      const imageUrl = primaryImage?.image_url || null;

      return {
        cart_id: item.cart_id,
        product_id: item.product_id,
        variant_id: item.variant_id,
        phone_model_id: item.phone_model_id,
        phone_model_name: item.phone_model_name,
        quantity: item.quantity,
        created_at: item.created_at,
        // Flatten product info
        product_name: item.products?.product_name || `Sản phẩm #${item.product_id}`,
        price: item.products?.sale_price || item.products?.price || 0,
        original_price: item.products?.price || 0,
        image_url: imageUrl,
        status: item.products?.status || 'active',
      };
    });

    return {
      success: true,
      data: cartItems,
      total: cartItems.reduce((sum: number, item: any) => sum + (item.price * item.quantity), 0),
      itemCount: cartItems.reduce((sum: number, item: any) => sum + item.quantity, 0),
    };
  }

  /**
   * Thêm sản phẩm vào giỏ
   */
  async addToCart(
    userId: string, 
    productId: number, 
    quantity: number = 1, 
    variantId?: number,
    phoneModelId?: number,
    phoneModelName?: string
  ) {
    this.logger.log(`Adding to cart: user=${userId}, product=${productId}, qty=${quantity}, phoneModel=${phoneModelName || phoneModelId}`);

    if (quantity < 1) {
      throw new BadRequestException('Số lượng phải >= 1');
    }

    // 1️⃣ Kiểm tra sản phẩm đã có trong giỏ chưa (cùng phone model)
    const { data: existingItem, error: checkError } = 
      await this.supabaseService.getCartItemByUserAndProduct(userId, productId, phoneModelId);

    if (checkError && checkError.code !== 'PGRST116') {
      // PGRST116 = no rows returned, không phải lỗi thực sự
      this.logger.error(`Check existing error: ${checkError.message}`);
      return { success: false, message: checkError.message };
    }

    // 2️⃣ Nếu đã tồn tại → cộng dồn quantity
    if (existingItem) {
      const newQuantity = existingItem.quantity + quantity;
      const { data: updated, error: updateError } = 
        await this.supabaseService.updateShoppingCartQuantity(existingItem.cart_id, newQuantity);

      if (updateError) {
        this.logger.error(`Update quantity error: ${updateError.message}`);
        return { success: false, message: updateError.message };
      }

      this.logger.log(`Updated existing cart item: ${existingItem.cart_id}, new qty: ${newQuantity}`);

      return {
        success: true,
        action: 'updated',
        message: 'Đã cập nhật số lượng trong giỏ hàng',
        data: updated,
      };
    }

    // 3️⃣ Chưa tồn tại → insert mới
    const { data: created, error: createError } = await this.supabaseService.createShoppingCartItem({
      customer_id: userId,
      product_id: productId,
      variant_id: variantId || null,
      phone_model_id: phoneModelId || null,
      phone_model_name: phoneModelName || null,
      quantity,
    });

    if (createError) {
      this.logger.error(`Create cart item error: ${createError.message}`);
      return { success: false, message: createError.message };
    }

    this.logger.log(`Created new cart item for product: ${productId}`);

    return {
      success: true,
      action: 'created',
      message: 'Đã thêm sản phẩm vào giỏ hàng',
      data: created,
    };
  }

  /**
   * Cập nhật số lượng sản phẩm trong giỏ
   */
  async updateQuantity(userId: string, cartId: number, quantity: number) {
    this.logger.log(`Updating quantity: cart=${cartId}, qty=${quantity}`);

    // 1️⃣ Verify ownership
    const { data: cartItem, error: getError } = await this.supabaseService.getCartItemById(cartId);

    if (getError || !cartItem) {
      throw new BadRequestException('Không tìm thấy item trong giỏ hàng');
    }

    if (cartItem.customer_id !== userId) {
      throw new ForbiddenException('Bạn không có quyền sửa giỏ hàng này');
    }

    // 2️⃣ Nếu quantity = 0 → xóa item
    if (quantity <= 0) {
      return this.removeFromCart(userId, cartId);
    }

    // 3️⃣ Update quantity
    const { data, error } = await this.supabaseService.updateShoppingCartQuantity(cartId, quantity);

    if (error) {
      this.logger.error(`Update error: ${error.message}`);
      return { success: false, message: error.message };
    }

    return {
      success: true,
      message: 'Đã cập nhật số lượng',
      data,
    };
  }

  /**
   * Xóa sản phẩm khỏi giỏ
   */
  async removeFromCart(userId: string, cartId: number) {
    this.logger.log(`Removing from cart: cart=${cartId}`);

    // 1️⃣ Verify ownership
    const { data: cartItem, error: getError } = await this.supabaseService.getCartItemById(cartId);

    if (getError || !cartItem) {
      throw new BadRequestException('Không tìm thấy item trong giỏ hàng');
    }

    if (cartItem.customer_id !== userId) {
      throw new ForbiddenException('Bạn không có quyền xóa item này');
    }

    // 2️⃣ Delete
    const { error } = await this.supabaseService.deleteShoppingCartItem(cartId);

    if (error) {
      this.logger.error(`Delete error: ${error.message}`);
      return { success: false, message: error.message };
    }

    return {
      success: true,
      message: 'Đã xóa sản phẩm khỏi giỏ hàng',
    };
  }

  /**
   * Xóa toàn bộ giỏ hàng
   */
  async clearCart(userId: string) {
    const { error } = await this.supabaseService.clearShoppingCart(userId);

    if (error) {
      return { success: false, message: error.message };
    }

    return {
      success: true,
      message: 'Đã xóa toàn bộ giỏ hàng',
    };
  }
}



################################################################################
## FILE 73: shopping-cart.module.ts
## Path: backend/src/shopping-cart/shopping-cart.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { ShoppingCartController } from './shopping-cart.controller';
import { ShoppingCartService } from './shopping-cart.service';
import { SupabaseService } from '../supabase.service';
import { AuthModule } from '../auth/auth.module';

@Module({
  imports: [AuthModule],
  controllers: [ShoppingCartController],
  providers: [ShoppingCartService,SupabaseService],
  exports: [ShoppingCartService],
})
export class ShoppingCartModule {}




################################################################################
## FILE 74: shopping-cart.controller.ts
## Path: backend/src/shopping-cart/shopping-cart.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Put,
  Delete,
  Body,
  Param,
  ParseIntPipe,
  HttpCode,
  HttpStatus,
} from '@nestjs/common';
import { ShoppingCartService } from './shopping-cart.service';
import { CurrentUser, CustomerOnly } from '../auth/decorators';

// DTOs
class AddToCartDto {
  productId: number;
  quantity?: number;
  variantId?: number;
  phoneModelId?: number;
  phoneModelName?: string;
}

class UpdateQuantityDto {
  quantity: number;
}

@Controller('shopping-cart')
export class ShoppingCartController {
  constructor(private readonly cartService: ShoppingCartService) {}

  /**
   * GET /shopping-cart - Lấy giỏ hàng của user hiện tại
   * Yêu cầu: Đăng nhập với role CUSTOMER
   */
  @Get()
  @CustomerOnly()
  async getCart(@CurrentUser('id') userId: string) {
    return this.cartService.getCartByUserId(userId);
  }

  /**
   * POST /shopping-cart - Thêm sản phẩm vào giỏ
   * Body: { productId: number, quantity?: number, variantId?: number }
   */
  @Post()
  @CustomerOnly()
  @HttpCode(HttpStatus.CREATED)
  async addToCart(
    @CurrentUser('id') userId: string,
    @Body() body: AddToCartDto,
  ) {
    return this.cartService.addToCart(
      userId,
      body.productId,
      body.quantity || 1,
      body.variantId,
      body.phoneModelId,
      body.phoneModelName,
    );
  }

  /**
   * PUT /shopping-cart/:id - Cập nhật số lượng
   * Params: id = cart_id
   * Body: { quantity: number }
   */
  @Put(':id')
  @CustomerOnly()
  async updateQuantity(
    @CurrentUser('id') userId: string,
    @Param('id', ParseIntPipe) cartId: number,
    @Body() body: UpdateQuantityDto,
  ) {
    return this.cartService.updateQuantity(userId, cartId, body.quantity);
  }

  /**
   * DELETE /shopping-cart/:id - Xóa item khỏi giỏ
   */
  @Delete(':id')
  @CustomerOnly()
  async removeFromCart(
    @CurrentUser('id') userId: string,
    @Param('id', ParseIntPipe) cartId: number,
  ) {
    return this.cartService.removeFromCart(userId, cartId);
  }

  /**
   * DELETE /shopping-cart - Xóa toàn bộ giỏ hàng
   */
  @Delete()
  @CustomerOnly()
  async clearCart(@CurrentUser('id') userId: string) {
    return this.cartService.clearCart(userId);
  }
}




################################################################################
## FILE 75: users.service.ts
## Path: backend/src/users/users.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class UsersService {
  constructor(private readonly supabaseService: SupabaseService) {}

  async getUsers() {
    const result = await this.supabaseService.getCustomers();
    return result.data || [];
  }
}




################################################################################
## FILE 76: users.module.ts
## Path: backend/src/users/users.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';
import { UsersService } from './users.service';
import { SupabaseService } from '../supabase.service';

@Module({
  controllers: [UsersController],
  providers: [UsersService, SupabaseService],
  exports: [UsersService],
})
export class UsersModule {}




################################################################################
## FILE 77: users.controller.ts
## Path: backend/src/users/users.controller.ts
################################################################################

import { Controller, Get } from '@nestjs/common';
import { UsersService } from './users.service';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Get()
  async getUsers() {
    return await this.usersService.getUsers();
  }
}




################################################################################
## FILE 78: wishlist.service.ts
## Path: backend/src/wishlist/wishlist.service.ts
################################################################################

import { Injectable } from '@nestjs/common';
import { SupabaseService } from '../supabase.service';

@Injectable()
export class WishlistService {
  constructor(private supabaseService: SupabaseService) {}

  // Lấy danh sách yêu thích của user
  async getWishlist(userId: string) {
    try {
      const { data, error } = await this.supabaseService.getWishlistByUserId(userId);

      if (error) {
        console.error('Get wishlist error:', error);
        return [];
      }

      return data || [];
    } catch (error) {
      console.error('Get wishlist error:', error);
      return [];
    }
  }

  // Lấy danh sách product_id trong wishlist của user
  async getWishlistProductIds(userId: string): Promise<number[]> {
    try {
      const { data, error } = await this.supabaseService.getWishlistProductIds(userId);

      if (error) {
        console.error('Get wishlist product ids error:', error);
        return [];
      }

      return data?.map(item => item.product_id) || [];
    } catch (error) {
      console.error('Get wishlist product ids error:', error);
      return [];
    }
  }

  // Thêm sản phẩm vào danh sách yêu thích
  async addToWishlist(userId: string, productId: number) {
    try {
      const { data, error } = await this.supabaseService.addProductToWishlist(userId, productId);

      if (error) {
        // Nếu đã tồn tại thì không báo lỗi
        if (error.code === '23505') {
          return { message: 'Product already in wishlist', success: true };
        }
        console.error('Add to wishlist error:', error);
        throw error;
      }

      return { message: 'Added to wishlist', success: true, data };
    } catch (error) {
      console.error('Add to wishlist error:', error);
      throw error;
    }
  }

  // Xóa sản phẩm khỏi danh sách yêu thích
  async removeFromWishlist(userId: string, productId: number) {
    try {
      const { error } = await this.supabaseService.removeProductFromWishlist(userId, productId);

      if (error) {
        console.error('Remove from wishlist error:', error);
        throw error;
      }

      return { message: 'Removed from wishlist', success: true };
    } catch (error) {
      console.error('Remove from wishlist error:', error);
      throw error;
    }
  }

  // Toggle wishlist (thêm nếu chưa có, xóa nếu đã có)
  async toggleWishlist(userId: string, productId: number) {
    try {
      // Kiểm tra xem đã có trong wishlist chưa
      const { data: existing } = await this.supabaseService.getWishlistItem(userId, productId);

      if (existing) {
        // Đã có -> xóa
        await this.removeFromWishlist(userId, productId);
        return { message: 'Removed from wishlist', success: true, action: 'removed' };
      } else {
        // Chưa có -> thêm
        await this.addToWishlist(userId, productId);
        return { message: 'Added to wishlist', success: true, action: 'added' };
      }
    } catch (error) {
      console.error('Toggle wishlist error:', error);
      throw error;
    }
  }

  // Kiểm tra sản phẩm có trong wishlist không
  async isInWishlist(userId: string, productId: number): Promise<boolean> {
    try {
      const { data } = await this.supabaseService.getWishlistItem(userId, productId);
      return !!data;
    } catch (error) {
      return false;
    }
  }
}




################################################################################
## FILE 79: wishlist.module.ts
## Path: backend/src/wishlist/wishlist.module.ts
################################################################################

import { Module } from '@nestjs/common';
import { WishlistController } from './wishlist.controller';
import { WishlistService } from './wishlist.service';
import { SupabaseService } from '../supabase.service';
import { AuthModule } from '../auth/auth.module';

@Module({
  imports: [AuthModule],
  controllers: [WishlistController],
  providers: [WishlistService, SupabaseService],
  exports: [WishlistService],
})
export class WishlistModule {}




################################################################################
## FILE 80: wishlist.controller.ts
## Path: backend/src/wishlist/wishlist.controller.ts
################################################################################

import {
  Controller,
  Get,
  Post,
  Delete,
  Param,
  UseGuards,
  Request,
  ParseIntPipe,
} from '@nestjs/common';
import { WishlistService } from './wishlist.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';

@Controller('wishlist')
export class WishlistController {
  constructor(private readonly wishlistService: WishlistService) {}

  // Lấy danh sách yêu thích của user
  @UseGuards(JwtAuthGuard)
  @Get()
  async getWishlist(@Request() req) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.getWishlist(userId);
  }

  // Lấy danh sách product_id trong wishlist
  @UseGuards(JwtAuthGuard)
  @Get('product-ids')
  async getWishlistProductIds(@Request() req) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.getWishlistProductIds(userId);
  }

  // Thêm sản phẩm vào wishlist
  @UseGuards(JwtAuthGuard)
  @Post(':productId')
  async addToWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.addToWishlist(userId, productId);
  }

  // Xóa sản phẩm khỏi wishlist
  @UseGuards(JwtAuthGuard)
  @Delete(':productId')
  async removeFromWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.removeFromWishlist(userId, productId);
  }

  // Toggle wishlist (thêm/xóa)
  @UseGuards(JwtAuthGuard)
  @Post('toggle/:productId')
  async toggleWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    return this.wishlistService.toggleWishlist(userId, productId);
  }

  // Kiểm tra sản phẩm có trong wishlist không
  @UseGuards(JwtAuthGuard)
  @Get('check/:productId')
  async isInWishlist(
    @Request() req,
    @Param('productId', ParseIntPipe) productId: number,
  ) {
    const userId = req.user.sub || req.user.id;
    const isInWishlist = await this.wishlistService.isInWishlist(userId, productId);
    return { isInWishlist };
  }
}




################################################################################
## FILE 81: postcss.config.mjs
## Path: fontend/postcss.config.mjs
################################################################################

const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;




################################################################################
## FILE 82: package.json
## Path: fontend/package.json
################################################################################

{
  "name": "fontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.87.3",
    "axios": "^1.13.2",
    "fabric": "^6.9.1",
    "lucide-react": "^0.555.0",
    "next": "16.0.7",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "sharp": "^0.34.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.23",
    "babel-plugin-react-compiler": "1.0.0",
    "eslint": "^9",
    "eslint-config-next": "16.0.7",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.13",
    "typescript": "^5"
  }
}




################################################################################
## FILE 83: next.config.ts
## Path: fontend/next.config.ts
################################################################################

import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '**',
      },
      {
        protocol: 'http',
        hostname: '**',
      },
    ],
  },
};

export default nextConfig;




################################################################################
## FILE 84: next-env.d.ts
## Path: fontend/next-env.d.ts
################################################################################

/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.




################################################################################
## FILE 85: constants.ts
## Path: fontend/lib/constants.ts
################################################################################

// Danh mục sản phẩm - dùng chung cho tất cả các trang
export const PRODUCT_CATEGORIES = [
  { name: 'Ốp lưng', icon: '📱', count: 120 },
  { name: 'Cường lực màn hình', icon: '🛡️', count: 95 },
  { name: 'Miếng dán camera', icon: '📷', count: 85 },
  // { name: 'Cáp sạc', icon: '⚡', count: 60 },
  // { name: 'Tai nghe', icon: '🎧', count: 40 },
  // { name: 'Dây đeo điện thoại', icon: '🔗', count: 60 },
  // { name: 'Sticker trang trí', icon: '✨', count: 40 }
];

// Danh mục cho trang Shop (có thêm "Tất Cả")
export const SHOP_CATEGORIES = [
  { name: 'Tất Cả', icon: '🛒' },
  ...PRODUCT_CATEGORIES.map(cat => ({ name: cat.name, icon: cat.icon }))
];

// Thương hiệu
export const BRAND_NAME = 'GoatTech';

// Danh sách thiết bị hỗ trợ
export const DEVICES = [
  'iPhone 17 Pro Max',
  'iPhone 17 Pro',
  'iPhone 16 Pro Max',
  'iPhone 16 Pro',
  'iPhone 16e',
  'iPhone 15 Pro Max',
  'iPhone 15 Pro',
  'iPhone 14 Pro Max',
  'Samsung Galaxy S24',
];

// Banner slides cho trang chủ
export const BANNER_SLIDES = [
  {
    title: 'Ốp Điện Thoại Cao Cấp - Shop #1 Việt Nam',
    subtitle: 'Bảo Vệ Điện Thoại Của Bạn Với Phong Cách',
    bg: 'from-purple-600 to-pink-600'
  },
  {
    title: 'Bộ Sưu Tập Xuân 2024 - Mẫu Mới Đặc Biệt',
    subtitle: 'Thiết Kế Độc Đáo, Chất Lượng Tuyệt Vời',
    bg: 'from-blue-600 to-cyan-600'
  },
  {
    title: 'Miễn Phí Vận Chuyển - Đơn Hàng Trên 100K',
    subtitle: 'Nhanh, An Toàn, Uy Tín',
    bg: 'from-green-600 to-teal-600'
  }
];




################################################################################
## FILE 86: api-client.ts
## Path: fontend/lib/api-client.ts
################################################################################

// ============ ADMIN DASHBOARD ============
export const fetchAdminDashboard = async () => {
  const response = await apiClient.get('/admin/dashboard');
  return response.data;
};
import axios from 'axios';

const API_BASE_URL = 'http://localhost:3001';

export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ============ USERS ============
export const fetchUsers = async () => {
  const response = await apiClient.get('/users');
  return response.data;
};

// ============ PRODUCTS ============
export const fetchProducts = async (limit = 10) => {
  const response = await apiClient.get(`/products?limit=${limit}`);
  return response.data;
};

export const fetchProductById = async (id: number) => {
  try {
    const response = await apiClient.get(`/products/${id}`);
    return response.data;
  } catch (error) {
    console.error('Fetch product by id error:', error);
    return null;
  }
};

export const createProduct = async (productData: any) => {
  const response = await apiClient.post('/products', productData);
  return response.data;
};

export const updateProduct = async (id: number, productData: any) => {
  const response = await apiClient.put(`/products/${id}`, productData);
  return response.data;
};

export const deleteProduct = async (id: number) => {
  const response = await apiClient.delete(`/products/${id}`);
  return response.data;
};

// ============ PRODUCTS BY SEASON ============
export const fetchProductsBySeason = async (season: string) => {
  const response = await apiClient.get(`/products/season/${season}`);
  return response.data;
};

export const fetchSeasonProductCounts = async () => {
  const response = await apiClient.get('/products/season/counts');
  return response.data;
};

// ============ ORDERS ============
export const fetchOrders = async (limit = 20) => {
  try {
    // Gửi token nếu có
    const customerData = localStorage.getItem('customer');
    const headers: Record<string, string> = {};
    
    if (customerData) {
      const customer = JSON.parse(customerData);
      if (customer.access_token) {
        headers['Authorization'] = `Bearer ${customer.access_token}`;
      }
    }
    
    const response = await apiClient.get(`/orders?limit=${limit}`, { headers });
    return response.data;
  } catch (error: any) {
    console.error('fetchOrders error:', error);
    return [];
  }
};

// Lấy tất cả orders cho admin
export const fetchAllOrdersAdmin = async () => {
  try {
    const customerData = localStorage.getItem('customer');
    const headers: Record<string, string> = {};
    
    if (customerData) {
      const customer = JSON.parse(customerData);
      if (customer.access_token) {
        headers['Authorization'] = `Bearer ${customer.access_token}`;
      }
    }
    
    const response = await apiClient.get('/orders/admin/all', { headers });
    return response.data;
  } catch (error: any) {
    console.error('fetchAllOrdersAdmin error:', error);
    return [];
  }
};

// ============ CATEGORIES ============
export const fetchCategories = async () => {
  const response = await apiClient.get('/categories');
  return response.data;
};

export const fetchCategoriesWithCount = async () => {
  const response = await apiClient.get('/categories/with-count');
  return response.data;
};

export const fetchRootCategories = async () => {
  const response = await apiClient.get('/categories/root');
  return response.data;
};

export const fetchCategoryById = async (id: number) => {
  const response = await apiClient.get(`/categories/${id}`);
  return response.data;
};

export const fetchCategoryBySlug = async (slug: string) => {
  const response = await apiClient.get(`/categories/slug/${slug}`);
  return response.data;
};

export const fetchChildCategories = async (parentId: number) => {
  const response = await apiClient.get(`/categories/${parentId}/children`);
  return response.data;
};

export const createCategory = async (categoryData: {
  category_name: string;
  category_slug: string;
  description?: string;
  parent_category_id?: number | null;
  display_order?: number;
  is_active?: boolean;
}) => {
  const response = await apiClient.post('/categories', categoryData);
  return response.data;
};

export const updateCategory = async (id: number, categoryData: any) => {
  const response = await apiClient.put(`/categories/${id}`, categoryData);
  return response.data;
};

export const deleteCategory = async (id: number) => {
  const response = await apiClient.delete(`/categories/${id}`);
  return response.data;
};

// ============ AUTHENTICATION ============

export const registerCustomer = async (customerData: {
  email: string;
  password: string;
  first_name?: string;
  last_name?: string;
  full_name?: string;
  phone?: string;
}) => {
  try {
    // Ghép first_name + last_name thành full_name nếu cần
    const fullName = customerData.full_name || 
      `${customerData.first_name || ''} ${customerData.last_name || ''}`.trim();
    
    const response = await apiClient.post('/auth/register', {
      email: customerData.email.trim().toLowerCase(),
      password: customerData.password,
      full_name: fullName,
      phone: customerData.phone?.trim() || undefined,
    });
    return response.data;
  } catch (error: any) {
    // Trả về error message từ backend
    return {
      success: false,
      message: error.response?.data?.message || 'Đăng ký thất bại',
    };
  }
};

export const loginCustomer = async (email: string, password: string) => {
  try {
    const response = await apiClient.post('/auth/login', { 
      email: email.trim().toLowerCase(), 
      password 
    });
    return response.data;
  } catch (error: any) {
    // Trả về error message từ backend
    return {
      success: false,
      message: error.response?.data?.message || 'Đăng nhập thất bại',
    };
  }
};

export const validateToken = async (token: string) => {
  try {
    const response = await apiClient.post('/auth/validate', null, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });
    return response.data;
  } catch (error: any) {
    return {
      valid: false,
      message: error.response?.data?.message || 'Token không hợp lệ',
    };
  }
};

export const changePassword = async (oldPassword: string, newPassword: string) => {
  try {
    const response = await apiClient.put('/auth/change-password', {
      oldPassword,
      newPassword,
    });
    return response.data;
  } catch (error: any) {
    return {
      success: false,
      message: error.response?.data?.message || 'Đổi mật khẩu thất bại',
    };
  }
};
// ============ REVIEWS ============
export const fetchAllReviews = async (limit = 50) => {
  const response = await apiClient.get(`/reviews?limit=${limit}`);
  return response.data;
};

export const fetchProductReviews = async (productId: number) => {
  const response = await apiClient.get(`/reviews/product/${productId}`);
  return response.data;
};

export const createReview = async (reviewData: {
  product_id: number;
  customer_id?: number;
  customer_name: string;
  customer_email?: string;
  rating: number;
  review_title?: string;
  review_text: string;
}) => {
  const response = await apiClient.post('/reviews', reviewData);
  return response.data;
};

export const approveReview = async (reviewId: number, isApproved: boolean) => {
  const response = await apiClient.put(`/reviews/${reviewId}/approve`, { is_approved: isApproved });
  return response.data;
};

export const deleteReview = async (reviewId: number) => {
  const response = await apiClient.delete(`/reviews/${reviewId}`);
  return response.data;
};

// ============ CONTACT MESSAGES ============
export const fetchAllContacts = async (limit = 50) => {
  const response = await apiClient.get(`/contacts?limit=${limit}`);
  return response.data;
};

export const createContactMessage = async (messageData: {
  name: string;
  email: string;
  phone?: string;
  subject?: string;
  message: string;
}) => {
  const response = await apiClient.post('/contacts', messageData);
  return response.data;
};

export const updateContactStatus = async (id: number, status: string) => {
  const response = await apiClient.put(`/contacts/${id}/status`, { status });
  return response.data;
};

export const deleteContact = async (id: number) => {
  const response = await apiClient.delete(`/contacts/${id}`);
  return response.data;
};

// ============ PAYMENT / MOMO ============
export const createMomoPayment = async (data: {
  amount: string | number;
  orderInfo?: string;
  orderId?: string;
  redirectUrl?: string;
  ipnUrl?: string;
  extraData?: string;
}) => {
  const response = await apiClient.post('/payment/momo', {
    amount: String(data.amount),
    orderInfo: data.orderInfo || 'Thanh toán đơn hàng GoatTech',
    orderId: data.orderId,
    redirectUrl: data.redirectUrl,
    ipnUrl: data.ipnUrl,
    extraData: data.extraData || '',
  });
  return response.data;
};

export const checkMomoPaymentStatus = async (orderId: string) => {
  const response = await apiClient.post('/payment/momo/check-status', { orderId });
  return response.data;
};

export const refundMomoPayment = async (data: {
  orderId: string;
  transId: string;
  amount: string | number;
  description?: string;
}) => {
  const response = await apiClient.post('/payment/momo/refund', {
    orderId: data.orderId,
    transId: data.transId,
    amount: String(data.amount),
    description: data.description || 'Hoàn tiền đơn hàng',
  });
  return response.data;
};

// ============ COLLECTIONS ============
export const fetchAllCollections = async () => {
  const response = await apiClient.get('/collections');
  return response.data;
};

export const fetchCollectionsByType = async (type: string) => {
  const response = await apiClient.get(`/collections/type/${type}`);
  return response.data;
};

export const fetchCollectionBySlug = async (slug: string) => {
  const response = await apiClient.get(`/collections/slug/${slug}`);
  return response.data;
};

export const fetchCollectionProductCounts = async () => {
  const response = await apiClient.get('/collections/counts');
  return response.data;
};

export const fetchProductsByCollection = async (slug: string) => {
  const response = await apiClient.get(`/collections/slug/${slug}/products`);
  return response.data;
};

export const fetchProductCollections = async (productId: number) => {
  const response = await apiClient.get(`/collections/product/${productId}`);
  return response.data;
};

export const addProductToCollection = async (productId: number, collectionId: number) => {
  const response = await apiClient.post('/collections/product', { productId, collectionId });
  return response.data;
};

export const updateProductCollections = async (productId: number, collectionIds: number[]) => {
  const response = await apiClient.put(`/collections/product/${productId}`, { collectionIds });
  return response.data;
};

export const removeProductFromCollection = async (productId: number, collectionId: number) => {
  const response = await apiClient.delete('/collections/product', { 
    data: { productId, collectionId } 
  });
  return response.data;
};

export const createCollection = async (collectionData: {
  collection_name: string;
  collection_slug: string;
  collection_description?: string;
  collection_image?: string;
  collection_gradient?: string;
  collection_icon?: string;
  collection_type?: string;
  display_order?: number;
}) => {
  const response = await apiClient.post('/collections', collectionData);
  return response.data;
};

export const updateCollection = async (id: number, collectionData: any) => {
  const response = await apiClient.put(`/collections/${id}`, collectionData);
  return response.data;
};

export const deleteCollection = async (id: number) => {
  const response = await apiClient.delete(`/collections/${id}`);
  return response.data;
};

// ============ ERROR HANDLING ============
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    console.error('API Error:', error.response?.data || error.message);
    return Promise.reject(error);
  },
);
// ============ SHOPPING_CART ============
/**
 * Lấy giỏ hàng của user hiện tại
 * Yêu cầu: Phải đăng nhập (có token)
 */
export const fetchShoppingCart = async () => {
  try {
    console.log('console log đang được gọi từ fetchShoppingCart');
    // Lấy token từ localStorage
    const customerData = localStorage.getItem('customer');
    console.log(customerData);
    console.log(getAuthHeaders());
    
    if (!customerData) {
      return { success: false, message: 'Chưa đăng nhập', data: [] };
    }
    const customer = JSON.parse(customerData);
    console.log('Customer ID (UUID):', customer.id);
    
    const response = await apiClient.get('/shopping-cart', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'Không thể tải giỏ hàng',
      data: [],
    };
  }
};

/**
 * Thêm sản phẩm vào giỏ
 */
export const addToShoppingCart = async (data: {
  userId: string;
  productId: number;
  quantity?: number;
  variantId?: number;
  phoneModelId?: number;
  phoneModelName?: string;
}) => {
  try {
    const response = await apiClient.post(
      '/shopping-cart',
      {
        productId: data.productId,
        quantity: data.quantity || 1,
        variantId: data.variantId || null,
        phoneModelId: data.phoneModelId || null,
        phoneModelName: data.phoneModelName || null,
      },
      {
        headers: getAuthHeaders(),
      }
    );
    return response.data;
  } catch (error: any) {
    console.error('Add to cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'Không thể thêm vào giỏ hàng',
    };
  }
};

/**
 * Cập nhật số lượng
 */
export const updateShoppingCart = async (cartId: number, quantity: number) => {
  try {
    const response = await apiClient.put(
      `/shopping-cart/${cartId}`,
      { quantity },
      {
        headers: getAuthHeaders(),
      }
    );
    return response.data;
  } catch (error: any) {
    console.error('Update cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'Không thể cập nhật',
    };
  }
};

/**
 * Xóa item khỏi giỏ
 */
export const deleteShoppingCart = async (cartId: number) => {
  try {
    const response = await apiClient.delete(`/shopping-cart/${cartId}`, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Delete cart item error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'Không thể xóa',
    };
  }
};

/**
 * Xóa toàn bộ giỏ hàng
 */
export const clearShoppingCart = async () => {
  try {
    const response = await apiClient.delete('/shopping-cart', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Clear cart error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'Không thể xóa giỏ hàng',
    };
  }
};

/**
 * Helper: Lấy auth headers
 */
const getAuthHeaders = () => {
  const customerData = localStorage.getItem('customer');
  if (!customerData) return {};
  console.log('🔍 getAuthHeaders called');
  console.log('📦 customerData raw:', customerData);
  try {
    const customer = JSON.parse(customerData);
    // Nếu có access_token thì dùng, không thì dùng id như là simple auth
    console.log('✅ Using Authorization Bearer token',customer.access_token);
    if (customer.access_token) {
      return { Authorization: `Bearer ${customer.access_token}` };
    }
    // Fallback: gửi user-id trong header (backend cần xử lý)
    return { 'X-User-Id': customer.id };
  } catch {
    return {};
  }
};

// ============ ORDERS - ENHANCED ============

/**
 * Tạo đơn hàng mới
 */
export const createOrder = async (orderData: {
  items: {
    product_id: number;
    variant_id?: number;
    product_name: string;
    variant_name?: string;
    sku?: string;
    quantity: number;
    unit_price: number;
    discount_amount?: number;
  }[];
  shipping_address?: {
    full_name: string;
    phone: string;
    address_line1: string;
    ward?: string;
    district?: string;
    city: string;
  };
  subtotal:number,
  payment_method?: string;
  coupon_code?: string;
  customer_note?: string;
}) => {
  try {
    const response = await apiClient.post('/orders', orderData, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Create order error:', error);
    return {
      success: false,
      message: error.response?.data?.message || 'Không thể tạo đơn hàng',
    };
  }
};

/**
 * Lấy đơn hàng theo order number
 */
export const fetchOrderByNumber = async (orderNumber: string) => {
  try {
    const response = await apiClient.get(`/orders/number/${orderNumber}`);
    return response.data;
  } catch (error: any) {
    console.error('Fetch order error:', error);
    return null;
  }
};

/**
 * Lấy danh sách đơn hàng của customer
 */
export const fetchMyOrders = async () => {
  try {
    const response = await apiClient.get('/orders', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch orders error:', error);
    return [];
  }
};

// ============ WISHLIST ============
export const fetchWishlist = async () => {
  try {
    const response = await apiClient.get('/wishlist', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch wishlist error:', error);
    return [];
  }
};

export const fetchWishlistProductIds = async (): Promise<number[]> => {
  try {
    const response = await apiClient.get('/wishlist/product-ids', {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Fetch wishlist product ids error:', error);
    return [];
  }
};

export const addToWishlist = async (productId: number) => {
  try {
    const response = await apiClient.post(`/wishlist/${productId}`, {}, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Add to wishlist error:', error);
    throw error;
  }
};

export const removeFromWishlist = async (productId: number) => {
  try {
    const response = await apiClient.delete(`/wishlist/${productId}`, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Remove from wishlist error:', error);
    throw error;
  }
};

export const toggleWishlist = async (productId: number) => {
  try {
    const response = await apiClient.post(`/wishlist/toggle/${productId}`, {}, {
      headers: getAuthHeaders(),
    });
    return response.data;
  } catch (error: any) {
    console.error('Toggle wishlist error:', error);
    throw error;
  }
};

export const checkIsInWishlist = async (productId: number): Promise<boolean> => {
  try {
    const response = await apiClient.get(`/wishlist/check/${productId}`, {
      headers: getAuthHeaders(),
    });
    return response.data.isInWishlist;
  } catch (error: any) {
    console.error('Check wishlist error:', error);
    return false;
  }
};

// ============ GIFT ============
export interface SendGiftData {
  senderName: string;
  senderEmail: string;
  senderMessage?: string;
  senderId?: string;
  recipientName: string;
  recipientEmail: string;
  recipientPhone?: string;
  recipientAddress?: string;
  productId: number;
  quantity?: number;
}

export const sendGift = async (data: SendGiftData) => {
  const response = await apiClient.post('/gift/send', data);
  return response.data;
};

export const verifyGift = async (giftId: string, verificationCode: string) => {
  const response = await apiClient.post('/gift/verify', { giftId, verificationCode });
  return response.data;
};

export const claimGift = async (giftId: string, recipientAddress: string, recipientPhone: string) => {
  const response = await apiClient.post('/gift/claim', { giftId, recipientAddress, recipientPhone });
  return response.data;
};

export const getGiftInfo = async (giftId: string) => {
  const response = await apiClient.get(`/gift/${giftId}`);
  return response.data;
};

export const getSentGifts = async (userId: string) => {
  const response = await apiClient.get(`/gift/sent/${userId}`);
  return response.data;
};

export const getReceivedGifts = async (email: string) => {
  const response = await apiClient.get(`/gift/received/by-email?email=${encodeURIComponent(email)}`);
  return response.data;
};

// ============ CUSTOM DESIGNS ============
export interface CreateDesignData {
  userId?: string;
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
  templateId?: string;
  phoneModel: string;
  designData: any;
  previewImageBase64?: string;
}

export interface SubmitDesignData {
  guestEmail?: string;
  guestName?: string;
  guestPhone?: string;
}

// Lấy danh sách phone templates
export const getPhoneTemplates = async () => {
  const response = await apiClient.get('/designs/templates');
  return response.data;
};

// Tạo thiết kế mới
export const createDesign = async (data: CreateDesignData) => {
  const response = await apiClient.post('/designs', data);
  return response.data;
};

// Lấy thiết kế theo ID
export const getDesignById = async (designId: string) => {
  const response = await apiClient.get(`/designs/${designId}`);
  return response.data;
};

// Cập nhật thiết kế
export const updateDesign = async (designId: string, data: any) => {
  const response = await apiClient.put(`/designs/${designId}`, data);
  return response.data;
};

// Gửi thiết kế cho admin
export const submitDesign = async (designId: string, data: SubmitDesignData) => {
  const response = await apiClient.post(`/designs/${designId}/submit`, data);
  return response.data;
};

// Lấy thiết kế của user
export const getUserDesigns = async (userId: string) => {
  const response = await apiClient.get(`/designs/user/${userId}`);
  return response.data;
};

// Admin: Lấy tất cả thiết kế
export const getAllDesigns = async (status?: string) => {
  const url = status ? `/designs/admin/all?status=${status}` : '/designs/admin/all';
  const response = await apiClient.get(url);
  return response.data;
};

// Admin: Duyệt thiết kế
export const approveDesign = async (designId: string, adminNotes?: string) => {
  const response = await apiClient.put(`/designs/admin/${designId}/approve`, { adminNotes });
  return response.data;
};

// Admin: Từ chối thiết kế
export const rejectDesign = async (designId: string, adminNotes: string) => {
  const response = await apiClient.put(`/designs/admin/${designId}/reject`, { adminNotes });
  return response.data;
};

// Xóa thiết kế
export const deleteDesign = async (designId: string) => {
  const response = await apiClient.delete(`/designs/${designId}`);
  return response.data;
};

// ============ PHONE MODELS (Dòng máy điện thoại) ============

// Lấy tất cả dòng máy (grouped by brand)
export const fetchAllPhoneModels = async () => {
  try {
    const response = await apiClient.get('/phone-models');
    return response.data;
  } catch (error) {
    console.error('fetchAllPhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Lấy dòng máy phổ biến
export const fetchPopularPhoneModels = async () => {
  try {
    const response = await apiClient.get('/phone-models/popular');
    return response.data;
  } catch (error) {
    console.error('fetchPopularPhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Lấy dòng máy theo hãng
export const fetchPhoneModelsByBrand = async (brandName: string) => {
  try {
    const response = await apiClient.get(`/phone-models/brand/${encodeURIComponent(brandName)}`);
    return response.data;
  } catch (error) {
    console.error('fetchPhoneModelsByBrand error:', error);
    return { success: false, data: [] };
  }
};

// Tìm kiếm dòng máy
export const searchPhoneModels = async (keyword: string) => {
  try {
    const response = await apiClient.get(`/phone-models/search?keyword=${encodeURIComponent(keyword)}`);
    return response.data;
  } catch (error) {
    console.error('searchPhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Lấy dòng máy tương thích với sản phẩm
export const fetchCompatiblePhoneModels = async (productId: number) => {
  try {
    const response = await apiClient.get(`/phone-models/product/${productId}`);
    return response.data;
  } catch (error) {
    console.error('fetchCompatiblePhoneModels error:', error);
    return { success: false, data: [] };
  }
};

// Lấy chi tiết dòng máy
export const fetchPhoneModelById = async (modelId: number) => {
  try {
    const response = await apiClient.get(`/phone-models/${modelId}`);
    return response.data;
  } catch (error) {
    console.error('fetchPhoneModelById error:', error);
    return null;
  }
};

// Admin: Tạo dòng máy mới
export const createPhoneModel = async (modelData: {
  brand_name: string;
  model_name: string;
  model_code?: string;
  release_year?: number;
  screen_size?: string;
  is_popular?: boolean;
  is_active?: boolean;
}) => {
  const response = await apiClient.post('/phone-models', modelData);
  return response.data;
};

// Admin: Cập nhật dòng máy
export const updatePhoneModel = async (modelId: number, modelData: any) => {
  const response = await apiClient.put(`/phone-models/${modelId}`, modelData);
  return response.data;
};

// Admin: Xóa dòng máy
export const deletePhoneModel = async (modelId: number) => {
  const response = await apiClient.delete(`/phone-models/${modelId}`);
  return response.data;
};

// Admin: Set dòng máy tương thích cho sản phẩm
export const setProductCompatibility = async (productId: number, phoneModelIds: number[]) => {
  const response = await apiClient.post(`/phone-models/product/${productId}/compatibility`, {
    phoneModelIds,
  });
  return response.data;
};

import { createBrowserClient } from '@supabase/ssr';
const client = axios.create({ baseURL: process.env.NEXT_PUBLIC_API_URL });

client.interceptors.request.use(async (config) => {
  const supabase = createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
  const { data } = await supabase.auth.getSession();
  const token = data.session?.access_token;
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

export default client;




################################################################################
## FILE 87: users.api.ts
## Path: fontend/lib/api/users.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ USERS ============
export const fetchUsers = async () => {
  const response = await apiClient.get('/users');
  return response.data;
};




################################################################################
## FILE 88: product.api.ts
## Path: fontend/lib/api/product.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ PRODUCTS ============
export const fetchProducts = async (limit = 10) => {
  const response = await apiClient.get(`/products?limit=${limit}`);
  return response.data;
};

export const fetchProductById = async (id: number) => {
  const response = await apiClient.get(`/products/${id}`);
  return response.data;
};




################################################################################
## FILE 89: order.api.ts
## Path: fontend/lib/api/order.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ ORDERS ============
export const fetchOrders = async (limit = 20) => {
  const response = await apiClient.get(`/orders?limit=${limit}`);
  return response.data;
};

export const fetchOrderById = async (id: number) => {
  const response = await apiClient.get(`/orders/${id}`);
  return response.data;
};




################################################################################
## FILE 90: index.ts
## Path: fontend/lib/api/index.ts
################################################################################

// Export tất cả API functions
export * from './auth.api';
export * from './product.api';
export * from './category.api';
export * from './order.api';
export * from './users.api';




################################################################################
## FILE 91: category.api.ts
## Path: fontend/lib/api/category.api.ts
################################################################################

import { apiClient } from './auth.api';

// ============ CATEGORIES ============
export const fetchCategories = async () => {
  const response = await apiClient.get('/categories');
  return response.data;
};

export const fetchRootCategories = async () => {
  const response = await apiClient.get('/categories/root');
  return response.data;
};

export const fetchCategoryById = async (id: number) => {
  const response = await apiClient.get(`/categories/${id}`);
  return response.data;
};

export const fetchCategoryBySlug = async (slug: string) => {
  const response = await apiClient.get(`/categories/slug/${slug}`);
  return response.data;
};

export const fetchChildCategories = async (parentId: number) => {
  const response = await apiClient.get(`/categories/${parentId}/children`);
  return response.data;
};




################################################################################
## FILE 92: auth.api.ts
## Path: fontend/lib/api/auth.api.ts
################################################################################

import axios from 'axios';

const API_BASE_URL = 'http://localhost:3001';

export const apiClient = axios.create({
  baseURL: API_BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// ============ AUTHENTICATION ============
export const registerCustomer = async (customerData: {
  email: string;
  password: string;
  full_name: string;
  phone_number?: string;
  address?: string;
}) => {
  const response = await apiClient.post('/auth/register', customerData);
  return response.data;
};

export const loginCustomer = async (email: string, password: string) => {
  const response = await apiClient.post('/auth/login', { email, password });
  return response.data;
};




################################################################################
## FILE 93: middleware.ts
## Path: fontend/src/middleware.ts
################################################################################

import { NextResponse, type NextRequest } from 'next/server';
import { createServerClient } from '@supabase/ssr';

// const PROTECTED_ROUTES = ['/account', '/shopping-cart', '/checkout', '/orders'];
const PROTECTED_ROUTES = ['/hihit'];
export async function middleware(request: NextRequest) {
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value);
          });

          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });

          cookiesToSet.forEach(({ name, value, options }) => {
            response.cookies.set(name, value, options);
          });
        },
      },
    }
  );

  const {
    data: { session },
  } = await supabase.auth.getSession();

  const pathname = request.nextUrl.pathname;

  const isProtected = PROTECTED_ROUTES.some(route =>
    pathname.startsWith(route)
  );

  if (isProtected && !session) {
    const loginUrl = new URL('/login', request.url);
    loginUrl.searchParams.set('redirect', pathname);
    return NextResponse.redirect(loginUrl);
  }

  return response;
}

export const config = {
  matcher: ['/((?!_next/static|_next/image|favicon.ico|api).*)'],
};




################################################################################
## FILE 94: page.tsx
## Path: fontend/src/app/page.tsx
################################################################################

// File: fontend/src/app/(public)/page.tsx

'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { fetchProducts, fetchCategoriesWithCount, createMomoPayment, fetchAllCollections } from '@/lib/api-client';
import { PRODUCT_CATEGORIES, BANNER_SLIDES } from '@/lib/constants';
import { Product, CartItem, Category } from '@/types';
import { 
  ChevronLeft, ChevronRight, Heart, ShoppingBag, Star, 
  Sparkles, Gift, Truck, Shield, ArrowRight, TrendingUp,
  Smartphone, Watch, Headphones, Zap
} from 'lucide-react';

// Components
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';
import CartModal from '@/components/modals/CartModal';
import CurrencyModal from '@/components/modals/CurrencyModal';
import { useWishlist } from '@/app/context/wishlist-context';
import { useCart } from '@/app/context/cart-context';

// Icon map for categories
const CATEGORY_ICON_MAP: Record<string, React.ReactNode> = {
  'Ốp lưng': <Smartphone className="w-8 h-8" />,
  'Cường lực màn hình': <Shield className="w-8 h-8" />,
  'Miếng dán camera': <Watch className="w-8 h-8" />,
  'Cáp sạc': <Zap className="w-8 h-8" />,
  'Tai nghe': <Headphones className="w-8 h-8" />,
  'Phụ kiện': <Gift className="w-8 h-8" />,
};

// Gradient colors for categories
const CATEGORY_GRADIENTS = [
  'from-pink-500 via-rose-500 to-red-500',
  'from-violet-500 via-purple-500 to-indigo-500',
  'from-cyan-500 via-blue-500 to-indigo-500',
  'from-emerald-500 via-green-500 to-teal-500',
  'from-amber-500 via-orange-500 to-red-500',
  'from-fuchsia-500 via-pink-500 to-rose-500',
  'from-sky-500 via-blue-500 to-violet-500',
];

export default function HomePage() {
  const router = useRouter();
  const { wishedProducts, toggleWishlist } = useWishlist();
  const { refreshCart } = useCart();

  // State
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('VND');
  const [featuredProducts, setFeaturedProducts] = useState<Product[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [loading, setLoading] = useState(true);
  const [checkoutLoading, setCheckoutLoading] = useState(false);
  const [currentSlide, setCurrentSlide] = useState(0);
  const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);

  // Hero slides với thiết kế mới
  const heroSlides = [
    {
      title: 'Bộ Sưu Tập Xuân 2026',
      subtitle: 'Thiết Kế Độc Đáo, Chất Lượng Tuyệt Vời',
      gradient: 'from-purple-600 via-pink-500 to-rose-500',
      cta: 'Khám Phá Ngay',
    },
    {
      title: 'Flash Sale - Giảm 50%',
      subtitle: 'Chỉ Trong Hôm Nay - Số Lượng Có Hạn',
      gradient: 'from-orange-500 via-red-500 to-pink-500',
      cta: 'Mua Ngay',
    },
    {
      title: 'Phụ Kiện Cao Cấp',
      subtitle: 'Bảo Vệ Hoàn Hảo Cho Thiết Bị Của Bạn',
      gradient: 'from-cyan-500 via-blue-500 to-violet-500',
      cta: 'Xem Thêm',
    },
  ];

  // Auto slide
  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % heroSlides.length);
    }, 5000);
    return () => clearInterval(interval);
  }, []);

  // Fetch categories
  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategoriesWithCount();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
          setCategories(data);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  // Fetch products
  useEffect(() => {
    const loadProducts = async () => {
      try {
        setLoading(true);
        const data = await fetchProducts(8);
        if (Array.isArray(data)) {
          setFeaturedProducts(data);
        }
      } catch (error) {
        console.error('Error loading products:', error);
      } finally {
        setLoading(false);
      }
    };
    loadProducts();
  }, []);

  // Format price
  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN') + '₫';
  };

  // Cart handlers
  const addToCart = (product: Product) => {
    setCartItems((prev) => {
      const existing = prev.find((item) => item.id === product.id);
      if (existing) {
        return prev.map((item) =>
          item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
        );
      }
      return [...prev, { ...product, quantity: 1 }];
    });
  };

  const updateQuantity = (productId: number, newQuantity: number) => {
    if (newQuantity <= 0) {
      setCartItems((prev) => prev.filter((item) => item.id !== productId));
    } else {
      setCartItems((prev) =>
        prev.map((item) =>
          item.id === productId ? { ...item, quantity: newQuantity } : item
        )
      );
    }
  };

  const removeFromCart = (productId: number) => {
    setCartItems((prev) => prev.filter((item) => item.id !== productId));
  };

  // Checkout handler
  const handleCheckout = async () => {
    try {
      setCheckoutLoading(true);
      const cartTotal = cartItems.reduce((t, i) => t + i.price * i.quantity, 0);
      const orderItems = cartItems.map((i) => `${i.name} x${i.quantity}`).join(', ');
      const result = await createMomoPayment({
        amount: Math.round(cartTotal),
        orderInfo: `GoatTech - ${orderItems}`,
      });

      if (result?.data?.payUrl) {
        window.location.href = result.data.payUrl;
      } else {
        alert('Không thể tạo thanh toán. Vui lòng thử lại!');
      }
    } catch (error: any) {
      console.error('Payment error:', error);
      alert('Lỗi thanh toán: ' + (error.message || 'Vui lòng thử lại!'));
    } finally {
      setCheckoutLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
      {/* Modals */}
      <CartModal
        isOpen={isCartOpen}
        onClose={() => setIsCartOpen(false)}
        cartItems={cartItems}
        onUpdateQuantity={updateQuantity}
        onRemoveItem={removeFromCart}
        onCheckout={handleCheckout}
        checkoutLoading={checkoutLoading}
      />

      {isCurrencyModalOpen && (
        <CurrencyModal
          isOpen={isCurrencyModalOpen}
          onClose={() => setIsCurrencyModalOpen(false)}
          selectedCurrency={selectedCurrency}
          onCurrencyChange={setSelectedCurrency}
        />
      )}

      {/* Layout */}
      <TopBanner />
      
      <Header
        onCartClick={() => setIsCartOpen(true)}
        onWishlistClick={() => router.push('/wishlist')}
        wishlistCount={wishedProducts.size}
        showDeviceSelector
        devices={devices}
        selectedDevice={selectedDevice}
        onDeviceChange={setSelectedDevice}
        showCurrencySelector
        selectedCurrency={selectedCurrency}
        onCurrencyClick={() => setIsCurrencyModalOpen(true)}
      />

      {/* ═══════════════════════════════════════════════════════════════════════════
          HERO SECTION - Modern Carousel
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="relative h-[500px] md:h-[600px] overflow-hidden">
        {heroSlides.map((slide, index) => (
          <div
            key={index}
            className={`absolute inset-0 transition-all duration-700 ease-in-out ${
              index === currentSlide 
                ? 'opacity-100 scale-100' 
                : 'opacity-0 scale-105'
            }`}
          >
            <div className={`absolute inset-0 bg-gradient-to-r ${slide.gradient}`} />
            <div className="absolute inset-0 bg-[url('/pattern.svg')] opacity-10" />
            
            <div className="relative h-full max-w-7xl mx-auto px-4 flex items-center justify-center">
              <div className="text-center text-white">
                <h1 className="text-4xl md:text-6xl lg:text-7xl font-black mb-6 drop-shadow-lg animate-fade-in">
                  {slide.title}
                </h1>
                <p className="text-xl md:text-2xl mb-8 opacity-90 max-w-2xl mx-auto">
                  {slide.subtitle}
                </p>
                <button
                  onClick={() => router.push('/shop')}
                  className="group bg-white text-gray-900 px-8 py-4 rounded-full font-bold text-lg hover:bg-opacity-90 transition-all duration-300 shadow-xl hover:shadow-2xl hover:scale-105"
                >
                  {slide.cta}
                  <ArrowRight className="inline-block ml-2 w-5 h-5 group-hover:translate-x-1 transition-transform" />
                </button>
              </div>
            </div>
          </div>
        ))}

        {/* Navigation */}
        <button
          onClick={() => setCurrentSlide((prev) => (prev - 1 + heroSlides.length) % heroSlides.length)}
          className="absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 backdrop-blur-sm p-3 rounded-full transition-all"
        >
          <ChevronLeft className="w-6 h-6 text-white" />
        </button>
        <button
          onClick={() => setCurrentSlide((prev) => (prev + 1) % heroSlides.length)}
          className="absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/40 backdrop-blur-sm p-3 rounded-full transition-all"
        >
          <ChevronRight className="w-6 h-6 text-white" />
        </button>

        {/* Dots */}
        <div className="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2">
          {heroSlides.map((_, index) => (
            <button
              key={index}
              onClick={() => setCurrentSlide(index)}
              className={`h-2 rounded-full transition-all duration-300 ${
                index === currentSlide 
                  ? 'bg-white w-8' 
                  : 'bg-white/50 w-2 hover:bg-white/70'
              }`}
            />
          ))}
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════════════
          FEATURES BAR
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {[
              { icon: <Truck className="w-6 h-6" />, title: 'Miễn phí ship', desc: 'Đơn từ 100K' },
              { icon: <Shield className="w-6 h-6" />, title: 'Bảo hành', desc: '12 tháng' },
              { icon: <Gift className="w-6 h-6" />, title: 'Quà tặng', desc: 'Mua 4 tặng 2' },
              { icon: <Sparkles className="w-6 h-6" />, title: 'Chính hãng', desc: '100% authentic' },
            ].map((feature, index) => (
              <div key={index} className="flex items-center gap-3 justify-center p-3">
                <div className="text-pink-600">{feature.icon}</div>
                <div>
                  <p className="font-semibold text-gray-900 text-sm">{feature.title}</p>
                  <p className="text-gray-500 text-xs">{feature.desc}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════════════
          CATEGORIES SECTION
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="py-16 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Danh Mục Sản Phẩm
            </h2>
            <p className="text-gray-600 max-w-2xl mx-auto">
              Khám phá đa dạng phụ kiện điện thoại chất lượng cao
            </p>
          </div>

          <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6">
            {categories.slice(0, 6).map((cat: any, index) => (
              <Link
                key={cat.category_id}
                href={`/shop?category=${encodeURIComponent(cat.category_name)}`}
                className="group relative"
              >
                <div className={`
                  relative overflow-hidden rounded-2xl p-6 h-44
                  bg-gradient-to-br ${CATEGORY_GRADIENTS[index % CATEGORY_GRADIENTS.length]}
                  transform transition-all duration-300
                  hover:scale-105 hover:shadow-2xl
                  cursor-pointer
                `}>
                  {/* Decorative circles */}
                  <div className="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full" />
                  <div className="absolute -bottom-6 -left-6 w-32 h-32 bg-white/10 rounded-full" />
                  
                  <div className="relative z-10 h-full flex flex-col items-center justify-center text-white text-center">
                    <h3 className="font-bold text-base mb-2 line-clamp-2">
                      {cat.category_name}
                    </h3>
                    <span className="text-sm opacity-80">
                      {cat.product_count || 0} sản phẩm
                    </span>
                  </div>
                </div>
              </Link>
            ))}
          </div>

          <div className="text-center mt-8">
            <Link
              href="/categories"
              className="inline-flex items-center gap-2 text-pink-600 font-semibold hover:text-pink-700 transition"
            >
              Xem tất cả danh mục
              <ArrowRight className="w-4 h-4" />
            </Link>
          </div>
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════════════
          DESIGN YOUR OWN CASE - CTA BANNER
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="py-12 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="relative overflow-hidden rounded-3xl bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 p-8 md:p-12">
            {/* Decorative elements */}
            <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2" />
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2" />
            <div className="absolute top-1/2 left-1/2 w-32 h-32 bg-white/5 rounded-full -translate-x-1/2 -translate-y-1/2" />
            
            <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
              <div className="text-center md:text-left">
                <div className="inline-flex items-center gap-2 bg-white/20 text-white px-4 py-2 rounded-full text-sm font-medium mb-4">
                  <Sparkles className="w-4 h-4" />
                  <span>Tính năng mới</span>
                </div>
                <h2 className="text-3xl md:text-4xl font-bold text-white mb-4">
                  🎨 Tự Thiết Kế Ốp Lưng Của Bạn
                </h2>
                <p className="text-white/90 text-lg max-w-xl">
                  Upload ảnh yêu thích, thêm chữ và tạo ra chiếc ốp điện thoại độc nhất vô nhị. 
                  Chúng tôi sẽ in và giao đến tận tay bạn!
                </p>
                <ul className="mt-4 space-y-2 text-white/80">
                  <li className="flex items-center gap-2">
                    <span className="text-green-300">✓</span> Thiết kế theo ý thích
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-300">✓</span> In ấn chất lượng cao 300dpi
                  </li>
                  <li className="flex items-center gap-2">
                    <span className="text-green-300">✓</span> Nhiều mẫu điện thoại
                  </li>
                </ul>
              </div>
              
              <div className="flex flex-col items-center">
                <div className="text-8xl mb-4"></div>
                <Link
                  href="/design"
                  className="bg-white text-pink-600 px-8 py-4 rounded-full font-bold text-lg hover:bg-gray-100 transition-all hover:shadow-xl transform hover:scale-105"
                >
                  Bắt Đầu Thiết Kế Ngay →
                </Link>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════════════
          FEATURED PRODUCTS SECTION
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="py-16 px-4 bg-gradient-to-b from-gray-50 to-white">
        <div className="max-w-7xl mx-auto">
          <div className="flex items-center justify-between mb-12">
            <div>
              <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-2">
                Sản Phẩm Nổi Bật
              </h2>
              <p className="text-gray-600">Được yêu thích nhất tuần này</p>
            </div>
            <Link
              href="/shop"
              className="hidden md:flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-pink-700 transition-all hover:shadow-lg"
            >
              Xem tất cả
              <ArrowRight className="w-4 h-4" />
            </Link>
          </div>

          {loading ? (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
              {[...Array(4)].map((_, i) => (
                <div key={i} className="bg-white rounded-2xl shadow-sm overflow-hidden animate-pulse">
                  <div className="h-48 md:h-64 bg-gray-200" />
                  <div className="p-4 space-y-3">
                    <div className="h-4 bg-gray-200 rounded w-3/4" />
                    <div className="h-4 bg-gray-200 rounded w-1/2" />
                    <div className="h-10 bg-gray-200 rounded" />
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
              {featuredProducts.map((product: any) => {
                const productId = product.product_id || product.id;
                const isWished = wishedProducts.has(productId);
                const primaryImage = product.product_images?.find((img: any) => img.is_primary)?.image_url 
                  || product.product_images?.[0]?.image_url
                  || product.image_url;
                const hasDiscount = product.sale_price && product.sale_price < product.price;
                const discountPercent = hasDiscount 
                  ? Math.round((1 - product.sale_price / product.price) * 100)
                  : 0;

                return (
                  <div
                    key={productId}
                    className="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden"
                    onMouseEnter={() => setHoveredProduct(productId)}
                    onMouseLeave={() => setHoveredProduct(null)}
                  >
                    {/* Image */}
                    <div className="relative h-48 md:h-64 bg-gray-100 overflow-hidden">
                      {primaryImage ? (
                        <img
                          src={primaryImage}
                          alt={product.product_name}
                          className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                        />
                      ) : (
                        <div className="w-full h-full flex items-center justify-center text-gray-400">
                          <Smartphone className="w-16 h-16" />
                        </div>
                      )}

                      {/* Badges */}
                      {hasDiscount && (
                        <div className="absolute top-3 left-3 bg-red-500 text-white px-2 py-1 rounded-lg text-xs font-bold">
                          -{discountPercent}%
                        </div>
                      )}

                      {/* Wishlist button */}
                      <button
                        onClick={(e) => {
                          e.preventDefault();
                          toggleWishlist(productId);
                        }}
                        className={`absolute top-3 right-3 p-2 rounded-full transition-all duration-300 ${
                          isWished 
                            ? 'bg-pink-500 text-white' 
                            : 'bg-white/80 text-gray-600 hover:bg-pink-500 hover:text-white'
                        }`}
                      >
                        <Heart className={`w-5 h-5 ${isWished ? 'fill-current' : ''}`} />
                      </button>

                      {/* Quick actions */}
                      <div className={`absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/60 to-transparent transform transition-all duration-300 ${
                        hoveredProduct === productId ? 'translate-y-0 opacity-100' : 'translate-y-full opacity-0'
                      }`}>
                        <Link
                          href={`/product/${productId}`}
                          className="block w-full bg-white text-gray-900 text-center py-2 rounded-lg font-semibold hover:bg-pink-600 hover:text-white transition"
                        >
                          Xem chi tiết
                        </Link>
                      </div>
                    </div>

                    {/* Info */}
                    <div className="p-4">
                      <Link href={`/product/${productId}`}>
                        <h3 className="font-semibold text-gray-900 mb-2 line-clamp-2 hover:text-pink-600 transition">
                          {product.product_name}
                        </h3>
                      </Link>

                      {/* Rating */}
                      <div className="flex items-center gap-1 mb-2">
                        {[...Array(5)].map((_, i) => (
                          <Star
                            key={i}
                            className={`w-4 h-4 ${i < 4 ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'}`}
                          />
                        ))}
                        <span className="text-xs text-gray-500 ml-1">(128)</span>
                      </div>

                      {/* Price */}
                      <div className="flex items-center gap-2">
                        <span className="text-lg font-bold text-pink-600">
                          {formatPrice(product.sale_price || product.price)}
                        </span>
                        {hasDiscount && (
                          <span className="text-sm text-gray-400 line-through">
                            {formatPrice(product.price)}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* Mobile CTA */}
          <div className="text-center mt-8 md:hidden">
            <Link
              href="/shop"
              className="inline-flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Xem tất cả sản phẩm
              <ArrowRight className="w-4 h-4" />
            </Link>
          </div>
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════════════
          TRENDING SECTION
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="py-16 px-4">
        <div className="max-w-7xl mx-auto">
          <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-rose-600 rounded-3xl p-8 md:p-12 text-white relative overflow-hidden">
            {/* Decorative */}
            <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2" />
            <div className="absolute bottom-0 left-0 w-48 h-48 bg-white/10 rounded-full translate-y-1/2 -translate-x-1/2" />

            <div className="relative z-10 flex flex-col md:flex-row items-center justify-between gap-6">
              <div className="text-center md:text-left">
                <div className="flex items-center gap-2 justify-center md:justify-start mb-4">
                  <TrendingUp className="w-6 h-6" />
                  <span className="text-sm font-semibold uppercase tracking-wider">Hot Trend</span>
                </div>
                <h2 className="text-3xl md:text-4xl font-bold mb-4">
                  Bộ Sưu Tập Mùa Lễ Hội
                </h2>
                <p className="text-white/80 max-w-md">
                  Khám phá những thiết kế độc đáo cho mùa Noel, Valentine và Tết Nguyên Đán
                </p>
              </div>
              <Link
                href="/collections"
                className="flex items-center gap-2 bg-white text-purple-600 px-8 py-4 rounded-full font-bold hover:bg-opacity-90 transition-all shadow-xl hover:shadow-2xl"
              >
                Khám phá ngay
                <ArrowRight className="w-5 h-5" />
              </Link>
            </div>
          </div>
        </div>
      </section>

      {/* ═══════════════════════════════════════════════════════════════════════════
          NEWSLETTER SECTION
      ═══════════════════════════════════════════════════════════════════════════ */}
      <section className="py-16 px-4 bg-gray-900 text-white">
        <div className="max-w-4xl mx-auto text-center">
          <Sparkles className="w-12 h-12 mx-auto mb-6 text-pink-500" />
          <h2 className="text-3xl md:text-4xl font-bold mb-4">
            Đăng Ký Nhận Ưu Đãi
          </h2>
          <p className="text-gray-400 mb-8 max-w-xl mx-auto">
            Nhận ngay mã giảm giá 10% cho đơn hàng đầu tiên và cập nhật những ưu đãi mới nhất
          </p>
          <form className="flex flex-col sm:flex-row gap-4 max-w-md mx-auto">
            <input
              type="email"
              placeholder="Email của bạn..."
              className="flex-1 px-6 py-4 rounded-full bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-pink-500 transition"
            />
            <button
              type="submit"
              className="px-8 py-4 bg-gradient-to-r from-pink-500 to-rose-500 rounded-full font-bold hover:opacity-90 transition"
            >
              Đăng ký
            </button>
          </form>
        </div>
      </section>

      {/* Footer */}
      <Footer />
    </div>
  );
}



################################################################################
## FILE 95: layout.tsx
## Path: fontend/src/app/layout.tsx
################################################################################

import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";
import { CartProvider } from '@/app/context/cart-context';
import { WishlistProvider } from '@/app/context/wishlist-context';
// import { AuthProvider } from '@/app/context/auth-context';
import { AuthProvider } from '@/contexts/AuthContext';
// import Navbar from '@/components/Navbar'; 
const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "GoatTech",
  description: "GoatTech Shop",
};

export default function RootLayout({ children,}: Readonly<{ children: React.ReactNode; }>) {
  return (
    <html lang="vi">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        <AuthProvider>
          <CartProvider>
            <WishlistProvider>
              {children}
            </WishlistProvider>
          </CartProvider>
        </AuthProvider>
      </body>
    </html>
  );
}




################################################################################
## FILE 96: globals.css
## Path: fontend/src/app/globals.css
################################################################################

/* @import "tailwindcss"; */
@tailwind base;
@tailwind components;
@tailwind utilities;


:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

/* Custom Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.animate-fade-in {
  animation: fadeIn 0.6s ease-out forwards;
}

.animate-slide-up {
  animation: slideUp 0.5s ease-out forwards;
}

.animate-scale-in {
  animation: scaleIn 0.3s ease-out forwards;
}

.animate-shimmer {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* Hide scrollbar for horizontal scroll sections */
.hide-scrollbar::-webkit-scrollbar {
  display: none;
}

.hide-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Line clamp utility */
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Glass effect */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}




################################################################################
## FILE 97: layout.tsx
## Path: fontend/src/app/(public)/layout.tsx
################################################################################

import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';

export default function PublicLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <>  
        <Header />
            {children}
        <Footer />
    </>
  );
}




################################################################################
## FILE 98: page.tsx
## Path: fontend/src/app/(public)/about/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu, Award, Users, Globe, Truck, Shield, Star } from 'lucide-react';
import Link from 'next/link';
import { fetchCategories } from '@/lib/api-client';

const AboutPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  const stats = [
    { number: '100K+', label: 'Khách Hàng Hài Lòng', icon: Users },
    { number: '100K+', label: 'Sản Phẩm Đã Bán', icon: Award },
    { number: '50+', label: 'Quốc Gia', icon: Globe },
    { number: '4.5/5', label: 'Đánh Giá Trung Bình', icon: Star }
  ];

  const values = [
    {
      icon: Award,
      title: 'Chất Lượng Cao Cấp',
      description: 'Sử dụng vật liệu cao cấp nhất, đảm bảo độ bền và bảo vệ tối ưu cho thiết bị của bạn.'
    },
    {
      icon: Shield,
      title: 'Bảo Vệ Tuyệt Đối',
      description: 'Thiết kế chống sốc, chống trầy xước, bảo vệ điện thoại trong mọi tình huống.'
    },
    {
      icon: Truck,
      title: 'Giao Hàng Nhanh',
      description: 'Giao hàng toàn quốc trong 2-5 ngày, miễn phí cho đơn hàng trên 100K.'
    },
    {
      icon: Star,
      title: 'Thiết Kế Độc Đáo',
      description: 'Hàng trăm mẫu thiết kế độc quyền, từ tối giản đến nghệ thuật đầy màu sắc.'
    }
  ];

  const team = [
    {
      name: 'Phạm Công Đoàn',
      role: 'Giám Đốc Điều Hành',
      image: 'đoàn.jpg'
    },
    {
      name: 'Võ Trần Minh Bảo',
      role: 'Trưởng Phòng Thiết Kế',
      image: 'bảo.jpg'
    },
    {
      name: 'Triệu Quân Sự',
      role: 'Trưởng Phòng Marketing',
      image: 'lĩnh.jpg'
    },
    {
      name: 'Đoàn Văn Sáng',
      role: 'Trưởng Phòng Kinh Doanh',
      image: 'nam.png'
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setIsCurrencyModalOpen(false)}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold">CHỌN LOẠI TIỀN TỆ</h2>
              <button onClick={() => setIsCurrencyModalOpen(false)} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-gray-700">QUỐC GIA/KHU VỰC:</label>
              <select 
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Việt Nam (VND ₫)</option>
              </select>
            </div>

            <button 
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
            >
              ÁP DỤNG
            </button>
          </div>
        </div>
      )}

      {/* Hero Section */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-20">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <h1 className="text-5xl md:text-6xl font-bold mb-6">Về GoatTech</h1>
          <p className="text-xl md:text-2xl max-w-3xl mx-auto">
            Chúng tôi là thương hiệu ốp điện thoại số 1 Việt Nam, mang đến sự bảo vệ hoàn hảo với phong cách độc đáo
          </p>
        </div>
      </div>

      {/* Stats Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-8">
          {stats.map((stat, index) => (
            <div key={index} className="bg-white p-8 rounded-xl shadow-sm text-center">
              <div className="bg-pink-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <stat.icon className="w-8 h-8 text-pink-600" />
              </div>
              <h3 className="text-3xl font-bold text-gray-900 mb-2">{stat.number}</h3>
              <p className="text-gray-600">{stat.label}</p>
            </div>
          ))}
        </div>
      </div>

      {/* Story Section */}
      <div className="bg-white py-16">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
            <div>
              <h2 className="text-4xl font-bold mb-6">Câu Chuyện Của Chúng Tôi</h2>
              <p className="text-gray-600 mb-4 leading-relaxed">
                GoatTech được thành lập vào năm 2018 với sứ mệnh mang đến những sản phẩm bảo vệ điện thoại chất lượng cao và thiết kế độc đáo cho người dùng Việt Nam.
              </p>
              <p className="text-gray-600 mb-4 leading-relaxed">
                Bắt đầu từ một cửa hàng nhỏ ở TP.HCM, chúng tôi đã phát triển thành thương hiệu ốp điện thoại được yêu thích nhất với hơn 500,000 khách hàng trên toàn quốc.
              </p>
              <p className="text-gray-600 mb-4 leading-relaxed">
                Mỗi sản phẩm của GoatTech đều được thiết kế tỉ mỉ, từ việc chọn vật liệu cao cấp đến quy trình sản xuất nghiêm ngặt, đảm bảo mang đến trải nghiệm tốt nhất cho khách hàng.
              </p>
              <Link href="/shop" className="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition">
                Khám Phá Sản Phẩm
              </Link>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <img
                src="about1.jpg"
                alt="GoatTech Store"
                className="rounded-xl shadow-lg w-full h-48 object-cover"
              />
              <img
                src="about2.jpg"
                alt="Phone Cases"
                className="rounded-xl shadow-lg w-full h-48 object-cover mt-8"
              />
              <img
                src="about3.jpg"
                alt="Design Process"
                className="rounded-xl shadow-lg w-full h-48 object-cover"
              />
              <img
                src="about4.jpg"
                alt="Quality Check"
                className="rounded-xl shadow-lg w-full h-48 object-cover mt-8"
              />
            </div>
          </div>
        </div>
      </div>

      {/* Values Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-center mb-12">Giá Trị Cốt Lõi</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          {values.map((value, index) => (
            <div key={index} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition">
              <div className="bg-gradient-to-br from-purple-100 to-pink-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <value.icon className="w-8 h-8 text-purple-600" />
              </div>
              <h3 className="text-xl font-semibold mb-3">{value.title}</h3>
              <p className="text-gray-600">{value.description}</p>
            </div>
          ))}
        </div>
      </div>

      {/* Team Section */}
      <div className="bg-gradient-to-br from-purple-50 to-pink-50 py-16">
        <div className="max-w-7xl mx-auto px-4">
          <h2 className="text-4xl font-bold text-center mb-4">Đội Ngũ Của Chúng Tôi</h2>
          <p className="text-center text-gray-600 mb-12 max-w-2xl mx-auto">
            Đội ngũ chuyên nghiệp, tận tâm và sáng tạo luôn nỗ lực để mang đến những sản phẩm tốt nhất
          </p>
          
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            {team.map((member, index) => (
              <div key={index} className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition">
                <img
                  src={member.image}
                  alt={member.name}
                  className="w-full h-64 object-cover"
                />
                <div className="p-6 text-center">
                  <h3 className="text-xl font-semibold mb-1">{member.name}</h3>
                  <p className="text-gray-600">{member.role}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Mission Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-12 text-white text-center">
          <h2 className="text-4xl font-bold mb-6">Sứ Mệnh Của Chúng Tôi</h2>
          <p className="text-xl max-w-3xl mx-auto mb-8">
            Mang đến cho mỗi khách hàng những sản phẩm bảo vệ điện thoại chất lượng cao nhất, 
            kết hợp giữa tính năng vượt trội và thiết kế nghệ thuật, 
            giúp họ thể hiện phong cách riêng và bảo vệ thiết bị yêu quý của mình.
          </p>
          <Link href="/contact" className="inline-block bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
            Liên Hệ Với Chúng Tôi
          </Link>
        </div>
      </div>
    </div>
  );
};

export default AboutPage;




################################################################################
## FILE 99: page.tsx
## Path: fontend/src/app/(public)/blog/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { Calendar, User, Eye, Clock, Search, ChevronRight, Tag } from 'lucide-react';

interface BlogPost {
  post_id: number;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  featured_image: string;
  author_id: number;
  category: string;
  tags: string;
  view_count: number;
  is_published: boolean;
  published_at: string;
  meta_title: string;
  meta_description: string;
  created_at: string;
  updated_at: string;
}

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export default function BlogPage() {
  const [posts, setPosts] = useState<BlogPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [currentPage, setCurrentPage] = useState(1);
  const postsPerPage = 9;

  const categories = [
    { id: 'all', name: 'Tất cả' },
    { id: 'news', name: 'Tin tức' },
    { id: 'tips', name: 'Mẹo hay' },
    { id: 'review', name: 'Đánh giá' },
    { id: 'guide', name: 'Hướng dẫn' },
  ];

  useEffect(() => {
    loadPosts();
  }, []);

  const loadPosts = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/blog-posts`);
      if (response.ok) {
        const data = await response.json();
        setPosts(data.filter((p: BlogPost) => p.is_published));
      } else {
        setPosts(getSamplePosts());
      }
    } catch (error) {
      console.error('Error loading posts:', error);
      setPosts(getSamplePosts());
    } finally {
      setLoading(false);
    }
  };

  const getSamplePosts = (): BlogPost[] => {
    return [
      {
        post_id: 1,
        title: 'Top 10 ốp lưng iPhone 15 Pro Max đẹp nhất 2024',
        slug: 'top-10-op-lung-iphone-15-pro-max-dep-nhat-2024',
        content: '',
        excerpt: 'Khám phá những mẫu ốp lưng iPhone 15 Pro Max được yêu thích nhất.',
        featured_image: '/noel.jpg',
        author_id: 1,
        category: 'review',
        tags: 'iPhone,ốp lưng,phụ kiện',
        view_count: 1523,
        is_published: true,
        published_at: '2024-12-15T10:00:00Z',
        meta_title: '',
        meta_description: '',
        created_at: '2024-12-15T10:00:00Z',
        updated_at: '2024-12-15T10:00:00Z',
      },
      {
        post_id: 2,
        title: 'Cách bảo vệ điện thoại trong mùa đông lạnh',
        slug: 'cach-bao-ve-dien-thoai-mua-dong',
        content: '',
        excerpt: 'Những mẹo đơn giản giúp bảo vệ điện thoại của bạn.',
        featured_image: '/about1.jpg',
        author_id: 1,
        category: 'tips',
        tags: 'mẹo hay,bảo vệ điện thoại',
        view_count: 892,
        is_published: true,
        published_at: '2024-12-10T14:30:00Z',
        meta_title: '',
        meta_description: '',
        created_at: '2024-12-10T14:30:00Z',
        updated_at: '2024-12-10T14:30:00Z',
      },
      {
        post_id: 3,
        title: 'GoatTech ra mắt bộ sưu tập Giáng sinh 2024',
        slug: 'goattech-bo-suu-tap-giang-sinh-2024',
        content: '',
        excerpt: 'Chào đón mùa lễ hội với bộ sưu tập ốp lưng Giáng sinh độc quyền.',
        featured_image: '/noel.jpg',
        author_id: 1,
        category: 'news',
        tags: 'Giáng sinh,bộ sưu tập,mới',
        view_count: 2341,
        is_published: true,
        published_at: '2024-12-01T09:00:00Z',
        meta_title: '',
        meta_description: '',
        created_at: '2024-12-01T09:00:00Z',
        updated_at: '2024-12-01T09:00:00Z',
      },
    ];
  };

  const filteredPosts = posts.filter(post => {
    const matchesSearch = post.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                          post.excerpt.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesCategory = selectedCategory === 'all' || post.category === selectedCategory;
    return matchesSearch && matchesCategory;
  });

  const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
  const paginatedPosts = filteredPosts.slice(
    (currentPage - 1) * postsPerPage,
    currentPage * postsPerPage
  );

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Hero Section */}
      <section className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">Blog GoatTech</h1>
          <p className="text-xl text-white/90 mb-8">
            Tin tức, mẹo hay và hướng dẫn về phụ kiện điện thoại
          </p>
          
          {/* Search Bar */}
          <div className="max-w-xl mx-auto relative">
            <input
              type="text"
              placeholder="Tìm kiếm bài viết..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full px-6 py-4 pr-12 rounded-full text-gray-900 focus:outline-none focus:ring-4 focus:ring-white/30"
            />
            <Search className="absolute right-4 top-1/2 -translate-y-1/2 w-6 h-6 text-gray-400" />
          </div>
        </div>
      </section>

      {/* Category Filter */}
      <section className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex flex-wrap gap-3 justify-center">
            {categories.map((cat) => (
              <button
                key={cat.id}
                onClick={() => {
                  setSelectedCategory(cat.id);
                  setCurrentPage(1);
                }}
                className={`px-6 py-2 rounded-full font-medium transition ${
                  selectedCategory === cat.id
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {cat.name}
              </button>
            ))}
          </div>
        </div>
      </section>

      {/* Blog Posts Grid */}
      <section className="max-w-7xl mx-auto px-4 py-12">
        {loading ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {[1, 2, 3, 4, 5, 6].map((i) => (
              <div key={i} className="animate-pulse">
                <div className="bg-gray-200 rounded-2xl h-48 mb-4"></div>
                <div className="bg-gray-200 h-6 rounded mb-2"></div>
                <div className="bg-gray-200 h-4 rounded w-3/4"></div>
              </div>
            ))}
          </div>
        ) : paginatedPosts.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {paginatedPosts.map((post) => (
              <Link key={post.post_id} href={`/blog/\${post.slug}`}>
                <article className="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition h-full flex flex-col">
                  <div className="relative h-48 overflow-hidden">
                    <img
                      src={post.featured_image || '/about1.jpg'}
                      alt={post.title}
                      className="w-full h-full object-cover group-hover:scale-110 transition duration-500"
                    />
                    <div className="absolute top-3 left-3">
                      <span className="bg-white/90 backdrop-blur-sm text-gray-700 text-xs font-medium px-3 py-1 rounded-full capitalize">
                        {categories.find(c => c.id === post.category)?.name || post.category}
                      </span>
                    </div>
                  </div>
                  
                  <div className="p-6 flex-1 flex flex-col">
                    <div className="flex items-center gap-4 text-xs text-gray-500 mb-3">
                      <span className="flex items-center gap-1">
                        <Calendar className="w-3 h-3" />
                        {formatDate(post.published_at)}
                      </span>
                      <span className="flex items-center gap-1">
                        <Eye className="w-3 h-3" />
                        {post.view_count}
                      </span>
                    </div>
                    
                    <h3 className="font-bold text-lg mb-3 line-clamp-2 group-hover:text-pink-600 transition">
                      {post.title}
                    </h3>
                    
                    <p className="text-gray-600 text-sm line-clamp-3 flex-1">
                      {post.excerpt}
                    </p>
                    
                    <div className="mt-4 pt-4 border-t">
                      <span className="text-pink-600 text-sm font-medium flex items-center gap-1 group-hover:gap-2 transition-all">
                        Đọc thêm <ChevronRight className="w-4 h-4" />
                      </span>
                    </div>
                  </div>
                </article>
              </Link>
            ))}
          </div>
        ) : (
          <div className="text-center py-16">
            <div className="text-6xl mb-4">📝</div>
            <h3 className="text-xl font-semibold text-gray-700 mb-2">
              Không tìm thấy bài viết
            </h3>
            <p className="text-gray-500">
              Thử tìm kiếm với từ khóa khác
            </p>
          </div>
        )}

        {/* Pagination */}
        {totalPages > 1 && (
          <div className="flex justify-center gap-2 mt-12">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
              <button
                key={page}
                onClick={() => setCurrentPage(page)}
                className={`px-4 py-2 rounded-lg \${
                  currentPage === page
                    ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white'
                    : 'bg-white border hover:bg-gray-50'
                }`}
              >
                {page}
              </button>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}



################################################################################
## FILE 100: page.tsx
## Path: fontend/src/app/(public)/blog/[slug]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { Calendar, User, Eye, Clock, ArrowLeft, Share2, Heart, Facebook, Twitter, Copy, Check, ChevronRight, Tag } from 'lucide-react';

interface BlogPost {
  post_id: number;
  title: string;
  slug: string;
  content: string;
  excerpt: string;
  featured_image: string;
  author_id: number;
  category: string;
  tags: string;
  view_count: number;
  is_published: boolean;
  published_at: string;
}

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export default function BlogDetailPage() {
  const params = useParams();
  const router = useRouter();
  const slug = params.slug as string;

  const [post, setPost] = useState<BlogPost | null>(null);
  const [relatedPosts, setRelatedPosts] = useState<BlogPost[]>([]);
  const [loading, setLoading] = useState(true);
  const [copied, setCopied] = useState(false);
  const [liked, setLiked] = useState(false);

  useEffect(() => {
    if (slug) {
      loadPost();
    }
  }, [slug]);

  const loadPost = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/blog-posts/${slug}`);
      if (response.ok) {
        const data = await response.json();
        setPost(data);
      } else {
        setPost(getSamplePost());
      }
    } catch (error) {
      setPost(getSamplePost());
    } finally {
      setLoading(false);
    }
  };

  const getSamplePost = (): BlogPost => ({
    post_id: 1,
    title: 'Top 10 ốp lưng iPhone 15 Pro Max đẹp nhất 2024',
    slug: slug,
    content: `
      <h2>Giới thiệu</h2>
      <p>iPhone 15 Pro Max là smartphone cao cấp nhất hiện nay. Trong bài viết này, chúng tôi giới thiệu top 10 ốp lưng đẹp nhất.</p>
      
      <h2>1. Ốp lưng MagSafe trong suốt</h2>
      <p>Đây là lựa chọn hoàn hảo cho những ai muốn khoe vẻ đẹp của iPhone 15 Pro Max.</p>
      <ul>
        <li>Chất liệu: Polycarbonate + TPU</li>
        <li>Trọng lượng: 30g</li>
        <li>Độ dày: 1.2mm</li>
      </ul>
      
      <h2>2. Ốp lưng da cao cấp</h2>
      <p>Với chất liệu da thật, chiếc ốp này mang đến vẻ sang trọng và đẳng cấp.</p>
      
      <h2>Kết luận</h2>
      <p>Việc chọn ốp lưng phù hợp phụ thuộc vào nhu cầu cá nhân. GoatTech cung cấp đầy đủ các loại ốp lưng với giá cạnh tranh.</p>
    `,
    excerpt: 'Khám phá những mẫu ốp lưng iPhone 15 Pro Max được yêu thích nhất.',
    featured_image: '/noel.jpg',
    author_id: 1,
    category: 'review',
    tags: 'iPhone,ốp lưng,phụ kiện,review',
    view_count: 1523,
    is_published: true,
    published_at: '2024-12-15T10:00:00Z',
  });

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('vi-VN', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
    });
  };

  const handleCopyLink = () => {
    navigator.clipboard.writeText(window.location.href);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  if (!post) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">😢</div>
          <h2 className="text-2xl font-bold mb-2">Không tìm thấy bài viết</h2>
          <Link href="/blog" className="text-pink-600 hover:underline">
            ← Quay lại Blog
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header Image */}
      <div className="relative h-[50vh] min-h-[400px]">
        <img
          src={post.featured_image || '/noel.jpg'}
          alt={post.title}
          className="w-full h-full object-cover"
        />
        <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
        
        <Link
          href="/blog"
          className="absolute top-6 left-6 flex items-center gap-2 bg-white/90 backdrop-blur-sm text-gray-800 px-4 py-2 rounded-full font-medium hover:bg-white transition"
        >
          <ArrowLeft className="w-4 h-4" />
          Quay lại
        </Link>

        <div className="absolute bottom-0 left-0 right-0 p-8 max-w-4xl mx-auto">
          <div className="flex items-center gap-3 mb-4">
            <span className="bg-white/90 backdrop-blur-sm text-gray-700 text-sm font-medium px-4 py-1 rounded-full capitalize">
              {post.category}
            </span>
          </div>
          <h1 className="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4">
            {post.title}
          </h1>
          <div className="flex flex-wrap items-center gap-4 text-white/80 text-sm">
            <span className="flex items-center gap-1">
              <Calendar className="w-4 h-4" />
              {formatDate(post.published_at)}
            </span>
            <span className="flex items-center gap-1">
              <Eye className="w-4 h-4" />
              {post.view_count} lượt xem
            </span>
          </div>
        </div>
      </div>

      {/* Content */}
      <article className="max-w-4xl mx-auto px-4 py-12">
        <div className="bg-white rounded-2xl shadow-sm p-8 md:p-12">
          <p className="text-xl text-gray-600 leading-relaxed mb-8 pb-8 border-b">
            {post.excerpt}
          </p>

          <div 
            className="prose prose-lg max-w-none"
            dangerouslySetInnerHTML={{ __html: post.content }}
          />

          {/* Tags */}
          {post.tags && (
            <div className="mt-12 pt-8 border-t">
              <div className="flex items-center gap-2 flex-wrap">
                <Tag className="w-5 h-5 text-gray-400" />
                {post.tags.split(',').map((tag, index) => (
                  <Link
                    key={index}
                    href={`/blog?tag=${tag.trim()}`}
                    className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm transition"
                  >
                    #{tag.trim()}
                  </Link>
                ))}
              </div>
            </div>
          )}

          {/* Share */}
          <div className="mt-8 pt-8 border-t flex flex-wrap items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <span className="text-gray-600 font-medium">Chia sẻ:</span>
              <button className="bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition">
                <Facebook className="w-5 h-5" />
              </button>
              <button className="bg-sky-500 text-white p-2 rounded-full hover:bg-sky-600 transition">
                <Twitter className="w-5 h-5" />
              </button>
              <button
                onClick={handleCopyLink}
                className="bg-gray-200 text-gray-700 p-2 rounded-full hover:bg-gray-300 transition"
              >
                {copied ? <Check className="w-5 h-5 text-green-600" /> : <Copy className="w-5 h-5" />}
              </button>
            </div>
            
            <button
              onClick={() => setLiked(!liked)}
              className={`flex items-center gap-2 px-6 py-2 rounded-full transition ${
                liked
                  ? 'bg-pink-100 text-pink-600'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              <Heart className={`w-5 h-5 ${liked ? 'fill-pink-600' : ''}`} />
              {liked ? 'Đã thích' : 'Thích bài viết'}
            </button>
          </div>
        </div>

        {/* CTA */}
        <div className="mt-16 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-8 text-white text-center">
          <h3 className="text-2xl font-bold mb-4">Khám phá sản phẩm của GoatTech</h3>
          <p className="text-white/90 mb-6">
            Hàng ngàn mẫu ốp lưng chất lượng cao đang chờ bạn
          </p>
          <Link
            href="/shop"
            className="inline-block bg-white text-pink-600 px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition"
          >
            Mua sắm ngay
          </Link>
        </div>
      </article>
    </div>
  );
}



################################################################################
## FILE 101: page.tsx
## Path: fontend/src/app/(public)/categories/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { Search, Menu, ShoppingCart, User, Heart, ChevronRight } from 'lucide-react';
import Link from 'next/link';
import { fetchRootCategories, fetchChildCategories } from '@/lib/api-client';

interface Category {
  category_id: number;
  category_name: string;
  category_slug: string;
  parent_category_id: number | null;
  description: string;
  image_url: string;
  icon_name: string;
  display_order: number;
  is_active: boolean;
  created_at?: string;
  updated_at?: string;
}

const CategoriesPage: React.FC = () => {
  const [rootCategories, setRootCategories] = useState<Category[]>([]);
  const [selectedCategory, setSelectedCategory] = useState<Category | null>(null);
  const [childCategories, setChildCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  useEffect(() => {
    loadRootCategories();
  }, []);

  const loadRootCategories = async () => {
    try {
      setLoading(true);
      const data = await fetchRootCategories();
      if (Array.isArray(data)) {
        setRootCategories(data);
      }
    } catch (error) {
      console.error('Error loading categories:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadChildCategories = async (parentId: number, category: Category) => {
    try {
      setSelectedCategory(category);
      const data = await fetchChildCategories(parentId);
      if (Array.isArray(data)) {
        setChildCategories(data);
      }
    } catch (error) {
      console.error('Error loading child categories:', error);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Top Banner */}
      <div className="bg-black text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <span>Miễn phí vận chuyển cho đơn hàng trên 100K</span>
          <span className="hidden md:inline">|</span>
          <span className="hidden md:inline">Ưu đãi GoatTech: Mua 4 ốp - Trả tiền 2 ốp</span>
        </div>
      </div>

      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <button className="lg:hidden" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                <Menu className="w-6 h-6" />
              </button>
              <button className="lg:hidden">
                <Search className="w-6 h-6" />
              </button>
            </div>

            <Link href="/" className="text-2xl font-bold tracking-wider">
              GoatTech
            </Link>

            <div className="flex items-center gap-4">
              <button className="relative">
                <Heart className="w-6 h-6" />
              </button>

              <Link href="/account">
                <User className="w-6 h-6" />
              </Link>

              <Link href="/shop" className="relative">
                <ShoppingCart className="w-6 h-6" />
              </Link>
            </div>
          </div>

          {/* Desktop Navigation */}
          <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t">
            <Link href="/" className="text-sm font-medium hover:text-pink-600">Trang Chủ</Link>
            <Link href="/shop" className="text-sm font-medium hover:text-pink-600">Cửa Hàng</Link>
            <Link href="/categories" className="text-sm font-medium text-pink-600">Danh Mục</Link>
            <Link href="/about" className="text-sm font-medium hover:text-pink-600">Về Chúng Tôi</Link>
            <Link href="/contact" className="text-sm font-medium hover:text-pink-600">Liên Hệ</Link>
            <Link href="/promotions" className="text-sm font-medium hover:text-pink-600">Khuyến Mại</Link>
          </nav>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 py-12">
        {/* Page Title */}
        <div className="text-center mb-12">
          <h1 className="text-4xl font-bold mb-4">Danh Mục Sản Phẩm</h1>
          <p className="text-gray-600">Khám phá các danh mục ốp lưng và phụ kiện điện thoại</p>
        </div>

        {loading ? (
          <div className="text-center py-12">
            <p className="text-xl">Đang tải...</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            {/* Root Categories - Left Side */}
            <div className="lg:col-span-1">
              <h2 className="text-2xl font-bold mb-6">Danh Mục Chính</h2>
              <div className="space-y-3">
                {rootCategories.map((category) => (
                  <button
                    key={category.category_id}
                    onClick={() => loadChildCategories(category.category_id, category)}
                    className={`w-full text-left p-4 rounded-lg border-2 transition ${
                      selectedCategory?.category_id === category.category_id
                        ? 'border-pink-600 bg-pink-50'
                        : 'border-gray-200 hover:border-pink-300'
                    }`}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="font-semibold text-lg">{category.category_name}</h3>
                        <p className="text-sm text-gray-600">{category.description}</p>
                      </div>
                      <ChevronRight className="w-5 h-5 text-gray-400" />
                    </div>
                  </button>
                ))}
              </div>
            </div>

            {/* Child Categories - Right Side */}
            <div className="lg:col-span-2">
              {selectedCategory ? (
                <>
                  <h2 className="text-2xl font-bold mb-6">
                    {selectedCategory.category_name}
                  </h2>
                  {childCategories.length > 0 ? (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      {childCategories.map((category) => (
                        <Link
                          key={category.category_id}
                          href={`/shop?category=${category.category_slug}`}
                          className="group bg-white rounded-lg border-2 border-gray-200 hover:border-pink-600 transition p-6"
                        >
                          <div className="flex items-start justify-between">
                            <div>
                              <h3 className="font-semibold text-lg mb-2 group-hover:text-pink-600">
                                {category.category_name}
                              </h3>
                              <p className="text-sm text-gray-600">{category.description}</p>
                            </div>
                            <span className="text-2xl">{category.icon_name || '📱'}</span>
                          </div>
                        </Link>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-12 bg-white rounded-lg border-2 border-gray-200">
                      <p className="text-gray-600">Chưa có danh mục con</p>
                    </div>
                  )}
                </>
              ) : (
                <div className="text-center py-20 bg-white rounded-lg border-2 border-gray-200">
                  <p className="text-gray-600 text-lg">
                    ← Chọn một danh mục bên trái để xem chi tiết
                  </p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Quick Links */}
        <div className="mt-16 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div className="bg-gradient-to-br from-purple-600 to-pink-600 text-white p-8 rounded-2xl">
            <h3 className="text-2xl font-bold mb-4">Ốp Lưng Theo Hãng</h3>
            <p className="mb-4">iPhone, Samsung, Xiaomi, OPPO...</p>
            <Link href="/shop?filter=brand" className="inline-block bg-white text-pink-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100">
              Xem Ngay
            </Link>
          </div>

          <div className="bg-gradient-to-br from-blue-600 to-cyan-600 text-white p-8 rounded-2xl">
            <h3 className="text-2xl font-bold mb-4">Bộ Sưu Tập Độc Quyền</h3>
            <p className="mb-4">Thiết kế độc đáo, phong cách riêng</p>
            <Link href="/shop?filter=collection" className="inline-block bg-white text-blue-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100">
              Khám Phá
            </Link>
          </div>

          <div className="bg-gradient-to-br from-green-600 to-teal-600 text-white p-8 rounded-2xl">
            <h3 className="text-2xl font-bold mb-4">Phụ Kiện Cao Cấp</h3>
            <p className="mb-4">Kính cường lực, dây đeo, charm...</p>
            <Link href="/shop?filter=accessories" className="inline-block bg-white text-green-600 px-6 py-2 rounded-lg font-medium hover:bg-gray-100">
              Mua Sắm
            </Link>
          </div>
        </div>
      </main>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12 mt-16">
        <div className="max-w-7xl mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 className="text-xl font-bold mb-4">GoatTech</h3>
            <p className="text-gray-400">Ốp lưng cao cấp, phong cách Việt Nam</p>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Hỗ Trợ</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/contact">Liên Hệ</Link></li>
              <li><Link href="/shipping">Vận Chuyển</Link></li>
              <li><Link href="/return">Đổi Trả</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Về Chúng Tôi</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/about">Giới Thiệu</Link></li>
              <li><Link href="/careers">Tuyển Dụng</Link></li>
              <li><Link href="/press">Báo Chí</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Theo Dõi</h4>
            <ul className="space-y-2 text-gray-400">
              <li>Facebook</li>
              <li>Instagram</li>
              <li>TikTok</li>
            </ul>
          </div>
        </div>
        <div className="max-w-7xl mx-auto px-4 mt-8 pt-8 border-t border-gray-800 text-center text-gray-400">
          <p>&copy; 2024 GoatTech Vietnam. All rights reserved.</p>
        </div>
      </footer>
    </div>
  );
};

export default CategoriesPage;




################################################################################
## FILE 102: page.tsx
## Path: fontend/src/app/(public)/checkout/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';
import {
  fetchShoppingCart,
  createOrder,
  clearShoppingCart,
  createMomoPayment,
} from '@/lib/api-client';
import {
  ArrowLeft,
  CreditCard,
  Truck,
  MapPin,
  Phone,
  User,
  FileText,
  ShoppingBag,
  Shield,
  AlertCircle,
  Check,
} from 'lucide-react';

interface CartItem {
  cart_id: number;
  product_id: number;
  variant_id?: number;
  phone_model_id?: number;
  phone_model_name?: string;
  quantity: number;
  product_name: string;
  price: number;
  original_price?: number;
  image_url?: string;
}

interface ShippingAddress {
  fullname: string;
  phone: string;
  addressline1: string;
  ward: string;
  district: string;
  city: string;
}

export default function CheckoutPage() {
  const { user, isAuthenticated, loading: authLoading } = useAuth();
  const router = useRouter();

  // States
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [submitting, setSubmitting] = useState(false);
  const [subtotal, setSubtotal] = useState(0);
  const [shippingFee, setShippingFee] = useState(30000);
  const [discount, setDiscount] = useState(0);
  const [paymentMethod, setPaymentMethod] = useState('cod');
  const [couponCode, setCouponCode] = useState('');
  const [customerNote, setCustomerNote] = useState('');
  const [validationErrors, setValidationErrors] = useState<Record<string, string>>({});

  // Shipping address form
  const [shippingAddress, setShippingAddress] = useState<ShippingAddress>({
    fullname: '',
    phone: '',
    addressline1: '',
    ward: '',
    district: '',
    city: '',
  });

  // Load cart data
  useEffect(() => {
    if (authLoading) return;

    if (!isAuthenticated) {
      router.push('/login?redirect=checkout');
      return;
    }

    const loadCart = async () => {
      setLoading(true);
      try {
        const res = await fetchShoppingCart();

        if (!res.success || !res.data || res.data.length === 0) {
          alert('Giỏ hàng trống!');
          router.push('/shopping-cart');
          return;
        }

        setCartItems(res.data);
        // Calculate subtotal
        const total = res.data.reduce((sum: number, item: CartItem) => {
          return sum + item.price * item.quantity;
        }, 0);

        setSubtotal(total);

        // Free shipping for orders >= 500k
        setShippingFee(total >= 500000 ? 0 : 30000);

        // Pre-fill user info
        if (user) {
          setShippingAddress((prev) => ({
            ...prev,
            fullname: user.fullname || user.firstname || '',
            phone: user.phone || '',
          }));
        }
      } catch (error) {
        console.error('Load cart error:', error);
        alert('Lỗi khi tải giỏ hàng');
      } finally {
        setLoading(false);
      }
    };

    loadCart();
  }, [authLoading, isAuthenticated, router, user]);

  // Handle input changes
  const handleAddressChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>
  ) => {
    const { name, value } = e.target;
    setShippingAddress((prev) => ({
      ...prev,
      [name]: value,
    }));
    // Clear error for this field when user starts typing
    if (validationErrors[name]) {
      setValidationErrors((prev) => ({
        ...prev,
        [name]: '',
      }));
    }
  };

  // Validate form - CẢI THIỆN
  const validateForm = (): boolean => {
    const errors: Record<string, string> = {};
    let isValid = true;

    if (!shippingAddress.fullname.trim()) {
      errors.fullname = 'Vui lòng nhập họ tên';
      isValid = false;
    }

    if (!shippingAddress.phone.trim()) {
      errors.phone = 'Vui lòng nhập số điện thoại';
      isValid = false;
    } else if (!/^[0-9]{10,11}$/.test(shippingAddress.phone.trim())) {
      errors.phone = 'Số điện thoại không hợp lệ (10-11 chữ số)';
      isValid = false;
    }

    if (!shippingAddress.addressline1.trim()) {
      errors.addressline1 = 'Vui lòng nhập địa chỉ chi tiết';
      isValid = false;
    }

    if (!shippingAddress.district.trim()) {
      errors.district = 'Vui lòng nhập quận/huyện';
      isValid = false;
    }

    if (!shippingAddress.city.trim()) {
      errors.city = 'Vui lòng nhập tỉnh/thành phố';
      isValid = false;
    }

    setValidationErrors(errors);

    if (!isValid) {
      // Scroll to first error
      const firstErrorField = document.querySelector('[data-error]');
      if (firstErrorField) {
        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    return isValid;
  };

  // Submit order - CHÍNH
  const handleCheckout = async () => {
    if (!validateForm()) return;

    setSubmitting(true);

    try {
      const orderData = {
        // ✅ items - ĐÚNG KEY BACKEND
        items: cartItems.map(item => ({
          product_id: item.product_id,//
          variant_id: item.variant_id,//
          phone_model_id: item.phone_model_id,
          phone_model_name: item.phone_model_name,
          product_name: item.product_name || item.products?.product_name || `Product #${item.product_id}`,
          quantity: item.quantity,//
          unit_price: item.price || item.products?.sale_price || item.products?.price || 0,
          discount_amount: 0,//
        })),

        // ✅ shipping_address - ĐÚNG STRUCT
        shipping_address: {
          full_name: shippingAddress.fullname,//
          phone: shippingAddress.phone,//
          address_line1: shippingAddress.addressline1,//
          ward: shippingAddress.ward ||  undefined,///
          district: shippingAddress.district,//
          city: shippingAddress.city,//
        },

        // ✅ order financials (FULL TABLE)
        subtotal:subtotal,
        total_amount: subtotal - discount + shippingFee,

        // ✅ meta
        payment_method: paymentMethod,
        coupon_code: couponCode ||  undefined,
        customer_note: customerNote ||  undefined,
      };

      const result = await createOrder(orderData);

      if (!result.success) throw new Error(result.message);

      const orderNumber = result.data.order_number;
      const orderId = result.data.order_id || result.data.id;
      const totalAmount = result.data.total_amount || (subtotal - discount + shippingFee);

      // ✅ Nếu chọn thanh toán MoMo -> Gọi API MoMo và redirect
      if (paymentMethod === 'momo') {
        try {
          const momoResult = await createMomoPayment({
            amount: totalAmount,
            orderInfo: `Thanh toán đơn hàng #${orderNumber}`,
            orderId: orderNumber, // Dùng order_number làm orderId cho MoMo
            redirectUrl: `${window.location.origin}/payment-result`,
            extraData: JSON.stringify({ orderId, orderNumber }),
          });

          if (momoResult.success && momoResult.data?.payUrl) {
            // Xóa giỏ hàng trước khi redirect
            await clearShoppingCart();
            // Redirect đến trang thanh toán MoMo
            window.location.href = momoResult.data.payUrl;
            return;
          } else {
            throw new Error(momoResult.message || 'Không thể tạo thanh toán MoMo');
          }
        } catch (momoError: any) {
          console.error('MoMo payment error:', momoError);
          // Vẫn chuyển đến trang order nếu MoMo lỗi, để user có thể thanh toán sau
          alert(`Lỗi thanh toán MoMo: ${momoError.message}. Đơn hàng đã được tạo, bạn có thể thanh toán sau.`);
        }
      }

      // COD hoặc thanh toán khác -> Xóa giỏ hàng và chuyển đến trang order
      await clearShoppingCart();
      router.push(`/order/${orderNumber}?total=${totalAmount}`);
    } catch (err: any) {
      alert(err.message || 'Lỗi tạo đơn hàng');
    } finally {
      setSubmitting(false);
    }
  };


  // Calculate total
  const totalAmount = subtotal - discount + shippingFee;

  // Format price
  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN');
  };

  // Loading state
  if (loading || authLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Đang tải thông tin thanh toán...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        {/* Header */}
        <div className="mb-8">
          <Link
            href="/shopping-cart"
            className="flex items-center gap-2 text-gray-600 hover:text-pink-600 mb-4"
          >
            <ArrowLeft className="w-5 h-5" />
            Quay lại giỏ hàng
          </Link>
          <h1 className="text-3xl font-bold text-gray-900">Thanh toán</h1>
        </div>

        <div className="grid lg:grid-cols-3 gap-8">
          {/* Left Column - Forms */}
          <div className="lg:col-span-2 space-y-6">
            {/* Shipping Address */}
            <div className="bg-white rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-pink-100 rounded-lg">
                  <MapPin className="w-5 h-5 text-pink-600" />
                </div>
                <h2 className="text-xl font-semibold">Địa chỉ giao hàng</h2>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                {/* Fullname */}
                <div data-error={validationErrors.fullname ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    <User className="w-4 h-4 inline mr-1" />
                    Họ và tên
                  </label>
                  <input
                    type="text"
                    name="fullname"
                    value={shippingAddress.fullname}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.fullname
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="Nguyễn Văn A"
                  />
                  {validationErrors.fullname && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.fullname}
                    </p>
                  )}
                </div>

                {/* Phone */}
                <div data-error={validationErrors.phone ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    <Phone className="w-4 h-4 inline mr-1" />
                    Số điện thoại
                  </label>
                  <input
                    type="tel"
                    name="phone"
                    value={shippingAddress.phone}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.phone
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="0901234567"
                  />
                  {validationErrors.phone && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.phone}
                    </p>
                  )}
                </div>

                {/* Address */}
                <div
                  className="md:col-span-2"
                  data-error={validationErrors.addressline1 ? 'true' : ''}
                >
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Địa chỉ chi tiết
                  </label>
                  <input
                    type="text"
                    name="addressline1"
                    value={shippingAddress.addressline1}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.addressline1
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="Số nhà, tên đường..."
                  />
                  {validationErrors.addressline1 && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.addressline1}
                    </p>
                  )}
                </div>

                {/* Ward */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Phường/Xã (tùy chọn)
                  </label>
                  <input
                    type="text"
                    name="ward"
                    value={shippingAddress.ward}
                    onChange={handleAddressChange}
                    className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                    placeholder="Phường 1"
                  />
                </div>

                {/* District */}
                <div data-error={validationErrors.district ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Quận/Huyện
                  </label>
                  <input
                    type="text"
                    name="district"
                    value={shippingAddress.district}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.district
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="Quận 1"
                  />
                  {validationErrors.district && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.district}
                    </p>
                  )}
                </div>

                {/* City */}
                <div data-error={validationErrors.city ? 'true' : ''}>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Tỉnh/Thành phố
                  </label>
                  <input
                    type="text"
                    name="city"
                    value={shippingAddress.city}
                    onChange={handleAddressChange}
                    className={`w-full border rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent ${
                      validationErrors.city
                        ? 'border-red-500'
                        : 'border-gray-300'
                    }`}
                    placeholder="TP. Hồ Chí Minh"
                  />
                  {validationErrors.city && (
                    <p className="text-red-500 text-sm mt-1 flex items-center gap-1">
                      <AlertCircle className="w-4 h-4" />
                      {validationErrors.city}
                    </p>
                  )}
                </div>
              </div>
            </div>

            {/* Payment Method */}
            <div className="bg-white rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-6">
                <div className="p-2 bg-blue-100 rounded-lg">
                  <CreditCard className="w-5 h-5 text-blue-600" />
                </div>
                <h2 className="text-xl font-semibold">Phương thức thanh toán</h2>
              </div>

              <div className="space-y-3">
                {/* COD */}
                <label className="flex items-center gap-4 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
                  style={{
                    borderColor: paymentMethod === 'cod' ? '#ec4899' : '#d1d5db',
                    backgroundColor: paymentMethod === 'cod' ? '#fce7f3' : 'white',
                  }}>
                  <input
                    type="radio"
                    name="payment"
                    value="cod"
                    checked={paymentMethod === 'cod'}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                    className="w-5 h-5 text-pink-600"
                  />
                  <Truck className="w-6 h-6 text-gray-600" />
                  <div>
                    <p className="font-medium">Thanh toán khi nhận hàng (COD)</p>
                    <p className="text-sm text-gray-500">
                      Thanh toán bằng tiền mặt khi nhận hàng
                    </p>
                  </div>
                </label>

                {/* MoMo */}
                <label className="flex items-center gap-4 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
                  style={{
                    borderColor: paymentMethod === 'momo' ? '#ec4899' : '#d1d5db',
                    backgroundColor: paymentMethod === 'momo' ? '#fce7f3' : 'white',
                  }}>
                  <input
                    type="radio"
                    name="payment"
                    value="momo"
                    checked={paymentMethod === 'momo'}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                    className="w-5 h-5 text-pink-600"
                  />
                  <div className="w-6 h-6 bg-pink-500 rounded-lg flex items-center justify-center text-white font-bold text-xs">
                    M
                  </div>
                  <div>
                    <p className="font-medium">Ví MoMo</p>
                    <p className="text-sm text-gray-500">
                      Thanh toán qua ví điện tử MoMo
                    </p>
                  </div>
                </label>

                {/* Bank Transfer */}
                <label className="flex items-center gap-4 p-4 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
                  style={{
                    borderColor: paymentMethod === 'bank' ? '#ec4899' : '#d1d5db',
                    backgroundColor: paymentMethod === 'bank' ? '#fce7f3' : 'white',
                  }}>
                  <input
                    type="radio"
                    name="payment"
                    value="bank"
                    checked={paymentMethod === 'bank'}
                    onChange={(e) => setPaymentMethod(e.target.value)}
                    className="w-5 h-5 text-pink-600"
                  />
                  <CreditCard className="w-6 h-6 text-gray-600" />
                  <div>
                    <p className="font-medium">Chuyển khoản ngân hàng</p>
                    <p className="text-sm text-gray-500">
                      Chuyển khoản qua tài khoản ngân hàng
                    </p>
                  </div>
                </label>
              </div>
            </div>

            {/* Customer Note */}
            <div className="bg-white rounded-2xl shadow-sm p-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="p-2 bg-gray-100 rounded-lg">
                  <FileText className="w-5 h-5 text-gray-600" />
                </div>
                <h2 className="text-xl font-semibold">Ghi chú đơn hàng</h2>
              </div>
              <textarea
                value={customerNote}
                onChange={(e) => setCustomerNote(e.target.value)}
                className="w-full border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none"
                rows={3}
                placeholder="Ghi chú thêm về đơn hàng tùy chọn..."
              ></textarea>
            </div>
          </div>

          {/* Right Column - Order Summary */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-sm p-6 sticky top-4">
              <h2 className="text-xl font-semibold mb-6">Đơn hàng của bạn</h2>

              {/* Cart Items */}
              <div className="space-y-4 max-h-64 overflow-y-auto mb-6 pb-4 border-b">
                {cartItems.map((item) => (
                  <div key={item.cart_id} className="flex gap-3">
                    <div className="w-16 h-16 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                      <img
                        src={item.image_url || '/placeholder.png'}
                        alt={item.product_name}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-sm line-clamp-2">
                        {item.product_name}
                      </p>
                      {item.phone_model_name && (
                        <p className="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded inline-block mt-1">
                          📱 {item.phone_model_name}
                        </p>
                      )}
                      <p className="text-gray-500 text-sm">
                        x{item.quantity}
                      </p>
                      <p className="font-semibold text-pink-600 whitespace-nowrap">
                        {formatPrice(item.price * item.quantity)}₫
                      </p>
                    </div>
                  </div>
                ))}
              </div>

              {/* Summary */}
              <div className="space-y-3">
                <div className="flex justify-between text-gray-600">
                  <span>Tạm tính</span>
                  <span>{formatPrice(subtotal)}₫</span>
                </div>

                {discount > 0 && (
                  <div className="flex justify-between text-green-600">
                    <span>Giảm giá</span>
                    <span>-{formatPrice(discount)}₫</span>
                  </div>
                )}

                <div className="flex justify-between text-gray-600">
                  <span>Phí vận chuyển</span>
                  <span>
                    {shippingFee === 0 ? 'Miễn phí' : formatPrice(shippingFee) + '₫'}
                  </span>
                </div>

                <div className="border-t pt-4 flex justify-between font-bold text-lg">
                  <span>Tổng cộng</span>
                  <span className="text-pink-600">{formatPrice(totalAmount)}₫</span>
                </div>
              </div>

              {/* Submit Button */}
              <button
                onClick={handleCheckout}
                disabled={submitting || cartItems.length === 0}
                className="w-full mt-6 bg-gradient-to-r from-pink-600 to-pink-500 text-white py-3 rounded-xl font-bold hover:from-pink-700 hover:to-pink-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {submitting ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    Đang xử lý...
                  </>
                ) : (
                  <>
                    <Check className="w-5 h-5" />
                    Xác nhận đơn hàng
                  </>
                )}
              </button>

              {/* Security Badge */}
              <div className="mt-4 flex items-center justify-center gap-2 text-gray-500 text-sm">
                <Shield className="w-4 h-4" />
                <span>Thanh toán an toàn</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}




################################################################################
## FILE 103: page.tsx
## Path: fontend/src/app/(public)/collections/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { Search, Menu, ShoppingCart, User, Heart, ArrowRight, Star, Sparkles, Crown, Gem, Palette, Zap, Shield, Gift, X } from 'lucide-react';
import Link from 'next/link';
import { fetchProducts, fetchCategoriesWithCount, fetchProductsBySeason, fetchSeasonProductCounts, fetchAllCollections, fetchCollectionsByType, fetchCollectionProductCounts, fetchProductsByCollection } from '@/lib/api-client';

interface Collection {
  id: number;
  name: string;
  description: string;
  image: string;
  productCount: number;
  gradient: string;
  icon: React.ReactNode;
  featured?: boolean;
}

interface Product {
  id: number;
  name: string;
  price: number;
  image: string;
  rating: number;
  reviews: number;
  tag?: string;
}

interface SeasonalCollection {
  id: number;
  name: string;
  image: string;
  gradient: string;
  products: number;
  seasonKey: string;
}

const CollectionsPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [activeCollection, setActiveCollection] = useState<number | null>(null);
  const [hoveredProduct, setHoveredProduct] = useState<number | null>(null);
  const [featuredProducts, setFeaturedProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Season modal states
  const [showSeasonModal, setShowSeasonModal] = useState(false);
  const [selectedSeason, setSelectedSeason] = useState<SeasonalCollection | null>(null);
  const [seasonProducts, setSeasonProducts] = useState<Product[]>([]);
  const [loadingSeasonProducts, setLoadingSeasonProducts] = useState(false);
  
  // Season product counts from API
  const [seasonCounts, setSeasonCounts] = useState<Record<string, number>>({
    noel: 0,
    valentine: 0,
    tet: 0
  });

  // Collection product counts from API (bắt đầu từ 0)
  const [collectionCounts, setCollectionCounts] = useState<Record<string, number>>({
    'luxury-edition': 0,
    'minimalist': 0,
    'artistic-series': 0,
    'gaming-pro': 0,
    'rugged-armor': 0,
    'limited-edition': 0,
    'giang-sinh-noel': 0,
    'valentine': 0,
    'tet-nguyen-dan': 0
  });

  // Featured Collections - sử dụng collectionCounts từ API
  const collections: Collection[] = [
    {
      id: 1,
      name: 'Luxury Edition',
      description: 'Bộ sưu tập cao cấp với chất liệu da thật và kim loại nguyên khối',
      image: 'https://images.unsplash.com/photo-1616348436168-de43ad0db179?w=800&h=600&fit=crop',
      productCount: collectionCounts['luxury-edition'] || 0,
      gradient: 'from-amber-500 via-yellow-500 to-orange-500',
      icon: <Crown className="w-8 h-8" />,
      featured: true
    },
    {
      id: 2,
      name: 'Minimalist',
      description: 'Thiết kế tối giản, tinh tế cho người yêu thích sự đơn giản',
      image: 'https://images.unsplash.com/photo-1609081219090-a6d81d3085bf?w=800&h=600&fit=crop',
      productCount: collectionCounts['minimalist'] || 0,
      gradient: 'from-gray-700 via-gray-800 to-gray-900',
      icon: <Gem className="w-8 h-8" />
    },
    {
      id: 3,
      name: 'Artistic Series',
      description: 'Họa tiết nghệ thuật độc đáo từ các nghệ sĩ hàng đầu',
      image: 'https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=800&h=600&fit=crop',
      productCount: collectionCounts['artistic-series'] || 0,
      gradient: 'from-purple-500 via-pink-500 to-red-500',
      icon: <Palette className="w-8 h-8" />
    },
    {
      id: 4,
      name: 'Gaming Pro',
      description: 'Dành cho game thủ với thiết kế RGB và grip chống trượt',
      image: 'https://images.unsplash.com/photo-1612287230202-1ff1d85d1bdf?w=800&h=600&fit=crop',
      productCount: collectionCounts['gaming-pro'] || 0,
      gradient: 'from-green-400 via-cyan-500 to-blue-500',
      icon: <Zap className="w-8 h-8" />
    },
    {
      id: 5,
      name: 'Rugged Armor',
      description: 'Bảo vệ tối đa với chuẩn quân đội, chống va đập cực tốt',
      image: 'https://images.unsplash.com/photo-1601784551446-20c9e07cdbdb?w=800&h=600&fit=crop',
      productCount: collectionCounts['rugged-armor'] || 0,
      gradient: 'from-slate-600 via-slate-700 to-slate-800',
      icon: <Shield className="w-8 h-8" />
    },
    {
      id: 6,
      name: 'Limited Edition',
      description: 'Phiên bản giới hạn, số lượng có hạn, thiết kế độc quyền',
      image: 'https://images.unsplash.com/photo-1585771724684-38269d6639fd?w=800&h=600&fit=crop',
      productCount: collectionCounts['limited-edition'] || 0,
      gradient: 'from-rose-500 via-pink-600 to-purple-600',
      icon: <Sparkles className="w-8 h-8" />,
      featured: true
    }
  ];

  // Seasonal Collections - sử dụng collectionCounts từ API
  const seasonalCollections: SeasonalCollection[] = [
    {
      id: 7,
      name: 'Giáng Sinh - Noel',
      image: 'noel.jpg',
      gradient: 'from-red-600 to-green-600',
      products: collectionCounts['giang-sinh-noel'] || 0,
      seasonKey: 'noel'
    },
    {
      id: 8,
      name: 'Valentine',
      image: 'https://images.unsplash.com/photo-1518199266791-5375a83190b7?w=600&h=400&fit=crop',
      gradient: 'from-red-400 to-pink-500',
      products: collectionCounts['valentine'] || 0,
      seasonKey: 'valentine'
    },
    {
      id: 9,
      name: 'Tết Nguyên Đán',
      image: 'https://images.unsplash.com/photo-1548919973-5cef591cdbc9?w=600&h=400&fit=crop',
      gradient: 'from-yellow-500 to-red-500',
      products: collectionCounts['tet-nguyen-dan'] || 0,
      seasonKey: 'tet'
    }
  ];

  // Load season product counts
  useEffect(() => {
    const loadSeasonCounts = async () => {
      try {
        const counts = await fetchSeasonProductCounts();
        setSeasonCounts(counts);
      } catch (error) {
        console.error('Error loading season counts:', error);
      }
    };
    loadSeasonCounts();
  }, []);

  // Load collection product counts từ API
  useEffect(() => {
    const loadCollectionCounts = async () => {
      try {
        const counts = await fetchCollectionProductCounts();
        setCollectionCounts(counts);
      } catch (error) {
        console.error('Error loading collection counts:', error);
        // Giữ giá trị 0 nếu lỗi
      }
    };
    loadCollectionCounts();
  }, []);

  // Handle click on seasonal collection
  const handleSeasonClick = async (collection: SeasonalCollection) => {
    setSelectedSeason(collection);
    setShowSeasonModal(true);
    setLoadingSeasonProducts(true);
    
    try {
      const products = await fetchProductsBySeason(collection.seasonKey);
      const mapped = products.map((p: any) => ({
        id: p.product_id || p.id,
        name: p.product_name || p.name,
        price: p.price || 0,
        image: p.image_url || p.image || 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400',
        rating: p.rating || 4.5,
        reviews: p.reviews || 0,
        tag: p.tag
      }));
      setSeasonProducts(mapped);
    } catch (error) {
      console.error('Error loading season products:', error);
      setSeasonProducts([]);
    } finally {
      setLoadingSeasonProducts(false);
    }
  };

  useEffect(() => {
    const loadFeaturedProducts = async () => {
      try {
        setLoading(true);
        const data = await fetchProducts(8);
        const mapped = data.map((p: any) => ({
          id: p.product_id || p.id,
          name: p.product_name || p.name,
          price: p.price || 0,
          image: p.image_url || p.image || 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400',
          rating: p.rating || 4.5,
          reviews: p.reviews || 0,
          tag: p.tag
        }));
        setFeaturedProducts(mapped);
      } catch (error) {
        console.error('Error loading products:', error);
        // Fallback data
        setFeaturedProducts([
          { id: 1, name: 'Ốp Luxury Gold', price: 299000, image: 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400', rating: 4.9, reviews: 128 },
          { id: 2, name: 'Ốp Minimal Black', price: 199000, image: 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=400', rating: 4.8, reviews: 256 },
          { id: 3, name: 'Ốp Art Series', price: 249000, image: 'https://images.unsplash.com/photo-1586953208448-b95a79798f07?w=400', rating: 4.7, reviews: 89 },
          { id: 4, name: 'Ốp Gaming RGB', price: 349000, image: 'https://images.unsplash.com/photo-1612287230202-1ff1d85d1bdf?w=400', rating: 4.9, reviews: 312 }
        ]);
      } finally {
        setLoading(false);
      }
    };
    loadFeaturedProducts();
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Season Products Modal */}
      {showSeasonModal && selectedSeason && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm" onClick={() => setShowSeasonModal(false)}>
          <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl mx-4" onClick={(e) => e.stopPropagation()}>
            {/* Modal Header */}
            <div className={`bg-gradient-to-r ${selectedSeason.gradient} p-6 text-white relative`}>
              <button 
                onClick={() => setShowSeasonModal(false)}
                className="absolute top-4 right-4 bg-white/20 hover:bg-white/30 p-2 rounded-full transition"
              >
                <X className="w-5 h-5" />
              </button>
              <h2 className="text-2xl font-bold">{selectedSeason.name}</h2>
              <p className="text-white/80">{selectedSeason.products} sản phẩm trong bộ sưu tập</p>
            </div>
            
            {/* Modal Content */}
            <div className="p-6 overflow-y-auto max-h-[60vh]">
              {loadingSeasonProducts ? (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {[1, 2, 3, 4, 5, 6].map((i) => (
                    <div key={i} className="animate-pulse">
                      <div className="bg-gray-200 rounded-xl h-40 mb-3"></div>
                      <div className="bg-gray-200 h-4 rounded mb-2"></div>
                      <div className="bg-gray-200 h-4 rounded w-2/3"></div>
                    </div>
                  ))}
                </div>
              ) : seasonProducts.length === 0 ? (
                <div className="text-center py-12">
                  <Gift className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                  <p className="text-gray-500 text-lg">Chưa có sản phẩm trong bộ sưu tập này</p>
                  <p className="text-gray-400 text-sm mt-2">Hãy thêm sản phẩm với mùa "{selectedSeason.seasonKey}" trong Admin</p>
                </div>
              ) : (
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                  {seasonProducts.map((product) => (
                    <Link href={`/product/${product.id}`} key={product.id}>
                      <div className="group bg-gray-50 rounded-xl overflow-hidden hover:shadow-lg transition">
                        <div className="relative overflow-hidden">
                          <img 
                            src={product.image} 
                            alt={product.name}
                            className="w-full h-40 object-cover group-hover:scale-110 transition duration-300"
                          />
                          {product.tag && (
                            <span className="absolute top-2 left-2 bg-pink-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                              {product.tag}
                            </span>
                          )}
                        </div>
                        <div className="p-3">
                          <h3 className="font-medium text-sm line-clamp-2 mb-2 group-hover:text-pink-600 transition">{product.name}</h3>
                          <div className="flex items-center gap-1 mb-2">
                            <Star className="w-3 h-3 fill-yellow-400 text-yellow-400" />
                            <span className="text-xs text-gray-600">{product.rating}</span>
                          </div>
                          <p className="text-pink-600 font-bold">{product.price.toLocaleString('vi-VN')}₫</p>
                        </div>
                      </div>
                    </Link>
                  ))}
                </div>
              )}
            </div>
            
            {/* Modal Footer */}
            <div className="p-4 border-t bg-gray-50">
              <Link href="/shop" className="block w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-xl font-semibold text-center hover:from-purple-700 hover:to-pink-700 transition">
                Xem Tất Cả Sản Phẩm
              </Link>
            </div>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-gradient-to-r from-purple-900 via-indigo-900 to-purple-900 text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <Sparkles className="w-4 h-4 text-yellow-400" />
          <span>Khám phá bộ sưu tập mới nhất - Giảm đến 30% cho thành viên</span>
          <Sparkles className="w-4 h-4 text-yellow-400" />
        </div>
      </div>

      

      {/* Hero Section */}
      <section className="relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-br from-purple-900 via-indigo-800 to-pink-900"></div>
        <div className="absolute inset-0 opacity-20">
          <div className="absolute inset-0" style={{
            backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
          }}></div>
        </div>
        <div className="relative max-w-7xl mx-auto px-4 py-20 md:py-32">
          <div className="text-center text-white">
            <div className="inline-flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full mb-6">
              <Sparkles className="w-5 h-5 text-yellow-400" />
              <span className="text-sm font-medium">Bộ sưu tập 2025</span>
            </div>
            <h1 className="text-5xl md:text-7xl font-bold mb-6">
              Khám Phá <span className="bg-gradient-to-r from-yellow-400 via-pink-400 to-purple-400 bg-clip-text text-transparent">Bộ Sưu Tập</span>
            </h1>
            <p className="text-xl md:text-2xl text-white/80 mb-8 max-w-2xl mx-auto">
              Những thiết kế độc đáo, chất lượng cao cấp dành riêng cho bạn
            </p>
            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <button className="bg-white text-purple-900 px-8 py-4 rounded-full font-semibold hover:bg-gray-100 transition transform hover:scale-105 shadow-xl">
                Khám Phá Ngay
              </button>
              <button className="border-2 border-white text-white px-8 py-4 rounded-full font-semibold hover:bg-white/10 transition">
                Xem Video
              </button>
            </div>
          </div>
        </div>
        
        {/* Animated gradient orbs */}
        <div className="absolute top-20 left-10 w-72 h-72 bg-purple-500/30 rounded-full blur-3xl animate-pulse"></div>
        <div className="absolute bottom-20 right-10 w-96 h-96 bg-pink-500/30 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }}></div>
      </section>

      {/* Featured Collections Grid */}
      <section className="max-w-7xl mx-auto px-4 py-16">
        <div className="text-center mb-12">
          <h2 className="text-4xl font-bold mb-4">Bộ Sưu Tập Nổi Bật</h2>
          <p className="text-gray-600 max-w-2xl mx-auto">Khám phá những bộ sưu tập được thiết kế đặc biệt, mang đến phong cách độc đáo cho chiếc điện thoại của bạn</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {collections.map((collection, index) => (
            <div
              key={collection.id}
              className={`group relative overflow-hidden rounded-3xl cursor-pointer transform transition-all duration-500 hover:scale-[1.02] hover:shadow-2xl ${
                collection.featured ? 'md:col-span-2 lg:col-span-1' : ''
              }`}
              style={{ minHeight: collection.featured ? '400px' : '320px' }}
              onMouseEnter={() => setActiveCollection(collection.id)}
              onMouseLeave={() => setActiveCollection(null)}
            >
              {/* Background Image */}
              <div className="absolute inset-0">
                <img 
                  src={collection.image} 
                  alt={collection.name}
                  className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
              </div>
              
              {/* Gradient Overlay */}
              <div className={`absolute inset-0 bg-gradient-to-t ${collection.gradient} opacity-80 group-hover:opacity-90 transition-opacity duration-300`}></div>
              
              {/* Content */}
              <div className="absolute inset-0 p-6 flex flex-col justify-end text-white">
                {collection.featured && (
                  <div className="absolute top-4 right-4 bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1">
                    <Star className="w-3 h-3 fill-current" />
                    HOT
                  </div>
                )}
                
                <div className={`transform transition-all duration-500 ${activeCollection === collection.id ? 'translate-y-0' : 'translate-y-4'}`}>
                  <div className="mb-3 inline-flex items-center justify-center w-14 h-14 bg-white/20 backdrop-blur-sm rounded-2xl">
                    {collection.icon}
                  </div>
                  <h3 className="text-2xl font-bold mb-2">{collection.name}</h3>
                  <p className={`text-white/80 mb-4 transition-all duration-300 ${activeCollection === collection.id ? 'opacity-100 max-h-20' : 'opacity-0 max-h-0'} overflow-hidden`}>
                    {collection.description}
                  </p>
                  <div className="flex items-center justify-between">
                    <span className="text-sm bg-white/20 px-3 py-1 rounded-full">{collection.productCount} sản phẩm</span>
                    <button className="flex items-center gap-2 font-medium hover:gap-3 transition-all">
                      Xem ngay <ArrowRight className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>

      {/* Seasonal Collections */}
      <section className="bg-gradient-to-b from-gray-100 to-white py-16">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex items-center justify-between mb-8">
            <div>
              <h2 className="text-3xl font-bold mb-2">Bộ Sưu Tập Theo Mùa</h2>
              <p className="text-gray-600">Những thiết kế phù hợp với từng dịp đặc biệt</p>
            </div>
            <Link href="/shop" className="hidden md:flex items-center gap-2 text-pink-600 font-medium hover:gap-3 transition-all">
              Xem tất cả <ArrowRight className="w-4 h-4" />
            </Link>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {seasonalCollections.map((collection) => (
              <div
                key={collection.id}
                className="group relative overflow-hidden rounded-2xl h-64 cursor-pointer"
                onClick={() => handleSeasonClick(collection)}
              >
                <img 
                  src={collection.image} 
                  alt={collection.name}
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                />
                <div className={`absolute inset-0 bg-gradient-to-t ${collection.gradient} opacity-60 group-hover:opacity-70 transition-opacity`}></div>
                <div className="absolute inset-0 p-6 flex flex-col justify-end text-white">
                  <h3 className="text-xl font-bold mb-1">{collection.name}</h3>
                  <p className="text-sm text-white/80">{collection.products} sản phẩm</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Featured Products from Collections
      <section className="max-w-7xl mx-auto px-4 py-16">
        <div className="text-center mb-12">
          <h2 className="text-3xl font-bold mb-4">Sản Phẩm Nổi Bật Từ Bộ Sưu Tập</h2>
          <p className="text-gray-600">Những sản phẩm được yêu thích nhất</p>
        </div>

        {loading ? (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="animate-pulse">
                <div className="bg-gray-200 rounded-2xl h-64 mb-4"></div>
                <div className="bg-gray-200 h-4 rounded mb-2"></div>
                <div className="bg-gray-200 h-4 rounded w-2/3"></div>
              </div>
            ))}
          </div>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            {featuredProducts.slice(0, 4).map((product) => (
              <div
                key={product.id}
                className="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2"
                onMouseEnter={() => setHoveredProduct(product.id)}
                onMouseLeave={() => setHoveredProduct(null)}
              >
                <div className="relative overflow-hidden">
                  <img 
                    src={product.image} 
                    alt={product.name}
                    className="w-full h-64 object-cover transition-transform duration-500 group-hover:scale-110"
                  />
                  {product.tag && (
                    <span className="absolute top-3 left-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                      {product.tag}
                    </span>
                  )}
                  <div className={`absolute inset-0 bg-black/20 flex items-center justify-center transition-opacity duration-300 ${hoveredProduct === product.id ? 'opacity-100' : 'opacity-0'}`}>
                    <button className="bg-white text-gray-900 px-6 py-2 rounded-full font-medium transform transition-transform hover:scale-105">
                      Xem Chi Tiết
                    </button>
                  </div>
                  <button className="absolute top-3 right-3 bg-white/80 backdrop-blur-sm p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white">
                    <Heart className="w-5 h-5 text-gray-600 hover:text-pink-500 transition-colors" />
                  </button>
                </div>
                <div className="p-4">
                  <h3 className="font-semibold mb-2 line-clamp-2 group-hover:text-pink-600 transition-colors">{product.name}</h3>
                  <div className="flex items-center gap-2 mb-2">
                    <div className="flex items-center">
                      <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                      <span className="text-sm ml-1">{product.rating}</span>
                    </div>
                    <span className="text-sm text-gray-500">({product.reviews})</span>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-lg font-bold text-pink-600">{product.price.toLocaleString('vi-VN')}₫</span>
                    <button className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-purple-700 hover:to-pink-700 transition">
                      Thêm
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}

        <div className="text-center mt-10">
          <Link href="/shop" className="inline-flex items-center gap-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-full font-semibold hover:from-purple-700 hover:to-pink-700 transition transform hover:scale-105 shadow-lg">
            Xem Tất Cả Sản Phẩm <ArrowRight className="w-5 h-5" />
          </Link>
        </div>
      </section> */}

      {/* Newsletter Section */}
      <section className="relative overflow-hidden">
        <div className="absolute inset-0 bg-gradient-to-r from-purple-600 via-pink-600 to-orange-500"></div>
        <div className="absolute inset-0 opacity-10">
          <div className="absolute inset-0" style={{
            backgroundImage: `radial-gradient(circle at 2px 2px, white 1px, transparent 0)`,
            backgroundSize: '32px 32px'
          }}></div>
        </div>
        <div className="relative max-w-4xl mx-auto px-4 py-20 text-center text-white">
          <Gift className="w-16 h-16 mx-auto mb-6 opacity-80" />
          <h2 className="text-4xl font-bold mb-4">Nhận Ưu Đãi Độc Quyền</h2>
          <p className="text-xl text-white/80 mb-8">Đăng ký để nhận thông tin về bộ sưu tập mới và giảm giá 15% cho đơn hàng đầu tiên</p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
            <input
              type="email"
              placeholder="Nhập email của bạn"
              className="flex-1 px-6 py-4 rounded-full text-gray-900 focus:outline-none focus:ring-4 focus:ring-white/30"
            />
            <button className="bg-white text-purple-600 px-8 py-4 rounded-full font-semibold hover:bg-gray-100 transition transform hover:scale-105 shadow-lg">
              Đăng Ký
            </button>
          </div>
        </div>
      </section>
    </div>
  );
};

export default CollectionsPage;




################################################################################
## FILE 104: page.tsx
## Path: fontend/src/app/(public)/contact/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu, Mail, Phone, MapPin, Clock, Send } from 'lucide-react';
import Link from 'next/link';
import { fetchCategories, createContactMessage } from '@/lib/api-client';

const ContactPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    subject: '',
    message: ''
  });
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const result = await createContactMessage({
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        subject: formData.subject,
        message: formData.message
      });
      
      if (result.success) {
        alert(`Cảm ơn ${formData.name}! Tin nhắn của bạn đã được gửi thành công. Chúng tôi sẽ liên hệ lại với bạn sớm.`);
        setFormData({ name: '', email: '', phone: '', subject: '', message: '' });
      } else {
        alert('Có lỗi xảy ra khi gửi tin nhắn. Vui lòng thử lại!');
      }
    } catch (error) {
      console.error('Error sending message:', error);
      alert(`Cảm ơn ${formData.name}! Chúng tôi sẽ liên hệ lại với bạn sớm.`);
      setFormData({ name: '', email: '', phone: '', subject: '', message: '' });
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value
    });
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setIsCurrencyModalOpen(false)}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold">CHỌN LOẠI TIỀN TỆ</h2>
              <button onClick={() => setIsCurrencyModalOpen(false)} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-gray-700">QUỐC GIA/KHU VỰC:</label>
              <select 
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Việt Nam (VND ₫)</option>
              </select>
            </div>

            <button 
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
            >
              ÁP DỤNG
            </button>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-black text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <span>Miễn phí vận chuyển cho đơn hàng trên 100K</span>
          <span className="hidden md:inline">|</span>
          <span className="hidden md:inline">Ưu đãi GoatTech: Mua 4 ốp - Trả tiền 2 ốp</span>
        </div>
      </div>

      {/* Hero Section */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-600 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">Liên Hệ Chúng Tôi</h1>
          <p className="text-xl">Chúng tôi luôn sẵn sàng hỗ trợ bạn 24/7</p>
        </div>
      </div>

      {/* Contact Information */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-16">
          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-pink-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Phone className="w-8 h-8 text-pink-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Điện Thoại</h3>
            <p className="text-gray-600">+84 941 402 595</p>
            <p className="text-gray-600">+84 914 100 559</p>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Mail className="w-8 h-8 text-blue-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Email</h3>
            <p className="text-gray-600">support@GoatTech.vn</p>
            <p className="text-gray-600">sales@GoatTech.vn</p>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <MapPin className="w-8 h-8 text-green-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Địa Chỉ</h3>
            <p className="text-gray-600">Khu phố 6, P.Linh Trung</p>
            <p className="text-gray-600">Ho Chi Minh City, Vietnam</p>
          </div>

          <div className="bg-white p-6 rounded-xl shadow-sm text-center">
            <div className="bg-orange-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Clock className="w-8 h-8 text-orange-600" />
            </div>
            <h3 className="font-semibold text-lg mb-2">Giờ Làm Việc</h3>
            <p className="text-gray-600">T2 - T6: 9:00 - 18:00</p>
            <p className="text-gray-600">T7 - CN: 10:00 - 17:00</p>
          </div>
        </div>

        {/* Contact Form */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          <div>
            <h2 className="text-3xl font-bold mb-6">Gửi Tin Nhắn Cho Chúng Tôi</h2>
            <p className="text-gray-600 mb-8">
              Điền thông tin vào form bên dưới và chúng tôi sẽ phản hồi trong vòng 24 giờ.
            </p>

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-semibold mb-2">Họ và Tên *</label>
                <input
                  type="text"
                  name="name"
                  value={formData.name}
                  onChange={handleInputChange}
                  placeholder="Nguyễn Văn A"
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                  required
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label className="block text-sm font-semibold mb-2">Email *</label>
                  <input
                    type="email"
                    name="email"
                    value={formData.email}
                    onChange={handleInputChange}
                    placeholder="email@example.com"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2">Số Điện Thoại</label>
                  <input
                    type="tel"
                    name="phone"
                    value={formData.phone}
                    onChange={handleInputChange}
                    placeholder="0123 456 789"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">Chủ Đề *</label>
                <select
                  name="subject"
                  value={formData.subject}
                  onChange={handleInputChange}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                  required
                >
                  <option value="">Chọn chủ đề</option>
                  <option value="order">Đơn Hàng</option>
                  <option value="product">Sản Phẩm</option>
                  <option value="shipping">Vận Chuyển</option>
                  <option value="return">Hoàn Trả</option>
                  <option value="other">Khác</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-semibold mb-2">Tin Nhắn *</label>
                <textarea
                  name="message"
                  value={formData.message}
                  onChange={handleInputChange}
                  placeholder="Nội dung tin nhắn của bạn..."
                  rows={6}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600 resize-none"
                  required
                />
              </div>

              <button
                type="submit"
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition flex items-center justify-center gap-2"
              >
                <Send className="w-5 h-5" />
                Gửi Tin Nhắn
              </button>
            </form>
          </div>

          {/* Map or Additional Info */}
          <div>
            <h2 className="text-3xl font-bold mb-6">Tìm Chúng Tôi</h2>
            <div className="bg-gray-200 rounded-xl overflow-hidden mb-6" style={{ height: '400px' }}>
              <iframe
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3919.4989654716707!2d106.69822631533431!3d10.772466862169026!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31752f4b3330bcc9%3A0x5a8b0f0c00dbf5e6!2zTmd1eeG7hW4gSHXhu4csIFF1YW4gMSwgVGjDoG5oIHBo4buRIEjhu5MgQ2jDrSBNaW5o!5e0!3m2!1svi!2s!4v1234567890123!5m2!1svi!2s"
                width="100%"
                height="100%"
                style={{ border: 0 }}
                allowFullScreen
                loading="lazy"
                referrerPolicy="no-referrer-when-downgrade"
              />
            </div>

            <div className="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
              <h3 className="font-semibold text-lg mb-4">Câu Hỏi Thường Gặp</h3>
              <ul className="space-y-3 text-gray-700">
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">•</span>
                  <span>Thời gian giao hàng: 2-5 ngày làm việc</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">•</span>
                  <span>Chính sách đổi trả trong vòng 30 ngày</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">•</span>
                  <span>Miễn phí vận chuyển đơn hàng trên 100K</span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-pink-600 font-bold">•</span>
                  <span>Bảo hành 12 tháng cho tất cả sản phẩm</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ContactPage;




################################################################################
## FILE 105: page.tsx
## Path: fontend/src/app/(public)/login/page.tsx
################################################################################

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { loginCustomer } from '@/lib/api-client';
import Link from 'next/link';
import { Mail, Lock, AlertCircle, User, LogOut, Settings, ShoppingBag, Heart, Edit, Eye, EyeOff } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';

export default function LoginPage() {
  const router = useRouter();
  const { user, isAuthenticated, login, logout, getDisplayName, loading , is_admin } = useAuth();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
  });
  const [submitLoading, setSubmitLoading] = useState(false);
  const [error, setError] = useState('');
  const [showPassword, setShowPassword] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value,
    });
    setError('');
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    // Validation
    if (!formData.email || !formData.password) {
      setError('Vui lòng điền đầy đủ thông tin');
      return;
    }

    if (!formData.email.includes('@')) {
      setError('Email không hợp lệ');
      return;
    }

    setSubmitLoading(true);

    try {
      const result = await loginCustomer(formData.email, formData.password);

      if (result.success) {
        const user = result.customer || result.user;
        
        // 🔧 SỬA: Lưu access_token vào cùng với user data
        const customerData = {
          ...user,
          access_token: result.access_token,
        };
        
        localStorage.setItem('customer', JSON.stringify(customerData));
        
        const isAdmin = result.role === 'admin' || 
                        user?.role === 'admin' || 
                        user?.email?.toLowerCase().includes('admin');
        
        localStorage.setItem('userRole', isAdmin ? 'admin' : 'customer');
        
        // 🔧 SỬA: Dùng login() từ useAuth() thay vì setLoggedInUser
        login(customerData);
        
        if (isAdmin) {
          router.push('/admin');
        } else {
          router.push('/');
        }
      } else {
        setError(result.message || 'Đăng nhập thất bại');
      }
    } catch (err: any) {
      console.error('Login error:', err);
      setError('Có lỗi xảy ra, vui lòng thử lại');
    } finally {
      setSubmitLoading(false);
    }
  };

  const handleLogout = () => {
    logout();
    localStorage.removeItem('userRole');
  };

  const getUserRole = () => {
    const role = localStorage.getItem('userRole');
    return role === 'admin' ? 'Quản trị viên' : 'Khách hàng';
  };

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // NẾU ĐÃ ĐĂNG NHẬP - HIỂN THỊ THÔNG TIN TÀI KHOẢN
  // ═══════════════════════════════════════════════════════════════════════════
  if (isAuthenticated && user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
        <div className="max-w-2xl mx-auto">
          <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
            {/* Header với avatar */}
            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-8 py-10 text-center">
              <div className="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center text-3xl font-bold text-blue-600 shadow-lg">
                {getDisplayName().charAt(0).toUpperCase()}
              </div>
              <h2 className="mt-4 text-2xl font-bold text-white">
                {getDisplayName()}
              </h2>
              <p className="mt-1 text-blue-100">{user.email}</p>
              <span className="inline-block mt-3 px-4 py-1 bg-white/20 rounded-full text-sm text-white">
                {getUserRole()}
              </span>
            </div>

            {/* Thông tin chi tiết */}
            <div className="p-8">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                Thông tin tài khoản
              </h3>

              <div className="space-y-4">
                <div className="flex items-center justify-between py-3 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <Mail className="w-5 h-5 text-gray-400" />
                    <span className="text-gray-600">Email</span>
                  </div>
                  <span className="text-gray-900 font-medium">{user.email}</span>
                </div>

                <div className="flex items-center justify-between py-3 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <User className="w-5 h-5 text-gray-400" />
                    <span className="text-gray-600">Họ và tên</span>
                  </div>
                  <span className="text-gray-900 font-medium">{getDisplayName()}</span>
                </div>

                {user.phone && (
                  <div className="flex items-center justify-between py-3 border-b border-gray-100">
                    <div className="flex items-center gap-3">
                      <span className="text-gray-400">📱</span>
                      <span className="text-gray-600">Số điện thoại</span>
                    </div>
                    <span className="text-gray-900 font-medium">{user.phone}</span>
                  </div>
                )}

                <div className="flex items-center justify-between py-3 border-b border-gray-100">
                  <div className="flex items-center gap-3">
                    <Settings className="w-5 h-5 text-gray-400" />
                    <span className="text-gray-600">Vai trò</span>
                  </div>
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                    user.role === 'admin' || user.is_admin
                      ? 'bg-purple-100 text-purple-700' 
                      : 'bg-green-100 text-green-700'
                  }`}>
                    {getUserRole()}
                  </span>
                </div>
              </div>

              {/* Action buttons */}
              <div className="mt-8 grid grid-cols-2 gap-4">
                <Link
                  href="/account"
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition font-medium"
                >
                  <Edit className="w-5 h-5" />
                  Chỉnh sửa
                </Link>

                <Link
                  href="/orders"
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition font-medium"
                >
                  <ShoppingBag className="w-5 h-5" />
                  Đơn hàng
                </Link>

                <Link
                  href="/wishlist"
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-pink-50 text-pink-600 rounded-lg hover:bg-pink-100 transition font-medium"
                >
                  <Heart className="w-5 h-5" />
                  Yêu thích
                </Link>

                <button
                  onClick={handleLogout}
                  className="flex items-center justify-center gap-2 px-4 py-3 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition font-medium"
                >
                  <LogOut className="w-5 h-5" />
                  Đăng xuất
                </button>
              </div>

              {(user.role === 'admin' || user.is_admin) && (
                <Link
                  href="/admin"
                  className="mt-4 w-full flex items-center justify-center gap-2 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium"
                >
                  <Settings className="w-5 h-5" />
                  Trang quản trị
                </Link>
              )}
            </div>
          </div>

          <div className="mt-6 text-center">
            <Link href="/shop" className="text-blue-600 hover:text-blue-700 font-medium">
              ← Tiếp tục mua sắm
            </Link>
          </div>
        </div>
      </div>
    );
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // CHƯA ĐĂNG NHẬP - HIỂN THỊ FORM ĐĂNG NHẬP
  // ═══════════════════════════════════════════════════════════════════════════
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8 bg-white p-10 rounded-2xl shadow-2xl">
        <div>
          <h2 className="text-center text-4xl font-extrabold text-gray-900">Đăng nhập</h2>
          <p className="mt-2 text-center text-sm text-gray-600">
            Hoặc{' '}
            <Link href="/register" className="font-medium text-blue-600 hover:text-blue-500">
              Tạo tài khoản mới
            </Link>
          </p>
        </div>

        {error && (
          <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded">
            <div className="flex items-center">
              <AlertCircle className="h-5 w-5 text-red-500 mr-2" />
              <p className="text-sm text-red-700">{error}</p>
            </div>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="space-y-4">
            {/* Email */}
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
                Email
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Mail className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  id="email"
                  name="email"
                  type="email"
                  autoComplete="email"
                  required
                  value={formData.email}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900"
                  placeholder="example@email.com"
                />
              </div>
            </div>

            {/* Password */}
            <div>
              <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
                Mật khẩu
              </label>
              <div className="relative">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Lock className="h-5 w-5 text-gray-400" />
                </div>
                <input
                  id="password"
                  name="password"
                  type={showPassword ? 'text' : 'password'}
                  autoComplete="current-password"
                  required
                  value={formData.password}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900"
                  placeholder="••••••••"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute inset-y-0 right-0 pr-3 flex items-center"
                >
                  {showPassword ? (
                    <EyeOff className="h-5 w-5 text-gray-400 hover:text-gray-600" />
                  ) : (
                    <Eye className="h-5 w-5 text-gray-400 hover:text-gray-600" />
                  )}
                </button>
              </div>
            </div>
          </div>

          {/* Remember & Forgot */}
          <div className="flex items-center justify-between">
            <div className="flex items-center">
              <input
                id="remember-me"
                name="remember-me"
                type="checkbox"
                className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <label htmlFor="remember-me" className="ml-2 block text-sm text-gray-900">
                Ghi nhớ đăng nhập
              </label>
            </div>
            <div className="text-sm">
              <Link href="/forgot-password" className="font-medium text-blue-600 hover:text-blue-500">
                Quên mật khẩu?
              </Link>
            </div>
          </div>

          {/* Submit Button */}
          <div>
            <button
              type="submit"
              disabled={submitLoading}
              className={`w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white ${
                submitLoading
                  ? 'bg-blue-400 cursor-not-allowed'
                  : 'bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500'
              }`}
            >
              {submitLoading ? (
                <span className="flex items-center">
                  <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Đang xử lý...
                </span>
              ) : (
                'Đăng nhập'
              )}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}



################################################################################
## FILE 106: page.tsx
## Path: fontend/src/app/(public)/order/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { fetchMyOrders } from '@/lib/api-client';
import { Package, ArrowRight, Clock, CheckCircle, XCircle } from 'lucide-react';

interface Order {
  order_id: number;
  order_number: string;
  order_status: string;
  total_amount: number;
  created_at: string;
}

export default function OrdersPage() {
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadOrders();
  }, []);

  const loadOrders = async () => {
    setLoading(true);
    try {
      const data = await fetchMyOrders();
      setOrders(data || []);
    } catch (err) {
      console.error('Fetch orders error', err);
    } finally {
      setLoading(false);
    }
  };

  const statusBadge = (status: string) => {
    switch (status) {
      case 'pending':
        return (
          <span className="flex items-center gap-1 text-yellow-700">
            <Clock className="w-4 h-4" /> Chờ xử lý
          </span>
        );
      case 'delivered':
        return (
          <span className="flex items-center gap-1 text-green-700">
            <CheckCircle className="w-4 h-4" /> Đã giao
          </span>
        );
      case 'cancelled':
        return (
          <span className="flex items-center gap-1 text-red-700">
            <XCircle className="w-4 h-4" /> Đã hủy
          </span>
        );
      default:
        return status;
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen flex justify-center items-center">
        <div className="animate-spin h-12 w-12 border-4 border-pink-600 border-t-transparent rounded-full" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-10">
      <div className="max-w-5xl mx-auto px-4">
        <h1 className="text-2xl font-bold mb-6 flex items-center gap-2">
          <Package className="w-6 h-6 text-pink-600" />
          Đơn hàng của tôi
        </h1>

        {orders.length === 0 ? (
          <div className="bg-white p-10 rounded-xl text-center shadow">
            <p className="text-gray-500 mb-4">
              Bạn chưa có đơn hàng nào
            </p>
            <Link
              href="/shop"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-pink-700"
            >
              Mua sắm ngay
            </Link>
          </div>
        ) : (
          <div className="space-y-4">
            {orders.map((order) => (
              <div
                key={order.order_id}
                className="bg-white rounded-xl shadow p-5 flex justify-between items-center"
              >
                <div>
                  <p className="font-semibold text-lg">
                    #{order.order_number}
                  </p>
                  <p className="text-sm text-gray-500">
                    {new Date(order.created_at).toLocaleString('vi-VN')}
                  </p>
                  <div className="mt-1">
                    {statusBadge(order.order_status)}
                  </div>
                </div>

                <div className="text-right">
                  <p className="font-bold text-pink-600 text-lg">
                    {order.total_amount.toLocaleString('vi-VN')}₫
                  </p>
                  <Link
                    href={`/order/${order.order_number}`}
                    className="inline-flex items-center gap-1 text-sm text-pink-600 hover:underline mt-2"
                  >
                    Xem chi tiết <ArrowRight className="w-4 h-4" />
                  </Link>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}




################################################################################
## FILE 107: page.tsx
## Path: fontend/src/app/(public)/order/[orderNumber]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { fetchOrderByNumber } from '@/lib/api-client';
import { 
  ArrowLeft, 
  Package, 
  Truck, 
  CheckCircle, 
  Clock, 
  XCircle,
  MapPin,
  Phone,
  CreditCard,
  Calendar
} from 'lucide-react';

interface OrderItem {
  order_item_id: number;
  product_id: number;
  product_name: string;
  variant_name?: string;
  quantity: number;
  unit_price: number;
  total_price: number;
  image_url?: string;
}

interface Order {
  order_id: number;
  order_number: string;
  order_status: string;
  payment_status: string;
  payment_method: string;
  subtotal: number;
  discount_amount: number;
  shipping_fee: number;
  total_amount: number;
  tracking_number?: string;
  created_at: string;
  items: OrderItem[];
  shipping_full_name?: string;
  shipping_phone?: string;
  shipping_address?: string;
  shipping_ward?: string;
  shipping_district?: string;
  shipping_city?: string;
}

export default function OrderDetailPage() {
  const params = useParams();
  const orderNumber = params.orderNumber as string;
  
  const [order, setOrder] = useState<Order | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (orderNumber) {
      loadOrder();
    }
  }, [orderNumber]);

  const loadOrder = async () => {
    setLoading(true);
    try {
      const data = await fetchOrderByNumber(orderNumber);
      setOrder(data);
    } catch (error) {
      console.error('Load order error:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusInfo = (status: string) => {
    const statuses: Record<string, { label: string; color: string; icon: React.ReactNode }> = {
      pending: { label: 'Chờ xử lý', color: 'bg-yellow-100 text-yellow-700', icon: <Clock className="w-5 h-5" /> },
      confirmed: { label: 'Đã xác nhận', color: 'bg-blue-100 text-blue-700', icon: <CheckCircle className="w-5 h-5" /> },
      processing: { label: 'Đang chuẩn bị', color: 'bg-purple-100 text-purple-700', icon: <Package className="w-5 h-5" /> },
      shipped: { label: 'Đang giao hàng', color: 'bg-indigo-100 text-indigo-700', icon: <Truck className="w-5 h-5" /> },
      delivered: { label: 'Đã giao hàng', color: 'bg-green-100 text-green-700', icon: <CheckCircle className="w-5 h-5" /> },
      cancelled: { label: 'Đã hủy', color: 'bg-red-100 text-red-700', icon: <XCircle className="w-5 h-5" /> },
    };
    return statuses[status] || statuses.pending;
  };

  const formatPrice = (price: number) => price.toLocaleString('vi-VN') + '₫';
  const formatDate = (dateString: string) => new Date(dateString).toLocaleString('vi-VN');

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  if (!order) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">📦</div>
          <h2 className="text-2xl font-bold mb-2">Không tìm thấy đơn hàng</h2>
          <p className="text-gray-500 mb-4">Mã đơn hàng: {orderNumber}</p>
          <Link href="/" className="text-pink-600 hover:underline">
            ← Quay lại trang chủ
          </Link>
        </div>
      </div>
    );
  }

  const statusInfo = getStatusInfo(order.order_status);

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-5xl mx-auto px-4">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <div>
            <Link href="/account" className="flex items-center gap-2 text-gray-600 hover:text-pink-600 mb-2">
              <ArrowLeft className="w-4 h-4" />
              Quay lại
            </Link>
            <h1 className="text-2xl font-bold">Đơn hàng #{order.order_number}</h1>
            <p className="text-gray-500 text-sm flex items-center gap-2 mt-1">
              <Calendar className="w-4 h-4" />
              Đặt ngày: {formatDate(order.created_at)}
            </p>
          </div>
          <div className={`flex items-center gap-2 px-4 py-2 rounded-full ${statusInfo.color}`}>
            {statusInfo.icon}
            <span className="font-medium">{statusInfo.label}</span>
          </div>
        </div>

        <div className="grid lg:grid-cols-3 gap-6">
          {/* Order Items */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Package className="w-5 h-5 text-pink-600" />
                Sản phẩm đã đặt ({order.items?.length || 0})
              </h2>
              <div className="space-y-4">
                {order.items?.map((item) => (
                  <div key={item.order_item_id} className="flex gap-4 pb-4 border-b last:border-0 last:pb-0">
                    <div className="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                      <img
                        src={item.image_url || '/placeholder.png'}
                        alt={item.product_name}
                        className="w-full h-full object-cover"
                      />
                    </div>
                    <div className="flex-1">
                      <h3 className="font-medium">{item.product_name}</h3>
                      {item.variant_name && (
                        <p className="text-sm text-gray-500">Phân loại: {item.variant_name}</p>
                      )}
                      <div className="flex justify-between items-end mt-2">
                        <span className="text-sm text-gray-600">
                          {formatPrice(item.unit_price)} x {item.quantity}
                        </span>
                        <span className="font-semibold text-pink-600">{formatPrice(item.total_price)}</span>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Tracking Info */}
            {order.tracking_number && (
              <div className="bg-white rounded-2xl p-6 shadow-sm">
                <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <Truck className="w-5 h-5 text-blue-600" />
                  Theo dõi đơn hàng
                </h2>
                <div className="flex items-center gap-3 bg-blue-50 p-4 rounded-xl">
                  <Truck className="w-6 h-6 text-blue-600" />
                  <div>
                    <p className="text-sm text-gray-600">Mã vận đơn</p>
                    <p className="font-mono font-semibold">{order.tracking_number}</p>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Order Summary */}
          <div className="space-y-6">
            {/* Payment Summary */}
            <div className="bg-white rounded-2xl p-6 shadow-sm">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                <CreditCard className="w-5 h-5 text-green-600" />
                Thanh toán
              </h2>
              <div className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-gray-600">Tạm tính</span>
                  <span>{formatPrice(order.subtotal)}</span>
                </div>
                {order.discount_amount > 0 && (
                  <div className="flex justify-between text-green-600">
                    <span>Giảm giá</span>
                    <span>-{formatPrice(order.discount_amount)}</span>
                  </div>
                )}
                <div className="flex justify-between">
                  <span className="text-gray-600">Phí vận chuyển</span>
                  <span>{order.shipping_fee === 0 ? 'Miễn phí' : formatPrice(order.shipping_fee)}</span>
                </div>
                <div className="border-t pt-3 flex justify-between">
                  <span className="font-bold">Tổng cộng</span>
                  <span className="font-bold text-pink-600 text-xl">{formatPrice(order.total_amount)}</span>
                </div>
                <div className="pt-2">
                  <span className="text-sm text-gray-500">
                    Phương thức: {order.payment_method === 'cod' ? 'Thanh toán khi nhận hàng' : 
                                  order.payment_method === 'momo' ? 'Ví MoMo' : 'Chuyển khoản'}
                  </span>
                </div>
              </div>
            </div>

            {/* Shipping Address */}
            {order.shipping_full_name && (
              <div className="bg-white rounded-2xl p-6 shadow-sm">
                <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                  <MapPin className="w-5 h-5 text-purple-600" />
                  Địa chỉ giao hàng
                </h2>
                <div className="space-y-2 text-sm">
                  <p className="font-medium text-base">{order.shipping_full_name}</p>
                  <p className="flex items-center gap-2 text-gray-600">
                    <Phone className="w-4 h-4" />
                    {order.shipping_phone}
                  </p>
                  <p className="flex items-start gap-2 text-gray-600">
                    <MapPin className="w-4 h-4 mt-0.5 flex-shrink-0" />
                    <span>
                      {[
                        order.shipping_address,
                        order.shipping_ward,
                        order.shipping_district,
                        order.shipping_city
                      ].filter(Boolean).join(', ')}
                    </span>
                  </p>
                </div>
              </div>
            )}

            {/* Actions */}
            <div className="space-y-3">
              <Link
                href="/shop"
                className="block w-full text-center bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition"
              >
                Tiếp tục mua sắm
              </Link>
              <Link
                href="/contact"
                className="block w-full text-center bg-gray-100 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition"
              >
                Liên hệ hỗ trợ
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 108: page.tsx
## Path: fontend/src/app/(public)/order/success/page.tsx
################################################################################

'use client';

import React, { useState } from 'react';
import { useSearchParams } from 'next/navigation';
import Link from 'next/link';
import { CheckCircle, Package, Truck, ArrowRight, Mail, Phone, Copy, Check } from 'lucide-react';

export default function OrderSuccessPage() {
  const searchParams = useSearchParams();
  const [copied, setCopied] = useState(false);
  
  const orderNumber = searchParams.get('orderNumber') || searchParams.get('order') || 'GT' + Date.now();
  const total = searchParams.get('total');

  const handleCopyOrderNumber = () => {
    navigator.clipboard.writeText(orderNumber);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 via-white to-purple-50 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        {/* Success Animation */}
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-24 h-24 bg-green-100 rounded-full mb-6 animate-bounce">
            <CheckCircle className="w-14 h-14 text-green-600" />
          </div>
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Đặt hàng thành công! 🎉
          </h1>
          <p className="text-gray-600 text-lg">
            Cảm ơn bạn đã mua sắm tại GoatTech
          </p>
        </div>

        {/* Order Info Card */}
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-8">
          <div className="text-center mb-6 pb-6 border-b">
            <p className="text-gray-500 mb-2">Mã đơn hàng của bạn</p>
            <div className="flex items-center justify-center gap-3">
              <span className="text-2xl font-bold text-pink-600 font-mono">
                {orderNumber}
              </span>
              <button
                onClick={handleCopyOrderNumber}
                className="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition"
              >
                {copied ? (
                  <Check className="w-5 h-5 text-green-600" />
                ) : (
                  <Copy className="w-5 h-5 text-gray-500" />
                )}
              </button>
            </div>
            {total && (
              <p className="mt-4 text-lg">
                Tổng thanh toán: <span className="font-bold text-pink-600">{parseInt(total).toLocaleString('vi-VN')}₫</span>
              </p>
            )}
          </div>

          {/* Order Steps */}
          <div className="mb-6">
            <h3 className="font-semibold mb-4">Các bước tiếp theo:</h3>
            <div className="space-y-4">
              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                  <CheckCircle className="w-5 h-5 text-green-600" />
                </div>
                <div>
                  <p className="font-medium">Đơn hàng đã được xác nhận</p>
                  <p className="text-sm text-gray-500">Chúng tôi đã nhận được đơn hàng của bạn</p>
                </div>
              </div>

              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                  <Package className="w-5 h-5 text-blue-600" />
                </div>
                <div>
                  <p className="font-medium">Đang chuẩn bị hàng</p>
                  <p className="text-sm text-gray-500">Đơn hàng sẽ được đóng gói trong 1-2 ngày</p>
                </div>
              </div>

              <div className="flex items-start gap-4">
                <div className="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                  <Truck className="w-5 h-5 text-purple-600" />
                </div>
                <div>
                  <p className="font-medium">Giao hàng</p>
                  <p className="text-sm text-gray-500">Dự kiến giao trong 2-5 ngày làm việc</p>
                </div>
              </div>
            </div>
          </div>

          {/* Email Notice */}
          <div className="bg-blue-50 rounded-xl p-4 mb-6">
            <div className="flex items-start gap-3">
              <Mail className="w-5 h-5 text-blue-600 mt-0.5" />
              <div>
                <p className="text-sm font-medium text-blue-900">
                  Email xác nhận đã được gửi
                </p>
                <p className="text-sm text-blue-700">
                  Kiểm tra hộp thư của bạn để xem chi tiết đơn hàng.
                </p>
              </div>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-4">
            <Link
              href={`/order/${orderNumber}`}
              className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition"
            >
              Xem chi tiết đơn hàng
              <ArrowRight className="w-5 h-5" />
            </Link>
            <Link
              href="/shop"
              className="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-200 transition"
            >
              Tiếp tục mua sắm
            </Link>
          </div>
        </div>

        {/* Support Info */}
        <div className="bg-white rounded-2xl shadow-sm p-6 text-center">
          <h3 className="font-semibold mb-4">Cần hỗ trợ?</h3>
          <div className="flex flex-col sm:flex-row justify-center gap-6">
            <a href="tel:1900xxxx" className="flex items-center justify-center gap-2 text-gray-600 hover:text-pink-600">
              <Phone className="w-5 h-5" />
              <span>1900 xxxx</span>
            </a>
            <a href="mailto:support@goattech.vn" className="flex items-center justify-center gap-2 text-gray-600 hover:text-pink-600">
              <Mail className="w-5 h-5" />
              <span>support@goattech.vn</span>
            </a>
          </div>
        </div>

        {/* Promo Banner */}
        <div className="mt-8 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white text-center">
          <h3 className="text-xl font-bold mb-2">Giảm 10% cho đơn hàng tiếp theo!</h3>
          <p className="text-white/90 mb-4">Sử dụng mã <span className="font-mono bg-white/20 px-2 py-1 rounded">THANKYOU10</span></p>
          <Link
            href="/shop"
            className="inline-block bg-white text-pink-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition"
          >
            Mua sắm ngay
          </Link>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 109: page.tsx
## Path: fontend/src/app/(public)/payment/payment-result/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { CheckCircle, XCircle, Clock, ArrowLeft, Receipt } from 'lucide-react';
import Link from 'next/link';

interface PaymentResult {
  resultCode?: string;
  orderId?: string;
  message?: string;
  transId?: string;
  amount?: string;
}

const PaymentResultPage: React.FC = () => {
  const searchParams = useSearchParams();
  const router = useRouter();
  const [result, setResult] = useState<PaymentResult>({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const resultCode = searchParams.get('resultCode');
    const orderId = searchParams.get('orderId');
    const message = searchParams.get('message');
    const transId = searchParams.get('transId');
    const amount = searchParams.get('amount');

    setResult({
      resultCode: resultCode || undefined,
      orderId: orderId || undefined,
      message: message || undefined,
      transId: transId || undefined,
      amount: amount || undefined,
    });
    setLoading(false);
  }, [searchParams]);

  const isSuccess = result.resultCode === '0';
  const isPending = result.resultCode === '9000';
  const isFailed = result.resultCode && result.resultCode !== '0' && result.resultCode !== '9000';

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        {/* Header với logo */}
        <div className="text-center mb-8">
          <Link href="/" className="inline-flex items-center gap-2 text-3xl font-bold">
            <span className="bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
              Goat
            </span>
            <span className="text-gray-800">Tech</span>
          </Link>
        </div>

        {/* Card kết quả */}
        <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12">
          {/* Icon trạng thái */}
          <div className="text-center mb-6">
            {isSuccess && (
              <div className="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                <CheckCircle className="w-12 h-12 text-green-600" />
              </div>
            )}
            {isPending && (
              <div className="inline-flex items-center justify-center w-20 h-20 bg-yellow-100 rounded-full mb-4">
                <Clock className="w-12 h-12 text-yellow-600" />
              </div>
            )}
            {isFailed && (
              <div className="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-4">
                <XCircle className="w-12 h-12 text-red-600" />
              </div>
            )}
          </div>

          {/* Tiêu đề */}
          <h1 className="text-3xl font-bold text-center mb-2">
            {isSuccess && <span className="text-green-600">Thanh Toán Thành Công!</span>}
            {isPending && <span className="text-yellow-600">Đang Xử Lý</span>}
            {isFailed && <span className="text-red-600">Thanh Toán Thất Bại</span>}
          </h1>

          {/* Thông báo */}
          <p className="text-gray-600 text-center mb-8">
            {isSuccess && 'Cảm ơn bạn đã mua hàng tại GoatTech. Đơn hàng của bạn đã được xác nhận.'}
            {isPending && 'Giao dịch đang được xử lý. Vui lòng đợi trong giây lát.'}
            {isFailed && result.message || 'Giao dịch không thành công. Vui lòng thử lại.'}
          </p>

          {/* Thông tin chi tiết */}
          <div className="bg-gray-50 rounded-xl p-6 mb-8 space-y-4">
            <div className="flex items-center gap-2 text-gray-600 mb-4">
              <Receipt className="w-5 h-5" />
              <span className="font-semibold">Chi Tiết Giao Dịch</span>
            </div>

            {result.orderId && (
              <div className="flex justify-between items-center py-2 border-b border-gray-200">
                <span className="text-gray-600">Mã đơn hàng:</span>
                <span className="font-semibold text-gray-800">{result.orderId}</span>
              </div>
            )}

            {result.transId && (
              <div className="flex justify-between items-center py-2 border-b border-gray-200">
                <span className="text-gray-600">Mã giao dịch:</span>
                <span className="font-semibold text-gray-800">{result.transId}</span>
              </div>
            )}

            {result.amount && (
              <div className="flex justify-between items-center py-2 border-b border-gray-200">
                <span className="text-gray-600">Số tiền:</span>
                <span className="font-semibold text-pink-600 text-lg">
                  {Number(result.amount).toLocaleString('vi-VN')}₫
                </span>
              </div>
            )}

            <div className="flex justify-between items-center py-2">
              <span className="text-gray-600">Trạng thái:</span>
              <span className={`font-semibold ${
                isSuccess ? 'text-green-600' : 
                isPending ? 'text-yellow-600' : 
                'text-red-600'
              }`}>
                {isSuccess && 'Thành công'}
                {isPending && 'Đang xử lý'}
                {isFailed && 'Thất bại'}
              </span>
            </div>
          </div>

          {/* Nút hành động */}
          <div className="flex flex-col sm:flex-row gap-4">
            <Link 
              href="/"
              className="flex-1 flex items-center justify-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 px-6 rounded-xl hover:from-pink-700 hover:to-purple-700 transition font-medium"
            >
              <ArrowLeft className="w-5 h-5" />
              Về Trang Chủ
            </Link>
            
            {isSuccess && (
              <Link 
                href="/account"
                className="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-800 py-3 px-6 rounded-xl hover:bg-gray-200 transition font-medium"
              >
                Xem Đơn Hàng
              </Link>
            )}

            {isFailed && (
              <button 
                onClick={() => router.back()}
                className="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-gray-800 py-3 px-6 rounded-xl hover:bg-gray-200 transition font-medium"
              >
                Thử Lại
              </button>
            )}
          </div>

          {/* Lưu ý */}
          {isSuccess && (
            <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
              <p className="text-sm text-blue-800">
                <strong>Lưu ý:</strong> Thông tin đơn hàng đã được gửi đến email của bạn. 
                Vui lòng kiểm tra hộp thư và cả thư mục spam.
              </p>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="text-center mt-8 text-gray-600 text-sm">
          <p>Cần hỗ trợ? Liên hệ: <a href="mailto:support@goattech.com" className="text-pink-600 hover:underline">support@goattech.com</a></p>
          <p className="mt-1">Hotline: <a href="tel:1900xxxx" className="text-pink-600 hover:underline">1900 xxxx</a></p>
        </div>
      </div>
    </div>
  );
};

export default PaymentResultPage;




################################################################################
## FILE 110: page.tsx
## Path: fontend/src/app/(public)/payment/payment-test/page.tsx
################################################################################

'use client';

import { useState } from 'react';
import { createMomoPayment, checkMomoPaymentStatus } from '@/lib/api-client';
import { CreditCard, DollarSign, FileText, Search } from 'lucide-react';

export default function PaymentTest() {
  const [amount, setAmount] = useState('50000');
  const [orderInfo, setOrderInfo] = useState('Thanh toán đơn hàng GoatTech');
  const [loading, setLoading] = useState(false);
  const [response, setResponse] = useState<any>(null);
  const [error, setError] = useState<string | null>(null);
  
  // Check status
  const [checkOrderId, setCheckOrderId] = useState('');
  const [checkLoading, setCheckLoading] = useState(false);
  const [checkResponse, setCheckResponse] = useState<any>(null);

  const handlePayment = async () => {
    setLoading(true);
    setError(null);
    setResponse(null);

    try {
      const result = await createMomoPayment({
        amount,
        orderInfo,
      });
      
      setResponse(result);
      console.log('✅ Payment Created:', result);
      
      // Nếu có payUrl, tự động chuyển hướng
      if (result?.data?.payUrl) {
        setTimeout(() => {
          window.open(result.data.payUrl, '_blank');
        }, 1000);
      }
    } catch (err: any) {
      setError(err.response?.data?.message || err.message || 'Lỗi khi tạo thanh toán');
      console.error('❌ Payment Error:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleCheckStatus = async () => {
    if (!checkOrderId.trim()) {
      alert('Vui lòng nhập Order ID');
      return;
    }

    setCheckLoading(true);
    setCheckResponse(null);

    try {
      const result = await checkMomoPaymentStatus(checkOrderId);
      setCheckResponse(result);
      console.log('📊 Status:', result);
    } catch (err: any) {
      console.error('❌ Check Status Error:', err);
      setCheckResponse({ error: err.message });
    } finally {
      setCheckLoading(false);
    }
  };

  return (
    <main className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-4xl font-bold text-center mb-8 bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
          Test Thanh Toán MoMo
        </h1>

        <div className="grid md:grid-cols-2 gap-6">
          {/* Card tạo thanh toán */}
          <div className="bg-white rounded-2xl shadow-xl p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="p-3 bg-pink-100 rounded-xl">
                <CreditCard className="w-6 h-6 text-pink-600" />
              </div>
              <h2 className="text-2xl font-bold text-gray-800">Tạo Thanh Toán</h2>
            </div>

            {/* Nhập số tiền */}
            <div className="mb-4">
              <label className="flex items-center gap-2 text-sm font-medium mb-2 text-gray-700">
                <DollarSign className="w-4 h-4" />
                Số tiền (VND)
              </label>
              <input
                type="text"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none transition"
                placeholder="50000"
              />
            </div>

            {/* Nhập mô tả đơn hàng */}
            <div className="mb-6">
              <label className="flex items-center gap-2 text-sm font-medium mb-2 text-gray-700">
                <FileText className="w-4 h-4" />
                Mô tả đơn hàng
              </label>
              <input
                type="text"
                value={orderInfo}
                onChange={(e) => setOrderInfo(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none transition"
                placeholder="Thanh toán đơn hàng GoatTech"
              />
            </div>

            {/* Nút thanh toán */}
            <button
              onClick={handlePayment}
              disabled={loading}
              className="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg"
            >
              {loading ? '⏳ Đang xử lý...' : '💳 Tạo Thanh Toán MoMo'}
            </button>

            {/* Hiển thị lỗi */}
            {error && (
              <div className="mt-4 p-4 bg-red-50 border-2 border-red-200 text-red-700 rounded-xl">
                <strong>❌ Lỗi:</strong> {error}
              </div>
            )}

            {/* Hiển thị kết quả */}
            {response && (
              <div className="mt-4 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
                <strong className="text-green-700">✅ Thành công!</strong>
                {response.data?.payUrl && (
                  <div className="mt-3">
                    <a 
                      href={response.data.payUrl} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="inline-block bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                    >
                      🔗 Mở Link Thanh Toán
                    </a>
                  </div>
                )}
                <details className="mt-3">
                  <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                    Xem chi tiết
                  </summary>
                  <pre className="mt-2 text-xs overflow-auto bg-gray-100 p-2 rounded">
                    {JSON.stringify(response, null, 2)}
                  </pre>
                </details>
              </div>
            )}
          </div>

          {/* Card kiểm tra trạng thái */}
          <div className="bg-white rounded-2xl shadow-xl p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="p-3 bg-blue-100 rounded-xl">
                <Search className="w-6 h-6 text-blue-600" />
              </div>
              <h2 className="text-2xl font-bold text-gray-800">Kiểm Tra Trạng Thái</h2>
            </div>

            <div className="mb-4">
              <label className="block text-sm font-medium mb-2 text-gray-700">
                Order ID
              </label>
              <input
                type="text"
                value={checkOrderId}
                onChange={(e) => setCheckOrderId(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none transition"
                placeholder="MOMO1234567890"
              />
            </div>

            <button
              onClick={handleCheckStatus}
              disabled={checkLoading}
              className="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg"
            >
              {checkLoading ? '⏳ Đang kiểm tra...' : '🔍 Kiểm Tra Trạng Thái'}
            </button>

            {/* Hiển thị kết quả kiểm tra */}
            {checkResponse && (
              <div className={`mt-4 p-4 rounded-xl border-2 ${
                checkResponse.error 
                  ? 'bg-red-50 border-red-200' 
                  : 'bg-blue-50 border-blue-200'
              }`}>
                {checkResponse.error ? (
                  <div className="text-red-700">
                    <strong>❌ Lỗi:</strong> {checkResponse.error}
                  </div>
                ) : (
                  <>
                    <strong className="text-blue-700">📊 Kết quả:</strong>
                    {checkResponse.data?.resultCode === 0 && (
                      <div className="mt-2 text-green-600 font-semibold">
                        ✅ Thanh toán thành công
                      </div>
                    )}
                    <details className="mt-3">
                      <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                        Xem chi tiết
                      </summary>
                      <pre className="mt-2 text-xs overflow-auto bg-gray-100 p-2 rounded">
                        {JSON.stringify(checkResponse, null, 2)}
                      </pre>
                    </details>
                  </>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Hướng dẫn */}
        <div className="mt-8 bg-white rounded-2xl shadow-xl p-6">
          <h3 className="text-xl font-bold mb-4 text-gray-800">📖 Hướng Dẫn Test</h3>
          <div className="space-y-3 text-gray-600">
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">1.</span>
              <p>Nhập số tiền và mô tả, nhấn <strong>"Tạo Thanh Toán MoMo"</strong></p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">2.</span>
              <p>Sao chép <strong>payUrl</strong> hoặc nhấn nút "Mở Link Thanh Toán"</p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">3.</span>
              <p>Trên trang MoMo test, chọn phương thức thanh toán và xác nhận</p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">4.</span>
              <p>Sau khi thanh toán, bạn sẽ được redirect về trang kết quả</p>
            </div>
            <div className="flex gap-3">
              <span className="font-bold text-pink-600">5.</span>
              <p>Sử dụng <strong>Order ID</strong> để kiểm tra trạng thái thanh toán</p>
            </div>
          </div>
          
          <div className="mt-6 p-4 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
            <p className="text-sm text-yellow-800">
              <strong>⚠️ Lưu ý:</strong> Đây là môi trường test của MoMo. 
              Sử dụng thông tin test được cung cấp bởi MoMo để thanh toán.
            </p>
          </div>
        </div>
      </div>
    </main>
  );
}




################################################################################
## FILE 111: page.tsx
## Path: fontend/src/app/(public)/register/page.tsx
################################################################################

'use client';

import React, { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Mail, Lock, User, Phone, Eye, EyeOff, AlertCircle, CheckCircle } from 'lucide-react';
import { registerCustomer } from '@/lib/api-client';

export default function RegisterPage() {
  const router = useRouter();
  const [formData, setFormData] = useState({
    email: '',
    password: '',
    confirmPassword: '',
    first_name: '',
    last_name: '',
    phone: '',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [agreed, setAgreed] = useState(false);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
    setError('');
  };

  const validateForm = () => {
    if (!formData.email || !formData.password || !formData.confirmPassword) {
      setError('Vui lòng điền đầy đủ thông tin bắt buộc');
      return false;
    }
    if (!formData.email.includes('@')) {
      setError('Email không hợp lệ');
      return false;
    }
    if (formData.password.length < 6) {
      setError('Mật khẩu phải có ít nhất 6 ký tự');
      return false;
    }
    if (formData.password !== formData.confirmPassword) {
      setError('Mật khẩu xác nhận không khớp');
      return false;
    }
    if (!agreed) {
      setError('Vui lòng đồng ý với điều khoản sử dụng');
      return false;
    }
    return true;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!validateForm()) return;

    setLoading(true);
    try {
      const result = await registerCustomer({
        email: formData.email,
        password: formData.password,
        full_name: `${formData.last_name} ${formData.first_name}`.trim(),
        phone: formData.phone,
      });

      if (result.success) {
        alert('Đăng ký thành công! Vui lòng đăng nhập.');
        router.push('/login');
      } else {
        setError(result.message || 'Đăng ký thất bại');
      }
    } catch (err: any) {
      setError('Có lỗi xảy ra, vui lòng thử lại');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center py-12 px-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <Link href="/" className="inline-flex items-center gap-2 text-3xl font-bold">
            <span className="bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">Goat</span>
            <span className="text-gray-800">Tech</span>
          </Link>
        </div>

        <div className="bg-white rounded-2xl shadow-xl p-8">
          <h2 className="text-2xl font-bold text-center mb-2">Tạo tài khoản mới</h2>
          <p className="text-gray-500 text-center mb-8">Đăng ký để nhận nhiều ưu đãi hấp dẫn</p>

          {error && (
            <div className="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded">
              <div className="flex items-center">
                <AlertCircle className="h-5 w-5 text-red-500 mr-2" />
                <p className="text-sm text-red-700">{error}</p>
              </div>
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-5">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Họ</label>
                <input
                  type="text"
                  name="last_name"
                  value={formData.last_name}
                  onChange={handleChange}
                  className="block w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Nguyễn"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Tên</label>
                <input
                  type="text"
                  name="first_name"
                  value={formData.first_name}
                  onChange={handleChange}
                  className="block w-full px-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Văn A"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="email"
                  name="email"
                  value={formData.email}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="email@example.com"
                  required
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Số điện thoại</label>
              <div className="relative">
                <Phone className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="tel"
                  name="phone"
                  value={formData.phone}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="0901234567"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Mật khẩu *</label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type={showPassword ? 'text' : 'password'}
                  name="password"
                  value={formData.password}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-10 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Tối thiểu 6 ký tự"
                  required
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2"
                >
                  {showPassword ? <EyeOff className="h-5 w-5 text-gray-400" /> : <Eye className="h-5 w-5 text-gray-400" />}
                </button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Xác nhận mật khẩu *</label>
              <div className="relative">
                <Lock className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" />
                <input
                  type="password"
                  name="confirmPassword"
                  value={formData.confirmPassword}
                  onChange={handleChange}
                  className="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                  placeholder="Nhập lại mật khẩu"
                  required
                />
              </div>
              {formData.confirmPassword && formData.password === formData.confirmPassword && (
                <p className="text-xs text-green-600 mt-1 flex items-center gap-1">
                  <CheckCircle className="w-3 h-3" /> Mật khẩu khớp
                </p>
              )}
            </div>

            <div className="flex items-start gap-3">
              <input
                type="checkbox"
                id="agree"
                checked={agreed}
                onChange={(e) => setAgreed(e.target.checked)}
                className="mt-1 h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded"
              />
              <label htmlFor="agree" className="text-sm text-gray-600">
                Tôi đồng ý với <Link href="/terms" className="text-pink-600 hover:underline">Điều khoản sử dụng</Link> và <Link href="/privacy" className="text-pink-600 hover:underline">Chính sách bảo mật</Link>
              </label>
            </div>

            <button
              type="submit"
              disabled={loading}
              className="w-full bg-gradient-to-r from-pink-600 to-purple-600 text-white py-3 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition disabled:opacity-50"
            >
              {loading ? 'Đang xử lý...' : 'Đăng ký'}
            </button>
          </form>

          <p className="mt-6 text-center text-gray-600">
            Đã có tài khoản? <Link href="/login" className="text-pink-600 font-medium hover:underline">Đăng nhập ngay</Link>
          </p>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 112: page.tsx
## Path: fontend/src/app/(public)/search/page.tsx
################################################################################





################################################################################
## FILE 113: page.tsx
## Path: fontend/src/app/(public)/shop/page.tsx
################################################################################

'use client';

import { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import {
  Heart,
  Star,
  Filter,
  X,
  ShoppingCart,
} from 'lucide-react';

import { fetchProducts, fetchCategoriesWithCount, createMomoPayment } from '@/lib/api-client';
import { AddToCartButton } from '@/components/products/AddToCartButton';
import { useCart } from '@/app/context/cart-context';
import { useWishlist } from '@/app/context/wishlist-context';
import { useAuth } from '@/contexts/AuthContext';

/* ===================== TYPES ===================== */
interface Product {
  id: number;
  name: string;
  price: number;
  // image: string;
  image_url: string;
  rating: number;
  reviews: number;
  tag?: string;
  category: string;
  categoryId: number;
}

interface Category {
  category_id: number;
  category_name: string;
  product_count: number;
}

interface CartItem extends Product {
  quantity: number;
}

/* ===================== PAGE ===================== */
export default function ShopPage() {
  /* ---------- State ---------- */
  const [products, setProducts] = useState<Product[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [loading, setLoading] = useState(true);

  const [isCartOpen, setIsCartOpen] = useState(false);
  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [checkoutLoading, setCheckoutLoading] = useState(false);

  const [isFilterOpen, setIsFilterOpen] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState('Tất Cả');
  const [sortBy, setSortBy] = useState<'newest' | 'price-low' | 'price-high' | 'rating'>('newest');
  const [priceRange, setPriceRange] = useState<[number, number]>([0, 9_999_999]);

  const { refreshCart } = useCart();
  const { isWished, toggleWishlist } = useWishlist();
  const { isAuthenticated } = useAuth();
  const router = useRouter();

  /* ---------- Fetch products & categories ---------- */
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true);
        
        // Fetch categories từ API
        const catData = await fetchCategoriesWithCount();
        if (Array.isArray(catData)) {
          setCategories(catData);
        }
        
        // Fetch products
        const data = await fetchProducts(10000);
        console.log('SHOP PRODUCT SAMPLE:', data[0]);

        const mapped: Product[] = data.map((p: any, index: number) => ({
          id: p.product_id || p.id || index + 1,
          name: p.product_name || p.name || 'Sản phẩm',
          price: p.price || 0,
          image_url:
            p.image_url ||
            p.image ||
            'https://res.cloudinary.com/ddaryoz5b/image/upload/v1766113075/510K2ioasAL._AC_UY436_FMwebp_QL65__eavdxx.webp',
          rating: p.rating || 4.5,
          reviews: p.reviews || 0,
          tag: p.is_new ? 'MỚI' : p.is_featured ? 'NỔI BẬT' : undefined,
          category: p.category_name || 'Khác',
          categoryId: p.categories?.category_id ?? 0,
        }));

        setProducts(mapped);
      } catch (err) {
        console.error('Load data error:', err);
      } finally {
        setLoading(false);
      }
    };

    loadData();
  }, []);

  /* ---------- Derived data ---------- */
  const filteredProducts = useMemo(() => {
    return products
      .filter(
        p =>
          selectedCategory === 'Tất Cả' || p.category === selectedCategory,
      )
      .filter(
        p => p.price >= priceRange[0] && p.price <= priceRange[1],
      )
      .sort((a, b) => {
        switch (sortBy) {
          case 'price-low':
            return a.price - b.price;
          case 'price-high':
            return b.price - a.price;
          case 'rating':
            return b.rating - a.rating;
          default:
            return b.id - a.id;
        }
      });
  }, [products, selectedCategory, priceRange, sortBy]);

  const cartCount = cartItems.reduce((t, i) => t + i.quantity, 0);
  const cartTotal = cartItems.reduce((t, i) => t + i.price * i.quantity, 0);

  /* ---------- Handlers ---------- */
  const handleToggleWishlist = async (productId: number) => {
    // Kiểm tra đăng nhập trước
    if (!isAuthenticated) {
      if (confirm('Vui lòng đăng nhập để thêm vào danh sách yêu thích. Đi đến trang đăng nhập?')) {
        router.push('/login');
      }
      return;
    }
    await toggleWishlist(productId);
  };

  /* ===================== RENDER ===================== */
  return (
    <div className="min-h-screen bg-gray-50">
      {/* ===================== BREADCRUMB ===================== */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-4 text-sm text-gray-600 flex gap-2">
          <Link href="/" className="hover:text-pink-600">
            Trang Chủ
          </Link>
          <span>/</span>
          <span className="text-gray-900 font-medium">Cửa Hàng</span>
        </div>
      </div>

      {/* ===================== MAIN ===================== */}
      <div className="max-w-7xl mx-auto px-4 py-8 flex gap-8">
        {/* ---------- FILTER SIDEBAR ---------- */}
        <aside
          className={`w-full lg:w-64 ${
            isFilterOpen ? 'block' : 'hidden lg:block'
          }`}
        >
          <div className="bg-white p-6 rounded-xl shadow-sm">
            <div className="flex justify-between mb-6">
              <h2 className="font-bold">Bộ Lọc</h2>
              <button
                onClick={() => setIsFilterOpen(false)}
                className="lg:hidden"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            {/* Category */}
            <div className="mb-6">
              <h3 className="font-semibold mb-4">Loại Sản Phẩm</h3>
              
              {/* Tất cả */}
              <label className="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer">
                <input
                  type="radio"
                  checked={selectedCategory === 'Tất Cả'}
                  onChange={() => setSelectedCategory('Tất Cả')}
                />
                <span className="flex-1">Tất Cả</span>
                <span className="text-gray-400 text-sm">
                  ({products.length})
                </span>
              </label>
              
              {/* Categories từ API */}
              {categories.map(cat => (
                <label
                  key={cat.category_id}
                  className="flex items-center gap-2 p-2 rounded hover:bg-gray-50 cursor-pointer"
                >
                  <input
                    type="radio"
                    checked={selectedCategory === cat.category_name}
                    onChange={() => setSelectedCategory(cat.category_name)}
                  />
                  <span className="flex-1">{cat.category_name}</span>
                  <span className="text-gray-400 text-sm">
                    ({cat.product_count || 0})
                  </span>
                </label>
              ))}
            </div>

            {/* Sort */}
            <div>
              <h3 className="font-semibold mb-4">Sắp Xếp</h3>
              <select
                value={sortBy}
                onChange={e => setSortBy(e.target.value as any)}
                className="w-full border rounded-lg px-3 py-2"
              >
                <option value="newest">Mới Nhất</option>
                <option value="price-low">Giá Thấp → Cao</option>
                <option value="price-high">Giá Cao → Thấp</option>
                <option value="rating">Đánh Giá Cao</option>
              </select>
            </div>
          </div>
        </aside>

        {/* ---------- PRODUCTS ---------- */}
        <main className="flex-1">
          <div className="mb-6 flex justify-between lg:hidden">
            <button
              onClick={() => setIsFilterOpen(true)}
              className="flex items-center gap-2 border px-4 py-2 rounded-lg"
            >
              <Filter className="w-4 h-4" />
              Bộ Lọc
            </button>
          </div>

          <p className="text-sm text-gray-600 mb-6">
            Hiển thị{' '}
            <span className="font-semibold">{filteredProducts.length}</span> sản
            phẩm
          </p>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredProducts.map(product => (
              <Link
                key={product.id}
                href={`/product/${product.id}`}
                className="bg-white rounded-xl shadow-sm hover:shadow-lg transition overflow-hidden group"
              >
                <div className="relative">
                  {product.tag && (
                    <span className="absolute top-3 left-3 bg-red-500 text-white text-xs px-3 py-1 rounded-full">
                      {product.tag}
                    </span>
                  )}

                  <img
                    src={product.image_url}
                    alt={product.name}
                    className="w-full h-64 object-cover group-hover:scale-110 transition"
                  />

                  <button
                    onClick={e => {
                      e.preventDefault();
                      handleToggleWishlist(product.id);
                    }}
                    className="absolute bottom-3 right-3 bg-white p-2 rounded-full shadow hover:scale-110 transition"
                  >
                    <Heart
                      className={`w-5 h-5 ${
                        isWished(product.id)
                          ? 'fill-red-500 text-red-500'
                          : ''
                      }`}
                    />
                  </button>
                </div>

                <div className="p-4">
                  <span className="text-xs text-gray-500 uppercase">
                    {product.category}
                  </span>

                  <h3 className="font-semibold line-clamp-2 mb-2">
                    {product.name}
                  </h3>

                  <div className="flex items-center gap-2 mb-3">
                    <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                    <span className="text-sm">{product.rating}</span>
                    <span className="text-sm text-gray-500">
                      ({product.reviews})
                    </span>
                  </div>

                  <div className="flex justify-between items-center">
                    <span className="text-xl font-bold">
                      {product.price.toLocaleString('vi-VN')}₫
                    </span>
                    <AddToCartButton productId={product.id} />
                  </div>
                </div>
              </Link>
            ))}
          </div>

          {!loading && filteredProducts.length === 0 && (
            <div className="text-center py-12 text-gray-600">
              Không tìm thấy sản phẩm phù hợp
            </div>
          )}
        </main>
      </div>
    </div>
  );
}




################################################################################
## FILE 114: page.tsx
## Path: fontend/src/app/(public)/shop/product/[slug]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { 
  Star, Heart, ShoppingCart, Minus, Plus, 
  Truck, Shield, RotateCcw, Check, ChevronRight, Gift
} from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';

interface Product {
  product_id: number;
  product_name: string;
  product_slug: string;
  sku: string;
  description: string;
  short_description: string;
  price: number;
  sale_price: number;
  category_id: number;
  brand_id: number;
  image_url: string;
  is_featured: boolean;
  is_new: boolean;
  status: string;
  category_name?: string;
  brand_name?: string;
  images?: { image_id: number; image_url: string; is_primary: boolean }[];
  variants?: { variant_id: number; variant_name: string; price: number; stock: number }[];
  avg_rating?: number;
  review_count?: number;
}

interface Review {
  review_id: number;
  customer_id: number;
  rating: number;
  comment: string;
  created_at: string;
  customer_name?: string;
}

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

export default function ProductDetailPage() {
  const params = useParams();
  const router = useRouter();
  const slug = params.slug as string;
  const { user, isAuthenticated } = useAuth();

  const [product, setProduct] = useState<Product | null>(null);
  const [reviews, setReviews] = useState<Review[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedImage, setSelectedImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [selectedVariant, setSelectedVariant] = useState<number | null>(null);
  const [isWished, setIsWished] = useState(false);
  const [addingToCart, setAddingToCart] = useState(false);
  const [activeTab, setActiveTab] = useState<'description' | 'reviews'>('description');

  useEffect(() => {
    if (slug) {
      loadProduct();
    }
  }, [slug]);

  const loadProduct = async () => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/products/slug/${slug}`);
      if (response.ok) {
        const data = await response.json();
        setProduct(data);
      } else {
        setProduct(getSampleProduct());
        setReviews(getSampleReviews());
      }
    } catch (error) {
      setProduct(getSampleProduct());
      setReviews(getSampleReviews());
    } finally {
      setLoading(false);
    }
  };

  const getSampleProduct = (): Product => ({
    product_id: 1,
    product_name: 'Ốp lưng iPhone 15 Pro Max MagSafe trong suốt cao cấp',
    product_slug: slug,
    sku: 'IP15PM-MAGSAFE-CLEAR',
    description: `
      <h3>Đặc điểm nổi bật:</h3>
      <ul>
        <li>Chất liệu polycarbonate cao cấp, chống trầy xước</li>
        <li>Hỗ trợ sạc không dây MagSafe</li>
        <li>Thiết kế trong suốt, khoe trọn vẻ đẹp iPhone</li>
        <li>Viền chống sốc, bảo vệ góc cạnh</li>
      </ul>
    `,
    short_description: 'Ốp lưng MagSafe trong suốt cao cấp dành cho iPhone 15 Pro Max.',
    price: 350000,
    sale_price: 299000,
    category_id: 1,
    brand_id: 1,
    image_url: '/SP001.png',
    is_featured: true,
    is_new: true,
    status: 'active',
    category_name: 'Ốp iPhone',
    brand_name: 'GoatTech',
    images: [
      { image_id: 1, image_url: '/SP001.png', is_primary: true },
      { image_id: 2, image_url: '/about1.jpg', is_primary: false },
      { image_id: 3, image_url: '/about2.jpg', is_primary: false },
    ],
    variants: [
      { variant_id: 1, variant_name: 'Trong suốt', price: 299000, stock: 50 },
      { variant_id: 2, variant_name: 'Mờ (Matte)', price: 329000, stock: 30 },
    ],
    avg_rating: 4.8,
    review_count: 156,
  });

  const getSampleReviews = (): Review[] => [
    {
      review_id: 1,
      customer_id: 1,
      rating: 5,
      comment: 'Ốp rất đẹp, vừa khít máy. Chất lượng tuyệt vời!',
      created_at: '2024-12-10T10:00:00Z',
      customer_name: 'Nguyễn Văn A',
    },
    {
      review_id: 2,
      customer_id: 2,
      rating: 5,
      comment: 'Giao hàng nhanh, đóng gói cẩn thận.',
      created_at: '2024-12-08T14:30:00Z',
      customer_name: 'Trần Thị B',
    },
  ];

  const handleAddToCart = async () => {
    if (!isAuthenticated) {
      router.push('/login?redirect=' + encodeURIComponent(window.location.pathname));
      return;
    }

    setAddingToCart(true);
    try {
      // Add to cart API call here
      alert('Đã thêm vào giỏ hàng!');
    } catch (error) {
      console.error('Error adding to cart:', error);
    } finally {
      setAddingToCart(false);
    }
  };

  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN') + '₫';
  };

  const getDiscountPercent = () => {
    if (!product || !product.sale_price || product.sale_price >= product.price) return 0;
    return Math.round((1 - product.sale_price / product.price) * 100);
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  if (!product) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="text-6xl mb-4">😢</div>
          <h2 className="text-2xl font-bold mb-2">Không tìm thấy sản phẩm</h2>
          <Link href="/shop" className="text-pink-600 hover:underline">
            ← Quay lại cửa hàng
          </Link>
        </div>
      </div>
    );
  }

  const images = product.images?.length ? product.images : [{ image_id: 0, image_url: product.image_url, is_primary: true }];
  const currentPrice = product.sale_price || product.price;

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Breadcrumb */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center gap-2 text-sm text-gray-600">
            <Link href="/" className="hover:text-pink-600">Trang chủ</Link>
            <ChevronRight className="w-4 h-4" />
            <Link href="/shop" className="hover:text-pink-600">Cửa hàng</Link>
            <ChevronRight className="w-4 h-4" />
            <span className="text-gray-900 font-medium truncate max-w-[200px]">{product.product_name}</span>
          </div>
        </div>
      </div>

      {/* Product Main */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="bg-white rounded-2xl shadow-sm p-6 lg:p-8">
          <div className="grid lg:grid-cols-2 gap-8 lg:gap-12">
            {/* Images */}
            <div>
              <div className="relative aspect-square rounded-2xl overflow-hidden bg-gray-100 mb-4">
                <img
                  src={images[selectedImage]?.image_url || product.image_url}
                  alt={product.product_name}
                  className="w-full h-full object-cover"
                />
                {getDiscountPercent() > 0 && (
                  <span className="absolute top-4 left-4 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                    -{getDiscountPercent()}%
                  </span>
                )}
              </div>

              {images.length > 1 && (
                <div className="flex gap-3 overflow-x-auto pb-2">
                  {images.map((img, index) => (
                    <button
                      key={img.image_id}
                      onClick={() => setSelectedImage(index)}
                      className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition ${
                        selectedImage === index ? 'border-pink-600' : 'border-gray-200'
                      }`}
                    >
                      <img src={img.image_url} alt="" className="w-full h-full object-cover" />
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Info */}
            <div>
              <div className="mb-4">
                {product.brand_name && (
                  <span className="text-pink-600 text-sm font-medium">{product.brand_name}</span>
                )}
                <h1 className="text-2xl lg:text-3xl font-bold text-gray-900 mt-1">
                  {product.product_name}
                </h1>
                <div className="flex items-center gap-4 mt-3">
                  <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        className={`w-5 h-5 ${
                          star <= (product.avg_rating || 4.5)
                            ? 'fill-yellow-400 text-yellow-400'
                            : 'text-gray-300'
                        }`}
                      />
                    ))}
                    <span className="ml-2 text-sm text-gray-600">
                      {product.avg_rating || 4.5} ({product.review_count || reviews.length} đánh giá)
                    </span>
                  </div>
                </div>
              </div>

              {/* Price */}
              <div className="mb-6 pb-6 border-b">
                <div className="flex items-baseline gap-3">
                  <span className="text-3xl font-bold text-pink-600">
                    {formatPrice(currentPrice)}
                  </span>
                  {product.sale_price && product.sale_price < product.price && (
                    <span className="text-lg text-gray-400 line-through">
                      {formatPrice(product.price)}
                    </span>
                  )}
                </div>
              </div>

              <p className="text-gray-600 mb-6">{product.short_description}</p>

              {/* Variants */}
              {product.variants && product.variants.length > 0 && (
                <div className="mb-6">
                  <h3 className="font-semibold mb-3">Phân loại:</h3>
                  <div className="flex flex-wrap gap-3">
                    {product.variants.map((variant) => (
                      <button
                        key={variant.variant_id}
                        onClick={() => setSelectedVariant(variant.variant_id)}
                        className={`px-4 py-2 rounded-lg border-2 transition ${
                          selectedVariant === variant.variant_id
                            ? 'border-pink-600 bg-pink-50 text-pink-600'
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        {variant.variant_name}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Quantity */}
              <div className="mb-6">
                <h3 className="font-semibold mb-3">Số lượng:</h3>
                <div className="flex items-center gap-4">
                  <div className="flex items-center border rounded-lg">
                    <button
                      onClick={() => setQuantity(q => Math.max(1, q - 1))}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Minus className="w-4 h-4" />
                    </button>
                    <span className="px-6 py-3 font-semibold">{quantity}</span>
                    <button
                      onClick={() => setQuantity(q => q + 1)}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Plus className="w-4 h-4" />
                    </button>
                  </div>
                  <button
                    onClick={() => setIsWished(!isWished)}
                    className={`p-3 rounded-lg border transition ${
                      isWished ? 'bg-pink-50 border-pink-600 text-pink-600' : 'border-gray-200'
                    }`}
                  >
                    <Heart className={`w-6 h-6 ${isWished ? 'fill-pink-600' : ''}`} />
                  </button>
                </div>
              </div>

              {/* Buttons */}
              <div className="flex gap-4 mb-4">
                <button
                  onClick={handleAddToCart}
                  disabled={addingToCart}
                  className="flex-1 flex items-center justify-center gap-2 bg-white border-2 border-pink-600 text-pink-600 py-4 rounded-xl font-semibold hover:bg-pink-50 transition disabled:opacity-50"
                >
                  <ShoppingCart className="w-5 h-5" />
                  {addingToCart ? 'Đang thêm...' : 'Thêm vào giỏ'}
                </button>
                <button
                  onClick={() => { handleAddToCart(); router.push('/checkout'); }}
                  className="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition"
                >
                  Mua ngay
                </button>
              </div>

              {/* Gift Button */}
              <button
                onClick={() => router.push(`/gift/send?productId=${product.product_id}`)}
                className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-semibold hover:from-amber-600 hover:to-orange-600 transition mb-8"
              >
                <Gift className="w-5 h-5" />
                🎁 Gửi Tặng Bạn Bè
              </button>

              {/* Benefits */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl">
                <div className="flex items-center gap-3">
                  <div className="bg-green-100 p-2 rounded-full">
                    <Truck className="w-5 h-5 text-green-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Giao hàng nhanh</p>
                    <p className="text-gray-500">2-3 ngày</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-blue-100 p-2 rounded-full">
                    <Shield className="w-5 h-5 text-blue-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Bảo hành</p>
                    <p className="text-gray-500">12 tháng</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-orange-100 p-2 rounded-full">
                    <RotateCcw className="w-5 h-5 text-orange-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Đổi trả</p>
                    <p className="text-gray-500">30 ngày</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-purple-100 p-2 rounded-full">
                    <Check className="w-5 h-5 text-purple-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Chính hãng</p>
                    <p className="text-gray-500">100%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Tabs */}
        <div className="bg-white rounded-2xl shadow-sm mt-8 overflow-hidden">
          <div className="flex border-b">
            <button
              onClick={() => setActiveTab('description')}
              className={`flex-1 py-4 px-6 text-center font-semibold transition \${
                activeTab === 'description'
                  ? 'text-pink-600 border-b-2 border-pink-600'
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              Mô tả sản phẩm
            </button>
            <button
              onClick={() => setActiveTab('reviews')}
              className={`flex-1 py-4 px-6 text-center font-semibold transition \${
                activeTab === 'reviews'
                  ? 'text-pink-600 border-b-2 border-pink-600'
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              Đánh giá ({reviews.length})
            </button>
          </div>

          <div className="p-6 lg:p-8">
            {activeTab === 'description' ? (
              <div
                className="prose max-w-none"
                dangerouslySetInnerHTML={{ __html: product.description }}
              />
            ) : (
              <div className="space-y-6">
                {reviews.map((review) => (
                  <div key={review.review_id} className="border-b pb-6 last:border-0">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-10 h-10 bg-gradient-to-br from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white font-semibold">
                        {review.customer_name?.charAt(0) || 'K'}
                      </div>
                      <div>
                        <p className="font-medium">{review.customer_name || 'Khách hàng'}</p>
                        <p className="text-sm text-gray-500">
                          {new Date(review.created_at).toLocaleDateString('vi-VN')}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-1 mb-2">
                      {[1, 2, 3, 4, 5].map((star) => (
                        <Star
                          key={star}
                          className={`w-4 h-4 ${
                            star <= review.rating
                              ? 'fill-yellow-400 text-yellow-400'
                              : 'text-gray-300'
                          }`}
                        />
                      ))}
                    </div>
                    <p className="text-gray-700">{review.comment}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 115: page.tsx
## Path: fontend/src/app/(public)/shopping-cart/page.tsx
################################################################################

'use client';

import React, { useEffect, useState, useCallback } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { ShoppingCart, Trash2, Plus, Minus, ArrowLeft } from 'lucide-react';
import { useAuth } from '@/contexts/AuthContext';
import { useCart } from '@/app/context/cart-context';
import { useRouter } from 'next/navigation';
import {
  fetchShoppingCart,
  updateShoppingCart,
  deleteShoppingCart,
  clearShoppingCart,
} from '@/lib/api-client';

interface CartItem {
  cart_id: number;
  product_id: number;
  variant_id?: number;
  quantity: number;
  product_name: string;
  price: number;
  original_price?: number;
  image_url: string;
}

export default function CartPage() {
  const { user, isAuthenticated, loading: authLoading } = useAuth();
  const { refreshCart } = useCart();
  const router = useRouter();

  const [cartItems, setCartItems] = useState<CartItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [updating, setUpdating] = useState<number | null>(null);
  const [cartTotal, setCartTotal] = useState(0);
  const [itemCount, setItemCount] = useState(0);

  // Load cart
  const loadCart = useCallback(async () => {
    if (!isAuthenticated) {
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      const result = await fetchShoppingCart();

      if (result.success) {
        setCartItems(result.data || []);
        setCartTotal(result.total || 0);
        setItemCount(result.itemCount || 0);
        // Cập nhật icon giỏ hàng trên header
        await refreshCart();
      } else {
        console.error('Load cart failed:', result.message);
        setCartItems([]);
      }
    } catch (error) {
      console.error('Load cart error:', error);
      setCartItems([]);
    } finally {
      setLoading(false);
    }
  }, [isAuthenticated, refreshCart]);

  useEffect(() => {
    if (!authLoading) {
      if (!isAuthenticated) {
        // Redirect to login if not authenticated
        router.push('/login?redirect=/shopping-cart');
      } else {
        loadCart();
      }
    }
  }, [authLoading, isAuthenticated, loadCart, router]);

  // Update quantity
  const handleUpdateQuantity = async (cartId: number, newQuantity: number) => {
    if (newQuantity < 1) {
      handleRemoveItem(cartId);
      return;
    }

    setUpdating(cartId);

    try {
      const result = await updateShoppingCart(cartId, newQuantity);

      if (result.success) {
        // Reload cart to get updated totals
        await loadCart();
        // Cập nhật icon
        await refreshCart();
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Update error:', error);
      alert('Không thể cập nhật số lượng');
    } finally {
      setUpdating(null);
    }
  };

  // Remove item
  const handleRemoveItem = async (cartId: number) => {
    if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

    setUpdating(cartId);

    try {
      const result = await deleteShoppingCart(cartId);

      if (result.success) {
        await loadCart();
        // Cập nhật icon
        await refreshCart();
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Remove error:', error);
      alert('Không thể xóa sản phẩm');
    } finally {
      setUpdating(null);
    }
  };

  // Clear all
  const handleClearCart = async () => {
    if (!confirm('Xóa toàn bộ giỏ hàng?')) return;

    try {
      const result = await clearShoppingCart();

      if (result.success) {
        setCartItems([]);
        setCartTotal(0);
        setItemCount(0);
        // Cập nhật icon
        await refreshCart();
      } else {
        alert(result.message);
      }
    } catch (error) {
      console.error('Clear cart error:', error);
      alert('Không thể xóa giỏ hàng');
    }
  };

  // Format price
  const formatPrice = (price: number) => {
    return price.toLocaleString('vi-VN') + '₫';
  };

  // ═══════════════════════════════════════════════════════════════════════════
  // RENDER
  // ═══════════════════════════════════════════════════════════════════════════

  // Loading state
  if (authLoading || loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="flex flex-col items-center gap-4">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600"></div>
          <p className="text-gray-500">Đang tải giỏ hàng...</p>
        </div>
      </div>
    );
  }

  // Not authenticated
  if (!isAuthenticated) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
        <ShoppingCart className="w-16 h-16 text-gray-400 mb-4" />
        <h2 className="text-xl font-semibold text-gray-700 mb-2">
          Vui lòng đăng nhập
        </h2>
        <p className="text-gray-500 mb-6">
          Bạn cần đăng nhập để xem giỏ hàng
        </p>
        <Link
          href="/login?redirect=/shopping-cart"
          className="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg transition"
        >
          Đăng nhập ngay
        </Link>
      </div>
    );
  }

  // Empty cart
  if (cartItems.length === 0) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gray-50">
        <ShoppingCart className="w-20 h-20 text-gray-300 mb-4" />
        <h2 className="text-2xl font-semibold text-gray-700 mb-2">
          Giỏ hàng trống
        </h2>
        <p className="text-gray-500 mb-6">
          Hãy thêm sản phẩm vào giỏ hàng của bạn
        </p>
        <Link
          href="/shop"
          className="bg-pink-600 hover:bg-pink-700 text-white px-8 py-3 rounded-lg transition flex items-center gap-2"
        >
          <ArrowLeft className="w-5 h-5" />
          Tiếp tục mua sắm
        </Link>
      </div>
    );
  }

  // Cart with items
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-10">
      <div className="max-w-6xl mx-auto px-4">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <ShoppingCart className="w-8 h-8 text-pink-600" />
            Giỏ Hàng ({itemCount} sản phẩm)
          </h1>

          <button
            onClick={handleClearCart}
            className="text-red-500 hover:text-red-600 text-sm font-medium flex items-center gap-1"
          >
            <Trash2 className="w-4 h-4" />
            Xóa tất cả
          </button>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Cart Items */}
          <div className="lg:col-span-2 space-y-4">
            {cartItems.map((item) => (
              <div
                key={item.cart_id}
                className={`bg-white rounded-2xl shadow-md p-5 flex gap-4 transition ${
                  updating === item.cart_id ? 'opacity-50' : ''
                }`}
              >
                {/* Product Image */}
                <div className="w-24 h-24 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                  {item.image_url && item.image_url.startsWith('http') ? (
                    <img
                      src={item.image_url}
                      alt={item.product_name}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400 text-xs text-center p-2">
                      {item.product_name}
                    </div>
                  )}
                </div>

                {/* Product Info */}
                <div className="flex-1">
                  <h3 className="font-semibold text-gray-900 mb-1">
                    {item.product_name}
                  </h3>

                  <p className="text-pink-600 font-bold text-lg">
                    {formatPrice(item.price)}
                  </p>

                  {/* Quantity Controls */}
                  <div className="flex items-center gap-3 mt-3">
                    <button
                      onClick={() => handleUpdateQuantity(item.cart_id, item.quantity - 1)}
                      disabled={updating === item.cart_id}
                      className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 hover:bg-gray-100 disabled:opacity-50"
                    >
                      <Minus className="w-4 h-4" />
                    </button>

                    <span className="w-8 text-center font-semibold">
                      {item.quantity}
                    </span>

                    <button
                      onClick={() => handleUpdateQuantity(item.cart_id, item.quantity + 1)}
                      disabled={updating === item.cart_id}
                      className="w-8 h-8 flex items-center justify-center rounded-full border border-gray-300 hover:bg-gray-100 disabled:opacity-50"
                    >
                      <Plus className="w-4 h-4" />
                    </button>

                    <button
                      onClick={() => handleRemoveItem(item.cart_id)}
                      disabled={updating === item.cart_id}
                      className="ml-4 text-red-500 hover:text-red-600"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>
                </div>

                {/* Item Total */}
                <div className="text-right">
                  <p className="text-lg font-bold text-gray-900">
                    {formatPrice(item.price * item.quantity)}
                  </p>
                </div>
              </div>
            ))}
          </div>

          {/* Order Summary */}
          <div className="lg:col-span-1">
            <div className="bg-white rounded-2xl shadow-md p-6 sticky top-4">
              <h2 className="text-xl font-bold text-gray-800 mb-6">
                Tóm tắt đơn hàng
              </h2>

              <div className="space-y-3 mb-6">
                <div className="flex justify-between text-gray-600">
                  <span>Tạm tính ({itemCount} sản phẩm)</span>
                  <span>{formatPrice(cartTotal)}</span>
                </div>
                <div className="flex justify-between text-gray-600">
                  <span>Phí vận chuyển</span>
                  <span className="text-green-600">Miễn phí</span>
                </div>
                <hr />
                <div className="flex justify-between text-xl font-bold">
                  <span>Tổng cộng</span>
                  <span className="text-pink-600">{formatPrice(cartTotal)}</span>
                </div>
              </div>

              <Link
                href="/checkout"
                className="w-full bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white py-4 rounded-xl font-semibold text-center block transition"
              >
                💳 Tiến hành thanh toán
              </Link>

              <Link
                href="/shop"
                className="w-full mt-3 border border-gray-300 text-gray-700 py-3 rounded-xl font-medium text-center block hover:bg-gray-50 transition"
              >
                ← Tiếp tục mua sắm
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 116: page.tsx
## Path: fontend/src/app/(public)/wishlist/page.tsx
################################################################################

'use client';

import React, { useEffect, useState } from 'react';
import Link from 'next/link';
import { Heart, Trash2, Star, ArrowLeft } from 'lucide-react';
import { useWishlist } from '@/app/context/wishlist-context';
import { AddToCartButton } from '@/components/products/AddToCartButton';
import { fetchProductById } from '@/lib/api-client';

interface Product {
  product_id: number;
  product_name: string;
  price: number;
  sale_price?: number;
  image_url: string;
  description?: string;
}

export default function WishlistPage() {
  const { wishedProducts, loading, toggleWishlist, wishlistCount, refreshWishlist } = useWishlist();
  const [products, setProducts] = useState<Product[]>([]);
  const [loadingProducts, setLoadingProducts] = useState(false);

  // Fetch thông tin sản phẩm khi wishedProducts thay đổi
  useEffect(() => {
    const loadProducts = async () => {
      if (wishedProducts.size === 0) {
        setProducts([]);
        return;
      }

      setLoadingProducts(true);
      try {
        const productIds = Array.from(wishedProducts);
        const productPromises = productIds.map(id => fetchProductById(id));
        const results = await Promise.all(productPromises);
        
        // Lọc những sản phẩm fetch thành công
        const validProducts = results.filter(p => p && p.product_id);
        setProducts(validProducts);
      } catch (error) {
        console.error('Load products error:', error);
      } finally {
        setLoadingProducts(false);
      }
    };

    loadProducts();
  }, [wishedProducts]);

  const formatPrice = (price: number) => price?.toLocaleString('vi-VN') + '₫';

  const handleRemove = async (productId: number) => {
    await toggleWishlist(productId);
  };

  if (loading || loadingProducts) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-7xl mx-auto px-4">
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
              <Heart className="w-8 h-8 text-pink-600 fill-pink-600" />
              Sản phẩm yêu thích
            </h1>
            <p className="text-gray-500 mt-1">{wishlistCount} sản phẩm</p>
          </div>
          <Link href="/shop" className="text-pink-600 hover:underline flex items-center gap-1">
            <ArrowLeft className="w-4 h-4" />
            Tiếp tục mua sắm
          </Link>
        </div>

        {products.length === 0 ? (
          <div className="bg-white rounded-2xl shadow-sm p-12 text-center">
            <Heart className="w-24 h-24 text-gray-300 mx-auto mb-6" />
            <h2 className="text-2xl font-bold mb-4">Chưa có sản phẩm yêu thích</h2>
            <p className="text-gray-500 mb-8">
              Hãy thêm sản phẩm vào danh sách yêu thích để dễ dàng theo dõi!
            </p>
            <Link
              href="/shop"
              className="inline-flex items-center gap-2 bg-gradient-to-r from-pink-600 to-purple-600 text-white px-8 py-3 rounded-full font-semibold hover:from-pink-700 hover:to-purple-700 transition"
            >
              Khám phá sản phẩm
            </Link>
          </div>
        ) : (
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {products.map((product) => (
              <div
                key={product.product_id}
                className="bg-white rounded-xl overflow-hidden shadow-sm hover:shadow-lg transition group"
              >
                <div className="relative">
                  <Link href={`/product/${product.product_id}`}>
                    <img
                      src={product.image_url || 'https://i.pinimg.com/1200x/f4/0a/de/f40ade8f15c8354c5eb584af2b1ebd82.jpg'}
                      alt={product.product_name}
                      className="w-full h-56 object-cover group-hover:scale-105 transition duration-300"
                    />
                  </Link>

                  <button
                    onClick={() => handleRemove(product.product_id)}
                    className="absolute top-3 right-3 bg-white p-2 rounded-full shadow opacity-0 group-hover:opacity-100 transition hover:bg-red-50"
                    title="Xóa khỏi yêu thích"
                  >
                    <Trash2 className="w-5 h-5 text-red-500" />
                  </button>
                </div>

                <div className="p-4">
                  <Link href={`/product/${product.product_id}`}>
                    <h3 className="font-semibold line-clamp-2 mb-2 hover:text-pink-600 transition">
                      {product.product_name}
                    </h3>
                  </Link>

                  <div className="flex items-center gap-1 mb-3">
                    <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                    <span className="text-sm">4.5</span>
                    <span className="text-sm text-gray-500">(0)</span>
                  </div>

                  <div className="flex items-center justify-between">
                    <span className="text-lg font-bold text-pink-600">
                      {formatPrice(product.sale_price || product.price)}
                    </span>
                    <AddToCartButton productId={product.product_id} />
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}




################################################################################
## FILE 117: page.tsx
## Path: fontend/src/app/account/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu } from 'lucide-react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { fetchCategories, loginCustomer } from '@/lib/api-client';

const AccountPage: React.FC = () => {
  const router = useRouter();
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    
    try {
      const result = await loginCustomer(email, password);
      
      if (result.success) {
        // Lưu thông tin user vào localStorage
        const user = result.customer || result.user;
        localStorage.setItem('customer', JSON.stringify(user));
        
        // Kiểm tra role admin
        const isAdmin = result.role === 'admin' || 
                        user?.role === 'admin' || 
                        user?.email?.toLowerCase().includes('admin');
        
        localStorage.setItem('userRole', isAdmin ? 'admin' : 'customer');
        
        // Hiển thị thông báo
        alert(`Đăng nhập thành công với: ${email}`);
        
        // Redirect dựa trên role
        if (isAdmin) {
          router.push('/admin');
        } else {
          router.push('/');
        }
      } else {
        alert(result.message || 'Đăng nhập thất bại. Vui lòng kiểm tra lại email và mật khẩu.');
      }
    } catch (error: any) {
      alert(error.response?.data?.message || 'Có lỗi xảy ra, vui lòng thử lại');
    }
  };

  const handleCreateAccount = () => {
    window.location.href = '/register';
  };

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
          onClick={() => setIsCurrencyModalOpen(false)}
        >
          <div
            className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-xl border border-slate-200"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold text-slate-900">
                CHỌN LOẠI TIỀN TỆ
              </h2>
              <button
                onClick={() => setIsCurrencyModalOpen(false)}
                className="text-slate-500 hover:text-slate-700"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-slate-700">
                QUỐC GIA/KHU VỰC:
              </label>
              <select
                className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Việt Nam (VND ₫)</option>
              </select>
            </div>

            <button
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-pink-600 text-white py-3 rounded-lg font-semibold hover:bg-pink-700 transition"
            >
              ÁP DỤNG
            </button>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-slate-900 text-white py-2 px-4 text-center text-sm">
        <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
          <span>Miễn phí vận chuyển cho đơn hàng trên 100K</span>
          <span className="hidden md:inline">|</span>
          <span className="hidden md:inline">
            Ưu đãi GoatTech: Mua 4 ốp - Trả tiền 2 ốp
          </span>
        </div>
      </div>

      {/* Header */}
    <header className="bg-slate-900 shadow-md sticky top-0 z-40">
      <div className="max-w-7xl mx-auto px-4 py-4">
        <div className="flex items-center justify-between gap-4">
          <div className="flex items-center gap-4">
            <button className="lg:hidden text-slate-200 hover:text-pink-400">
              <Menu className="w-6 h-6" />
            </button>
            <button className="lg:hidden text-slate-200 hover:text-pink-400">
              <Search className="w-6 h-6" />
            </button>
          </div>

          <Link
            href="/"
            className="text-2xl font-bold tracking-wider text-white hover:text-pink-400 transition"
          >
            GoatTech
          </Link>

          <div className="flex items-center gap-4">
            <button
              className="hidden lg:block px-4 py-2 text-sm font-medium border border-slate-600 text-slate-200 rounded-lg hover:border-pink-500 hover:text-pink-400 transition"
              onClick={() => setIsCurrencyModalOpen(true)}
            >
              🌍 {selectedCurrency} {selectedCurrency === 'USD' ? '$' : '₫'}
            </button>

            <select
              value={selectedDevice}
              onChange={(e) => setSelectedDevice(e.target.value)}
              className="hidden lg:block px-4 py-2 border border-slate-600 bg-slate-900 text-slate-200 rounded-lg text-sm focus:outline-none focus:border-pink-500"
            >
              {devices.map((device) => (
                <option key={device} value={device} className="text-black">
                  {device}
                </option>
              ))}
            </select>

            <button className="relative text-slate-200 hover:text-pink-400 transition">
              <Heart className="w-6 h-6" />
              {wishlistCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-emerald-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                  {wishlistCount}
                </span>
              )}
            </button>

            <button className="text-slate-200 hover:text-pink-400 transition">
              <User className="w-6 h-6" />
            </button>

            <button className="relative text-slate-200 hover:text-pink-400 transition">
              <ShoppingCart className="w-6 h-6" />
              {cartCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-pink-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                  {cartCount}
                </span>
              )}
            </button>
          </div>
        </div>

        {/* Desktop Navigation */}
        <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t border-slate-700">
          <Link href="/" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Trang Chủ
          </Link>
          <Link href="/shop" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Cửa Hàng
          </Link>
          <button className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Bộ Sưu Tập
          </button>
          <Link href="/about" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Về Chúng Tôi
          </Link>
          <Link href="/contact" className="text-sm font-medium text-slate-200 hover:text-pink-400">
            Liên Hệ
          </Link>
          <Link
            href="/promotions"
            className="text-sm font-semibold text-pink-500 hover:text-pink-400"
          >
            Khuyến Mại
          </Link>
        </nav>
      </div>
    </header>


      {/* Hero Banner */}
      <div className="relative w-full h-[400px] bg-slate-100 overflow-hidden">
        <div className="flex items-center justify-center h-full gap-0 px-4">
          <img src="/banneraccount.jpg" alt="Left Banner" className="h-full w-auto object-contain" />
          <img src="/banneraccount.jpg" alt="Center Banner" className="h-full w-auto object-contain" />
          <img src="/banneraccount.jpg" alt="Right Banner" className="h-full w-auto object-contain" />
        </div>
      </div>

      {/* Account Section */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          <div>
            <h1 className="text-3xl font-bold mb-4 text-slate-900">
              CHÀO MỪNG TRỞ LẠI
            </h1>
            <p className="text-slate-600 mb-8">
              Đăng nhập để xem đơn hàng và quản lý tài khoản của bạn.
            </p>

            <form onSubmit={handleSignIn}>
              <div className="mb-6">
                <label className="block text-sm font-semibold mb-2 text-slate-700">
                  Địa chỉ Email:
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="Nhập email của bạn"
                  className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                  required
                />
              </div>

              <div className="mb-6">
                <label className="block text-sm font-semibold mb-2 text-slate-700">
                  Mật khẩu:
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Nhập mật khẩu"
                  className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                  required
                />
              </div>

              <button
                type="submit"
                className="w-full bg-pink-600 text-white py-3 rounded-lg font-semibold hover:bg-pink-700 transition mb-4"
              >
                ĐĂNG NHẬP
              </button>

              <button
                type="button"
                className="w-full text-sm text-slate-500 hover:text-pink-500 underline"
              >
                Quên mật khẩu?
              </button>
            </form>
          </div>

          <div>
            <h1 className="text-3xl font-bold mb-4 text-slate-900">
              TẠO TÀI KHOẢN
            </h1>
            <p className="text-slate-600 mb-8">
              Tạo tài khoản GoatTech mới để theo dõi đơn hàng và quản lý tài khoản.
            </p>

            <button
              onClick={handleCreateAccount}
              className="w-full bg-slate-900 text-white py-4 rounded-lg font-semibold hover:bg-slate-800 transition text-lg"
            >
              TẠO TÀI KHOẢN
            </button>
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-slate-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div>
              <h3 className="text-2xl font-bold mb-4">GoatTech</h3>
              <p className="text-slate-400">
                Ốp điện thoại cao cấp và phụ kiện công nghệ
              </p>
            </div>

            <div>
              <h4 className="font-semibold mb-4">Cửa Hàng</h4>
              <ul className="space-y-2 text-slate-400">
                <li><Link href="/shop" className="hover:text-pink-500 block">Ốp iPhone</Link></li>
                <li><Link href="/shop" className="hover:text-pink-500 block">Phụ Kiện</Link></li>
                <li><Link href="/shop" className="hover:text-pink-500 block">Hàng Mới Về</Link></li>
                <li><Link href="/promotions" className="hover:text-pink-500 block">Khuyến Mại</Link></li>
              </ul>
            </div>

            <div>
              <h4 className="font-semibold mb-4">Hỗ Trợ</h4>
              <ul className="space-y-2 text-slate-400">
                <li><Link href="/contact" className="hover:text-pink-500 block">Liên Hệ Chúng Tôi</Link></li>
                <li><button className="hover:text-pink-500 text-left">Thông Tin Vận Chuyển</button></li>
                <li><button className="hover:text-pink-500 text-left">Chính Sách Hoàn Hàng</button></li>
                <li><button className="hover:text-pink-500 text-left">Câu Hỏi Thường Gặp</button></li>
              </ul>
            </div>

            <div>
              <h4 className="font-semibold mb-4">Theo Dõi Chúng Tôi</h4>
              <ul className="space-y-2 text-slate-400">
                <li><button className="hover:text-pink-500 text-left">Instagram</button></li>
                <li><button className="hover:text-pink-500 text-left">Facebook</button></li>
                <li><button className="hover:text-pink-500 text-left">TikTok</button></li>
                <li><button className="hover:text-pink-500 text-left">YouTube</button></li>
              </ul>
            </div>
          </div>

          <div className="border-t border-slate-800 pt-8 text-center text-slate-400">
            <p>
              &copy; 2024 GoatTech - Ốp Điện Thoại Số 1 Việt Nam. Bảo Lưu Mọi Quyền.
            </p>
          </div>
        </div>
      </footer>
    </div>
  );

};

export default AccountPage;




################################################################################
## FILE 118: page.tsx
## Path: fontend/src/app/admin/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { 
  LayoutDashboard, 
  Package, 
  ShoppingCart, 
  Users, 
  FolderTree, 
  Star, 
  Settings,
  LogOut,
  Menu,
  X,
  TrendingUp,
  DollarSign,
  ShoppingBag,
  UserCheck,
  Search,
  Filter,
  Edit,
  Trash2,
  Eye,
  Plus,
  Check,
  XCircle,
  MessageSquare
} from 'lucide-react';
import Link from 'next/link';
import { fetchProducts, fetchOrders, fetchAllOrdersAdmin, fetchUsers, fetchCategories, createProduct, updateProduct, deleteProduct, createCategory, updateCategory, deleteCategory, fetchAllReviews, approveReview, deleteReview, fetchAllContacts, updateContactStatus, deleteContact, fetchAllCollections, updateProductCollections, fetchProductCollections, fetchAdminDashboard } from '@/lib/api-client';

interface Collection {
  collection_id: number;
  collection_name: string;
  collection_slug: string;
  collection_type: string;
  is_active: boolean;
}

interface Product {
  product_id: number;
  product_name: string;
  product_slug: string;
  sku: string;
  description?: string;
  short_description?: string;
  price: number;
  sale_price?: number;
  category_id?: number;
  brand_id?: number;
  is_featured: boolean;
  is_new: boolean;
  is_bestseller: boolean;
  status: string;
}

interface Order {
  order_id: number;
  order_number: string;
  customer_id: string | null;
  order_status: string;
  payment_status: string;
  total_amount: number;
  created_at: string;
  shipping_full_name?: string;
  shipping_phone?: string;
  shipping_address?: string;
  customer_note?: string;
}

interface Customer {
  id: string;
  full_name: string;
  email: string;
  phone?: string;
  role?: string;
  status?: string;
  created_at: string;
}

interface Category {
  category_id: number;
  category_name: string;
  category_slug: string;
  description?: string;
  parent_category_id?: number;
  is_active: boolean;
  display_order: number;
}

interface Review {
  review_id: number;
  product_id: number;
  user_id: string;
  rating: number;
  review_title?: string;
  review_text?: string;
  is_approved: boolean;
  created_at: string;
  user_name?: string;
  product_name?: string;
}

interface ContactMessage {
  id: number;
  name: string;
  email: string;
  phone?: string;
  subject?: string;
  message: string;
  status: string;
  created_at: string;
}

const AdminDashboard: React.FC = () => {
  const router = useRouter();
  const [activeTab, setActiveTab] = useState('dashboard');
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [isMounted, setIsMounted] = useState(false);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  
  // Data states
  const [products, setProducts] = useState<Product[]>([]);
  const [orders, setOrders] = useState<Order[]>([]);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [categories, setCategories] = useState<Category[]>([]);
  const [reviews, setReviews] = useState<Review[]>([]);
  const [contacts, setContacts] = useState<ContactMessage[]>([]);
  const [collections, setCollections] = useState<Collection[]>([]);
  const [loading, setLoading] = useState(false);
  
  // Selected collections for product form
  const [selectedCollections, setSelectedCollections] = useState<number[]>([]);
  
  // Modal states
  const [showModal, setShowModal] = useState(false);
  const [modalType, setModalType] = useState<'add' | 'edit'>('add');
  const [selectedItem, setSelectedItem] = useState<any>(null);
  
  // Form states for product
  const [formData, setFormData] = useState({
    product_name: '',
    sku: '',
    description: '',
    short_description: '',
    price: 0,
    sale_price: 0,
    category_id: null as number | null,
    image_url: '',
    is_featured: false,
    is_new: true,
    status: 'active',
    season: '' as string // Mùa lễ: noel, valentine, tet hoặc rỗng
  });

  // Form states for category
  const [categoryFormData, setCategoryFormData] = useState({
    category_name: '',
    category_slug: '',
    description: '',
    display_order: 0,
    is_active: true
  });

  // Category modal state
  const [showCategoryModal, setShowCategoryModal] = useState(false);
  const [categoryModalType, setCategoryModalType] = useState<'add' | 'edit'>('add');
  const [selectedCategory, setSelectedCategory] = useState<any>(null);
  
  // Search & Filter
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState('all');

  // Kiểm tra quyền admin
  useEffect(() => {
    const userRole = localStorage.getItem('userRole');
    const customer = localStorage.getItem('customer');
    
    if (!customer || userRole !== 'admin') {
      router.push('/login');
      return;
    }
    
    setIsAuthenticated(true);
    setIsMounted(true);
  }, [router]);

  useEffect(() => {
    if (isMounted && isAuthenticated) {
      loadData();
    }
  }, [activeTab, isMounted, isAuthenticated]);

  const loadData = async () => {
    try {
      setLoading(true);
      if (activeTab === 'products' || activeTab === 'dashboard') {
        const data = await fetchProducts(100);
        setProducts(Array.isArray(data) ? data : []);
        // Load collections for product form
        try {
          const collectionsData = await fetchAllCollections();
          setCollections(Array.isArray(collectionsData) ? collectionsData : []);
        } catch (e) {
          console.log('Collections not available yet');
        }
      }
      if (activeTab === 'orders' || activeTab === 'dashboard') {
        const data = await fetchAllOrdersAdmin();
        setOrders(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'customers' || activeTab === 'dashboard') {
        const data = await fetchUsers();
        setCustomers(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'categories' || activeTab === 'dashboard') {
        const data = await fetchCategories();
        setCategories(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'reviews' || activeTab === 'dashboard') {
        const data = await fetchAllReviews();
        setReviews(Array.isArray(data) ? data : []);
      }
      if (activeTab === 'contacts' || activeTab === 'dashboard') {
        const data = await fetchAllContacts();
        setContacts(Array.isArray(data) ? data : []);
      }
    } catch (error) {
      console.error('Error loading data:', error);
    } finally {
      setLoading(false);
    }
  };

  const [dashboard, setDashboard] = useState<any>(null);

  useEffect(() => {
    if (isMounted && isAuthenticated && activeTab === 'dashboard') {
      fetchAdminDashboard().then(setDashboard).catch(console.error);
    }
  }, [isMounted, isAuthenticated, activeTab]);

  const revenue7Days = dashboard?.revenue7Days || [];
  const bestSellers = dashboard?.bestSellers || [];

  const stats = dashboard ? [
    {
      label: 'Tổng Doanh Thu',
      value: (dashboard.totalRevenue || 0).toLocaleString('vi-VN') + '₫',
      icon: DollarSign,
      color: 'bg-green-500'
    },
    {
      label: 'Đơn Hàng',
      value: (dashboard.orderCount || 0).toString(),
      icon: ShoppingCart,
      color: 'bg-blue-500'
    },
    {
      label: 'Sản Phẩm',
      value: (dashboard.productCount || 0).toString(),
      icon: Package,
      color: 'bg-purple-500'
    },
    {
      label: 'Khách Hàng',
      value: (dashboard.customerCount || 0).toString(),
      icon: Users,
      color: 'bg-orange-500'
    }
  ] : [
    { 
      label: 'Tổng Doanh Thu', 
      value: orders.reduce((sum, order) => sum + (order.total_amount || 0), 0).toLocaleString('vi-VN') + '₫', 
      icon: DollarSign, 
      color: 'bg-green-500', 
      change: '+12.5%' 
    },
    { 
      label: 'Đơn Hàng', 
      value: orders.length.toString(), 
      icon: ShoppingCart, 
      color: 'bg-blue-500', 
      change: '+8.2%' 
    },
    { 
      label: 'Sản Phẩm', 
      value: products.length.toString(), 
      icon: Package, 
      color: 'bg-purple-500', 
      change: '+3.1%' 
    },
    { 
      label: 'Khách Hàng', 
      value: customers.length.toString(), 
      icon: Users, 
      color: 'bg-orange-500', 
      change: '+15.3%' 
    }
  ];

  const menuItems = [
    { id: 'dashboard', label: 'Tổng Quan', icon: LayoutDashboard },
    { id: 'products', label: 'Sản Phẩm', icon: Package },
    { id: 'orders', label: 'Đơn Hàng', icon: ShoppingCart },
    { id: 'customers', label: 'Khách Hàng', icon: Users },
    { id: 'categories', label: 'Danh Mục', icon: FolderTree },
    { id: 'reviews', label: 'Đánh Giá', icon: Star },
    { id: 'contacts', label: 'Tin Nhắn', icon: MessageSquare },
    { id: 'designs', label: ' Thiết Kế', icon: Package, isLink: true, href: '/admin/designs' },
    { id: 'templates', label: 'Các mẫu điện thoại', icon: Package, isLink: true, href: '/admin/templates' },
    { id: 'settings', label: 'Cài Đặt', icon: Settings }
  ];

  const getStatusColor = (status: string) => {
    switch (status.toLowerCase()) {
      case 'pending':
      case 'đang xử lý': return 'bg-yellow-100 text-yellow-800';
      case 'processing':
      case 'đang giao': return 'bg-blue-100 text-blue-800';
      case 'completed':
      case 'delivered':
      case 'đã giao': return 'bg-green-100 text-green-800';
      case 'cancelled':
      case 'đã hủy': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const openModal = async (type: 'add' | 'edit', item?: any) => {
    setModalType(type);
    setSelectedItem(item || null);
    if (type === 'edit' && item) {
      setFormData({
        product_name: item.product_name || '',
        sku: item.sku || '',
        description: item.description || '',
        short_description: item.short_description || '',
        price: item.price || 0,
        sale_price: item.sale_price || 0,
        category_id: item.category_id || null,
        image_url: item.image_url || '',
        is_featured: item.is_featured || false,
        is_new: item.is_new || false,
        status: item.status || 'active',
        season: item.season || ''
      });
      // Load collections của sản phẩm
      try {
        const productColls = await fetchProductCollections(item.product_id);
        const collIds = productColls.map((pc: any) => pc.collection_id);
        setSelectedCollections(collIds);
      } catch (e) {
        setSelectedCollections([]);
      }
    } else {
      setFormData({
        product_name: '',
        sku: '',
        description: '',
        short_description: '',
        price: 0,
        sale_price: 0,
        category_id: null,
        image_url: '',
        is_featured: false,
        is_new: true,
        status: 'active',
        season: ''
      });
      setSelectedCollections([]);
    }
    setShowModal(true);
  };

  const closeModal = () => {
    setShowModal(false);
    setSelectedItem(null);
    setSelectedCollections([]);
  };

  const handleCollectionToggle = (collectionId: number) => {
    setSelectedCollections(prev => 
      prev.includes(collectionId)
        ? prev.filter(id => id !== collectionId)
        : [...prev, collectionId]
    );
  };

  const handleSaveProduct = async () => {
    // Validate bắt buộc chọn danh mục
    if (!formData.category_id) {
      alert('Vui lòng chọn danh mục sản phẩm!');
      return;
    }
    
    try {
      setLoading(true);
      
      // Tự động tạo slug từ tên sản phẩm
      const slug = formData.product_name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Bỏ dấu tiếng Việt
        .replace(/đ/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
      
      const dataToSend = {
        ...formData,
        product_slug: slug
      };
      
      let productId: number;
      
      if (modalType === 'add') {
        const result = await createProduct(dataToSend);
        if (result.success) {
          productId = result.data?.product_id;
          // Lưu collections cho sản phẩm mới
          if (productId && selectedCollections.length > 0) {
            try {
              await updateProductCollections(productId, selectedCollections);
            } catch (e) {
              console.log('Could not save collections');
            }
          }
          alert('Thêm sản phẩm thành công!');
        } else {
          alert('Lỗi: ' + result.message);
        }
      } else {
        const result = await updateProduct(selectedItem.product_id, dataToSend);
        if (result.success) {
          // Cập nhật collections cho sản phẩm
          try {
            await updateProductCollections(selectedItem.product_id, selectedCollections);
          } catch (e) {
            console.log('Could not update collections');
          }
          alert('Cập nhật sản phẩm thành công!');
        } else {
          alert('Lỗi: ' + result.message);
        }
      }
      closeModal();
      loadData();
    } catch (error: any) {
      alert('Lỗi: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteProduct = async (id: number) => {
    if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
      try {
        const result = await deleteProduct(id);
        if (result.success) {
          alert('Xóa sản phẩm thành công!');
          loadData();
        } else {
          alert('Lỗi: ' + result.message);
        }
      } catch (error: any) {
        alert('Lỗi: ' + error.message);
      }
    }
  };

  const handleDelete = (id: number) => {
    if (confirm('Bạn có chắc chắn muốn xóa?')) {
      console.log('Delete item:', id);
      loadData();
    }
  };

  // Category modal functions
  const openCategoryModal = (type: 'add' | 'edit', category?: any) => {
    setCategoryModalType(type);
    setSelectedCategory(category || null);
    if (type === 'edit' && category) {
      setCategoryFormData({
        category_name: category.category_name || '',
        category_slug: category.category_slug || '',
        description: category.description || '',
        display_order: category.display_order || 0,
        is_active: category.is_active ?? true
      });
    } else {
      setCategoryFormData({
        category_name: '',
        category_slug: '',
        description: '',
        display_order: 0,
        is_active: true
      });
    }
    setShowCategoryModal(true);
  };

  const closeCategoryModal = () => {
    setShowCategoryModal(false);
    setSelectedCategory(null);
  };

  const handleSaveCategory = async () => {
    try {
      setLoading(true);
      
      // Tự động tạo slug từ tên danh mục
      const slug = categoryFormData.category_slug || categoryFormData.category_name
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/đ/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
      
      const dataToSend = {
        ...categoryFormData,
        category_slug: slug
      };
      
      if (categoryModalType === 'add') {
        const result = await createCategory(dataToSend);
        if (result.data) {
          alert('Thêm danh mục thành công!');
        } else {
          alert('Lỗi: ' + (result.error?.message || 'Không thể thêm danh mục'));
        }
      } else {
        const result = await updateCategory(selectedCategory.category_id, dataToSend);
        if (result.data) {
          alert('Cập nhật danh mục thành công!');
        } else {
          alert('Lỗi: ' + (result.error?.message || 'Không thể cập nhật danh mục'));
        }
      }
      closeCategoryModal();
      loadData();
    } catch (error: any) {
      alert('Lỗi: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteCategory = async (id: number) => {
    if (confirm('Bạn có chắc chắn muốn xóa danh mục này?')) {
      try {
        const result = await deleteCategory(id);
        if (!result.error) {
          alert('Xóa danh mục thành công!');
          loadData();
        } else {
          alert('Lỗi: ' + result.error.message);
        }
      } catch (error: any) {
        alert('Lỗi: ' + error.message);
      }
    }
  };

  // Review handlers
  const handleApproveReview = async (id: number, approve: boolean) => {
    try {
      const result = await approveReview(id, approve);
      if (!result.error) {
        alert(approve ? 'Đã duyệt đánh giá!' : 'Đã từ chối đánh giá!');
        loadData();
      } else {
        alert('Lỗi: ' + result.error.message);
      }
    } catch (error: any) {
      alert('Lỗi: ' + error.message);
    }
  };

  const handleDeleteReview = async (id: number) => {
    if (confirm('Bạn có chắc chắn muốn xóa đánh giá này?')) {
      try {
        const result = await deleteReview(id);
        if (!result.error) {
          alert('Xóa đánh giá thành công!');
          loadData();
        } else {
          alert('Lỗi: ' + result.error.message);
        }
      } catch (error: any) {
        alert('Lỗi: ' + error.message);
      }
    }
  };

  // Contact handlers
  const handleUpdateContactStatus = async (id: number, status: string) => {
    try {
      const result = await updateContactStatus(id, status);
      if (result.success) {
        alert(status === 'replied' ? 'Đã đánh dấu đã trả lời!' : 'Cập nhật trạng thái thành công!');
        loadData();
      } else {
        alert('Lỗi: ' + result.error?.message);
      }
    } catch (error: any) {
      alert('Lỗi: ' + error.message);
    }
  };

  const handleDeleteContact = async (id: number) => {
    if (confirm('Bạn có chắc chắn muốn xóa tin nhắn này?')) {
      try {
        const result = await deleteContact(id);
        if (result.success) {
          alert('Xóa tin nhắn thành công!');
          loadData();
        } else {
          alert('Lỗi: ' + result.error?.message);
        }
      } catch (error: any) {
        alert('Lỗi: ' + error.message);
      }
    }
  };

  const filteredProducts = products.filter(p => 
    p.product_name?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredOrders = orders.filter(o => 
    filterStatus === 'all' || o.order_status === filterStatus
  );

  const filteredCustomers = customers.filter(c => 
    c.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
    c.email?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const filteredCategories = categories.filter(c => 
    c.category_name?.toLowerCase().includes(searchTerm.toLowerCase())
  );

  const handleLogout = () => {
    localStorage.removeItem('customer');
    localStorage.removeItem('userRole');
    router.push('/login');
  };

  if (!isMounted || !isAuthenticated) {
    return (
      <div className="min-h-screen bg-gray-100 flex items-center justify-center">
        <div className="text-gray-500">Loading...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 flex">
      {/* Sidebar */}
      <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} bg-gray-900 text-white transition-all duration-300 fixed h-full z-30`}>
        <div className="p-4 flex items-center justify-between border-b border-gray-800">
          {isSidebarOpen && <h1 className="text-xl font-bold">GoatTech Admin</h1>}
          <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-gray-800 rounded">
            {isSidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
          </button>
        </div>

        <nav className="mt-6">
          {menuItems.map((item: any) => (
            item.isLink ? (
              <Link
                key={item.id}
                href={item.href}
                className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 transition`}
              >
                <item.icon className="w-5 h-5" />
                {isSidebarOpen && <span>{item.label}</span>}
              </Link>
            ) : (
              <button
                key={item.id}
                onClick={() => setActiveTab(item.id)}
                className={`w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 transition ${
                  activeTab === item.id ? 'bg-gray-800 border-l-4 border-pink-500' : ''
                }`}
              >
                <item.icon className="w-5 h-5" />
                {isSidebarOpen && <span>{item.label}</span>}
              </button>
            )
          ))}
        </nav>

        <div className="absolute bottom-0 w-full border-t border-gray-800">
          <button 
            onClick={handleLogout}
            className="w-full flex items-center gap-3 px-4 py-3 hover:bg-gray-800 transition text-red-400"
          >
            <LogOut className="w-5 h-5" />
            {isSidebarOpen && <span>Đăng Xuất</span>}
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className={`flex-1 ${isSidebarOpen ? 'ml-64' : 'ml-20'} transition-all duration-300`}>
        {/* Top Bar */}
        <header className="bg-white shadow-sm p-4 flex items-center justify-between sticky top-0 z-20">
          <div>
            <h2 className="text-2xl font-bold">
              {menuItems.find(item => item.id === activeTab)?.label || 'Tổng Quan'}
            </h2>
            <p className="text-sm text-gray-600">Chào mừng trở lại, Admin!</p>
          </div>
          <div className="flex items-center gap-4">
            <Link href="/" className="text-sm text-pink-600 hover:underline">Xem Website</Link>
            <div className="w-10 h-10 bg-pink-600 rounded-full flex items-center justify-center text-white font-bold">
              A
            </div>
          </div>
        </header>

        {/* Dashboard Content */}
        <div className="p-6">
          {activeTab === 'dashboard' && (
            <>
              {/* Stats Grid */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                {stats.map((stat, index) => (
                  <div key={index} className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className={`${stat.color} w-12 h-12 rounded-lg flex items-center justify-center`}>
                        <stat.icon className="w-6 h-6 text-white" />
                      </div>
                    </div>
                    <h3 className="text-gray-600 text-sm mb-1">{stat.label}</h3>
                    <p className="text-2xl font-bold">{stat.value}</p>
                  </div>
                ))}
              </div>

              {/* Charts Row */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Revenue Chart */}
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-bold mb-4">Doanh Thu 7 Ngày Qua</h3>
                  <div className="h-64 flex items-end justify-around gap-2">
                    {revenue7Days.length === 7 ? revenue7Days.map((amount, i) => (
                      <div key={i} className="flex-1 flex flex-col items-center">
                        <div className="w-full bg-pink-600 rounded-t" style={{ height: `${Math.max(amount / Math.max(...revenue7Days, 1) * 100, 5)}%` }}></div>
                        <span className="text-xs text-gray-600 mt-2">T{i + 2}</span>
                        <span className="text-xs text-gray-500">{amount.toLocaleString('vi-VN')}₫</span>
                      </div>
                    )) : <div className="text-gray-400">Không có dữ liệu</div>}
                  </div>
                </div>

                {/* Top Products */}
                <div className="bg-white rounded-lg shadow p-6">
                  <h3 className="text-lg font-bold mb-4">Sản Phẩm Bán Chạy</h3>
                  <div className="space-y-4">
                    {bestSellers.length > 0 ? bestSellers.map((product, i) => (
                      <div key={product.id} className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-gray-200 rounded"></div>
                          <div>
                            <p className="font-medium">{product.name}</p>
                            <p className="text-sm text-gray-600">{product.sold} đã bán</p>
                          </div>
                        </div>
                        <span className="font-bold text-pink-600">{Math.round(product.revenue/1000)}K</span>
                      </div>
                    )) : <div className="text-gray-400">Không có dữ liệu</div>}
                  </div>
                </div>
              </div>

              {/* Recent Orders */}
              <div className="bg-white rounded-lg shadow">
                <div className="p-6 border-b">
                  <h3 className="text-lg font-bold">Đơn Hàng Gần Đây</h3>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã ĐH</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày Đặt</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Số Tiền</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng Thái</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thanh Toán</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {orders.slice(0, 5).map((order) => (
                        <tr key={order.order_id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap font-medium">#{order.order_number || order.order_id}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{order.created_at ? new Date(order.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-bold">{order.total_amount?.toLocaleString('vi-VN')}₫</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.order_status)}`}>
                              {order.order_status}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.payment_status)}`}>
                              {order.payment_status}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </>
          )}

          {/* PRODUCTS TAB */}
          {activeTab === 'products' && (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-lg font-bold">Quản Lý Sản Phẩm ({products.length})</h3>
                  <button 
                    onClick={() => openModal('add')}
                    className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 flex items-center gap-2"
                  >
                    <Plus className="w-4 h-4" /> Thêm Sản Phẩm
                  </button>
                </div>

                {/* Search */}
                <div className="mb-4 flex gap-4">
                  <div className="flex-1 relative">
                    <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                    <input
                      type="text"
                      placeholder="Tìm kiếm sản phẩm..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border rounded-lg"
                    />
                  </div>
                </div>

                {/* Table */}
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SKU</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên Sản Phẩm</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giá</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Giá KM</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng Thái</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {filteredProducts.map((product) => (
                        <tr key={product.product_id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">#{product.product_id}</td>
                          <td className="px-6 py-4 whitespace-nowrap text-gray-500">{product.sku}</td>
                          <td className="px-6 py-4">{product.product_name}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-bold">{product.price?.toLocaleString('vi-VN')}₫</td>
                          <td className="px-6 py-4 whitespace-nowrap text-pink-600">
                            {product.sale_price ? `${product.sale_price.toLocaleString('vi-VN')}₫` : '-'}
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                              product.status === 'active' ? 'bg-green-100 text-green-800' : 
                              product.status === 'inactive' ? 'bg-red-100 text-red-800' : 
                              'bg-gray-100 text-gray-800'
                            }`}>
                              {product.status === 'active' ? 'Đang bán' : 
                               product.status === 'inactive' ? 'Ngừng bán' : 'Bản nháp'}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-2">
                              <button onClick={() => openModal('edit', product)} className="text-blue-600 hover:text-blue-800">
                                <Edit className="w-4 h-4" />
                              </button>
                              <button onClick={() => handleDeleteProduct(product.product_id)} className="text-red-600 hover:text-red-800">
                                <Trash2 className="w-4 h-4" />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* ORDERS TAB */}
          {activeTab === 'orders' && (
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-bold">Quản Lý Đơn Hàng ({orders.length})</h3>
                <div className="flex gap-2">
                  <select 
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    className="border rounded-lg px-3 py-2"
                  >
                    <option value="all">Tất cả</option>
                    <option value="pending">Chờ xử lý</option>
                    <option value="processing">Đang xử lý</option>
                    <option value="completed">Hoàn thành</option>
                    <option value="cancelled">Đã hủy</option>
                  </select>
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mã ĐH</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Khách Hàng</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày Đặt</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tổng Tiền</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng Thái</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thanh Toán</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredOrders.map((order) => (
                      <tr key={order.order_id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap font-medium">#{order.order_number || order.order_id}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          {order.customer_id ? (
                            <span>#{order.customer_id.slice(0, 8)}</span>
                          ) : order.shipping_full_name ? (
                            <div className="flex flex-col">
                              <span className="font-medium">{order.shipping_full_name}</span>
                              <span className="text-xs text-gray-500">{order.shipping_phone}</span>
                              {order.order_number?.startsWith('MSG') && (
                                <span className="text-xs text-blue-500"> Messenger</span>
                              )}
                            </div>
                          ) : (
                            <span className="text-gray-400">Khách vãng lai</span>
                          )}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">{order.created_at ? new Date(order.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap font-bold">{order.total_amount?.toLocaleString('vi-VN')}₫</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.order_status)}`}>
                            {order.order_status}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(order.payment_status)}`}>
                            {order.payment_status}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <button className="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            <Eye className="w-4 h-4" /> Chi tiết
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* CUSTOMERS TAB */}
          {activeTab === 'customers' && (
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-bold">Quản Lý Khách Hàng ({customers.length})</h3>
                <div className="relative">
                  <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  <input
                    type="text"
                    placeholder="Tìm khách hàng..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 pr-4 py-2 border rounded-lg"
                  />
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Họ Tên</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SĐT</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ngày Đăng Ký</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredCustomers.map((customer) => (
                      <tr key={customer.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">#{customer.id?.slice(0, 8)}</td>
                        <td className="px-6 py-4 whitespace-nowrap font-medium">{customer.full_name}</td>
                        <td className="px-6 py-4">{customer.email}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{customer.phone || '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{customer.created_at ? new Date(customer.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <button className="text-blue-600 hover:text-blue-800 flex items-center gap-1">
                            <Eye className="w-4 h-4" /> Xem
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* CATEGORIES TAB */}
          {activeTab === 'categories' && (
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-bold">Quản Lý Danh Mục ({categories.length})</h3>
                <button 
                  onClick={() => openCategoryModal('add')}
                  className="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 flex items-center gap-2"
                >
                  <Plus className="w-4 h-4" /> Thêm Danh Mục
                </button>
              </div>

              <div className="mb-4">
                <div className="relative">
                  <Search className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                  <input
                    type="text"
                    placeholder="Tìm danh mục..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-10 pr-4 py-2 border rounded-lg"
                  />
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tên Danh Mục</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slug</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thứ Tự</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trạng Thái</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hành Động</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredCategories.map((category) => (
                      <tr key={category.category_id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">#{category.category_id}</td>
                        <td className="px-6 py-4 font-medium">{category.category_name}</td>
                        <td className="px-6 py-4 text-sm text-gray-600">{category.category_slug}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{category.display_order}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-3 py-1 rounded-full text-xs font-medium ${category.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}`}>
                            {category.is_active ? 'Hoạt động' : 'Tạm ngưng'}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center gap-2">
                            <button onClick={() => openCategoryModal('edit', category)} className="text-blue-600 hover:text-blue-800">
                              <Edit className="w-4 h-4" />
                            </button>
                            <button onClick={() => handleDeleteCategory(category.category_id)} className="text-red-600 hover:text-red-800">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* REVIEWS TAB */}
          {activeTab === 'reviews' && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-bold mb-6">Quản Lý Đánh Giá ({reviews.length})</h3>
              <div className="space-y-4">
                {loading ? (
                  <p className="text-center text-gray-500 py-8">Đang tải...</p>
                ) : reviews.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">Chưa có đánh giá nào.</p>
                ) : (
                  reviews.map((review) => (
                    <div key={review.review_id} className={`border rounded-lg p-4 ${review.is_approved ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <div className="flex">
                              {[1,2,3,4,5].map(i => (
                                <Star 
                                  key={i} 
                                  className={`w-4 h-4 ${i <= review.rating ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'}`} 
                                />
                              ))}
                            </div>
                            <span className="font-semibold">{review.user_name || 'Khách hàng'}</span>
                            <span className="text-sm text-gray-500">
                              {new Date(review.created_at).toLocaleDateString('vi-VN')}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded ${review.is_approved ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                              {review.is_approved ? 'Đã duyệt' : 'Chờ duyệt'}
                            </span>
                          </div>
                          {review.review_title && (
                            <h4 className="font-medium text-gray-800 mb-1">{review.review_title}</h4>
                          )}
                          <p className="text-gray-700 mb-2">{review.review_text || 'Không có nội dung'}</p>
                          <div className="text-sm text-gray-500">Sản phẩm: {review.product_name || `ID: ${review.product_id}`}</div>
                        </div>
                        <div className="flex gap-2 ml-4">
                          {!review.is_approved && (
                            <button 
                              onClick={() => handleApproveReview(review.review_id, true)}
                              className="text-green-600 hover:text-green-800 p-1"
                              title="Duyệt"
                            >
                              <Check className="w-5 h-5" />
                            </button>
                          )}
                          {review.is_approved && (
                            <button 
                              onClick={() => handleApproveReview(review.review_id, false)}
                              className="text-orange-600 hover:text-orange-800 p-1"
                              title="Bỏ duyệt"
                            >
                              <XCircle className="w-5 h-5" />
                            </button>
                          )}
                          <button 
                            onClick={() => handleDeleteReview(review.review_id)}
                            className="text-red-600 hover:text-red-800 p-1"
                            title="Xóa"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}

          {/* CONTACTS TAB */}
          {activeTab === 'contacts' && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-bold mb-6">Quản Lý Tin Nhắn Liên Hệ ({contacts.length})</h3>
              <div className="space-y-4">
                {loading ? (
                  <p className="text-center text-gray-500 py-8">Đang tải...</p>
                ) : contacts.length === 0 ? (
                  <p className="text-center text-gray-500 py-8">Chưa có tin nhắn nào.</p>
                ) : (
                  contacts.map((contact) => (
                    <div key={contact.id} className={`border rounded-lg p-4 ${contact.status === 'replied' ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className="font-semibold text-lg">{contact.name}</span>
                            <span className="text-sm text-gray-500">
                              {new Date(contact.created_at).toLocaleDateString('vi-VN')} {new Date(contact.created_at).toLocaleTimeString('vi-VN')}
                            </span>
                            <span className={`text-xs px-2 py-0.5 rounded ${contact.status === 'replied' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                              {contact.status === 'replied' ? 'Đã trả lời' : 'Chờ xử lý'}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600 mb-2">
                            <span className="font-medium">Email:</span> {contact.email}
                            {contact.phone && <span className="ml-4"><span className="font-medium">SĐT:</span> {contact.phone}</span>}
                          </div>
                          {contact.subject && (
                            <div className="text-sm text-gray-600 mb-2">
                              <span className="font-medium">Chủ đề:</span> {contact.subject}
                            </div>
                          )}
                          <p className="text-gray-700 bg-white p-3 rounded border">{contact.message}</p>
                        </div>
                        <div className="flex gap-2 ml-4">
                          {contact.status !== 'replied' && (
                            <button 
                              onClick={() => handleUpdateContactStatus(contact.id, 'replied')}
                              className="text-green-600 hover:text-green-800 p-1"
                              title="Đánh dấu đã trả lời"
                            >
                              <Check className="w-5 h-5" />
                            </button>
                          )}
                          <button 
                            onClick={() => handleDeleteContact(contact.id)}
                            className="text-red-600 hover:text-red-800 p-1"
                            title="Xóa"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            </div>
          )}

          {/* SETTINGS TAB */}
          {activeTab === 'settings' && (
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-bold mb-6">Cài Đặt Hệ Thống</h3>
              <div className="space-y-6">
                <div className="border-b pb-6">
                  <h4 className="font-semibold mb-4">Thông Tin Website</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Tên Website</label>
                      <input type="text" defaultValue="GoatTech Vietnam" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Email Liên Hệ</label>
                      <input type="email" defaultValue="contact@GoatTech.vn" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Số Điện Thoại</label>
                      <input type="tel" defaultValue="0123456789" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Địa Chỉ</label>
                      <input type="text" defaultValue="Hà Nội, Việt Nam" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                  </div>
                </div>

                <div className="border-b pb-6">
                  <h4 className="font-semibold mb-4">Cài Đặt Thanh Toán</h4>
                  <div className="space-y-3">
                    <label className="flex items-center gap-3">
                      <input type="checkbox" defaultChecked className="w-4 h-4" />
                      <span>Chấp nhận thanh toán COD</span>
                    </label>
                    <label className="flex items-center gap-3">
                      <input type="checkbox" defaultChecked className="w-4 h-4" />
                      <span>Chấp nhận thanh toán MoMo</span>
                    </label>
                    <label className="flex items-center gap-3">
                      <input type="checkbox" className="w-4 h-4" />
                      <span>Chấp nhận thanh toán VNPay</span>
                    </label>
                  </div>
                </div>

                <div className="border-b pb-6">
                  <h4 className="font-semibold mb-4">Cài Đặt Vận Chuyển</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Phí Ship Mặc Định</label>
                      <input type="number" defaultValue="30000" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                    <div>
                      <label className="block text-sm text-gray-600 mb-2">Miễn Ship Từ (VNĐ)</label>
                      <input type="number" defaultValue="200000" className="w-full border rounded-lg px-3 py-2" />
                    </div>
                  </div>
                </div>

                <button className="bg-pink-600 text-white px-6 py-3 rounded-lg hover:bg-pink-700 font-medium">
                  Lưu Tất Cả Thay Đổi
                </button>
              </div>
            </div>
          )}
        </div>
      </main>

      {/* Modal for Add/Edit */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b flex items-center justify-between">
              <h3 className="text-xl font-bold">
                {modalType === 'add' ? 'Thêm Mới' : 'Chỉnh Sửa'} Sản Phẩm
              </h3>
              <button onClick={closeModal} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            <div className="p-6">
              <form className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Tên Sản Phẩm *</label>
                    <input 
                      type="text" 
                      value={formData.product_name}
                      onChange={(e) => setFormData({...formData, product_name: e.target.value})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="Nhập tên sản phẩm"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">SKU *</label>
                    <input 
                      type="text" 
                      value={formData.sku}
                      onChange={(e) => setFormData({...formData, sku: e.target.value.toUpperCase()})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="SP001"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">URL Hình Ảnh</label>
                  <input 
                    type="text" 
                    value={formData.image_url}
                    onChange={(e) => setFormData({...formData, image_url: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="https://example.com/image.jpg"
                  />
                  {formData.image_url && (
                    <img src={formData.image_url} alt="Preview" className="mt-2 h-20 w-20 object-cover rounded border" />
                  )}
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Mô Tả Ngắn</label>
                  <input 
                    type="text" 
                    value={formData.short_description}
                    onChange={(e) => setFormData({...formData, short_description: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="Mô tả ngắn gọn"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Mô Tả Chi Tiết</label>
                  <textarea 
                    value={formData.description}
                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 h-24"
                    placeholder="Nhập mô tả chi tiết sản phẩm"
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Giá Gốc (VNĐ) *</label>
                    <input 
                      type="number" 
                      value={formData.price}
                      onChange={(e) => setFormData({...formData, price: Number(e.target.value)})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="0"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-2">Giá Khuyến Mãi</label>
                    <input 
                      type="number" 
                      value={formData.sale_price}
                      onChange={(e) => setFormData({...formData, sale_price: Number(e.target.value)})}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="0"
                    />
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Danh Mục</label>
                  <select 
                    value={formData.category_id || ''}
                    onChange={(e) => setFormData({...formData, category_id: e.target.value ? Number(e.target.value) : null})}
                    className="w-full border rounded-lg px-3 py-2"
                  >
                    <option value="">-- Chọn danh mục --</option>
                    {categories.map(cat => (
                      <option key={cat.category_id} value={cat.category_id}>{cat.category_name}</option>
                    ))}
                  </select>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="flex items-center gap-2">
                      <input 
                        type="checkbox" 
                        checked={formData.is_featured}
                        onChange={(e) => setFormData({...formData, is_featured: e.target.checked})}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-medium">Sản phẩm nổi bật</span>
                    </label>
                  </div>
                  <div>
                    <label className="flex items-center gap-2">
                      <input 
                        type="checkbox" 
                        checked={formData.is_new}
                        onChange={(e) => setFormData({...formData, is_new: e.target.checked})}
                        className="w-4 h-4"
                      />
                      <span className="text-sm font-medium">Sản phẩm mới</span>
                    </label>
                  </div>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Trạng thái</label>
                  <select 
                    value={formData.status}
                    onChange={(e) => setFormData({...formData, status: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                  >
                    <option value="active">Đang bán</option>
                    <option value="inactive">Ngừng bán</option>
                    <option value="draft">Bản nháp</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Bộ Sưu Tập Theo Mùa (Tùy chọn)</label>
                  <select 
                    value={formData.season}
                    onChange={(e) => setFormData({...formData, season: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2"
                  >
                    <option value="">-- Không thuộc mùa nào --</option>
                    <option value="noel">🎄 Giáng Sinh - Noel</option>
                    <option value="valentine">💕 Valentine</option>
                    <option value="tet">🧧 Tết Nguyên Đán</option>
                  </select>
                </div>

                {/* Collections Multi-select */}
                {collections.length > 0 && (
                  <div>
                    <label className="block text-sm font-medium mb-2">Bộ Sưu Tập (Chọn nhiều)</label>
                    <div className="border rounded-lg p-3 max-h-40 overflow-y-auto space-y-2">
                      {collections.map((collection) => (
                        <label 
                          key={collection.collection_id} 
                          className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 p-1 rounded"
                        >
                          <input
                            type="checkbox"
                            checked={selectedCollections.includes(collection.collection_id)}
                            onChange={() => handleCollectionToggle(collection.collection_id)}
                            className="w-4 h-4 text-pink-600 rounded"
                          />
                          <span className="text-sm">
                            {collection.collection_name}
                            <span className="text-xs text-gray-400 ml-1">
                              ({collection.collection_type === 'seasonal' ? 'Theo mùa' : 'Chính'})
                            </span>
                          </span>
                        </label>
                      ))}
                    </div>
                    {selectedCollections.length > 0 && (
                      <p className="text-xs text-gray-500 mt-1">
                        Đã chọn {selectedCollections.length} bộ sưu tập
                      </p>
                    )}
                  </div>
                )}

                <div className="flex gap-3 pt-4">
                  <button 
                    type="button"
                    onClick={handleSaveProduct}
                    disabled={loading}
                    className="flex-1 bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 font-medium disabled:bg-gray-400"
                  >
                    {loading ? 'Đang xử lý...' : (modalType === 'add' ? 'Thêm Mới' : 'Cập Nhật')}
                  </button>
                  <button 
                    type="button"
                    onClick={closeModal}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-medium"
                  >
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Category Modal */}
      {showCategoryModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6 border-b flex items-center justify-between">
              <h3 className="text-xl font-bold">
                {categoryModalType === 'add' ? 'Thêm Mới' : 'Chỉnh Sửa'} Danh Mục
              </h3>
              <button onClick={closeCategoryModal} className="text-gray-400 hover:text-gray-600">
                <X className="w-6 h-6" />
              </button>
            </div>
            <div className="p-6">
              <form className="space-y-4">
                <div>
                  <label className="block text-sm font-medium mb-2">Tên Danh Mục *</label>
                  <input 
                    type="text" 
                    value={categoryFormData.category_name}
                    onChange={(e) => {
                      const name = e.target.value;
                      const slug = name
                        .toLowerCase()
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .replace(/đ/g, 'd')
                        .replace(/[^a-z0-9\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                      setCategoryFormData({...categoryFormData, category_name: name, category_slug: slug});
                    }}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="Nhập tên danh mục"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Slug</label>
                  <input 
                    type="text" 
                    value={categoryFormData.category_slug}
                    onChange={(e) => setCategoryFormData({...categoryFormData, category_slug: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 bg-gray-50"
                    placeholder="ten-danh-muc"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Mô Tả</label>
                  <textarea 
                    value={categoryFormData.description}
                    onChange={(e) => setCategoryFormData({...categoryFormData, description: e.target.value})}
                    className="w-full border rounded-lg px-3 py-2 h-20"
                    placeholder="Nhập mô tả danh mục"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">Thứ Tự Hiển Thị</label>
                  <input 
                    type="number" 
                    value={categoryFormData.display_order}
                    onChange={(e) => setCategoryFormData({...categoryFormData, display_order: Number(e.target.value)})}
                    className="w-full border rounded-lg px-3 py-2"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="flex items-center gap-2">
                    <input 
                      type="checkbox" 
                      checked={categoryFormData.is_active}
                      onChange={(e) => setCategoryFormData({...categoryFormData, is_active: e.target.checked})}
                      className="w-4 h-4"
                    />
                    <span className="text-sm font-medium">Kích hoạt danh mục</span>
                  </label>
                </div>

                <div className="flex gap-3 pt-4">
                  <button 
                    type="button"
                    onClick={handleSaveCategory}
                    disabled={loading}
                    className="flex-1 bg-pink-600 text-white py-2 rounded-lg hover:bg-pink-700 font-medium disabled:bg-gray-400"
                  >
                    {loading ? 'Đang xử lý...' : (categoryModalType === 'add' ? 'Thêm Mới' : 'Cập Nhật')}
                  </button>
                  <button 
                    type="button"
                    onClick={closeCategoryModal}
                    className="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-medium"
                  >
                    Hủy
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default AdminDashboard;




################################################################################
## FILE 119: page.tsx
## Path: fontend/src/app/admin/designs/page.tsx
################################################################################

'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';

interface Design {
  design_id: string;
  phone_model: string;
  status: string;
  preview_image_url: string | null;
  high_res_image_url: string | null;
  guest_name: string | null;
  guest_email: string | null;
  guest_phone: string | null;
  admin_notes: string | null;
  created_at: string;
  submitted_at: string | null;
  design_data: any;
  users?: {
    full_name: string;
    email: string;
    phone: string;
  };
}

const statusLabels: Record<string, { label: string; color: string }> = {
  draft: { label: 'Bản nháp', color: 'bg-gray-100 text-gray-800' },
  submitted: { label: 'Chờ duyệt', color: 'bg-yellow-100 text-yellow-800' },
  processing: { label: 'Đang xử lý', color: 'bg-blue-100 text-blue-800' },
  approved: { label: 'Đã duyệt', color: 'bg-green-100 text-green-800' },
  rejected: { label: 'Từ chối', color: 'bg-red-100 text-red-800' },
  printed: { label: 'Đã in', color: 'bg-purple-100 text-purple-800' },
};

export default function AdminDesignsPage() {
  const [designs, setDesigns] = useState<Design[]>([]);
  const [loading, setLoading] = useState(true);
  const [filterStatus, setFilterStatus] = useState<string>('');
  const [selectedDesign, setSelectedDesign] = useState<Design | null>(null);
  const [adminNotes, setAdminNotes] = useState('');
  const [actionLoading, setActionLoading] = useState(false);

  // Load designs
  const loadDesigns = async () => {
    try {
      const url = filterStatus 
        ? `http://localhost:3001/designs/admin/all?status=${filterStatus}`
        : 'http://localhost:3001/designs/admin/all';
      
      const res = await fetch(url);
      if (res.ok) {
        const data = await res.json();
        setDesigns(data.data || []);
      }
    } catch (error) {
      console.error('Load designs error:', error);
    }
    setLoading(false);
  };

  useEffect(() => {
    loadDesigns();
  }, [filterStatus]);

  // Duyệt thiết kế
  const approveDesign = async (designId: string) => {
    setActionLoading(true);
    try {
      const res = await fetch(`http://localhost:3001/designs/admin/${designId}/approve`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      });

      if (res.ok) {
        alert('✅ Đã duyệt thiết kế thành công!');
        setSelectedDesign(null);
        setAdminNotes('');
        loadDesigns();
      } else {
        alert('Có lỗi xảy ra!');
      }
    } catch (error) {
      console.error('Approve error:', error);
      alert('Có lỗi xảy ra!');
    }
    setActionLoading(false);
  };

  // Từ chối thiết kế
  const rejectDesign = async (designId: string) => {
    if (!adminNotes.trim()) {
      alert('Vui lòng nhập lý do từ chối!');
      return;
    }

    setActionLoading(true);
    try {
      const res = await fetch(`http://localhost:3001/designs/admin/${designId}/reject`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adminNotes }),
      });

      if (res.ok) {
        alert('❌ Đã từ chối thiết kế!');
        setSelectedDesign(null);
        setAdminNotes('');
        loadDesigns();
      } else {
        alert('Có lỗi xảy ra!');
      }
    } catch (error) {
      console.error('Reject error:', error);
      alert('Có lỗi xảy ra!');
    }
    setActionLoading(false);
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleString('vi-VN');
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow">
        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/admin" className="text-gray-600 hover:text-pink-500">
              ← Quay lại
            </Link>
            <h1 className="text-xl font-bold text-gray-800">🎨 Quản Lý Thiết Kế Ốp Lưng</h1>
          </div>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-500">
              Tổng: {designs.length} thiết kế
            </span>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6">
        {/* Filter */}
        <div className="bg-white rounded-lg shadow p-4 mb-6">
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setFilterStatus('')}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                !filterStatus ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Tất cả
            </button>
            {Object.entries(statusLabels).map(([status, { label }]) => (
              <button
                key={status}
                onClick={() => setFilterStatus(status)}
                className={`px-4 py-2 rounded-lg text-sm font-medium transition ${
                  filterStatus === status ? 'bg-pink-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {label}
              </button>
            ))}
          </div>
        </div>

        {/* Designs List */}
        {loading ? (
          <div className="text-center py-12">
            <div className="animate-spin text-4xl">⏳</div>
            <p className="text-gray-500 mt-2">Đang tải...</p>
          </div>
        ) : designs.length === 0 ? (
          <div className="text-center py-12 bg-white rounded-lg shadow">
            <div className="text-6xl mb-4">📭</div>
            <p className="text-gray-500">Chưa có thiết kế nào</p>
          </div>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {designs.map((design) => (
              <div
                key={design.design_id}
                className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition"
              >
                {/* Preview Image */}
                <div className="aspect-[3/4] bg-gray-100 relative">
                  {design.preview_image_url ? (
                    <img
                      src={`http://localhost:3001${design.preview_image_url}`}
                      alt="Design preview"
                      className="w-full h-full object-contain"
                      onError={(e) => {
                        console.error('Image load error:', design.preview_image_url);
                        (e.target as HTMLImageElement).style.display = 'none';
                      }}
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <span className="text-6xl">📱</span>
                    </div>
                  )}
                  
                  {/* Status Badge */}
                  <div className="absolute top-3 right-3">
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${statusLabels[design.status]?.color}`}>
                      {statusLabels[design.status]?.label}
                    </span>
                  </div>
                </div>

                {/* Info */}
                <div className="p-4">
                  <h3 className="font-semibold text-gray-800 mb-2">
                     {design.phone_model}
                  </h3>
                  
                  <div className="text-sm text-gray-600 space-y-1">
                    <p>
                      👤 {design.guest_name || design.users?.full_name || 'Ẩn danh'}
                    </p>
                    <p>
                      📞 {design.guest_phone || design.users?.phone || 'N/A'}
                    </p>
                    <p>
                      📧 {design.guest_email || design.users?.email || 'N/A'}
                    </p>
                    <p className="text-gray-400">
                      🕐 {design.submitted_at ? formatDate(design.submitted_at) : formatDate(design.created_at)}
                    </p>
                  </div>

                  {design.admin_notes && (
                    <div className="mt-3 p-2 bg-gray-50 rounded text-sm">
                      <span className="font-medium">Ghi chú:</span> {design.admin_notes}
                    </div>
                  )}

                  {/* Actions */}
                  {design.status === 'submitted' && (
                    <div className="mt-4 flex gap-2">
                      <button
                        onClick={() => {
                          setSelectedDesign(design);
                          setAdminNotes('');
                        }}
                        className="flex-1 bg-pink-500 text-white py-2 rounded-lg text-sm font-medium hover:bg-pink-600"
                      >
                        Xem & Duyệt
                      </button>
                    </div>
                  )}

                  {design.status !== 'submitted' && (
                    <button
                      onClick={() => setSelectedDesign(design)}
                      className="mt-4 w-full bg-gray-100 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-200"
                    >
                      Xem chi tiết
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Modal xem chi tiết & duyệt */}
      {selectedDesign && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-auto">
            <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold">Chi tiết thiết kế</h2>
              <button
                onClick={() => setSelectedDesign(null)}
                className="text-gray-500 hover:text-gray-700 text-2xl"
              >
                ×
              </button>
            </div>

            <div className="p-6 grid md:grid-cols-2 gap-6">
              {/* Preview */}
              <div>
                <div className="aspect-[3/4] bg-gray-100 rounded-xl overflow-hidden relative">
                  {selectedDesign.preview_image_url ? (
                    <img
                      src={`http://localhost:3001${selectedDesign.preview_image_url}`}
                      alt="Design preview"
                      className="w-full h-full object-contain"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <span className="text-6xl">📱</span>
                    </div>
                  )}
                </div>

                {selectedDesign.high_res_image_url && (
                  <a
                    href={`http://localhost:3001${selectedDesign.high_res_image_url}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="mt-4 block text-center bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600"
                  >
                     Tải ảnh HD 
                  </a>
                )}
              </div>

              {/* Info & Actions */}
              <div>
                <div className="space-y-4">
                  <div>
                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${statusLabels[selectedDesign.status]?.color}`}>
                      {statusLabels[selectedDesign.status]?.label}
                    </span>
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                    <h3 className="font-semibold">📱 Thông tin</h3>
                    <p><span className="text-gray-500">Model:</span> {selectedDesign.phone_model}</p>
                    <p><span className="text-gray-500">Ngày gửi:</span> {selectedDesign.submitted_at ? formatDate(selectedDesign.submitted_at) : 'Chưa gửi'}</p>
                  </div>

                  <div className="bg-gray-50 rounded-lg p-4 space-y-2">
                    <h3 className="font-semibold">👤 Khách hàng</h3>
                    <p><span className="text-gray-500">Tên:</span> {selectedDesign.guest_name || selectedDesign.users?.full_name || 'N/A'}</p>
                    <p><span className="text-gray-500">SĐT:</span> {selectedDesign.guest_phone || selectedDesign.users?.phone || 'N/A'}</p>
                    <p><span className="text-gray-500">Email:</span> {selectedDesign.guest_email || selectedDesign.users?.email || 'N/A'}</p>
                  </div>

                  {selectedDesign.status === 'submitted' && (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Ghi chú của Admin
                        </label>
                        <textarea
                          value={adminNotes}
                          onChange={(e) => setAdminNotes(e.target.value)}
                          rows={3}
                          className="w-full border rounded-lg px-3 py-2"
                          placeholder="Nhập ghi chú (bắt buộc khi từ chối)..."
                        />
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={() => approveDesign(selectedDesign.design_id)}
                          disabled={actionLoading}
                          className="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 disabled:opacity-50"
                        >
                          ✅ Duyệt
                        </button>
                        <button
                          onClick={() => rejectDesign(selectedDesign.design_id)}
                          disabled={actionLoading}
                          className="flex-1 bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 disabled:opacity-50"
                        >
                          ❌ Từ chối
                        </button>
                      </div>
                    </>
                  )}

                  {selectedDesign.admin_notes && (
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h3 className="font-semibold text-yellow-800">📝 Ghi chú Admin</h3>
                      <p className="text-yellow-700 mt-1">{selectedDesign.admin_notes}</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}




################################################################################
## FILE 120: page.tsx
## Path: fontend/src/app/admin/templates/page.tsx
################################################################################

'use client';

import React, { useState, useEffect, useRef } from 'react';
import Link from 'next/link';
import { 
  ArrowLeft, Plus, Pencil, Trash2, Save, X, Upload, 
  Smartphone, Check, AlertCircle, Image as ImageIcon
} from 'lucide-react';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

interface PhoneTemplate {
  template_id: number;
  phone_model: string;
  brand: string;
  template_image_url: string | null;
  print_width_mm: number;
  print_height_mm: number;
  canvas_width: number;
  canvas_height: number;
  is_active: boolean;
  created_at?: string;
}

const BRANDS = ['Apple', 'Samsung', 'Xiaomi', 'OPPO', 'Vivo', 'Realme', 'OnePlus', 'Google', 'Huawei', 'Other'];

export default function AdminTemplatesPage() {
  const [templates, setTemplates] = useState<PhoneTemplate[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [showModal, setShowModal] = useState(false);
  const [editingTemplate, setEditingTemplate] = useState<PhoneTemplate | null>(null);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [previewImage, setPreviewImage] = useState<string | null>(null);
  
  const [formData, setFormData] = useState({
    phone_model: '',
    brand: 'Apple',
    template_image_url: '',
    print_width_mm: 70,
    print_height_mm: 150,
    canvas_width: 700,
    canvas_height: 1500,
    is_active: true,
  });

  // Load templates
  useEffect(() => {
    loadTemplates();
  }, []);

  const loadTemplates = async () => {
    setLoading(true);
    try {
      const response = await fetch(`${API_URL}/designs/templates`);
      const result = await response.json();
      
      let data = result;
      if (result?.data) {
        data = result.data;
      }
      
      if (Array.isArray(data)) {
        setTemplates(data);
      }
    } catch (error) {
      console.error('Error loading templates:', error);
      showMessage('error', 'Không thể tải danh sách templates');
    } finally {
      setLoading(false);
    }
  };

  const showMessage = (type: 'success' | 'error', text: string) => {
    setMessage({ type, text });
    setTimeout(() => setMessage(null), 3000);
  };

  const openAddModal = () => {
    setEditingTemplate(null);
    setFormData({
      phone_model: '',
      brand: 'Apple',
      template_image_url: '',
      print_width_mm: 70,
      print_height_mm: 150,
      canvas_width: 700,
      canvas_height: 1500,
      is_active: true,
    });
    setPreviewImage(null);
    setShowModal(true);
  };

  const openEditModal = (template: PhoneTemplate) => {
    setEditingTemplate(template);
    setFormData({
      phone_model: template.phone_model,
      brand: template.brand,
      template_image_url: template.template_image_url || '',
      print_width_mm: template.print_width_mm,
      print_height_mm: template.print_height_mm,
      canvas_width: template.canvas_width,
      canvas_height: template.canvas_height,
      is_active: template.is_active,
    });
    setPreviewImage(template.template_image_url);
    setShowModal(true);
  };

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Preview
    const reader = new FileReader();
    reader.onload = (event) => {
      const base64 = event.target?.result as string;
      setPreviewImage(base64);
      setFormData(prev => ({ ...prev, template_image_url: base64 }));
    };
    reader.readAsDataURL(file);
  };

  const handleSave = async () => {
    if (!formData.phone_model.trim()) {
      showMessage('error', 'Vui lòng nhập tên model điện thoại');
      return;
    }

    setSaving(true);
    try {
      const url = editingTemplate 
        ? `${API_URL}/designs/templates/${editingTemplate.template_id}`
        : `${API_URL}/designs/templates`;
      
      const method = editingTemplate ? 'PUT' : 'POST';
      
      // Chuẩn bị data để gửi
      const dataToSend = {
        ...formData,
        // Nếu template_image_url là URL cũ (không phải base64 mới), giữ nguyên
        template_image_url: formData.template_image_url || (editingTemplate?.template_image_url || ''),
      };
      
      console.log('Sending data:', dataToSend);
      
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend),
      });

      const result = await response.json();
      console.log('API Response:', result);

      if (!response.ok) {
        throw new Error(result.message || 'Failed to save template');
      }

      showMessage('success', editingTemplate ? 'Đã cập nhật template!' : 'Đã thêm template mới!');
      setShowModal(false);
      loadTemplates();
    } catch (error: any) {
      console.error('Error saving template:', error);
      showMessage('error', error.message || 'Không thể lưu template. Vui lòng thử lại.');
    } finally {
      setSaving(false);
    }
  };

  const handleDelete = async (templateId: number) => {
    if (!confirm('Bạn có chắc muốn xóa template này?')) return;

    try {
      const response = await fetch(`${API_URL}/designs/templates/${templateId}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Failed to delete template');
      }

      showMessage('success', 'Đã xóa template!');
      loadTemplates();
    } catch (error) {
      console.error('Error deleting template:', error);
      showMessage('error', 'Không thể xóa template');
    }
  };

  const toggleActive = async (template: PhoneTemplate) => {
    try {
      const response = await fetch(`${API_URL}/designs/templates/${template.template_id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...template, is_active: !template.is_active }),
      });

      if (!response.ok) {
        throw new Error('Failed to update template');
      }

      loadTemplates();
    } catch (error) {
      console.error('Error updating template:', error);
      showMessage('error', 'Không thể cập nhật trạng thái');
    }
  };

  return (
    <div className="min-h-screen bg-gray-100">
      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Link href="/admin" className="text-gray-600 hover:text-pink-600 transition">
              <ArrowLeft className="w-6 h-6" />
            </Link>
            <h1 className="text-xl font-bold text-gray-900">Quản Lý Phone Templates</h1>
          </div>
          <button
            onClick={openAddModal}
            className="flex items-center gap-2 px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
          >
            <Plus className="w-5 h-5" />
            Thêm Template
          </button>
        </div>
      </header>

      {/* Message */}
      {message && (
        <div className={`fixed top-20 right-4 z-50 px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
          message.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`}>
          {message.type === 'success' ? <Check className="w-5 h-5" /> : <AlertCircle className="w-5 h-5" />}
          {message.text}
        </div>
      )}

      {/* Content */}
      <main className="max-w-7xl mx-auto px-4 py-8">
        {loading ? (
          <div className="flex justify-center py-20">
            <div className="w-12 h-12 border-4 border-pink-200 border-t-pink-600 rounded-full animate-spin"></div>
          </div>
        ) : templates.length === 0 ? (
          <div className="text-center py-20 bg-white rounded-xl shadow">
            <Smartphone className="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-semibold text-gray-700 mb-2">Chưa có template nào</h3>
            <p className="text-gray-500 mb-6">Bắt đầu bằng cách thêm template đầu tiên</p>
            <button
              onClick={openAddModal}
              className="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
            >
              Thêm Template
            </button>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {templates.map(template => (
              <div 
                key={template.template_id}
                className={`bg-white rounded-xl shadow-sm overflow-hidden border-2 transition ${
                  template.is_active ? 'border-transparent' : 'border-red-200 opacity-60'
                }`}
              >
                {/* Image */}
                <div className="aspect-square bg-gradient-to-br from-gray-100 to-gray-200 relative">
                  {template.template_image_url ? (
                    <img 
                      src={template.template_image_url}
                      alt={template.phone_model}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center">
                      <Smartphone className="w-20 h-20 text-gray-300" />
                    </div>
                  )}
                  
                  {/* Status badge */}
                  <div className={`absolute top-2 right-2 px-2 py-1 rounded-full text-xs font-semibold ${
                    template.is_active ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                  }`}>
                    {template.is_active ? 'Đang hiển thị' : 'Đã ẩn'}
                  </div>
                </div>

                {/* Info */}
                <div className="p-4">
                  <div className="flex items-center gap-2 mb-1">
                    <span className="text-xs px-2 py-0.5 bg-pink-100 text-pink-600 rounded-full font-medium">
                      {template.brand}
                    </span>
                  </div>
                  <h3 className="font-bold text-gray-900">{template.phone_model}</h3>
                  <p className="text-sm text-gray-500 mt-1">
                    {template.print_width_mm} × {template.print_height_mm} mm
                  </p>
                  <p className="text-xs text-gray-400 mt-1">
                    Canvas: {template.canvas_width} × {template.canvas_height} px
                  </p>

                  {/* Actions */}
                  <div className="flex gap-2 mt-4">
                    <button
                      onClick={() => toggleActive(template)}
                      className={`flex-1 py-2 rounded-lg text-sm font-medium transition ${
                        template.is_active 
                          ? 'bg-gray-100 text-gray-700 hover:bg-gray-200' 
                          : 'bg-green-100 text-green-700 hover:bg-green-200'
                      }`}
                    >
                      {template.is_active ? 'Ẩn' : 'Hiện'}
                    </button>
                    <button
                      onClick={() => openEditModal(template)}
                      className="flex-1 py-2 bg-blue-100 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-200 transition"
                    >
                      <Pencil className="w-4 h-4 mx-auto" />
                    </button>
                    <button
                      onClick={() => handleDelete(template.template_id)}
                      className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-medium hover:bg-red-200 transition"
                    >
                      <Trash2 className="w-4 h-4 mx-auto" />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </main>

      {/* Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
              <h2 className="text-xl font-bold text-gray-900">
                {editingTemplate ? 'Sửa Template' : 'Thêm Template Mới'}
              </h2>
              <button onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">
                <X className="w-6 h-6" />
              </button>
            </div>

            <div className="p-6 space-y-5">
              {/* Image Upload */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Ảnh Template</label>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageUpload}
                  className="hidden"
                />
                <div 
                  onClick={() => fileInputRef.current?.click()}
                  className="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center cursor-pointer hover:border-pink-500 hover:bg-pink-50 transition"
                >
                  {previewImage ? (
                    <div className="relative">
                      <img 
                        src={previewImage} 
                        alt="Preview" 
                        className="w-32 h-32 object-cover rounded-lg mx-auto"
                      />
                      <p className="text-sm text-gray-500 mt-2">Click để thay đổi ảnh</p>
                    </div>
                  ) : (
                    <>
                      <Upload className="w-10 h-10 text-gray-400 mx-auto mb-2" />
                      <p className="text-sm text-gray-600">Click để upload ảnh</p>
                      <p className="text-xs text-gray-400 mt-1">PNG, JPG tối đa 5MB</p>
                    </>
                  )}
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  Hoặc nhập URL ảnh:
                </p>
                <input
                  type="text"
                  value={formData.template_image_url?.startsWith('data:') ? '' : formData.template_image_url}
                  onChange={(e) => {
                    setFormData(prev => ({ ...prev, template_image_url: e.target.value }));
                    if (e.target.value && !e.target.value.startsWith('data:')) {
                      setPreviewImage(e.target.value);
                    }
                  }}
                  placeholder="/templates/iphone15.jpg hoặc https://..."
                  className="mt-2 w-full px-3 py-2 border rounded-lg text-sm"
                />
              </div>

              {/* Phone Model */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tên Model <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.phone_model}
                  onChange={(e) => setFormData(prev => ({ ...prev, phone_model: e.target.value }))}
                  placeholder="VD: iPhone 15 Pro Max"
                  className="w-full px-3 py-2 border rounded-lg"
                />
              </div>

              {/* Brand */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Hãng</label>
                <select
                  value={formData.brand}
                  onChange={(e) => setFormData(prev => ({ ...prev, brand: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg"
                >
                  {BRANDS.map(brand => (
                    <option key={brand} value={brand}>{brand}</option>
                  ))}
                </select>
              </div>

              {/* Dimensions */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Chiều rộng in (mm)</label>
                  <input
                    type="number"
                    value={formData.print_width_mm}
                    onChange={(e) => setFormData(prev => ({ ...prev, print_width_mm: parseFloat(e.target.value) || 0 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                    step="0.1"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Chiều cao in (mm)</label>
                  <input
                    type="number"
                    value={formData.print_height_mm}
                    onChange={(e) => setFormData(prev => ({ ...prev, print_height_mm: parseFloat(e.target.value) || 0 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                    step="0.1"
                  />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Canvas Width (px)</label>
                  <input
                    type="number"
                    value={formData.canvas_width}
                    onChange={(e) => setFormData(prev => ({ ...prev, canvas_width: parseInt(e.target.value) || 700 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Canvas Height (px)</label>
                  <input
                    type="number"
                    value={formData.canvas_height}
                    onChange={(e) => setFormData(prev => ({ ...prev, canvas_height: parseInt(e.target.value) || 1500 }))}
                    className="w-full px-3 py-2 border rounded-lg"
                  />
                </div>
              </div>

              {/* Active Toggle */}
              <div className="flex items-center gap-3">
                <input
                  type="checkbox"
                  id="is_active"
                  checked={formData.is_active}
                  onChange={(e) => setFormData(prev => ({ ...prev, is_active: e.target.checked }))}
                  className="w-5 h-5 text-pink-600 rounded"
                />
                <label htmlFor="is_active" className="text-sm font-medium text-gray-700">
                  Hiển thị trên trang thiết kế
                </label>
              </div>
            </div>

            {/* Footer */}
            <div className="sticky bottom-0 bg-gray-50 border-t px-6 py-4 flex gap-3">
              <button
                onClick={() => setShowModal(false)}
                className="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition"
              >
                Hủy
              </button>
              <button
                onClick={handleSave}
                disabled={saving}
                className="flex-1 py-2 bg-pink-600 text-white rounded-lg font-medium hover:bg-pink-700 transition disabled:opacity-50 flex items-center justify-center gap-2"
              >
                {saving ? (
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                ) : (
                  <Save className="w-5 h-5" />
                )}
                {saving ? 'Đang lưu...' : 'Lưu'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}




################################################################################
## FILE 121: page.tsx
## Path: fontend/src/app/api-test/page.tsx
################################################################################

'use client';

import { useEffect, useState } from 'react';
import {
  fetchUsers,
  fetchProducts,
  fetchOrders,
  fetchCategories,
} from '@/lib/api-client';

export default function ApiTest() {
  const [customers, setCustomers] = useState<any>(null);
  const [products, setProducts] = useState<any>(null);
  const [orders, setOrders] = useState<any>(null);
  const [categories, setCategories] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleFetchUsers = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchUsers();
      setCustomers(data);
    } catch (err: any) {
      setError(err.message || 'Lỗi khi gọi API');
    } finally {
      setLoading(false);
    }
  };

  const handleFetchProducts = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchProducts(5);
      setProducts(data);
    } catch (err: any) {
      setError(err.message || 'Lỗi khi gọi API');
    } finally {
      setLoading(false);
    }
  };

  const handleFetchOrders = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchOrders(10);
      setOrders(data);
    } catch (err: any) {
      setError(err.message || 'Lỗi khi gọi API');
    } finally {
      setLoading(false);
    }
  };

  const handleFetchCategories = async () => {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchCategories();
      setCategories(data);
    } catch (err: any) {
      setError(err.message || 'Lỗi khi gọi API');
    } finally {
      setLoading(false);
    }
  };

  return (
    <main className="min-h-screen bg-gray-100 p-8">
      <div className="max-w-4xl mx-auto">
        <h1 className="text-3xl font-bold mb-8">Test API Backend</h1>

        {/* Error Display */}
        {error && (
          <div className="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
            <strong>Lỗi:</strong> {error}
          </div>
        )}

        {/* Loading State */}
        {loading && (
          <div className="mb-4 p-4 bg-blue-100 border border-blue-400 text-blue-700 rounded">
            Đang tải...
          </div>
        )}

        {/* Buttons */}
        <div className="grid grid-cols-2 gap-4 mb-8">
          <button
            onClick={handleFetchUsers}
            disabled={loading}
            className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Lấy Khách Hàng
          </button>
          <button
            onClick={handleFetchProducts}
            disabled={loading}
            className="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Lấy Sản Phẩm
          </button>
          <button
            onClick={handleFetchOrders}
            disabled={loading}
            className="bg-purple-500 hover:bg-purple-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Lấy Đơn Hàng
          </button>
          <button
            onClick={handleFetchCategories}
            disabled={loading}
            className="bg-orange-500 hover:bg-orange-600 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded"
          >
            Lấy Danh Mục
          </button>
        </div>

        {/* Results */}
        <div className="space-y-6">
          {customers && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Khách Hàng</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(customers, null, 2)}
              </pre>
            </div>
          )}

          {products && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Sản Phẩm</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(products, null, 2)}
              </pre>
            </div>
          )}

          {orders && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Đơn Hàng</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(orders, null, 2)}
              </pre>
            </div>
          )}

          {categories && (
            <div className="bg-white rounded-lg shadow p-6">
              <h2 className="text-xl font-bold mb-4">Danh Mục</h2>
              <pre className="bg-gray-100 p-4 rounded overflow-auto text-sm">
                {JSON.stringify(categories, null, 2)}
              </pre>
            </div>
          )}
        </div>
      </div>
    </main>
  );
}




################################################################################
## FILE 122: wishlist-context.tsx
## Path: fontend/src/app/context/wishlist-context.tsx
################################################################################

'use client';

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  useCallback,
} from 'react';
import { 
  fetchWishlistProductIds, 
  toggleWishlist as apiToggleWishlist,
  fetchWishlist as apiFetchWishlist 
} from '@/lib/api-client';

interface WishlistItem {
  wishlist_id: number;
  product_id: number;
  created_at: string;
  products: {
    product_id: number;
    product_name: string;
    price: number;
    sale_price?: number;
    image_url: string;
    description: string;
  };
}

interface WishlistContextType {
  // Danh sách product_id đã yêu thích
  wishedProducts: Set<number>;
  
  // Danh sách chi tiết sản phẩm yêu thích
  wishlistItems: WishlistItem[];
  
  // Loading state
  loading: boolean;
  
  // Kiểm tra sản phẩm có trong wishlist
  isWished: (productId: number) => boolean;
  
  // Toggle yêu thích - return true nếu thành công
  toggleWishlist: (productId: number) => Promise<boolean>;
  
  // Refresh danh sách từ server
  refreshWishlist: () => Promise<void>;
  
  // Số lượng sản phẩm yêu thích
  wishlistCount: number;
}

const WishlistContext = createContext<WishlistContextType | undefined>(undefined);

export const WishlistProvider = ({
  children,
}: {
  children: React.ReactNode;
}) => {
  const [wishedProducts, setWishedProducts] = useState<Set<number>>(new Set());
  const [wishlistItems, setWishlistItems] = useState<WishlistItem[]>([]);
  const [loading, setLoading] = useState(false);

  /**
   * 🔄 Đồng bộ danh sách yêu thích từ backend
   */
  const refreshWishlist = useCallback(async () => {
    try {
      setLoading(true);
      
      // Lấy danh sách product_id
      const productIds = await fetchWishlistProductIds();
      console.log('📋 Wishlist productIds:', productIds);
      setWishedProducts(new Set(productIds));
      
      // Lấy chi tiết sản phẩm
      const items = await apiFetchWishlist();
      console.log('📋 Wishlist items:', items);
      setWishlistItems(items || []);
    } catch (error) {
      console.error('❌ refreshWishlist failed:', error);
    } finally {
      setLoading(false);
    }
  }, []);

  /**
   *  Kiểm tra sản phẩm có trong danh sách yêu thích
   */
  const isWished = useCallback((productId: number): boolean => {
    return wishedProducts.has(productId);
  }, [wishedProducts]);

  /**
   *  Toggle yêu thích sản phẩm
   * @returns true nếu thành công, false nếu chưa đăng nhập
   */
  const toggleWishlist = useCallback(async (productId: number): Promise<boolean> => {
    try {
      // Kiểm tra đăng nhập
      const customerData = localStorage.getItem('customer');
      if (!customerData) {
        return false; // Chưa đăng nhập
      }

      // Optimistic update (cập nhật UI trước)
      setWishedProducts(prev => {
        const next = new Set(prev);
        if (next.has(productId)) {
          next.delete(productId);
        } else {
          next.add(productId);
        }
        return next;
      });

      // Gọi API
      const result = await apiToggleWishlist(productId);
      console.log('Toggle wishlist result:', result);
      
      // Refresh để đồng bộ với server
      await refreshWishlist();
      return true;
    } catch (error) {
      console.error('❌ toggleWishlist failed:', error);
      // Rollback nếu lỗi
      await refreshWishlist();
      return false;
    }
  }, [refreshWishlist]);

  /**
   *  Load wishlist lần đầu khi app mount
   */
  useEffect(() => {
    // Chỉ load nếu đã đăng nhập
    const customerData = localStorage.getItem('customer');
    if (customerData) {
      refreshWishlist();
    }
  }, [refreshWishlist]);

  // Lắng nghe sự kiện login/logout (từ tab khác)
  useEffect(() => {
    const handleStorageChange = () => {
      const customerData = localStorage.getItem('customer');
      if (customerData) {
        refreshWishlist();
      } else {
        setWishedProducts(new Set());
        setWishlistItems([]);
      }
    };

    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, [refreshWishlist]);

  // Lắng nghe custom event khi login/logout trong cùng tab
  useEffect(() => {
    const handleAuthChange = () => {
      const customerData = localStorage.getItem('customer');
      if (customerData) {
        console.log('🔄 Auth changed - refreshing wishlist');
        refreshWishlist();
      } else {
        console.log('🔄 Auth changed - clearing wishlist');
        setWishedProducts(new Set());
        setWishlistItems([]);
      }
    };

    window.addEventListener('authChange', handleAuthChange);
    return () => window.removeEventListener('authChange', handleAuthChange);
  }, [refreshWishlist]);

  return (
    <WishlistContext.Provider
      value={{
        wishedProducts,
        wishlistItems,
        loading,
        isWished,
        toggleWishlist,
        refreshWishlist,
        wishlistCount: wishedProducts.size,
      }}
    >
      {children}
    </WishlistContext.Provider>
  );
};

/**
 * 🔐 Hook an toàn
 */
export const useWishlist = () => {
  const context = useContext(WishlistContext);
  if (context === undefined) {
    throw new Error('useWishlist must be used within a WishlistProvider');
  }
  return context;
};




################################################################################
## FILE 123: cart-context.tsx
## Path: fontend/src/app/context/cart-context.tsx
################################################################################

'use client';

import React, {
  createContext,
  useContext,
  useEffect,
  useState,
  useCallback,
} from 'react';
import { fetchShoppingCart } from '@/lib/api-client';

interface CartContextType {
  cartCount: number;

  // Sync với backend
  refreshCart: () => Promise<void>;

  // Local update (UX mượt)
  increaseCart: (qty?: number) => void;
  decreaseCart: (qty?: number) => void;
  clearCart: () => void;
}

const CartContext = createContext<CartContextType | undefined>(undefined);

export const CartProvider = ({
  children,
}: {
  children: React.ReactNode;
}) => {
  const [cartCount, setCartCount] = useState(0);

  /**
   * 🔄 Đồng bộ giỏ hàng từ backend
   */
  const refreshCart = useCallback(async () => {
    try {
      const result = await fetchShoppingCart();

      if (result?.success && Array.isArray(result.data)) {
        const total = result.data.reduce(
          (sum: number, item: any) => sum + (item.quantity || 0),
          0,
        );
        setCartCount(total);
      } else {
        setCartCount(0);
      }
    } catch (error) {
      console.error('❌ refreshCart failed:', error);
    }
  }, []);

  /**
   * ➕ Tăng số lượng ngay (UX)
   */
  const increaseCart = useCallback((qty: number = 1) => {
    setCartCount(prev => Math.max(prev + qty, 0));
  }, []);

  /**
   * ➖ Giảm số lượng
   */
  const decreaseCart = useCallback((qty: number = 1) => {
    setCartCount(prev => Math.max(prev - qty, 0));
  }, []);

  /**
   * Clear cart (sau checkout / logout)
   */
  const clearCart = useCallback(() => {
    setCartCount(0);
  }, []);

  /**
   * Load cart lần đầu khi app mount
   */
  useEffect(() => {
    refreshCart();
  }, [refreshCart]);

  /**
   *  Lắng nghe event cartUpdated để cập nhật ngay khi thêm vào giỏ
   */
  useEffect(() => {
    const handleCartUpdated = () => {
      refreshCart();
    };

    window.addEventListener('cartUpdated', handleCartUpdated);
    
    return () => {
      window.removeEventListener('cartUpdated', handleCartUpdated);
    };
  }, [refreshCart]);

  return (
    <CartContext.Provider
      value={{
        cartCount,
        refreshCart,
        increaseCart,
        decreaseCart,
        clearCart,
      }}
    >
      {children}
    </CartContext.Provider>
  );
};

/**
 * 🔐 Hook an toàn
 */
export const useCart = () => {
  const context = useContext(CartContext);
  if (!context) {
    throw new Error('useCart must be used within CartProvider');
  }
  return context;
};




################################################################################
## FILE 124: page.tsx
## Path: fontend/src/app/design/page.tsx
################################################################################

'use client';

import React, { useState, useEffect, useRef, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { 
  Upload, Type, Image as ImageIcon, RotateCcw, RotateCw, 
  Trash2, Download, Send, Save, ZoomIn, ZoomOut, 
  Move, Smartphone, ChevronLeft, ChevronRight, Palette,
  AlignCenter, AlignLeft, AlignRight, Bold, Italic, Underline,
  Layers, Eye, EyeOff, Copy, FlipHorizontal, FlipVertical,
  Undo, Redo, Grid, Lock, Unlock, Home
} from 'lucide-react';
import { Canvas as FabricCanvas, FabricImage, FabricText, Rect, Circle, IText } from 'fabric';
import { useAuth } from '@/contexts/AuthContext';
import { getPhoneTemplates, createDesign, updateDesign, submitDesign } from '@/lib/api-client';

// Types
interface PhoneTemplate {
  template_id: number;
  phone_model: string;
  brand: string;
  template_image_url: string;
  print_width_mm: number;
  print_height_mm: number;
  canvas_width: number;
  canvas_height: number;
  is_active: boolean;
}

interface DesignState {
  designId: number | null;
  phoneModel: string;
  templateId: number | null;
  status: 'draft' | 'submitted' | 'processing' | 'approved' | 'rejected';
}

export default function DesignPage() {
  const router = useRouter();
  const { user, isAuthenticated } = useAuth();
  
  // Refs
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const fabricRef = useRef<FabricCanvas | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  
  // State
  const [templates, setTemplates] = useState<PhoneTemplate[]>([]);
  const [loadingTemplates, setLoadingTemplates] = useState(true);
  const [selectedTemplate, setSelectedTemplate] = useState<PhoneTemplate | null>(null);
  const [designState, setDesignState] = useState<DesignState>({
    designId: null,
    phoneModel: '',
    templateId: null,
    status: 'draft'
  });
  
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [showTemplateSelector, setShowTemplateSelector] = useState(true);
  const [activeTab, setActiveTab] = useState<'upload' | 'text' | 'shapes' | 'layers'>('upload');
  const [selectedObject, setSelectedObject] = useState<any>(null);
  const [zoom, setZoom] = useState(0.4);
  const [history, setHistory] = useState<string[]>([]);
  const [historyIndex, setHistoryIndex] = useState(-1);
  
  // Text settings
  const [textSettings, setTextSettings] = useState({
    text: 'Nhập text',
    fontFamily: 'Arial',
    fontSize: 40,
    fill: '#000000',
    fontWeight: 'normal',
    fontStyle: 'normal',
    textAlign: 'center',
    underline: false
  });
  
  // Guest info (for non-logged in users)
  const [guestInfo, setGuestInfo] = useState({
    name: '',
    email: '',
    phone: ''
  });
  
  // Load templates from API
  useEffect(() => {
    const loadTemplates = async () => {
      setLoadingTemplates(true);
      try {
        const response = await getPhoneTemplates();
        console.log('API Response:', response);
        
        // Handle response format { data, error } from backend
        let templatesData = response;
        if (response?.data) {
          templatesData = response.data;
        }
        
        if (templatesData && Array.isArray(templatesData) && templatesData.length > 0) {
          setTemplates(templatesData);
        } else {
          console.warn('No templates found in API response');
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      } finally {
        setLoadingTemplates(false);
      }
    };
    loadTemplates();
  }, []);
  
  // Initialize Fabric.js canvas
  useEffect(() => {
    if (!canvasRef.current || !selectedTemplate || fabricRef.current) return;
    
    const canvas = new FabricCanvas(canvasRef.current, {
      width: selectedTemplate.canvas_width,
      height: selectedTemplate.canvas_height,
      backgroundColor: '#ffffff',
      selection: true,
      preserveObjectStacking: true,
    });
    
    fabricRef.current = canvas;
    
    // Event listeners
    canvas.on('selection:created', (e) => {
      setSelectedObject(e.selected?.[0] || null);
    });
    
    canvas.on('selection:updated', (e) => {
      setSelectedObject(e.selected?.[0] || null);
    });
    
    canvas.on('selection:cleared', () => {
      setSelectedObject(null);
    });
    
    canvas.on('object:modified', () => {
      saveToHistory();
    });
    
    // Add phone template overlay
    addTemplateOverlay(canvas, selectedTemplate);
    
    // Initial zoom
    updateZoom(0.4);
    
    // Save initial state
    saveToHistory();
    
    return () => {
      canvas.dispose();
      fabricRef.current = null;
    };
  }, [selectedTemplate]);
  
  // Add template overlay (phone frame)
  const addTemplateOverlay = async (canvas: FabricCanvas, template: PhoneTemplate) => {
    const cw = template.canvas_width;
    const ch = template.canvas_height;
    
    // Load template image if available
    if (template.template_image_url) {
      try {
        const img = await FabricImage.fromURL(template.template_image_url, { crossOrigin: 'anonymous' });
        // Scale to fit canvas while maintaining aspect ratio
        const scale = Math.min(cw / (img.width || cw), ch / (img.height || ch)) * 0.9;
        img.scale(scale);
        img.set({
          left: cw / 2,
          top: ch / 2,
          originX: 'center',
          originY: 'center',
          selectable: false,
          evented: false,
          opacity: 0.3,
          name: 'phoneFrame'
        });
        canvas.add(img);
        canvas.sendObjectToBack(img);
      } catch (e) {
        console.log('Could not load template image');
      }
    }
    
    // Calculate safe print area (with padding for phone edges)
    const paddingX = cw * 0.05; // 5% padding on each side
    const paddingTop = ch * 0.08; // 8% padding top (for camera notch)
    const paddingBottom = ch * 0.05; // 5% padding bottom
    
    // Create safe area indicator
    const safeAreaRect = new Rect({
      left: paddingX,
      top: paddingTop,
      width: cw - (paddingX * 2),
      height: ch - paddingTop - paddingBottom,
      fill: 'transparent',
      stroke: '#e91e63',
      strokeWidth: 2,
      strokeDashArray: [10, 5],
      selectable: false,
      evented: false,
      name: 'safeArea'
    });
    
    canvas.add(safeAreaRect);
    
    // Add camera notch indicator for iPhones
    if (template.phone_model.toLowerCase().includes('iphone')) {
      const notchWidth = cw * 0.3;
      const notchHeight = ch * 0.03;
      const notch = new Rect({
        left: (cw - notchWidth) / 2,
        top: 10,
        width: notchWidth,
        height: notchHeight,
        fill: '#00000020',
        rx: notchHeight / 2,
        ry: notchHeight / 2,
        selectable: false,
        evented: false,
        name: 'phoneFrame'
      });
      canvas.add(notch);
    }
    
    // Add phone model label
    const label = new FabricText(template.phone_model, {
      left: cw / 2,
      top: ch * 0.04,
      fontSize: 20,
      fill: '#999999',
      fontFamily: 'Arial',
      originX: 'center',
      selectable: false,
      evented: false,
      name: 'phoneLabel'
    });
    
    canvas.add(label);
    
    // Add size info label
    const sizeLabel = new FabricText(`${template.print_width_mm} × ${template.print_height_mm} mm`, {
      left: cw / 2,
      top: ch - 25,
      fontSize: 14,
      fill: '#cccccc',
      fontFamily: 'Arial',
      originX: 'center',
      selectable: false,
      evented: false,
      name: 'phoneLabel'
    });
    
    canvas.add(sizeLabel);
    canvas.renderAll();
  };
  
  // Save to history for undo/redo
  const saveToHistory = useCallback(() => {
    if (!fabricRef.current) return;
    
    const json = JSON.stringify(fabricRef.current.toJSON());
    const newHistory = history.slice(0, historyIndex + 1);
    newHistory.push(json);
    
    // Limit history to 50 states
    if (newHistory.length > 50) {
      newHistory.shift();
    }
    
    setHistory(newHistory);
    setHistoryIndex(newHistory.length - 1);
  }, [history, historyIndex]);
  
  // Undo
  const undo = useCallback(() => {
    if (historyIndex <= 0 || !fabricRef.current) return;
    
    const newIndex = historyIndex - 1;
    fabricRef.current.loadFromJSON(JSON.parse(history[newIndex]), () => {
      fabricRef.current?.renderAll();
      setHistoryIndex(newIndex);
    });
  }, [history, historyIndex]);
  
  // Redo
  const redo = useCallback(() => {
    if (historyIndex >= history.length - 1 || !fabricRef.current) return;
    
    const newIndex = historyIndex + 1;
    fabricRef.current.loadFromJSON(JSON.parse(history[newIndex]), () => {
      fabricRef.current?.renderAll();
      setHistoryIndex(newIndex);
    });
  }, [history, historyIndex]);
  
  // Update zoom
  const updateZoom = (newZoom: number) => {
    if (!fabricRef.current || !containerRef.current) return;
    
    const clampedZoom = Math.max(0.1, Math.min(2, newZoom));
    setZoom(clampedZoom);
    
    fabricRef.current.setZoom(clampedZoom);
    fabricRef.current.setDimensions({
      width: (selectedTemplate?.canvas_width || 700) * clampedZoom,
      height: (selectedTemplate?.canvas_height || 1500) * clampedZoom
    });
    fabricRef.current.renderAll();
  };
  
  // Handle image upload
  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || !fabricRef.current) return;
    
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = async (event) => {
        const imgUrl = event.target?.result as string;
        
        try {
          const img = await FabricImage.fromURL(imgUrl, { crossOrigin: 'anonymous' });
          
          // Scale image to fit canvas
          const canvas = fabricRef.current!;
          const maxWidth = canvas.width! * 0.8;
          const maxHeight = canvas.height! * 0.5;
          
          const scale = Math.min(
            maxWidth / (img.width || 100),
            maxHeight / (img.height || 100)
          );
          
          img.scale(scale);
          img.set({
            left: (canvas.width! / 2) - ((img.width || 100) * scale / 2),
            top: (canvas.height! / 2) - ((img.height || 100) * scale / 2),
            cornerStyle: 'circle',
            cornerColor: '#e91e63',
            cornerStrokeColor: '#ffffff',
            borderColor: '#e91e63',
            transparentCorners: false,
          });
          
          canvas.add(img);
          canvas.setActiveObject(img);
          canvas.renderAll();
          saveToHistory();
        } catch (error) {
          console.error('Error loading image:', error);
        }
      };
      reader.readAsDataURL(file);
    });
    
    // Reset input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };
  
  // Add text
  const addText = () => {
    if (!fabricRef.current) return;
    
    const text = new IText(textSettings.text, {
      left: fabricRef.current.width! / 2,
      top: fabricRef.current.height! / 2,
      fontSize: textSettings.fontSize,
      fontFamily: textSettings.fontFamily,
      fill: textSettings.fill,
      fontWeight: textSettings.fontWeight as any,
      fontStyle: textSettings.fontStyle as any,
      textAlign: textSettings.textAlign,
      underline: textSettings.underline,
      originX: 'center',
      originY: 'center',
      cornerStyle: 'circle',
      cornerColor: '#e91e63',
      cornerStrokeColor: '#ffffff',
      borderColor: '#e91e63',
      transparentCorners: false,
    });
    
    fabricRef.current.add(text);
    fabricRef.current.setActiveObject(text);
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Add shape
  const addShape = (type: 'rect' | 'circle') => {
    if (!fabricRef.current) return;
    
    let shape;
    const centerX = fabricRef.current.width! / 2;
    const centerY = fabricRef.current.height! / 2;
    
    if (type === 'rect') {
      shape = new Rect({
        left: centerX - 75,
        top: centerY - 75,
        width: 150,
        height: 150,
        fill: '#e91e63',
        cornerStyle: 'circle',
        cornerColor: '#e91e63',
        borderColor: '#e91e63',
        transparentCorners: false,
      });
    } else {
      shape = new Circle({
        left: centerX - 75,
        top: centerY - 75,
        radius: 75,
        fill: '#e91e63',
        cornerStyle: 'circle',
        cornerColor: '#e91e63',
        borderColor: '#e91e63',
        transparentCorners: false,
      });
    }
    
    fabricRef.current.add(shape);
    fabricRef.current.setActiveObject(shape);
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Delete selected object
  const deleteSelected = () => {
    if (!fabricRef.current || !selectedObject) return;
    
    // Don't delete system objects
    if (selectedObject.name === 'safeArea' || selectedObject.name === 'phoneLabel') return;
    
    fabricRef.current.remove(selectedObject);
    fabricRef.current.renderAll();
    setSelectedObject(null);
    saveToHistory();
  };
  
  // Rotate object
  const rotateObject = (angle: number) => {
    if (!fabricRef.current || !selectedObject) return;
    
    const currentAngle = selectedObject.angle || 0;
    selectedObject.rotate(currentAngle + angle);
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Flip object
  const flipObject = (direction: 'horizontal' | 'vertical') => {
    if (!fabricRef.current || !selectedObject) return;
    
    if (direction === 'horizontal') {
      selectedObject.set('flipX', !selectedObject.flipX);
    } else {
      selectedObject.set('flipY', !selectedObject.flipY);
    }
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Duplicate object
  const duplicateObject = () => {
    if (!fabricRef.current || !selectedObject) return;
    
    selectedObject.clone((cloned: any) => {
      cloned.set({
        left: (selectedObject.left || 0) + 20,
        top: (selectedObject.top || 0) + 20,
      });
      fabricRef.current!.add(cloned);
      fabricRef.current!.setActiveObject(cloned);
      fabricRef.current!.renderAll();
      saveToHistory();
    });
  };
  
  // Bring to front / Send to back
  const changeLayer = (action: 'front' | 'back') => {
    if (!fabricRef.current || !selectedObject) return;
    
    if (action === 'front') {
      fabricRef.current.bringObjectToFront(selectedObject);
    } else {
      fabricRef.current.sendObjectToBack(selectedObject);
    }
    fabricRef.current.renderAll();
    saveToHistory();
  };
  
  // Export canvas to base64
  const exportCanvas = (): string => {
    if (!fabricRef.current) return '';
    
    // Temporarily remove system objects for export
    const objects = fabricRef.current.getObjects();
    const systemObjects = objects.filter(obj => 
      (obj as any).name === 'safeArea' || (obj as any).name === 'phoneLabel' || (obj as any).name === 'phoneFrame'
    );
    
    systemObjects.forEach(obj => fabricRef.current!.remove(obj));
    
    const dataUrl = fabricRef.current.toDataURL({
      format: 'jpeg',
      quality: 0.8,
      multiplier: 1, // Reduced to avoid large file size
    });
    
    // Re-add system objects
    systemObjects.forEach(obj => fabricRef.current!.add(obj));
    fabricRef.current.renderAll();
    
    return dataUrl;
  };
  
  // Get design data as JSON
  const getDesignData = () => {
    if (!fabricRef.current) return null;
    
    // Get canvas JSON without system objects
    const json = fabricRef.current.toJSON() as any;
    json.objects = json.objects.filter((obj: any) => 
      obj.name !== 'safeArea' && obj.name !== 'phoneLabel' && obj.name !== 'phoneFrame'
    );
    
    return {
      ...json,
      width: selectedTemplate?.canvas_width,
      height: selectedTemplate?.canvas_height,
    };
  };
  
  // Save design
  const handleSave = async () => {
    if (!fabricRef.current || !selectedTemplate) return;
    
    setSaving(true);
    try {
      const designData = getDesignData();
      const previewImage = exportCanvas();
      
      const payload = {
        userId: user?.id || undefined,
        guestEmail: !isAuthenticated ? guestInfo.email : undefined,
        guestName: !isAuthenticated ? guestInfo.name : undefined,
        guestPhone: !isAuthenticated ? guestInfo.phone : undefined,
        templateId: selectedTemplate.template_id.toString(),
        phoneModel: selectedTemplate.phone_model,
        designData,
        previewImageBase64: previewImage,
      };
      
      let result: any;
      if (designState.designId) {
        result = await updateDesign(designState.designId.toString(), {
          designData,
          previewImageBase64: previewImage,
        });
      } else {
        result = await createDesign(payload);
        if (result?.design?.design_id) {
          setDesignState(prev => ({
            ...prev,
            designId: result.design.design_id
          }));
        }
      }
      
      alert('Đã lưu thiết kế thành công!');
    } catch (error) {
      console.error('Error saving design:', error);
      alert('Có lỗi khi lưu thiết kế. Vui lòng thử lại!');
    } finally {
      setSaving(false);
    }
  };
  
  // Submit design
  const handleSubmit = async () => {
    if (!fabricRef.current || !selectedTemplate) return;
    
    // Validate guest info if not logged in
    if (!isAuthenticated) {
      if (!guestInfo.email || !guestInfo.name || !guestInfo.phone) {
        alert('Vui lòng nhập đầy đủ thông tin liên hệ!');
        return;
      }
    }
    
    setSaving(true);
    try {
      // First save the design
      const designData = getDesignData();
      const previewImage = exportCanvas();
      
      let designId = designState.designId;
      
      if (!designId) {
        const createResult = await createDesign({
          userId: user?.id || undefined,
          guestEmail: !isAuthenticated ? guestInfo.email : undefined,
          guestName: !isAuthenticated ? guestInfo.name : undefined,
          guestPhone: !isAuthenticated ? guestInfo.phone : undefined,
          templateId: selectedTemplate.template_id.toString(),
          phoneModel: selectedTemplate.phone_model,
          designData,
          previewImageBase64: previewImage,
        });
        designId = createResult.design?.design_id;
      } else {
        await updateDesign(designId.toString(), {
          designData,
          previewImageBase64: previewImage,
        });
      }
      
      if (!designId) {
        throw new Error('Không thể tạo thiết kế');
      }
      
      // Submit for review
      await submitDesign(designId.toString(), {
        guestEmail: !isAuthenticated ? guestInfo.email : undefined,
        guestName: !isAuthenticated ? guestInfo.name : undefined,
        guestPhone: !isAuthenticated ? guestInfo.phone : undefined,
      });
      
      setDesignState(prev => ({
        ...prev,
        designId,
        status: 'submitted'
      }));
      
      alert('Thiết kế đã được gửi! Admin sẽ xem xét và liên hệ với bạn.');
      
    } catch (error) {
      console.error('Error submitting design:', error);
      alert('Có lỗi khi gửi thiết kế. Vui lòng thử lại!');
    } finally {
      setSaving(false);
    }
  };
  
  // Download design
  const handleDownload = () => {
    if (!fabricRef.current) return;
    
    const dataUrl = exportCanvas();
    const link = document.createElement('a');
    link.download = `design-${selectedTemplate?.phone_model || 'custom'}-${Date.now()}.png`;
    link.href = dataUrl;
    link.click();
  };
  
  // Select template
  const handleSelectTemplate = (template: PhoneTemplate) => {
    setSelectedTemplate(template);
    setDesignState(prev => ({
      ...prev,
      phoneModel: template.phone_model,
      templateId: template.template_id
    }));
    setShowTemplateSelector(false);
  };
  
  // Template selector view
  if (showTemplateSelector) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-pink-50 via-purple-50 to-blue-50">
        {/* Header */}
        <header className="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
          <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <Link href="/" className="flex items-center gap-2 text-gray-600 hover:text-pink-600 transition">
              <Home className="w-5 h-5" />
              <span>Trang chủ</span>
            </Link>
            <h1 className="text-2xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
              🎨 Thiết Kế Ốp Điện Thoại
            </h1>
            <div className="w-24"></div>
          </div>
        </header>
        
        <div className="max-w-6xl mx-auto px-4 py-12">
          <div className="text-center mb-12">
            <h2 className="text-4xl font-bold text-gray-900 mb-4">
              Chọn Model Điện Thoại
            </h2>
            <p className="text-gray-600 text-lg">
              Bước đầu tiên: Chọn mẫu điện thoại để bắt đầu thiết kế ốp lưng độc đáo của bạn
            </p>
          </div>
          
          {/* Loading state */}
          {loadingTemplates && (
            <div className="flex flex-col items-center justify-center py-20">
              <div className="w-16 h-16 border-4 border-pink-200 border-t-pink-600 rounded-full animate-spin mb-4"></div>
              <p className="text-gray-600">Đang tải danh sách điện thoại...</p>
            </div>
          )}
          
          {/* Empty state */}
          {!loadingTemplates && templates.length === 0 && (
            <div className="text-center py-20">
              <Smartphone className="w-20 h-20 text-gray-300 mx-auto mb-4" />
              <h3 className="text-xl font-semibold text-gray-700 mb-2">Chưa có mẫu điện thoại nào</h3>
              <p className="text-gray-500 mb-6">Vui lòng liên hệ admin để thêm mẫu điện thoại vào hệ thống.</p>
              <button
                onClick={() => window.location.reload()}
                className="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
              >
                Thử lại
              </button>
            </div>
          )}
          
          {/* Group by brand */}
          {!loadingTemplates && templates.length > 0 && ['Apple', 'Samsung', 'Xiaomi', 'OPPO', 'Vivo', 'Realme', 'OnePlus', 'Google', 'Huawei', 'Other'].map(brand => {
            const brandTemplates = templates.filter(t => t.brand === brand || (brand === 'Other' && !['Apple', 'Samsung', 'Xiaomi', 'OPPO', 'Vivo', 'Realme', 'OnePlus', 'Google', 'Huawei'].includes(t.brand)));
            if (brandTemplates.length === 0) return null;
            
            return (
              <div key={brand} className="mb-10">
                <h3 className="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <Smartphone className="w-5 h-5 text-pink-600" />
                  {brand}
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5">
                  {brandTemplates.map(template => (
                    <button
                      key={template.template_id}
                      onClick={() => handleSelectTemplate(template)}
                      className="group bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 border-2 border-transparent hover:border-pink-500 transform hover:-translate-y-1"
                    >
                      <div className="relative aspect-square bg-gradient-to-br from-pink-50 via-white to-purple-50 overflow-hidden">
                        {template.template_image_url ? (
                          <img 
                            src={template.template_image_url} 
                            alt={template.phone_model}
                            className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                            onError={(e) => {
                              // Fallback to icon if image fails to load
                              (e.target as HTMLImageElement).style.display = 'none';
                              (e.target as HTMLImageElement).nextElementSibling?.classList.remove('hidden');
                            }}
                          />
                        ) : null}
                        <div className={`absolute inset-0 flex items-center justify-center ${template.template_image_url ? 'hidden' : ''}`}>
                          <Smartphone className="w-20 h-20 text-gray-300 group-hover:text-pink-400 transition-colors" />
                        </div>
                        {/* Overlay gradient on hover */}
                        <div className="absolute inset-0 bg-gradient-to-t from-black/40 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
                        {/* Select badge */}
                        <div className="absolute bottom-3 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-sm text-pink-600 px-4 py-1.5 rounded-full text-sm font-semibold opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0 shadow-lg">
                          Chọn mẫu này
                        </div>
                      </div>
                      <div className="p-4 text-center">
                        <h4 className="font-bold text-gray-900 group-hover:text-pink-600 transition-colors text-base">
                          {template.phone_model}
                        </h4>
                        <p className="text-xs text-gray-400 mt-1">
                          {template.print_width_mm} × {template.print_height_mm} mm
                        </p>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }
  
  // Design editor view
  return (
    <div className="min-h-screen bg-gray-100 flex flex-col">
      {/* Header */}
      <header className="bg-white shadow-sm z-50">
        <div className="max-w-full mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <button
              onClick={() => {
                if (confirm('Bạn có muốn chọn lại mẫu điện thoại? Thiết kế hiện tại sẽ bị mất nếu chưa lưu.')) {
                  fabricRef.current?.dispose();
                  fabricRef.current = null;
                  setShowTemplateSelector(true);
                  setSelectedTemplate(null);
                }
              }}
              className="flex items-center gap-2 text-gray-600 hover:text-pink-600 transition"
            >
              <ChevronLeft className="w-5 h-5" />
              <span className="hidden sm:inline">Đổi mẫu</span>
            </button>
            <div className="h-6 w-px bg-gray-300"></div>
            <div className="flex items-center gap-2">
              <Smartphone className="w-5 h-5 text-pink-600" />
              <span className="font-semibold text-gray-900">{selectedTemplate?.phone_model}</span>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            {/* Undo/Redo */}
            <button
              onClick={undo}
              disabled={historyIndex <= 0}
              className="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Hoàn tác"
            >
              <Undo className="w-5 h-5" />
            </button>
            <button
              onClick={redo}
              disabled={historyIndex >= history.length - 1}
              className="p-2 rounded-lg hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Làm lại"
            >
              <Redo className="w-5 h-5" />
            </button>
            
            <div className="h-6 w-px bg-gray-300 mx-2"></div>
            
            {/* Zoom controls */}
            <button
              onClick={() => updateZoom(zoom - 0.1)}
              className="p-2 rounded-lg hover:bg-gray-100"
              title="Thu nhỏ"
            >
              <ZoomOut className="w-5 h-5" />
            </button>
            <span className="text-sm font-medium w-14 text-center">{Math.round(zoom * 100)}%</span>
            <button
              onClick={() => updateZoom(zoom + 0.1)}
              className="p-2 rounded-lg hover:bg-gray-100"
              title="Phóng to"
            >
              <ZoomIn className="w-5 h-5" />
            </button>
            
            <div className="h-6 w-px bg-gray-300 mx-2"></div>
            
            {/* Action buttons */}
            <button
              onClick={handleDownload}
              className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition"
              title="Tải xuống"
            >
              <Download className="w-4 h-4" />
              <span className="hidden sm:inline">Tải xuống</span>
            </button>
            <button
              onClick={handleSave}
              disabled={saving}
              className="flex items-center gap-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition disabled:opacity-50"
            >
              <Save className="w-4 h-4" />
              <span className="hidden sm:inline">{saving ? 'Đang lưu...' : 'Lưu'}</span>
            </button>
            <button
              onClick={handleSubmit}
              disabled={saving}
              className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white rounded-lg transition disabled:opacity-50"
            >
              <Send className="w-4 h-4" />
              <span className="hidden sm:inline">{saving ? 'Đang gửi...' : 'Gửi thiết kế'}</span>
            </button>
          </div>
        </div>
      </header>
      
      <div className="flex flex-1 overflow-hidden">
        {/* Left Sidebar - Tools */}
        <aside className="w-72 bg-white shadow-lg overflow-y-auto">
          {/* Tabs */}
          <div className="flex border-b">
            {[
              { id: 'upload', icon: ImageIcon, label: 'Ảnh' },
              { id: 'text', icon: Type, label: 'Chữ' },
              { id: 'shapes', icon: Palette, label: 'Hình' },
              { id: 'layers', icon: Layers, label: 'Lớp' },
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex-1 py-3 flex flex-col items-center gap-1 text-xs font-medium transition ${
                  activeTab === tab.id
                    ? 'text-pink-600 border-b-2 border-pink-600 bg-pink-50'
                    : 'text-gray-500 hover:text-gray-700'
                }`}
              >
                <tab.icon className="w-5 h-5" />
                {tab.label}
              </button>
            ))}
          </div>
          
          <div className="p-4">
            {/* Upload Tab */}
            {activeTab === 'upload' && (
              <div className="space-y-4">
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  multiple
                  onChange={handleImageUpload}
                  className="hidden"
                />
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full py-8 border-2 border-dashed border-pink-300 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition flex flex-col items-center gap-2"
                >
                  <Upload className="w-8 h-8 text-pink-500" />
                  <span className="font-medium text-gray-700">Tải ảnh lên</span>
                  <span className="text-xs text-gray-500">PNG, JPG tối đa 10MB</span>
                </button>
                
                <p className="text-sm text-gray-500">
                  💡 <strong>Mẹo:</strong> Sử dụng ảnh có độ phân giải cao để kết quả in đẹp nhất!
                </p>
              </div>
            )}
            
            {/* Text Tab */}
            {activeTab === 'text' && (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Nội dung</label>
                  <textarea
                    value={textSettings.text}
                    onChange={(e) => setTextSettings(prev => ({ ...prev, text: e.target.value }))}
                    className="w-full px-3 py-2 border rounded-lg resize-none"
                    rows={2}
                    placeholder="Nhập nội dung..."
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Font chữ</label>
                  <select
                    value={textSettings.fontFamily}
                    onChange={(e) => setTextSettings(prev => ({ ...prev, fontFamily: e.target.value }))}
                    className="w-full px-3 py-2 border rounded-lg"
                  >
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Impact">Impact</option>
                    <option value="Comic Sans MS">Comic Sans MS</option>
                  </select>
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Cỡ chữ</label>
                    <input
                      type="number"
                      value={textSettings.fontSize}
                      onChange={(e) => setTextSettings(prev => ({ ...prev, fontSize: parseInt(e.target.value) || 40 }))}
                      className="w-full px-3 py-2 border rounded-lg"
                      min={10}
                      max={200}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Màu chữ</label>
                    <input
                      type="color"
                      value={textSettings.fill}
                      onChange={(e) => setTextSettings(prev => ({ ...prev, fill: e.target.value }))}
                      className="w-full h-10 border rounded-lg cursor-pointer"
                    />
                  </div>
                </div>
                
                {/* Text style buttons */}
                <div className="flex gap-2">
                  <button
                    onClick={() => setTextSettings(prev => ({ 
                      ...prev, 
                      fontWeight: prev.fontWeight === 'bold' ? 'normal' : 'bold' 
                    }))}
                    className={`flex-1 py-2 rounded-lg border transition ${
                      textSettings.fontWeight === 'bold' ? 'bg-pink-100 border-pink-500 text-pink-600' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Bold className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => setTextSettings(prev => ({ 
                      ...prev, 
                      fontStyle: prev.fontStyle === 'italic' ? 'normal' : 'italic' 
                    }))}
                    className={`flex-1 py-2 rounded-lg border transition ${
                      textSettings.fontStyle === 'italic' ? 'bg-pink-100 border-pink-500 text-pink-600' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Italic className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => setTextSettings(prev => ({ ...prev, underline: !prev.underline }))}
                    className={`flex-1 py-2 rounded-lg border transition ${
                      textSettings.underline ? 'bg-pink-100 border-pink-500 text-pink-600' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Underline className="w-4 h-4 mx-auto" />
                  </button>
                </div>
                
                <button
                  onClick={addText}
                  className="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg font-medium hover:from-pink-600 hover:to-purple-600 transition"
                >
                  + Thêm chữ
                </button>
              </div>
            )}
            
            {/* Shapes Tab */}
            {activeTab === 'shapes' && (
              <div className="space-y-4">
                <p className="text-sm text-gray-600">Thêm hình dạng vào thiết kế</p>
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => addShape('rect')}
                    className="aspect-square border-2 border-dashed border-gray-300 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition flex items-center justify-center"
                  >
                    <div className="w-12 h-12 bg-pink-500 rounded-lg"></div>
                  </button>
                  <button
                    onClick={() => addShape('circle')}
                    className="aspect-square border-2 border-dashed border-gray-300 rounded-xl hover:border-pink-500 hover:bg-pink-50 transition flex items-center justify-center"
                  >
                    <div className="w-12 h-12 bg-pink-500 rounded-full"></div>
                  </button>
                </div>
              </div>
            )}
            
            {/* Layers Tab */}
            {activeTab === 'layers' && (
              <div className="space-y-4">
                <p className="text-sm text-gray-600">Quản lý các lớp trong thiết kế</p>
                {fabricRef.current?.getObjects().filter(obj => 
                  (obj as any).name !== 'safeArea' && (obj as any).name !== 'phoneLabel'
                ).map((obj, index) => (
                  <div
                    key={index}
                    className={`flex items-center gap-3 p-3 rounded-lg border cursor-pointer transition ${
                      selectedObject === obj ? 'border-pink-500 bg-pink-50' : 'hover:bg-gray-50'
                    }`}
                    onClick={() => {
                      fabricRef.current?.setActiveObject(obj);
                      fabricRef.current?.renderAll();
                      setSelectedObject(obj);
                    }}
                  >
                    <div className="w-10 h-10 bg-gray-200 rounded flex items-center justify-center">
                      {obj.type === 'image' ? (
                        <ImageIcon className="w-5 h-5 text-gray-500" />
                      ) : obj.type === 'i-text' || obj.type === 'text' ? (
                        <Type className="w-5 h-5 text-gray-500" />
                      ) : (
                        <Palette className="w-5 h-5 text-gray-500" />
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900 truncate">
                        {obj.type === 'i-text' || obj.type === 'text' 
                          ? (obj as any).text?.substring(0, 20) || 'Text'
                          : obj.type === 'image' 
                            ? 'Hình ảnh'
                            : obj.type === 'rect'
                              ? 'Hình chữ nhật'
                              : 'Hình tròn'
                        }
                      </p>
                      <p className="text-xs text-gray-500">{obj.type}</p>
                    </div>
                  </div>
                ))}
                
                {fabricRef.current?.getObjects().filter(obj => 
                  (obj as any).name !== 'safeArea' && (obj as any).name !== 'phoneLabel'
                ).length === 0 && (
                  <p className="text-center text-gray-400 py-8">
                    Chưa có layer nào. Hãy thêm ảnh hoặc chữ!
                  </p>
                )}
              </div>
            )}
          </div>
          
          {/* Guest Info Form (if not logged in) */}
          {!isAuthenticated && (
            <div className="p-4 border-t bg-gray-50">
              <h3 className="font-semibold text-gray-900 mb-3">Thông tin liên hệ</h3>
              <div className="space-y-3">
                <input
                  type="text"
                  placeholder="Họ và tên *"
                  value={guestInfo.name}
                  onChange={(e) => setGuestInfo(prev => ({ ...prev, name: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
                <input
                  type="email"
                  placeholder="Email *"
                  value={guestInfo.email}
                  onChange={(e) => setGuestInfo(prev => ({ ...prev, email: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
                <input
                  type="tel"
                  placeholder="Số điện thoại *"
                  value={guestInfo.phone}
                  onChange={(e) => setGuestInfo(prev => ({ ...prev, phone: e.target.value }))}
                  className="w-full px-3 py-2 border rounded-lg text-sm"
                />
              </div>
            </div>
          )}
        </aside>
        
        {/* Canvas Area */}
        <main 
          ref={containerRef}
          className="flex-1 overflow-auto bg-gray-200 flex items-center justify-center p-8"
        >
          <div className="bg-white rounded-2xl shadow-2xl p-4">
            <canvas ref={canvasRef} />
          </div>
        </main>
        
        {/* Right Sidebar - Object Properties */}
        {selectedObject && (
          <aside className="w-64 bg-white shadow-lg overflow-y-auto">
            <div className="p-4 border-b">
              <h3 className="font-semibold text-gray-900">Chỉnh sửa đối tượng</h3>
            </div>
            
            <div className="p-4 space-y-4">
              {/* Transform */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Xoay</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => rotateObject(-15)}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <RotateCcw className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => rotateObject(15)}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <RotateCw className="w-4 h-4 mx-auto" />
                  </button>
                </div>
              </div>
              
              {/* Flip */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Lật</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => flipObject('horizontal')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <FlipHorizontal className="w-4 h-4 mx-auto" />
                  </button>
                  <button
                    onClick={() => flipObject('vertical')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  >
                    <FlipVertical className="w-4 h-4 mx-auto" />
                  </button>
                </div>
              </div>
              
              {/* Layer order */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Thứ tự lớp</label>
                <div className="flex gap-2">
                  <button
                    onClick={() => changeLayer('front')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition text-xs"
                  >
                    Đưa lên trên
                  </button>
                  <button
                    onClick={() => changeLayer('back')}
                    className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition text-xs"
                  >
                    Đưa xuống dưới
                  </button>
                </div>
              </div>
              
              {/* Actions */}
              <div className="flex gap-2">
                <button
                  onClick={duplicateObject}
                  className="flex-1 py-2 border rounded-lg hover:bg-gray-100 transition"
                  title="Nhân đôi"
                >
                  <Copy className="w-4 h-4 mx-auto" />
                </button>
                <button
                  onClick={deleteSelected}
                  className="flex-1 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 transition"
                  title="Xóa"
                >
                  <Trash2 className="w-4 h-4 mx-auto" />
                </button>
              </div>
              
              {/* Color picker for shapes */}
              {(selectedObject.type === 'rect' || selectedObject.type === 'circle') && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Màu sắc</label>
                  <input
                    type="color"
                    value={selectedObject.fill || '#e91e63'}
                    onChange={(e) => {
                      selectedObject.set('fill', e.target.value);
                      fabricRef.current?.renderAll();
                      saveToHistory();
                    }}
                    className="w-full h-10 border rounded-lg cursor-pointer"
                  />
                </div>
              )}
              
              {/* Text editing */}
              {(selectedObject.type === 'i-text' || selectedObject.type === 'text') && (
                <>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Màu chữ</label>
                    <input
                      type="color"
                      value={selectedObject.fill || '#000000'}
                      onChange={(e) => {
                        selectedObject.set('fill', e.target.value);
                        fabricRef.current?.renderAll();
                        saveToHistory();
                      }}
                      className="w-full h-10 border rounded-lg cursor-pointer"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Cỡ chữ</label>
                    <input
                      type="number"
                      value={selectedObject.fontSize || 40}
                      onChange={(e) => {
                        selectedObject.set('fontSize', parseInt(e.target.value) || 40);
                        fabricRef.current?.renderAll();
                        saveToHistory();
                      }}
                      className="w-full px-3 py-2 border rounded-lg"
                      min={10}
                      max={200}
                    />
                  </div>
                </>
              )}
            </div>
          </aside>
        )}
      </div>
    </div>
  );
}




################################################################################
## FILE 125: page.tsx
## Path: fontend/src/app/gift/claim/[giftId]/page.tsx
################################################################################

'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { getGiftInfo, verifyGift, claimGift } from '@/lib/api-client';
import { 
  Gift, CheckCircle, AlertCircle, Loader2, PartyPopper, 
  Lock, MapPin, Phone, ArrowRight, Clock, User, Mail 
} from 'lucide-react';
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';

type GiftStatus = 'pending' | 'verified' | 'claimed' | 'expired';

export default function ClaimGiftPage() {
  const params = useParams();
  const router = useRouter();
  const giftId = params.giftId as string;

  const [gift, setGift] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');
  
  // Verification
  const [verificationCode, setVerificationCode] = useState('');
  const [verifying, setVerifying] = useState(false);
  const [verified, setVerified] = useState(false);

  // Claim form
  const [claimData, setClaimData] = useState({
    address: '',
    phone: '',
  });
  const [claiming, setClaiming] = useState(false);
  const [claimed, setClaimed] = useState(false);
  const [orderId, setOrderId] = useState<number | null>(null);

  // Load gift info
  useEffect(() => {
    if (giftId) {
      loadGift();
    }
  }, [giftId]);

  const loadGift = async () => {
    try {
      setLoading(true);
      const data = await getGiftInfo(giftId);
      setGift(data);
      
      // Check status
      if (data.status === 'verified') {
        setVerified(true);
      } else if (data.status === 'claimed') {
        setClaimed(true);
      }
    } catch (err: any) {
      console.error('Load gift error:', err);
      setError('Không tìm thấy quà tặng hoặc đã hết hạn');
    } finally {
      setLoading(false);
    }
  };

  const handleVerify = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (verificationCode.length !== 6) {
      setError('Mã xác nhận phải có 6 chữ số');
      return;
    }

    try {
      setVerifying(true);
      await verifyGift(giftId, verificationCode);
      setVerified(true);
    } catch (err: any) {
      setError(err.response?.data?.message || 'Mã xác nhận không đúng');
    } finally {
      setVerifying(false);
    }
  };

  const handleClaim = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (!claimData.address || !claimData.phone) {
      setError('Vui lòng nhập địa chỉ và số điện thoại');
      return;
    }

    try {
      setClaiming(true);
      const result = await claimGift(giftId, claimData.address, claimData.phone);
      setClaimed(true);
      setOrderId(result.orderId);
    } catch (err: any) {
      setError(err.response?.data?.message || 'Có lỗi xảy ra');
    } finally {
      setClaiming(false);
    }
  };

  const getProductImage = () => {
    if (!gift?.products) return '';
    const product = gift.products;
    return product.image_url ||
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      '';
  };

  const isExpired = gift && new Date(gift.expires_at) < new Date();

  // Loading
  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white flex items-center justify-center">
        <Loader2 className="w-12 h-12 animate-spin text-pink-600" />
      </div>
    );
  }

  // Error - Gift not found
  if (error && !gift) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">Không Tìm Thấy Quà Tặng</h1>
            <p className="text-gray-600 mb-6">{error}</p>
            <Link
              href="/"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Về Trang Chủ
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  // Success - Claimed
  if (claimed) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-green-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <PartyPopper className="w-12 h-12 text-green-600" />
            </div>
            <h1 className="text-3xl font-bold text-gray-900 mb-4">
              🎉 Chúc Mừng!
            </h1>
            <p className="text-xl text-gray-600 mb-2">
              Bạn đã nhận quà thành công!
            </p>
            {orderId && (
              <p className="text-gray-500 mb-6">
                Mã đơn hàng: <strong>#{orderId}</strong>
              </p>
            )}

            <div className="bg-green-50 rounded-2xl p-6 mb-6">
              <div className="flex items-center gap-4 justify-center">
                {getProductImage() && (
                  <img
                    src={getProductImage()}
                    alt={gift.products.product_name}
                    className="w-20 h-20 rounded-xl object-cover"
                  />
                )}
                <div className="text-left">
                  <h3 className="font-bold text-gray-900">{gift.products.product_name}</h3>
                  <p className="text-green-600 font-semibold">MIỄN PHÍ</p>
                </div>
              </div>
            </div>

            <p className="text-gray-500 mb-6">
              Đơn hàng sẽ được giao đến địa chỉ bạn đã cung cấp trong 2-3 ngày làm việc.
            </p>

            <Link
              href="/shop"
              className="inline-flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-full font-semibold hover:bg-pink-700 transition"
            >
              Khám Phá Thêm Sản Phẩm
              <ArrowRight className="w-5 h-5" />
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  // Already claimed
  if (gift?.status === 'claimed') {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">Quà Đã Được Nhận</h1>
            <p className="text-gray-600 mb-6">Quà tặng này đã được nhận trước đó.</p>
            <Link
              href="/shop"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Mua Sắm
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  // Expired
  if (isExpired) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
        <TopBanner />
        <Header />
        <div className="max-w-xl mx-auto px-4 py-20 text-center">
          <div className="bg-white rounded-3xl shadow-xl p-8">
            <Clock className="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">Quà Đã Hết Hạn</h1>
            <p className="text-gray-600 mb-6">
              Rất tiếc, quà tặng này đã hết hạn vào {new Date(gift.expires_at).toLocaleDateString('vi-VN')}.
            </p>
            <Link
              href="/shop"
              className="inline-block bg-pink-600 text-white px-6 py-3 rounded-full font-semibold"
            >
              Khám Phá Shop
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
      <TopBanner />
      <Header />

      <div className="max-w-4xl mx-auto px-4 py-12">
        {/* Gift Card */}
        <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-pink-500 via-rose-500 to-red-500 p-8 text-white text-center">
            <div className="text-6xl mb-4">🎁</div>
            <h1 className="text-3xl font-bold mb-2">Bạn Có Quà Tặng!</h1>
            <p className="opacity-90">Từ {gift.sender_name}</p>
          </div>

          <div className="p-8">
            {/* Sender message */}
            {gift.sender_message && (
              <div className="bg-gradient-to-r from-pink-50 to-rose-50 rounded-2xl p-6 mb-8">
                <p className="text-lg text-gray-700 italic text-center">
                  "{gift.sender_message}"
                </p>
                <p className="text-right text-pink-600 mt-2 font-semibold">
                  — {gift.sender_name}
                </p>
              </div>
            )}

            {/* Product */}
            <div className="flex flex-col sm:flex-row gap-6 items-center bg-gray-50 rounded-2xl p-6 mb-8">
              <div className="w-40 h-40 bg-white rounded-2xl overflow-hidden shadow flex-shrink-0">
                {getProductImage() ? (
                  <img
                    src={getProductImage()}
                    alt={gift.products?.product_name}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-300">
                    <Gift className="w-16 h-16" />
                  </div>
                )}
              </div>
              <div className="text-center sm:text-left">
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                  {gift.products?.product_name}
                </h2>
                <p className="text-3xl font-bold text-pink-600">
                  {(gift.products?.sale_price || gift.products?.price)?.toLocaleString('vi-VN')}₫
                </p>
                <p className="text-green-600 font-semibold mt-2">🎉 MIỄN PHÍ CHO BẠN!</p>
              </div>
            </div>

            {/* Expiry warning */}
            <div className="flex items-center gap-2 bg-amber-50 text-amber-700 px-4 py-3 rounded-xl mb-8">
              <Clock className="w-5 h-5 flex-shrink-0" />
              <p>
                Quà có hiệu lực đến: <strong>{new Date(gift.expires_at).toLocaleDateString('vi-VN')}</strong>
              </p>
            </div>

            {/* Error */}
            {error && (
              <div className="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-xl mb-6">
                <AlertCircle className="w-5 h-5 flex-shrink-0" />
                <p>{error}</p>
              </div>
            )}

            {/* Step 1: Verify */}
            {!verified && (
              <div className="border-2 border-pink-200 rounded-2xl p-6">
                <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Lock className="w-6 h-6 text-pink-500" />
                  Bước 1: Nhập Mã Xác Nhận
                </h3>
                <p className="text-gray-600 mb-4">
                  Mã xác nhận 6 số đã được gửi trong email. Vui lòng kiểm tra hộp thư.
                </p>
                <form onSubmit={handleVerify} className="flex flex-col sm:flex-row gap-4">
                  <input
                    type="text"
                    maxLength={6}
                    value={verificationCode}
                    onChange={(e) => setVerificationCode(e.target.value.replace(/\D/g, ''))}
                    className="flex-1 px-6 py-4 text-center text-2xl tracking-widest border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                    placeholder="000000"
                  />
                  <button
                    type="submit"
                    disabled={verifying || verificationCode.length !== 6}
                    className="px-8 py-4 bg-pink-600 text-white font-bold rounded-xl hover:bg-pink-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    {verifying ? (
                      <Loader2 className="w-5 h-5 animate-spin" />
                    ) : (
                      <>
                        <CheckCircle className="w-5 h-5" />
                        Xác Nhận
                      </>
                    )}
                  </button>
                </form>
              </div>
            )}

            {/* Step 2: Claim */}
            {verified && !claimed && (
              <div className="border-2 border-green-200 rounded-2xl p-6">
                <div className="flex items-center gap-2 text-green-600 mb-4">
                  <CheckCircle className="w-6 h-6" />
                  <span className="font-semibold">Xác nhận thành công!</span>
                </div>

                <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <MapPin className="w-6 h-6 text-pink-500" />
                  Bước 2: Nhập Địa Chỉ Nhận Quà
                </h3>

                <form onSubmit={handleClaim} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Số điện thoại <span className="text-red-500">*</span>
                    </label>
                    <div className="relative">
                      <Phone className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                      <input
                        type="tel"
                        value={claimData.phone}
                        onChange={(e) => setClaimData({ ...claimData, phone: e.target.value })}
                        className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent"
                        placeholder="0901234567"
                        required
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Địa chỉ nhận hàng <span className="text-red-500">*</span>
                    </label>
                    <div className="relative">
                      <MapPin className="absolute left-4 top-4 w-5 h-5 text-gray-400" />
                      <textarea
                        value={claimData.address}
                        onChange={(e) => setClaimData({ ...claimData, address: e.target.value })}
                        rows={3}
                        className="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none"
                        placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố"
                        required
                      />
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={claiming}
                    className="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl hover:from-green-600 hover:to-emerald-600 transition disabled:opacity-50 flex items-center justify-center gap-2"
                  >
                    {claiming ? (
                      <Loader2 className="w-5 h-5 animate-spin" />
                    ) : (
                      <>
                        <Gift className="w-5 h-5" />
                        Nhận Quà Ngay
                      </>
                    )}
                  </button>
                </form>
              </div>
            )}
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
}




################################################################################
## FILE 126: page.tsx
## Path: fontend/src/app/gift/send/page.tsx
################################################################################

'use client';

import { useState, useEffect } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { fetchProductById, sendGift, SendGiftData } from '@/lib/api-client';
import { Gift, Heart, ArrowLeft, Send, Loader2, CheckCircle, AlertCircle, Sparkles } from 'lucide-react';
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';

export default function SendGiftPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const productId = searchParams.get('productId');

  const [product, setProduct] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState('');

  // Form state
  const [formData, setFormData] = useState({
    senderName: '',
    senderEmail: '',
    senderMessage: '',
    recipientName: '',
    recipientEmail: '',
    recipientPhone: '',
  });

  // Load product
  useEffect(() => {
    if (productId) {
      loadProduct(parseInt(productId));
    } else {
      setLoading(false);
    }
  }, [productId]);

  const loadProduct = async (id: number) => {
    try {
      const data = await fetchProductById(id);
      setProduct(data);
    } catch (err) {
      console.error('Error loading product:', err);
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    // Validate
    if (!formData.senderName || !formData.senderEmail || !formData.recipientName || !formData.recipientEmail) {
      setError('Vui lòng điền đầy đủ thông tin bắt buộc');
      return;
    }

    if (!productId) {
      setError('Vui lòng chọn sản phẩm để gửi tặng');
      return;
    }

    try {
      setSending(true);
      
      const giftData: SendGiftData = {
        ...formData,
        productId: parseInt(productId),
        quantity: 1,
      };

      await sendGift(giftData);
      setSuccess(true);
    } catch (err: any) {
      console.error('Send gift error:', err);
      setError(err.response?.data?.message || 'Có lỗi xảy ra khi gửi quà');
    } finally {
      setSending(false);
    }
  };

  const getProductImage = () => {
    if (!product) return '';
    return product.image_url || 
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      '';
  };

  // Success screen
  if (success) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
        <TopBanner />
        <Header />
        
        <div className="max-w-2xl mx-auto px-4 py-20">
          <div className="bg-white rounded-3xl shadow-xl p-8 text-center">
            <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <CheckCircle className="w-10 h-10 text-green-600" />
            </div>
            
            <h1 className="text-3xl font-bold text-gray-900 mb-4">
              🎁 Quà Tặng Đã Được Gửi!
            </h1>
            
            <p className="text-gray-600 mb-8">
              Email thông báo đã được gửi đến <strong>{formData.recipientEmail}</strong>. 
              Người nhận sẽ nhận được mã xác nhận để nhận quà.
            </p>

            <div className="bg-pink-50 rounded-2xl p-6 mb-8">
              <p className="text-pink-800">
                💌 Tin nhắn của bạn: <em>"{formData.senderMessage || 'Chúc bạn vui vẻ!'}"</em>
              </p>
            </div>

            <div className="flex flex-col sm:flex-row gap-4 justify-center">
              <Link
                href="/shop"
                className="px-6 py-3 bg-pink-600 text-white rounded-full font-semibold hover:bg-pink-700 transition"
              >
                Tiếp Tục Mua Sắm
              </Link>
              <button
                onClick={() => {
                  setSuccess(false);
                  setFormData({
                    senderName: '',
                    senderEmail: '',
                    senderMessage: '',
                    recipientName: '',
                    recipientEmail: '',
                    recipientPhone: '',
                  });
                }}
                className="px-6 py-3 border-2 border-pink-600 text-pink-600 rounded-full font-semibold hover:bg-pink-50 transition"
              >
                Gửi Quà Khác
              </button>
            </div>
          </div>
        </div>

        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-pink-50 to-white">
      <TopBanner />
      <Header />

      <div className="max-w-6xl mx-auto px-4 py-8">
        {/* Back button */}
        <button
          onClick={() => router.back()}
          className="flex items-center gap-2 text-gray-600 hover:text-pink-600 mb-6 transition"
        >
          <ArrowLeft className="w-5 h-5" />
          Quay lại
        </button>

        {/* Title */}
        <div className="text-center mb-10">
          <div className="inline-flex items-center gap-2 bg-pink-100 text-pink-700 px-4 py-2 rounded-full mb-4">
            <Gift className="w-5 h-5" />
            <span className="font-semibold">Gửi Quà Tặng</span>
          </div>
          <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
            Tặng Quà Cho Người Thân Yêu
          </h1>
          <p className="text-gray-600 max-w-xl mx-auto">
            Chọn sản phẩm, điền thông tin người nhận và gửi yêu thương qua email
          </p>
        </div>

        <div className="grid lg:grid-cols-2 gap-8">
          {/* Product Preview */}
          <div className="bg-white rounded-3xl shadow-lg p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
              <Sparkles className="w-5 h-5 text-pink-500" />
              Sản Phẩm Tặng
            </h2>

            {loading ? (
              <div className="flex items-center justify-center h-64">
                <Loader2 className="w-8 h-8 animate-spin text-pink-600" />
              </div>
            ) : product ? (
              <div className="flex gap-6">
                <div className="w-40 h-40 bg-gray-100 rounded-2xl overflow-hidden flex-shrink-0">
                  {getProductImage() ? (
                    <img
                      src={getProductImage()}
                      alt={product.product_name}
                      className="w-full h-full object-cover"
                    />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center text-gray-400">
                      <Gift className="w-12 h-12" />
                    </div>
                  )}
                </div>
                <div className="flex-1">
                  <h3 className="font-bold text-lg text-gray-900 mb-2">
                    {product.product_name}
                  </h3>
                  <p className="text-gray-500 text-sm mb-4 line-clamp-2">
                    {product.description}
                  </p>
                  <div className="flex items-center gap-3">
                    <span className="text-2xl font-bold text-pink-600">
                      {(product.sale_price || product.price).toLocaleString('vi-VN')}₫
                    </span>
                    {product.sale_price && product.sale_price < product.price && (
                      <span className="text-gray-400 line-through">
                        {product.price.toLocaleString('vi-VN')}₫
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ) : (
              <div className="text-center py-12">
                <Gift className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                <p className="text-gray-500 mb-4">Chưa chọn sản phẩm</p>
                <Link
                  href="/shop"
                  className="inline-block bg-pink-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-pink-700 transition"
                >
                  Chọn Sản Phẩm
                </Link>
              </div>
            )}

            {/* Gift message preview */}
            {formData.senderMessage && (
              <div className="mt-6 bg-gradient-to-r from-pink-50 to-rose-50 rounded-2xl p-6">
                <p className="text-sm text-pink-600 font-semibold mb-2">💌 Lời nhắn của bạn:</p>
                <p className="text-gray-700 italic">"{formData.senderMessage}"</p>
                <p className="text-right text-pink-600 mt-2">— {formData.senderName || 'Người gửi'}</p>
              </div>
            )}
          </div>

          {/* Form */}
          <div className="bg-white rounded-3xl shadow-lg p-6">
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Sender Info */}
              <div>
                <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Heart className="w-5 h-5 text-pink-500" />
                  Thông Tin Người Gửi
                </h3>
                <div className="grid sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Tên của bạn <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      name="senderName"
                      value={formData.senderName}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                      placeholder="Nguyễn Văn A"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Email của bạn <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="email"
                      name="senderEmail"
                      value={formData.senderEmail}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                      placeholder="email@example.com"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* Message */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Lời nhắn gửi kèm
                </label>
                <textarea
                  name="senderMessage"
                  value={formData.senderMessage}
                  onChange={handleChange}
                  rows={3}
                  className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition resize-none"
                  placeholder="Chúc mừng sinh nhật! Hy vọng bạn sẽ thích món quà này..."
                />
              </div>

              {/* Recipient Info */}
              <div>
                <h3 className="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <Gift className="w-5 h-5 text-pink-500" />
                  Thông Tin Người Nhận
                </h3>
                <div className="space-y-4">
                  <div className="grid sm:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Tên người nhận <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        name="recipientName"
                        value={formData.recipientName}
                        onChange={handleChange}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                        placeholder="Trần Thị B"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Số điện thoại
                      </label>
                      <input
                        type="tel"
                        name="recipientPhone"
                        value={formData.recipientPhone}
                        onChange={handleChange}
                        className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                        placeholder="0901234567"
                      />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Email người nhận <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="email"
                      name="recipientEmail"
                      value={formData.recipientEmail}
                      onChange={handleChange}
                      className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition"
                      placeholder="nguoinhan@example.com"
                      required
                    />
                    <p className="text-xs text-gray-500 mt-1">
                      📧 Email xác nhận sẽ được gửi đến địa chỉ này
                    </p>
                  </div>
                </div>
              </div>

              {/* Error */}
              {error && (
                <div className="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-3 rounded-xl">
                  <AlertCircle className="w-5 h-5 flex-shrink-0" />
                  <p>{error}</p>
                </div>
              )}

              {/* Submit */}
              <button
                type="submit"
                disabled={sending || !product}
                className="w-full py-4 bg-gradient-to-r from-pink-500 to-rose-500 text-white font-bold rounded-xl hover:from-pink-600 hover:to-rose-600 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                {sending ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    Đang gửi...
                  </>
                ) : (
                  <>
                    <Send className="w-5 h-5" />
                    Gửi Quà Tặng
                  </>
                )}
              </button>

              <p className="text-center text-sm text-gray-500">
                🔒 Thông tin của bạn được bảo mật an toàn
              </p>
            </form>
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
}




################################################################################
## FILE 127: page.tsx
## Path: fontend/src/app/product/[id]/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import Link from 'next/link';
import { 
  Star, Heart, ShoppingCart, Minus, Plus, 
  Truck, Shield, RotateCcw, Check, ChevronRight, Gift,
  Smartphone, ChevronDown, Search
} from 'lucide-react';
import { fetchProductById, addToShoppingCart, fetchCompatiblePhoneModels, fetchAllPhoneModels } from '@/lib/api-client';
import TopBanner from '@/components/layout/TopBanner';
import Header from '@/components/layout/Header';
import Footer from '@/components/layout/Footer';
import { useWishlist } from '@/app/context/wishlist-context';
import { useCart } from '@/app/context/cart-context';

interface PhoneModel {
  model_id: number;
  brand_name: string;
  model_name: string;
  model_code?: string;
  release_year?: number;
  is_popular?: boolean;
}

export default function ProductDetailPage() {
  const params = useParams();
  const router = useRouter();
  const productId = params.id as string;
  const { wishedProducts, toggleWishlist } = useWishlist();
  const { refreshCart, increaseCart } = useCart();

  const [product, setProduct] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [selectedImage, setSelectedImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [addingToCart, setAddingToCart] = useState(false);
  
  // Phone model selection states
  const [compatibleModels, setCompatibleModels] = useState<PhoneModel[]>([]);
  const [allPhoneModels, setAllPhoneModels] = useState<{brand: string, models: PhoneModel[]}[]>([]);
  const [selectedPhoneModel, setSelectedPhoneModel] = useState<PhoneModel | null>(null);
  const [showPhoneModelDropdown, setShowPhoneModelDropdown] = useState(false);
  const [phoneModelSearch, setPhoneModelSearch] = useState('');
  const [selectedBrand, setSelectedBrand] = useState<string>('');
  const [loadingModels, setLoadingModels] = useState(false);

  useEffect(() => {
    if (productId) {
      loadProduct();
      loadPhoneModels();
    }
  }, [productId]);

  const loadProduct = async () => {
    try {
      setLoading(true);
      const data = await fetchProductById(parseInt(productId));
      setProduct(data);
    } catch (error) {
      console.error('Error loading product:', error);
    } finally {
      setLoading(false);
    }
  };

  const loadPhoneModels = async () => {
    try {
      setLoadingModels(true);
      // Lấy dòng máy tương thích với sản phẩm
      const compatibleRes = await fetchCompatiblePhoneModels(parseInt(productId));
      if (compatibleRes.success && compatibleRes.data.length > 0) {
        setCompatibleModels(compatibleRes.data);
      }
      
      // Lấy tất cả dòng máy grouped by brand
      const allRes = await fetchAllPhoneModels();
      if (allRes.success) {
        setAllPhoneModels(allRes.data);
      }
    } catch (error) {
      console.error('Error loading phone models:', error);
    } finally {
      setLoadingModels(false);
    }
  };

  // Filter models dựa trên search và brand
  const getFilteredModels = () => {
    let models: PhoneModel[] = [];
    
    // Luôn hiện TẤT CẢ dòng máy từ database, không giới hạn chỉ compatible
    if (allPhoneModels.length > 0) {
      if (selectedBrand) {
        const brandData = allPhoneModels.find(b => b.brand === selectedBrand);
        models = brandData?.models || [];
      } else {
        models = allPhoneModels.flatMap(b => b.models);
      }
    } else if (compatibleModels.length > 0) {
      // Fallback nếu allPhoneModels không có
      if (selectedBrand) {
        models = compatibleModels.filter(m => m.brand_name === selectedBrand);
      } else {
        models = compatibleModels;
      }
    }

    if (phoneModelSearch) {
      const search = phoneModelSearch.toLowerCase();
      models = models.filter(m => 
        m.model_name.toLowerCase().includes(search) ||
        m.brand_name.toLowerCase().includes(search)
      );
    }

    return models;
  };

  const getBrands = () => {
    // Luôn lấy tất cả brands từ allPhoneModels
    if (allPhoneModels.length > 0) {
      return allPhoneModels.map(b => b.brand);
    }
    // Fallback nếu chưa load xong
    if (compatibleModels.length > 0) {
      return [...new Set(compatibleModels.map(m => m.brand_name))];
    }
    return [];
  };

  const handleAddToCart = async (): Promise<boolean> => {
    if (!product) return false;
    
    // Chỉ yêu cầu chọn dòng máy nếu có dòng máy trong database
    const hasPhoneModels = compatibleModels.length > 0 || allPhoneModels.length > 0;
    if (hasPhoneModels && !selectedPhoneModel) {
      alert('Vui lòng chọn dòng máy điện thoại!');
      setShowPhoneModelDropdown(true);
      return false;
    }
    
    setAddingToCart(true);
    try {
      // Lấy customer từ localStorage (đúng key)
      const customerData = localStorage.getItem('customer');
      if (!customerData) {
        router.push('/login?redirect=' + encodeURIComponent(window.location.pathname));
        return false;
      }
      
      const customer = JSON.parse(customerData);
      const userId = customer.id;
      
      if (!userId) {
        router.push('/login?redirect=' + encodeURIComponent(window.location.pathname));
        return false;
      }

      const result = await addToShoppingCart({
        userId,
        productId: product.product_id,
        quantity,
        phoneModelId: selectedPhoneModel?.model_id,
        phoneModelName: selectedPhoneModel ? `${selectedPhoneModel.brand_name} ${selectedPhoneModel.model_name}` : undefined
      });
      
      if (result.success) {
        // Cập nhật cart count ngay lập tức (optimistic update cho UX mượt)
        increaseCart(quantity);
        // Sau đó sync lại với backend để chắc chắn
        window.dispatchEvent(new Event('cartUpdated'));
        return true;
      } else {
        alert(result.message || 'Có lỗi xảy ra');
        return false;
      }
    } catch (error) {
      console.error('Error adding to cart:', error);
      alert('Có lỗi xảy ra khi thêm vào giỏ hàng');
      return false;
    } finally {
      setAddingToCart(false);
    }
  };

  // Mua ngay - thêm vào giỏ rồi chuyển đến checkout
  const handleBuyNow = async () => {
    const success = await handleAddToCart();
    if (success) {
      router.push('/checkout');
    }
  };

  // Thêm vào giỏ và hiện thông báo
  const handleAddToCartWithNotification = async () => {
    const success = await handleAddToCart();
    if (success) {
      alert('Đã thêm vào giỏ hàng!');
    }
  };

  const formatPrice = (price: number) => {
    return price?.toLocaleString('vi-VN') + '₫';
  };

  const getDiscountPercent = () => {
    if (!product || !product.sale_price || product.sale_price >= product.price) return 0;
    return Math.round((1 - product.sale_price / product.price) * 100);
  };

  const getProductImage = () => {
    if (!product) return '';
    return product.image_url || 
      product.product_images?.find((img: any) => img.is_primary)?.image_url ||
      product.product_images?.[0]?.image_url ||
      '';
  };

  const images = product?.product_images?.length 
    ? product.product_images 
    : product?.image_url 
      ? [{ image_id: 0, image_url: product.image_url, is_primary: true }]
      : [];

  const isWished = product && wishedProducts.has(product.product_id);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50">
        <TopBanner />
        <Header />
        <div className="flex items-center justify-center py-32">
          <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-pink-600"></div>
        </div>
        <Footer />
      </div>
    );
  }

  if (!product) {
    return (
      <div className="min-h-screen bg-gray-50">
        <TopBanner />
        <Header />
        <div className="flex items-center justify-center py-32">
          <div className="text-center">
            <div className="text-6xl mb-4">😢</div>
            <h2 className="text-2xl font-bold mb-2">Không tìm thấy sản phẩm</h2>
            <Link href="/shop" className="text-pink-600 hover:underline">
              ← Quay lại cửa hàng
            </Link>
          </div>
        </div>
        <Footer />
      </div>
    );
  }

  const currentPrice = product.sale_price || product.price;

  return (
    <div className="min-h-screen bg-gray-50">
      <TopBanner />
      <Header />

      {/* Breadcrumb */}
      <div className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="flex items-center gap-2 text-sm text-gray-600">
            <Link href="/" className="hover:text-pink-600">Trang chủ</Link>
            <ChevronRight className="w-4 h-4" />
            <Link href="/shop" className="hover:text-pink-600">Cửa hàng</Link>
            <ChevronRight className="w-4 h-4" />
            <span className="text-gray-900 font-medium truncate max-w-[200px]">
              {product.product_name}
            </span>
          </div>
        </div>
      </div>

      {/* Product Main */}
      <div className="max-w-7xl mx-auto px-4 py-8">
        <div className="bg-white rounded-2xl shadow-sm p-6 lg:p-8">
          <div className="grid lg:grid-cols-2 gap-8 lg:gap-12">
            {/* Images */}
            <div>
              <div className="relative aspect-square rounded-2xl overflow-hidden bg-gray-100 mb-4">
                {images.length > 0 ? (
                  <img
                    src={images[selectedImage]?.image_url || getProductImage()}
                    alt={product.product_name}
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <div className="w-full h-full flex items-center justify-center text-gray-400">
                    <ShoppingCart className="w-24 h-24" />
                  </div>
                )}
                {getDiscountPercent() > 0 && (
                  <span className="absolute top-4 left-4 bg-red-500 text-white text-sm font-bold px-3 py-1 rounded-full">
                    -{getDiscountPercent()}%
                  </span>
                )}
              </div>

              {images.length > 1 && (
                <div className="flex gap-3 overflow-x-auto pb-2">
                  {images.map((img: any, index: number) => (
                    <button
                      key={img.image_id || index}
                      onClick={() => setSelectedImage(index)}
                      className={`flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden border-2 transition ${
                        selectedImage === index ? 'border-pink-600' : 'border-gray-200'
                      }`}
                    >
                      <img src={img.image_url} alt="" className="w-full h-full object-cover" />
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Info */}
            <div>
              <div className="mb-4">
                {product.categories?.category_name && (
                  <span className="text-pink-600 text-sm font-medium">
                    {product.categories.category_name}
                  </span>
                )}
                <h1 className="text-2xl lg:text-3xl font-bold text-gray-900 mt-1">
                  {product.product_name}
                </h1>
                <div className="flex items-center gap-4 mt-3">
                  <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        className={`w-5 h-5 ${
                          star <= 4 ? 'fill-yellow-400 text-yellow-400' : 'text-gray-300'
                        }`}
                      />
                    ))}
                    <span className="ml-2 text-sm text-gray-600">4.5 (128 đánh giá)</span>
                  </div>
                </div>
              </div>

              {/* Price */}
              <div className="mb-6 pb-6 border-b">
                <div className="flex items-baseline gap-3">
                  <span className="text-3xl font-bold text-pink-600">
                    {formatPrice(currentPrice)}
                  </span>
                  {product.sale_price && product.sale_price < product.price && (
                    <span className="text-lg text-gray-400 line-through">
                      {formatPrice(product.price)}
                    </span>
                  )}
                </div>
              </div>

              {/* Description */}
              <p className="text-gray-600 mb-6">{product.description}</p>

              {/* Phone Model Selection */}
              <div className="mb-6">
                <h3 className="font-semibold mb-3 flex items-center gap-2">
                  <Smartphone className="w-5 h-5 text-pink-600" />
                  Chọn dòng máy:
                  {selectedPhoneModel && (
                    <span className="text-pink-600 font-normal">
                      {selectedPhoneModel.brand_name} {selectedPhoneModel.model_name}
                    </span>
                  )}
                </h3>
                
                <div className="relative">
                  <button
                    onClick={() => setShowPhoneModelDropdown(!showPhoneModelDropdown)}
                    className={`w-full flex items-center justify-between p-4 border-2 rounded-xl transition ${
                      selectedPhoneModel 
                        ? 'border-pink-600 bg-pink-50' 
                        : 'border-gray-200 hover:border-pink-300'
                    }`}
                  >
                    <span className={selectedPhoneModel ? 'text-gray-900' : 'text-gray-500'}>
                      {selectedPhoneModel 
                        ? `${selectedPhoneModel.brand_name} ${selectedPhoneModel.model_name}`
                        : 'Chọn dòng máy phù hợp với ốp'
                      }
                    </span>
                    <ChevronDown className={`w-5 h-5 transition ${showPhoneModelDropdown ? 'rotate-180' : ''}`} />
                  </button>

                  {showPhoneModelDropdown && (
                    <div className="absolute top-full left-0 right-0 mt-2 bg-white border-2 border-gray-200 rounded-xl shadow-xl z-50 max-h-80 overflow-hidden">
                      {/* Search */}
                      <div className="p-3 border-b sticky top-0 bg-white">
                        <div className="relative">
                          <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                          <input
                            type="text"
                            placeholder="Tìm kiếm dòng máy..."
                            value={phoneModelSearch}
                            onChange={(e) => setPhoneModelSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2 border rounded-lg focus:border-pink-600 focus:outline-none"
                          />
                        </div>
                      </div>

                      {/* Brand tabs */}
                      {getBrands().length > 1 && (
                        <div className="flex flex-wrap gap-2 p-3 border-b bg-gray-50">
                          <button
                            onClick={() => setSelectedBrand('')}
                            className={`px-3 py-1 rounded-full text-sm transition ${
                              selectedBrand === '' 
                                ? 'bg-pink-600 text-white' 
                                : 'bg-white border hover:bg-gray-100'
                            }`}
                          >
                            Tất cả
                          </button>
                          {getBrands().map(brand => (
                            <button
                              key={brand}
                              onClick={() => setSelectedBrand(brand)}
                              className={`px-3 py-1 rounded-full text-sm transition ${
                                selectedBrand === brand 
                                  ? 'bg-pink-600 text-white' 
                                  : 'bg-white border hover:bg-gray-100'
                              }`}
                            >
                              {brand}
                            </button>
                          ))}
                        </div>
                      )}

                      {/* Model list */}
                      <div className="max-h-48 overflow-y-auto">
                        {loadingModels ? (
                          <div className="p-4 text-center text-gray-500">
                            Đang tải...
                          </div>
                        ) : getFilteredModels().length === 0 ? (
                          <div className="p-4 text-center text-gray-500">
                            {compatibleModels.length === 0 && allPhoneModels.length === 0
                              ? 'Sản phẩm này phù hợp với mọi dòng máy'
                              : 'Không tìm thấy dòng máy phù hợp'
                            }
                          </div>
                        ) : (
                          getFilteredModels().map((model) => (
                            <button
                              key={model.model_id}
                              onClick={() => {
                                setSelectedPhoneModel(model);
                                setShowPhoneModelDropdown(false);
                                setPhoneModelSearch('');
                              }}
                              className={`w-full flex items-center justify-between p-3 hover:bg-pink-50 transition text-left ${
                                selectedPhoneModel?.model_id === model.model_id ? 'bg-pink-50' : ''
                              }`}
                            >
                              <div>
                                <span className="text-gray-500 text-sm">{model.brand_name}</span>
                                <span className="mx-2">•</span>
                                <span className="font-medium">{model.model_name}</span>
                                {model.is_popular && (
                                  <span className="ml-2 px-2 py-0.5 bg-orange-100 text-orange-600 text-xs rounded-full">
                                    Phổ biến
                                  </span>
                                )}
                              </div>
                              {selectedPhoneModel?.model_id === model.model_id && (
                                <Check className="w-5 h-5 text-pink-600" />
                              )}
                            </button>
                          ))
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {compatibleModels.length > 0 && (
                  <p className="text-sm text-gray-500 mt-2">
                    ✓ Sản phẩm này tương thích với {compatibleModels.length} dòng máy
                  </p>
                )}
              </div>

              {/* Quantity */}
              <div className="mb-6">
                <h3 className="font-semibold mb-3">Số lượng:</h3>
                <div className="flex items-center gap-4">
                  <div className="flex items-center border rounded-lg">
                    <button
                      onClick={() => setQuantity(q => Math.max(1, q - 1))}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Minus className="w-4 h-4" />
                    </button>
                    <span className="px-6 py-3 font-semibold">{quantity}</span>
                    <button
                      onClick={() => setQuantity(q => q + 1)}
                      className="p-3 hover:bg-gray-100 transition"
                    >
                      <Plus className="w-4 h-4" />
                    </button>
                  </div>
                  <button
                    onClick={() => toggleWishlist(product.product_id)}
                    className={`p-3 rounded-lg border transition ${
                      isWished ? 'bg-pink-50 border-pink-600 text-pink-600' : 'border-gray-200'
                    }`}
                  >
                    <Heart className={`w-6 h-6 ${isWished ? 'fill-pink-600' : ''}`} />
                  </button>
                </div>
              </div>

              {/* Buttons */}
              <div className="flex gap-4 mb-4">
                <button
                  onClick={handleAddToCartWithNotification}
                  disabled={addingToCart}
                  className="flex-1 flex items-center justify-center gap-2 bg-white border-2 border-pink-600 text-pink-600 py-4 rounded-xl font-semibold hover:bg-pink-50 transition disabled:opacity-50"
                >
                  <ShoppingCart className="w-5 h-5" />
                  {addingToCart ? 'Đang thêm...' : 'Thêm vào giỏ'}
                </button>
                <button
                  onClick={handleBuyNow}
                  disabled={addingToCart}
                  className="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition disabled:opacity-50"
                >
                  {addingToCart ? 'Đang xử lý...' : 'Mua ngay'}
                </button>
              </div>

              {/* Gift Button */}
              <button
                onClick={() => router.push(`/gift/send?productId=${product.product_id}`)}
                className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white py-4 rounded-xl font-semibold hover:from-amber-600 hover:to-orange-600 transition mb-8"
              >
                <Gift className="w-5 h-5" />
                 Gửi Tặng Bạn Bè
              </button>

              {/* Benefits */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl">
                <div className="flex items-center gap-3">
                  <div className="bg-green-100 p-2 rounded-full">
                    <Truck className="w-5 h-5 text-green-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Giao hàng nhanh</p>
                    <p className="text-gray-500">2-3 ngày</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-blue-100 p-2 rounded-full">
                    <Shield className="w-5 h-5 text-blue-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Bảo hành</p>
                    <p className="text-gray-500">12 tháng</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-orange-100 p-2 rounded-full">
                    <RotateCcw className="w-5 h-5 text-orange-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Đổi trả</p>
                    <p className="text-gray-500">30 ngày</p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <div className="bg-purple-100 p-2 rounded-full">
                    <Check className="w-5 h-5 text-purple-600" />
                  </div>
                  <div className="text-sm">
                    <p className="font-medium">Chính hãng</p>
                    <p className="text-gray-500">100%</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <Footer />
    </div>
  );
}




################################################################################
## FILE 128: page.tsx
## Path: fontend/src/app/promotions/page.tsx
################################################################################

'use client';

import React, { useState, useEffect } from 'react';
import { ShoppingCart, User, Heart, Search, Menu, Tag, Clock, Percent, Gift, Star, ChevronRight } from 'lucide-react';
import Link from 'next/link';
import { fetchCategories } from '@/lib/api-client';

interface Deal {
  id: number;
  title: string;
  description: string;
  discount: string;
  code: string;
  image: string;
  endDate: string;
  tag?: string;
}

const PromotionsPage: React.FC = () => {
  const [cartCount, setCartCount] = useState(0);
  const [wishlistCount, setWishlistCount] = useState(0);
  const [selectedDevice, setSelectedDevice] = useState('iPhone 17 Pro Max');
  const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
  const [selectedCurrency, setSelectedCurrency] = useState('USD');
  const [copiedCode, setCopiedCode] = useState<string | null>(null);
  const [devices, setDevices] = useState<string[]>(['iPhone 17 Pro Max']);

  useEffect(() => {
    const loadCategories = async () => {
      try {
        const data = await fetchCategories();
        if (Array.isArray(data) && data.length > 0) {
          const categoryNames = data.map((cat: any) => cat.category_name);
          setDevices(categoryNames);
          setSelectedDevice(categoryNames[0]);
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    };
    loadCategories();
  }, []);

  const handleCurrencyChange = (currency: string) => {
    setSelectedCurrency(currency);
    setIsCurrencyModalOpen(false);
  };

  const copyCode = (code: string) => {
    navigator.clipboard.writeText(code);
    setCopiedCode(code);
    setTimeout(() => setCopiedCode(null), 2000);
  };

  const featuredDeals: Deal[] = [
    {
      id: 1,
      title: 'Mua 4 Trả 2',
      description: 'Mua 4 ốp điện thoại bất kỳ chỉ phải trả tiền 2 ốp',
      discount: '50%',
      code: 'BUY4GET2',
      image: 'https://images.unsplash.com/photo-1556656793-08538906a9f8?w=600&h=400&fit=crop',
      endDate: '31/12/2024',
      tag: 'HOT'
    },
    {
      id: 2,
      title: 'Giảm 30% Toàn Bộ iPhone 17',
      description: 'Áp dụng cho tất cả ốp iPhone 17 Series',
      discount: '30%',
      code: 'IPHONE17',
      image: 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=600&h=400&fit=crop',
      endDate: '25/12/2024',
      tag: 'MỚI'
    },
    {
      id: 3,
      title: 'Flash Sale Cuối Tuần',
      description: 'Giảm giá shock từ T7-CN hàng tuần',
      discount: '40%',
      code: 'WEEKEND40',
      image: 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=600&h=400&fit=crop',
      endDate: '15/12/2024',
      tag: 'FLASH'
    }
  ];

  const deals: Deal[] = [
    {
      id: 4,
      title: 'Miễn Phí Vận Chuyển',
      description: 'Cho đơn hàng từ 100K trở lên',
      discount: 'FREE SHIP',
      code: 'FREESHIP100',
      image: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    },
    {
      id: 5,
      title: 'Giảm 20% Khách Hàng Mới',
      description: 'Dành cho đơn hàng đầu tiên',
      discount: '20%',
      code: 'NEW20',
      image: 'https://images.unsplash.com/photo-1510557880182-3d4d3cba35a5?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    },
    {
      id: 6,
      title: 'Bundle Deal',
      description: 'Mua ốp + phụ kiện giảm 25%',
      discount: '25%',
      code: 'BUNDLE25',
      image: 'https://images.unsplash.com/photo-1565849904461-04a3cc76e3a9?w=400&h=300&fit=crop',
      endDate: '20/12/2024'
    },
    {
      id: 7,
      title: 'Sinh Nhật GoatTech',
      description: 'Giảm 35% nhân dịp sinh nhật thương hiệu',
      discount: '35%',
      code: 'BDAY35',
      image: 'https://images.unsplash.com/photo-1556656793-08538906a9f8?w=400&h=300&fit=crop',
      endDate: '10/12/2024'
    },
    {
      id: 8,
      title: 'Giảm Giá Combo',
      description: 'Mua 2 ốp bất kỳ giảm 15%',
      discount: '15%',
      code: 'COMBO15',
      image: 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    },
    {
      id: 9,
      title: 'Student Discount',
      description: 'Giảm 10% cho học sinh, sinh viên',
      discount: '10%',
      code: 'STUDENT10',
      image: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=400&h=300&fit=crop',
      endDate: '31/12/2024'
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Currency Modal */}
      {isCurrencyModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center" onClick={() => setIsCurrencyModalOpen(false)}>
          <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-xl font-bold">CHỌN LOẠI TIỀN TỆ</h2>
              <button onClick={() => setIsCurrencyModalOpen(false)} className="text-gray-500 hover:text-gray-700">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            
            <div className="mb-6">
              <label className="block text-sm font-semibold mb-2 text-gray-700">QUỐC GIA/KHU VỰC:</label>
              <select 
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-600"
                value={selectedCurrency}
                onChange={(e) => handleCurrencyChange(e.target.value)}
              >
                <option value="USD">United States (USD $)</option>
                <option value="VND">Việt Nam (VND ₫)</option>
              </select>
            </div>

            <button 
              onClick={() => setIsCurrencyModalOpen(false)}
              className="w-full bg-black text-white py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
            >
              ÁP DỤNG
            </button>
          </div>
        </div>
      )}

      {/* Top Banner */}
      <div className="bg-gradient-to-r from-red-600 to-pink-600 text-white py-2 px-4 text-center text-sm font-semibold animate-pulse">
        <div className="max-w-7xl mx-auto">
          🔥 KHUYẾN MÃI ĐẶC BIỆT - GIẢM ĐẾN 50% - MUA NGAY KẺO LỠ! 🔥
        </div>
      </div>

      {/* Header */}
      <header className="bg-white shadow-sm sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <button className="lg:hidden">
                <Menu className="w-6 h-6" />
              </button>
              <button className="lg:hidden">
                <Search className="w-6 h-6" />
              </button>
            </div>

            <Link href="/" className="text-2xl font-bold tracking-wider">
              GoatTech
            </Link>

            <div className="flex items-center gap-4">
              <button className="hidden lg:block px-4 py-2 text-sm font-medium border rounded-lg" onClick={() => setIsCurrencyModalOpen(true)}>
                {selectedCurrency} {selectedCurrency === 'USD' ? '$' : '₫'}
              </button>

              <select 
                value={selectedDevice}
                onChange={(e) => setSelectedDevice(e.target.value)}
                className="hidden lg:block px-4 py-2 border rounded-lg text-sm"
              >
                {devices.map((device) => (
                  <option key={device} value={device}>{device}</option>
                ))}
              </select>

              <button className="relative">
                <Heart className="w-6 h-6" />
                {wishlistCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-green-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {wishlistCount}
                  </span>
                )}
              </button>

              <Link href="/account">
                <User className="w-6 h-6" />
              </Link>

              <button className="relative">
                <ShoppingCart className="w-6 h-6" />
                {cartCount > 0 && (
                  <span className="absolute -top-1 -right-1 bg-black text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    {cartCount}
                  </span>
                )}
              </button>
            </div>
          </div>

          {/* Desktop Navigation */}
          <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t">
            <Link href="/" className="text-sm font-medium hover:text-pink-600">Trang Chủ</Link>
            <Link href="/shop" className="text-sm font-medium hover:text-pink-600">Cửa Hàng</Link>
            <button className="text-sm font-medium hover:text-pink-600">Bộ Sưu Tập</button>
            <Link href="/about" className="text-sm font-medium hover:text-pink-600">Về Chúng Tôi</Link>
            <Link href="/contact" className="text-sm font-medium hover:text-pink-600">Liên Hệ</Link>
            <Link href="/promotions" className="text-sm font-medium text-red-600">Khuyến Mại</Link>
          </nav>
        </div>
      </header>

      {/* Hero Section */}
      <div className="bg-gradient-to-r from-red-600 via-pink-600 to-orange-600 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 text-center">
          <div className="inline-block bg-white/20 px-6 py-2 rounded-full mb-4">
            <span className="font-bold">⚡ SALE LỚN THÁNG 12</span>
          </div>
          <h1 className="text-5xl md:text-6xl font-bold mb-6">Khuyến Mãi Đặc Biệt</h1>
          <p className="text-xl md:text-2xl mb-8">
            Tiết kiệm đến 50% cho tất cả sản phẩm - Ưu đãi có hạn!
          </p>
          <div className="flex items-center justify-center gap-8 text-center">
            <div>
              <div className="text-4xl font-bold mb-1">50+</div>
              <div className="text-sm">Mã Giảm Giá</div>
            </div>
            <div className="w-px h-12 bg-white/30"></div>
            <div>
              <div className="text-4xl font-bold mb-1">500K+</div>
              <div className="text-sm">Khách Đã Tiết Kiệm</div>
            </div>
            <div className="w-px h-12 bg-white/30"></div>
            <div>
              <div className="text-4xl font-bold mb-1">-50%</div>
              <div className="text-sm">Giảm Tối Đa</div>
            </div>
          </div>
        </div>
      </div>

      {/* Featured Deals */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-center mb-12">Ưu Đãi Nổi Bật</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {featuredDeals.map((deal) => (
            <div key={deal.id} className="bg-white rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition group">
              <div className="relative overflow-hidden">
                {deal.tag && (
                  <span className="absolute top-4 left-4 bg-red-500 text-white px-4 py-1 rounded-full text-sm font-bold z-10">
                    {deal.tag}
                  </span>
                )}
                <div className="absolute top-4 right-4 bg-yellow-400 text-black w-20 h-20 rounded-full flex items-center justify-center font-bold text-lg z-10 shadow-lg">
                  -{deal.discount}
                </div>
                <img
                  src={deal.image}
                  alt={deal.title}
                  className="w-full h-64 object-cover group-hover:scale-110 transition duration-500"
                />
              </div>
              <div className="p-6">
                <h3 className="text-2xl font-bold mb-2">{deal.title}</h3>
                <p className="text-gray-600 mb-4">{deal.description}</p>
                
                <div className="flex items-center gap-2 text-sm text-gray-500 mb-4">
                  <Clock className="w-4 h-4" />
                  <span>Hết hạn: {deal.endDate}</span>
                </div>

                <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg mb-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-xs text-gray-600 mb-1">MÃ GIẢM GIÁ:</div>
                      <div className="text-xl font-bold text-purple-600">{deal.code}</div>
                    </div>
                    <button
                      onClick={() => copyCode(deal.code)}
                      className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition"
                    >
                      {copiedCode === deal.code ? '✓ Đã Copy' : 'Copy'}
                    </button>
                  </div>
                </div>

                <Link
                  href="/shop"
                  className="block w-full bg-black text-white text-center py-3 rounded-lg font-semibold hover:bg-gray-800 transition"
                >
                  Mua Ngay
                </Link>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* All Deals */}
      <div className="bg-white py-16">
        <div className="max-w-7xl mx-auto px-4">
          <h2 className="text-4xl font-bold text-center mb-12">Tất Cả Ưu Đãi</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            {deals.map((deal) => (
              <div key={deal.id} className="bg-gradient-to-br from-gray-50 to-white rounded-xl p-6 border-2 border-gray-100 hover:border-pink-300 hover:shadow-lg transition">
                <div className="flex items-start justify-between mb-4">
                  <div className="bg-gradient-to-br from-pink-500 to-orange-500 text-white w-16 h-16 rounded-xl flex items-center justify-center font-bold shadow-lg">
                    -{deal.discount}
                  </div>
                  <div className="flex items-center gap-1 text-yellow-500">
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                    <Star className="w-4 h-4 fill-current" />
                  </div>
                </div>

                <h3 className="text-xl font-bold mb-2">{deal.title}</h3>
                <p className="text-gray-600 text-sm mb-4">{deal.description}</p>

                <div className="flex items-center gap-2 text-xs text-gray-500 mb-4">
                  <Clock className="w-3 h-3" />
                  <span>Đến {deal.endDate}</span>
                </div>

                <div className="bg-gray-100 rounded-lg p-3 mb-4 border-2 border-dashed border-gray-300">
                  <div className="flex items-center justify-between">
                    <span className="font-mono font-bold text-purple-600">{deal.code}</span>
                    <button
                      onClick={() => copyCode(deal.code)}
                      className="text-pink-600 hover:text-pink-700 text-sm font-semibold"
                    >
                      {copiedCode === deal.code ? '✓' : 'Copy'}
                    </button>
                  </div>
                </div>

                <Link
                  href="/shop"
                  className="flex items-center justify-center gap-2 w-full bg-gradient-to-r from-pink-600 to-orange-600 text-white py-2 rounded-lg font-semibold hover:from-pink-700 hover:to-orange-700 transition"
                >
                  Áp Dụng Ngay <ChevronRight className="w-4 h-4" />
                </Link>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* How to Use */}
      <div className="max-w-7xl mx-auto px-4 py-16">
        <h2 className="text-4xl font-bold text-center mb-12">Cách Sử Dụng Mã Giảm Giá</h2>
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div className="text-center">
            <div className="bg-gradient-to-br from-purple-100 to-pink-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-purple-600">1</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Chọn Sản Phẩm</h3>
            <p className="text-gray-600">Thêm sản phẩm yêu thích vào giỏ hàng</p>
          </div>
          <div className="text-center">
            <div className="bg-gradient-to-br from-blue-100 to-cyan-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-blue-600">2</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Copy Mã</h3>
            <p className="text-gray-600">Click nút Copy để sao chép mã giảm giá</p>
          </div>
          <div className="text-center">
            <div className="bg-gradient-to-br from-green-100 to-teal-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-green-600">3</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Nhập Mã</h3>
            <p className="text-gray-600">Dán mã vào ô "Mã giảm giá" khi thanh toán</p>
          </div>
          <div className="text-center">
            <div className="bg-gradient-to-br from-orange-100 to-red-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
              <div className="text-3xl font-bold text-orange-600">4</div>
            </div>
            <h3 className="font-semibold text-lg mb-2">Tiết Kiệm</h3>
            <p className="text-gray-600">Tận hưởng giá ưu đãi và hoàn tất đơn hàng</p>
          </div>
        </div>
      </div>

      {/* CTA Banner */}
      <div className="bg-gradient-to-r from-purple-600 to-pink-600 py-16">
        <div className="max-w-7xl mx-auto px-4 text-center text-white">
          <Gift className="w-16 h-16 mx-auto mb-4" />
          <h2 className="text-4xl font-bold mb-4">Đăng Ký Nhận Ưu Đãi</h2>
          <p className="text-xl mb-8">Nhận mã giảm giá 15% cho đơn hàng đầu tiên + thông báo ưu đãi độc quyền</p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
            <input
              type="email"
              placeholder="Nhập email của bạn"
              className="px-4 py-3 rounded-lg text-gray-900 flex-1"
            />
            <button className="bg-black text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-800 transition">
              Đăng Ký Ngay
            </button>
          </div>
        </div>
      </div>

      {/* Footer */}
      <footer className="bg-gray-900 text-white py-12">
        <div className="max-w-7xl mx-auto px-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
            <div>
              <h3 className="text-2xl font-bold mb-4">GoatTech</h3>
              <p className="text-gray-400">Ốp điện thoại cao cấp và phụ kiện công nghệ</p>
            </div>
            <div>
              <h4 className="font-semibold mb-4">Cửa Hàng</h4>
              <ul className="space-y-2 text-gray-400">
                <li><Link href="/shop" className="hover:text-white">Ốp iPhone</Link></li>
                <li><Link href="/shop" className="hover:text-white">Phụ Kiện</Link></li>
                <li><Link href="/shop" className="hover:text-white">Hàng Mới Về</Link></li>
                <li><Link href="/promotions" className="hover:text-white">Khuyến Mại</Link></li>
              </ul>
            </div>
            <div>
              <h4 className="font-semibold mb-4">Hỗ Trợ</h4>
              <ul className="space-y-2 text-gray-400">
                <li><Link href="/contact" className="hover:text-white">Liên Hệ Chúng Tôi</Link></li>
                <li><button className="hover:text-white text-left">Thông Tin Vận Chuyển</button></li>
                <li><button className="hover:text-white text-left">Chính Sách Hoàn Hàng</button></li>
                <li><button className="hover:text-white text-left">Câu Hỏi Thường Gặp</button></li>
              </ul>
            </div>
            <div>
              <h4 className="font-semibold mb-4">Theo Dõi Chúng Tôi</h4>
              <ul className="space-y-2 text-gray-400">
                <li><button className="hover:text-white text-left">Instagram</button></li>
                <li><button className="hover:text-white text-left">Facebook</button></li>
                <li><button className="hover:text-white text-left">TikTok</button></li>
                <li><button className="hover:text-white text-left">YouTube</button></li>
              </ul>
            </div>
          </div>
          <div className="border-t border-gray-800 pt-8 text-center text-gray-400">
            <p>&copy; 2024 GoatTech - Ốp Điện Thoại Số 1 Việt Nam. Bảo Lưu Mọi Quyền.</p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default PromotionsPage;




################################################################################
## FILE 129: index.ts
## Path: fontend/src/components/guards/index.ts
################################################################################

export * from './CustomerOnly';
export * from './RoleGuard';



################################################################################
## FILE 130: RoleGuard.tsx
## Path: fontend/src/components/guards/RoleGuard.tsx
################################################################################

'use client';

import React, { ReactNode, useEffect } from 'react';
import { useAuth, UserRole } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';

interface RoleGuardProps {
  children: ReactNode;
  allowedRoles: UserRole[];
  redirectTo?: string;         // Redirect nếu không có quyền
  fallback?: ReactNode;        // Hiển thị thay vì redirect
}

/**
 * Component bảo vệ route theo role
 * 
 * Ví dụ sử dụng:
 * <RoleGuard allowedRoles={[UserRole.CUSTOMER]} redirectTo="/login">
 *   <CheckoutPage />
 * </RoleGuard>
 */
export function RoleGuard({
  children,
  allowedRoles,
  redirectTo,
  fallback,
}: RoleGuardProps) {
  const { user, loading, isAuthenticated } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!loading && !isAuthenticated && redirectTo) {
      router.push(redirectTo);
    }
  }, [loading, isAuthenticated, redirectTo, router]);

  // Loading
  if (loading) {
    return (
      <div className="flex justify-center items-center min-h-[200px]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600" />
      </div>
    );
  }

  // Chưa đăng nhập
  if (!isAuthenticated) {
    if (fallback) return <>{fallback}</>;
    return (
      <div className="text-center py-10">
        <p className="text-gray-600">Vui lòng đăng nhập để tiếp tục</p>
      </div>
    );
  }

  // Kiểm tra role
  if (!user || !allowedRoles.includes(user.role)) {
    if (fallback) return <>{fallback}</>;
    return (
      <div className="text-center py-10">
        <h2 className="text-xl font-semibold text-red-600 mb-2">
          ⛔ Không có quyền truy cập
        </h2>
        <p className="text-gray-600">
          Bạn cần vai trò "{allowedRoles.join('" hoặc "')}" để xem trang này
        </p>
      </div>
    );
  }

  // Có quyền
  return <>{children}</>;
}



################################################################################
## FILE 131: CustomerOnly.tsx
## Path: fontend/src/components/guards/CustomerOnly.tsx
################################################################################

'use client';

import React, { ReactNode } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import Link from 'next/link';

interface CustomerOnlyProps {
  children: ReactNode;
  fallback?: ReactNode;        // Hiển thị khi không có quyền
  showLoginPrompt?: boolean;   // Hiển thị link đăng nhập
}

/**
 * Component wrapper chỉ hiển thị nội dung cho CUSTOMER
 * 
 * Ví dụ sử dụng:
 * <CustomerOnly>
 *   <button onClick={addToCart}>Thêm vào giỏ hàng</button>
 * </CustomerOnly>
 */
export function CustomerOnly({
  children,
  fallback,
  showLoginPrompt = true,
}: CustomerOnlyProps) {
  const { user, isCustomer, loading, isAuthenticated } = useAuth();

  // Đang loading
  if (loading) {
    return (
      <div className="animate-pulse bg-gray-200 h-10 w-32 rounded" />
    );
  }

  // Đã đăng nhập và là Customer -> hiển thị children
  if (isAuthenticated && isCustomer) {
    return <>{children}</>;
  }

  // Có fallback custom -> hiển thị fallback
  if (fallback) {
    return <>{fallback}</>;
  }

  // Mặc định: hiển thị thông báo
  if (!isAuthenticated && showLoginPrompt) {
    return (
      <Link
        href="/login"
        className="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition"
      >
        Đăng nhập để tiếp tục
      </Link>
    );
  }

  // Đã đăng nhập nhưng không phải customer
  if (isAuthenticated && !isCustomer) {
    return (
      <span className="text-gray-500 text-sm">
        Chỉ khách hàng mới thực hiện được
      </span>
    );
  }

  return null;
}



################################################################################
## FILE 132: index.ts
## Path: fontend/src/components/home/index.ts
################################################################################

// File: fontend/src/components/home/index.ts

export { default as HeroCarousel } from './HeroCarousel';
export { default as CategoryGrid } from './CategoryGrid';
export { default as FeaturedProducts } from './FeaturedProducts';
export { default as PromoSection } from './PromoSection';



################################################################################
## FILE 133: PromoSection.tsx
## Path: fontend/src/components/home/PromoSection.tsx
################################################################################

// File: fontend/src/components/home/PromoSection.tsx

'use client';

import { useState } from 'react';

interface PromoSectionProps {
  title?: string;
  subtitle?: string;
  onSubscribe?: (email: string) => void;
}

export default function PromoSection({
  title = 'Tham Gia Nhóm GoatTech',
  subtitle = 'Nhận 15% giảm giá cho đơn hàng đầu tiên + ưu đãi độc quyền',
  onSubscribe,
}: PromoSectionProps) {
  const [email, setEmail] = useState('');

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (email.trim()) {
      onSubscribe?.(email);
      setEmail('');
    }
  };

  return (
    <div className="bg-gradient-to-r from-orange-500 to-pink-500 text-white py-16">
      <div className="max-w-7xl mx-auto px-4 text-center">
        <h2 className="text-4xl font-bold mb-4">{title}</h2>
        <p className="text-xl mb-8">{subtitle}</p>
        <form
          onSubmit={handleSubmit}
          className="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto"
        >
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Nhập email của bạn"
            className="px-4 py-3 rounded-lg text-gray-900 flex-1"
            required
          />
          <button
            type="submit"
            className="bg-white text-orange-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition"
          >
            Đăng Ký
          </button>
        </form>
      </div>
    </div>
  );
}



################################################################################
## FILE 134: HeroCarousel.tsx
## Path: fontend/src/components/home/HeroCarousel.tsx
################################################################################

// File: fontend/src/components/home/HeroCarousel.tsx

'use client';

import { useState, useEffect } from 'react';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { BannerSlide } from '@/types';

interface HeroCarouselProps {
  slides: BannerSlide[];
  autoPlay?: boolean;
  autoPlayInterval?: number;
  onShopNow?: () => void;
}

export default function HeroCarousel({
  slides,
  autoPlay = true,
  autoPlayInterval = 5000,
  onShopNow,
}: HeroCarouselProps) {
  const [currentSlide, setCurrentSlide] = useState(0);

  useEffect(() => {
    if (!autoPlay || slides.length <= 1) return;

    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % slides.length);
    }, autoPlayInterval);

    return () => clearInterval(interval);
  }, [autoPlay, autoPlayInterval, slides.length]);

  const nextSlide = () => {
    setCurrentSlide((prev) => (prev + 1) % slides.length);
  };

  const prevSlide = () => {
    setCurrentSlide((prev) => (prev - 1 + slides.length) % slides.length);
  };

  if (slides.length === 0) return null;

  return (
    <div className="relative bg-gradient-to-r from-purple-600 to-pink-600 text-white overflow-hidden">
      <div className="max-w-7xl mx-auto px-4 py-16 md:py-24">
        <div className="text-center">
          <h1 className="text-4xl md:text-6xl font-bold mb-4">
            {slides[currentSlide].title}
          </h1>
          <p className="text-xl md:text-2xl mb-8">
            {slides[currentSlide].subtitle}
          </p>
          <button
            onClick={onShopNow}
            className="bg-white text-purple-600 px-8 py-3 rounded-full font-semibold hover:bg-gray-100 transition"
          >
            Shop Now
          </button>
        </div>
      </div>

      {slides.length > 1 && (
        <>
          <button
            onClick={prevSlide}
            className="absolute left-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/30 p-2 rounded-full transition"
          >
            <ChevronLeft className="w-6 h-6" />
          </button>

          <button
            onClick={nextSlide}
            className="absolute right-4 top-1/2 -translate-y-1/2 bg-white/20 hover:bg-white/30 p-2 rounded-full transition"
          >
            <ChevronRight className="w-6 h-6" />
          </button>

          <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
            {slides.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentSlide(index)}
                className={`w-2 h-2 rounded-full transition ${
                  index === currentSlide ? 'bg-white w-8' : 'bg-white/50'
                }`}
              />
            ))}
          </div>
        </>
      )}
    </div>
  );
}



################################################################################
## FILE 135: FeaturedProducts.tsx
## Path: fontend/src/components/home/FeaturedProducts.tsx
################################################################################

// File: fontend/src/components/home/FeaturedProducts.tsx

'use client';

import Link from 'next/link';
import ProductCard from '@/components/ui/ProductCard';
import { Product } from '@/types';

interface FeaturedProductsProps {
  products: Product[];
  title?: string;
  loading?: boolean;
  wishedProducts?: Set<number>;
  onAddToCart?: (product: Product) => void;
  onToggleWishlist?: (productId: number) => void;
}

export default function FeaturedProducts({
  products,
  title = 'Sản Phẩm Nổi Bật',
  loading = false,
  wishedProducts = new Set(),
  onAddToCart,
  onToggleWishlist,
}: FeaturedProductsProps) {
  if (loading) {
    return (
      <div className="max-w-7xl mx-auto px-4 py-12">
        <div className="flex items-center justify-between mb-8">
          <h2 className="text-3xl font-bold">{title}</h2>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="bg-white rounded-xl shadow-sm overflow-hidden animate-pulse">
              <div className="h-64 bg-gray-200" />
              <div className="p-4 space-y-3">
                <div className="h-4 bg-gray-200 rounded w-3/4" />
                <div className="h-4 bg-gray-200 rounded w-1/2" />
                <div className="h-8 bg-gray-200 rounded" />
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-7xl mx-auto px-4 py-12">
      <div className="flex items-center justify-between mb-8">
        <h2 className="text-3xl font-bold">{title}</h2>
        <Link href="/shop" className="text-pink-600 font-medium hover:underline">
          Xem Tất Cả →
        </Link>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {products.map((product) => (
          <ProductCard
            key={product.product_id || product.id}
            product={product}
            isWished={wishedProducts.has(product.product_id || product.id)}
            onAddToCart={onAddToCart}
            onToggleWishlist={onToggleWishlist}
          />
        ))}
      </div>
    </div>
  );
}



################################################################################
## FILE 136: CategoryGrid.tsx
## Path: fontend/src/components/home/CategoryGrid.tsx
################################################################################

// File: fontend/src/components/home/CategoryGrid.tsx

'use client';

import Link from 'next/link';
import { Category } from '@/types';

interface CategoryGridProps {
  categories: Category[];
  title?: string;
}

const GRADIENT_COLORS = [
  'from-pink-500 to-rose-500',
  'from-blue-500 to-cyan-500',
  'from-purple-500 to-indigo-500',
  'from-amber-500 to-orange-500',
  'from-emerald-500 to-teal-500',
  'from-red-500 to-pink-500',
  'from-violet-500 to-purple-500',
];

export default function CategoryGrid({
  categories,
  title = 'Các sản phẩm chính',
}: CategoryGridProps) {
  return (
    <div className="max-w-7xl mx-auto px-4 py-12">
      <h2 className="text-3xl font-bold mb-8 text-center">{title}</h2>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4">
        {categories.map((category, index) => (
          <Link
            key={category.name}
            href={`/shop?category=${encodeURIComponent(category.name)}`}
            className="group cursor-pointer"
          >
            <div
              className={`bg-gradient-to-br ${GRADIENT_COLORS[index % GRADIENT_COLORS.length]} p-4 rounded-2xl shadow-md hover:shadow-xl hover:scale-105 transition-all duration-300 text-center text-white h-36 flex flex-col items-center justify-center`}
            >
              <span className="text-3xl mb-2">{category.icon}</span>
              <h3 className="font-semibold text-xs mb-1 line-clamp-2 leading-tight px-1">
                {category.name}
              </h3>
              <p className="text-xs opacity-80">{category.count} SP</p>
            </div>
          </Link>
        ))}
      </div>
    </div>
  );
}



################################################################################
## FILE 137: TopBanner.tsx
## Path: fontend/src/components/layout/TopBanner.tsx
################################################################################

// File: fontend/src/components/layout/TopBanner.tsx

export default function TopBanner() {
  return (
    <div className="bg-black text-white py-2 px-4 text-center text-sm">
      <div className="max-w-7xl mx-auto flex items-center justify-center gap-4">
        <span>Miễn phí vận chuyển cho đơn hàng trên 100K</span>
        <span className="hidden md:inline">|</span>
        <span className="hidden md:inline text-pink-400 font-medium">
          Ưu đãi GoatTech: Mua 4 ốp - Trả tiền 2 ốp
        </span>
      </div>
    </div>
  );
}



################################################################################
## FILE 138: Header.tsx
## Path: fontend/src/components/layout/Header.tsx
################################################################################

// File: fontend/src/components/layout/Header.tsx

'use client';

import { useState } from 'react';
import { Search, Menu, ShoppingCart, User, Heart, ChevronDown, LogOut } from 'lucide-react';
import Link from 'next/link';
// import { useAuth } from '@/context/AuthContext';
import { useAuth } from '@/contexts/AuthContext';
import { useCart } from '@/app/context/cart-context';
import { useWishlist } from '@/app/context/wishlist-context';
import { useRouter } from 'next/navigation';


interface HeaderProps {
  // onCartClick?: () => void;
  onWishlistClick?: () => void;
  showDeviceSelector?: boolean;
  devices?: string[];
  selectedDevice?: string;
  onDeviceChange?: (device: string) => void;
  showCurrencySelector?: boolean;
  selectedCurrency?: string;
  onCurrencyClick?: () => void;
}

export default function Header({
  // onCartClick,
  onWishlistClick,
  showDeviceSelector = false,
  devices = [],
  selectedDevice = '',
  onDeviceChange,
  showCurrencySelector = false,
  selectedCurrency = 'VND',
  onCurrencyClick,
}: HeaderProps) {
  const router = useRouter();

  const handleCartClick = () => {
    router.push('/shopping-cart');
  };
  
  const handleWishlistClick = () => {
    if (onWishlistClick) {
      onWishlistClick();
    } else {
      router.push('/wishlist');
    }
  };
  
  const { user, isAuthenticated, logout, getDisplayName } = useAuth();
  const { cartCount } = useCart();
  const { wishlistCount } = useWishlist();
  const [showDropdown, setShowDropdown] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const handleLogout = () => {
    logout();
    setShowDropdown(false);
  };

return (
  <header className="bg-gray-100 border-b border-gray-300 sticky top-0 z-50">
    <div className="max-w-7xl mx-auto px-4 py-4">
      <div className="flex items-center justify-between gap-4 text-gray-900">
        {/* Left - Mobile menu */}
        <div className="flex items-center gap-4">
          <button
            className="lg:hidden text-gray-800 hover:text-pink-600"
            onClick={() => setIsMenuOpen(!isMenuOpen)}
          >
            <Menu className="w-6 h-6" />
          </button>
          <button className="lg:hidden text-gray-800 hover:text-pink-600">
            <Search className="w-6 h-6" />
          </button>
        </div>

        {/* Logo */}
        <Link
          href="/"
          className="text-2xl font-bold tracking-wider text-gray-900 hover:text-pink-600 transition"
        >
          GoatTech
        </Link>

        {/* Right */}
        <div className="flex items-center gap-4">
          {/* Device Selector */}
          {showDeviceSelector && devices.length > 0 && (
            <select
              value={selectedDevice}
              onChange={(e) => onDeviceChange?.(e.target.value)}
              className="hidden lg:block px-4 py-2 border border-gray-400 rounded-lg text-sm bg-white text-gray-900"
            >
              {devices.map((device) => (
                <option key={device} value={device}>
                  {device}
                </option>
              ))}
            </select>
          )}

          {/* Currency Selector */}
          {showCurrencySelector && (
            <button
              className="hidden lg:block px-4 py-2 text-sm font-medium text-gray-900 hover:text-pink-600"
              onClick={onCurrencyClick}
            >
              {selectedCurrency} {selectedCurrency === 'USD' ? '$' : '₫'}
            </button>
          )}

          {/* Wishlist */}
          <button
            className="relative text-gray-800 hover:text-pink-600"
            onClick={handleWishlistClick}
          >
            <Heart className={`w-6 h-6 ${wishlistCount > 0 ? 'fill-red-500 text-red-500' : ''}`} />
            {wishlistCount > 0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                {wishlistCount}
              </span>
            )}
          </button>

          {/* User section */}
          {isAuthenticated && user ? (
            <div className="relative">
              <button
                onClick={() => setShowDropdown(!showDropdown)}
                className="flex items-center gap-2 text-gray-900 hover:text-pink-600 transition px-2 py-1 rounded-lg hover:bg-pink-100"
              >
                <div className="w-8 h-8 bg-pink-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                  {getDisplayName().charAt(0).toUpperCase()}
                </div>
                <span className="hidden sm:inline text-sm font-medium max-w-[100px] truncate">
                  {getDisplayName()}
                </span>
                <ChevronDown className="w-4 h-4" />
              </button>

              {showDropdown && (
                <>
                  <div
                    className="fixed inset-0 z-40"
                    onClick={() => setShowDropdown(false)}
                  />
                  <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-300 py-2 z-50 text-gray-900">
                    <div className="px-4 py-2 border-b border-gray-200">
                      <p className="text-sm font-semibold truncate">
                        {getDisplayName()}
                      </p>
                      <p className="text-xs text-gray-600 truncate">
                        {user.email}
                      </p>
                    </div>

                    <Link
                      href="/login"
                      className="flex items-center gap-2 px-4 py-2 text-sm hover:bg-pink-100 hover:text-pink-600"
                      onClick={() => setShowDropdown(false)}
                    >
                      <User className="w-4 h-4" />
                      Tài khoản
                    </Link>

                    <Link
                      href="/order"
                      className="flex items-center gap-2 px-4 py-2 text-sm hover:bg-pink-100 hover:text-pink-600"
                      onClick={() => setShowDropdown(false)}
                    >
                      <ShoppingCart className="w-4 h-4" />
                      Đơn hàng
                    </Link>

                    <button
                      onClick={handleLogout}
                      className="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-700 hover:bg-red-100"
                    >
                      <LogOut className="w-4 h-4" />
                      Đăng xuất
                    </button>
                  </div>
                </>
              )}
            </div>
          ) : (
            <Link
              href="/login"
              className="text-gray-800 hover:text-pink-600"
            >
              <User className="w-6 h-6" />
            </Link>
          )}

          {/* Cart */}
          <button
            className="relative text-gray-800 hover:text-pink-600"
            onClick={handleCartClick}
          >
            <ShoppingCart className="w-6 h-6" />
            {isAuthenticated && cartCount > 0 && (
              <span className="absolute -top-1 -right-1 bg-pink-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                {cartCount}
              </span>
            )}
          </button>
        </div>
      </div>

      {/* Desktop Navigation */}
      <nav className="hidden lg:flex items-center justify-center gap-8 mt-4 pt-4 border-t border-gray-300 text-gray-900">
        <Link href="/shop" className="text-sm font-medium hover:text-pink-600">
          Cửa Hàng
        </Link>
        <Link href="/collections" className="text-sm font-medium hover:text-pink-600">
          Bộ Sưu Tập
        </Link>
        <Link href="/about" className="text-sm font-medium hover:text-pink-600">
          Về Chúng Tôi
        </Link>
        <Link href="/contact" className="text-sm font-medium hover:text-pink-600">
          Liên Hệ
        </Link>
        <Link href="/promotions" className="text-sm font-medium text-red-700">
          Khuyến Mại
        </Link>
      </nav>
    </div>
  </header>
);

}



################################################################################
## FILE 139: Footer.tsx
## Path: fontend/src/components/layout/Footer.tsx
################################################################################

// File: fontend/src/components/layout/Footer.tsx

import Link from 'next/link';

export default function Footer() {
  return (
    <footer className="bg-gray-900 text-white py-12">
      <div className="max-w-7xl mx-auto px-4">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
          <div>
            <h3 className="text-2xl font-bold mb-4">GoatTech</h3>
            <p className="text-gray-400">Ốp điện thoại cao cấp và phụ kiện công nghệ</p>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Cửa Hàng</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/shop" className="hover:text-white">Ốp iPhone</Link></li>
              <li><Link href="/shop" className="hover:text-white">Phụ Kiện</Link></li>
              <li><Link href="/promotions" className="hover:text-white">Khuyến Mại</Link></li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Hỗ Trợ</h4>
            <ul className="space-y-2 text-gray-400">
              <li><Link href="/contact" className="hover:text-white">Liên Hệ</Link></li>
              <li>Chính Sách Hoàn Hàng</li>
              <li>FAQ</li>
            </ul>
          </div>
          <div>
            <h4 className="font-semibold mb-4">Theo Dõi</h4>
            <ul className="space-y-2 text-gray-400">
              <li>Instagram</li>
              <li>Facebook</li>
              <li>TikTok</li>
            </ul>
          </div>
        </div>
        <div className="border-t border-gray-800 pt-8 text-center text-gray-400">
          <p>© 2024 GoatTech. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
}



################################################################################
## FILE 140: index.ts
## Path: fontend/src/components/modals/index.ts
################################################################################





################################################################################
## FILE 141: CurrencyModal.tsx
## Path: fontend/src/components/modals/CurrencyModal.tsx
################################################################################





################################################################################
## FILE 142: CartModal.tsx
## Path: fontend/src/components/modals/CartModal.tsx
################################################################################

// File: fontend/src/components/modals/CartModal.tsx

'use client';

import { ShoppingCart, X } from 'lucide-react';
import { CartItem } from '@/types';

interface CartModalProps {
  isOpen: boolean;
  onClose: () => void;
  cartItems: CartItem[];
  onUpdateQuantity: (productId: number, quantity: number) => void;
  onRemoveItem: (productId: number) => void;
  onCheckout: () => void;
  checkoutLoading?: boolean;
}

export default function CartModal({
  isOpen,
  onClose,
  cartItems,
  onUpdateQuantity,
  onRemoveItem,
  onCheckout,
  checkoutLoading = false,
}: CartModalProps) {
  if (!isOpen) return null;

  const cartCount = cartItems.reduce((total, item) => total + item.quantity, 0);
  const cartTotal = cartItems.reduce((total, item) => total + item.price * item.quantity, 0);

  return (
    <div
      className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-t-3xl sm:rounded-xl w-full sm:max-w-2xl sm:mx-4 max-h-[90vh] overflow-hidden shadow-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between p-6 border-b">
          <h2 className="text-2xl font-bold">Giỏ Hàng ({cartCount})</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Body */}
        <div className="overflow-y-auto max-h-[60vh] p-6">
          {cartItems.length === 0 ? (
            <div className="text-center py-12">
              <ShoppingCart className="w-16 h-16 mx-auto text-gray-300 mb-4" />
              <p className="text-gray-500 text-lg">Giỏ hàng trống</p>
              <button
                onClick={onClose}
                className="mt-4 bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition"
              >
                Mua Sắm Ngay
              </button>
            </div>
          ) : (
            <div className="space-y-4">
              {cartItems.map((item) => (
                <div key={item.id} className="flex gap-4 bg-gray-50 p-4 rounded-xl">
                  <img
                    src={item.image || item.image_url}
                    alt={item.name}
                    className="w-24 h-24 object-cover rounded-lg"
                  />
                  <div className="flex-1">
                    <h3 className="font-semibold mb-2 line-clamp-2">{item.name}</h3>
                    <p className="text-pink-600 font-bold mb-2">
                      {item.price.toLocaleString('vi-VN')}₫
                    </p>
                    <div className="flex items-center gap-3">
                      <button
                        onClick={() => onUpdateQuantity(item.id, item.quantity - 1)}
                        className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center"
                      >
                        -
                      </button>
                      <span className="font-semibold w-8 text-center">{item.quantity}</span>
                      <button
                        onClick={() => onUpdateQuantity(item.id, item.quantity + 1)}
                        className="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center"
                      >
                        +
                      </button>
                      <button
                        onClick={() => onRemoveItem(item.id)}
                        className="ml-auto text-red-500 hover:text-red-700 text-sm"
                      >
                        Xóa
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Footer */}
        {cartItems.length > 0 && (
          <div className="p-6 border-t bg-gray-50">
            <div className="flex items-center justify-between mb-4">
              <span className="text-lg font-semibold">Tổng Cộng:</span>
              <span className="text-2xl font-bold text-pink-600">
                {cartTotal.toLocaleString('vi-VN')}₫
              </span>
            </div>
            <button
              onClick={onCheckout}
              disabled={checkoutLoading}
              className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-semibold hover:from-purple-700 hover:to-pink-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {checkoutLoading ? (
                <>
                  <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                  </svg>
                  Đang xử lý...
                </>
              ) : (
                '💳 Thanh Toán MoMo'
              )}
            </button>
          </div>
        )}
      </div>
    </div>
  );
}



################################################################################
## FILE 143: AddToCartButton.tsx
## Path: fontend/src/components/products/AddToCartButton.tsx
################################################################################

'use client';

import { useAuth } from '@/contexts/AuthContext';
import { addToShoppingCart } from '@/lib/api-client';
import { useRouter } from 'next/navigation';
import { useState } from 'react';

interface AddToCartButtonProps {
  productId: number;
}

export function AddToCartButton({ productId }: AddToCartButtonProps) {
  const { user, isAuthenticated } = useAuth();
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  const handleAddToCart = async (e: React.MouseEvent<HTMLButtonElement>) => {
    // 🚫 Chặn Link bọc ngoài
    e.preventDefault();
    e.stopPropagation();

    // 1️⃣ Chưa đăng nhập → login
    if (!isAuthenticated || !user) {
      alert('Vui lòng đăng nhập để thêm vào giỏ hàng');
      router.push('/login');
      return;
    }

    // 2️⃣ Không có user.id → lỗi logic
    if (!user.id) {
      alert('Không tìm thấy thông tin người dùng');
      return;
    }

    setLoading(true);
    try {
      // 3️⃣ Gọi backend
      await addToShoppingCart({
        // customer_id: user.id,
        productId,
        quantity: 1,
      });

      // 4️⃣ Đồng bộ giỏ hàng (header, cart badge…)
      window.dispatchEvent(new Event('cartUpdated'));
    } catch (error) {
      console.error('Add to cart error:', error);
      alert('Không thể thêm vào giỏ hàng, vui lòng thử lại');
    } finally {
      setLoading(false);
    }
  };

  return (
    <button
      onClick={handleAddToCart}
      disabled={loading}
      className="bg-pink-600 hover:bg-pink-700 text-white px-4 py-2 rounded-lg text-sm font-medium disabled:opacity-50"
    >
      {loading ? 'Đang thêm...' : 'Thêm Vào Giỏ Hàng'}
    </button>
  );
}





################################################################################
## FILE 144: index.ts
## Path: fontend/src/components/ui/index.ts
################################################################################





################################################################################
## FILE 145: ProductCard.tsx
## Path: fontend/src/components/ui/ProductCard.tsx
################################################################################

// File: fontend/src/components/ui/ProductCard.tsx

'use client';

import { Heart, Star } from 'lucide-react';
import Link from 'next/link';
import { Product } from '@/types';

interface ProductCardProps {
  product: Product;
  isWished?: boolean;
  onAddToCart?: (product: Product) => void;
  onToggleWishlist?: (productId: number) => void;
}

export default function ProductCard({
  product,
  isWished = false,
  onAddToCart,
  onToggleWishlist,
}: ProductCardProps) {
  const productId = product.product_id || product.id;
  const productName = product.name || product.product_name || 'Sản phẩm';
  const productImage = product.image || product.image_url || 'https://via.placeholder.com/400';
  const productRating = product.rating || 4.5;
  const productReviews = product.reviews || 0;

  return (
    <div className="bg-white rounded-xl shadow-sm hover:shadow-lg transition group cursor-pointer overflow-hidden">
      <Link href={`/product/${productId}`}>
        <div className="relative overflow-hidden">
          {product.tag && (
            <span className="absolute top-3 left-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full z-10">
              {product.tag}
            </span>
          )}
          <img
            src={productImage}
            alt={productName}
            className="w-full h-64 object-cover group-hover:scale-110 transition duration-300"
          />
          <button
            onClick={(e) => {
              e.preventDefault();
              e.stopPropagation();
              onToggleWishlist?.(productId);
            }}
            className="absolute bottom-3 right-3 bg-white p-2 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition"
          >
            <Heart
              className={`w-5 h-5 ${isWished ? 'fill-red-500 text-red-500' : ''}`}
            />
          </button>
        </div>
      </Link>

      <div className="p-4">
        <Link href={`/product/${productId}`}>
          <h3 className="font-semibold mb-2 line-clamp-2 hover:text-pink-600 transition">
            {productName}
          </h3>
        </Link>
        <div className="flex items-center gap-2 mb-2">
          <div className="flex items-center">
            <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
            <span className="text-sm ml-1">{productRating}</span>
          </div>
          <span className="text-sm text-gray-500">({productReviews})</span>
        </div>
        <div className="flex items-center justify-between">
          <span className="text-xl font-bold">
            {(product.price || 0).toLocaleString('vi-VN')}₫
          </span>
          <button
            onClick={() => onAddToCart?.(product)}
            className="bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-pink-700 transition"
          >
            Thêm Vào Giỏ
          </button>
        </div>
      </div>
    </div>
  );
}



################################################################################
## FILE 146: AuthContext.tsx
## Path: fontend/src/contexts/AuthContext.tsx
################################################################################

// File: fontend/src/app/context/auth-context.tsx

'use client';

import React, { createContext, useContext, useState, useEffect, ReactNode } from 'react';

export interface AuthUser {
  id?: string;
  email: string;
  full_name?: string;
  fullName?: string;
  name?: string;
  phone?: string;
  role?: string;
  is_admin?: boolean; 
  created_at?: string;
  access_token?: string;
}

interface AuthContextType {
  user: AuthUser | null;
  isAuthenticated: boolean;
  loading: boolean;
  login: (userData: AuthUser) => void;
  logout: () => void;
  refreshAuth: () => void;
  getDisplayName: () => string;
  is_admin:() =>boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<AuthUser | null>(null);
  const [loading, setLoading] = useState(true);

  // Load user từ localStorage khi mount
  useEffect(() => {
    refreshAuth();
  }, []);

  // Listen for storage changes (đồng bộ giữa các tab/components)
  useEffect(() => {
    const handleStorageChange = (e: StorageEvent) => {
      if (e.key === 'customer') {
        refreshAuth();
      }
    };

    // Custom event để đồng bộ trong cùng 1 tab
    const handleAuthChange = () => {
      refreshAuth();
    };

    window.addEventListener('storage', handleStorageChange);
    window.addEventListener('authChange', handleAuthChange);

    return () => {
      window.removeEventListener('storage', handleStorageChange);
      window.removeEventListener('authChange', handleAuthChange);
    };
  }, []);

  const refreshAuth = () => {
    try {
      const customerData = localStorage.getItem('customer');
      if (customerData) {
        const parsedUser = JSON.parse(customerData);
        setUser(parsedUser);
      } else {
        setUser(null);
      }
    } catch (error) {
      console.error('Error parsing customer data:', error);
      setUser(null);
    } finally {
      setLoading(false);
    }
  };

  const login = (userData: AuthUser) => {
    localStorage.setItem('customer', JSON.stringify(userData));
    setUser(userData);
    // Dispatch event để các component khác biết
    window.dispatchEvent(new Event('authChange'));
  };

  const logout = () => {
    localStorage.removeItem('customer');
    localStorage.removeItem('userRole');
    setUser(null);
    // Dispatch event để các component khác biết
    window.dispatchEvent(new Event('authChange'));
  };

  const getDisplayName = () => {
    if (!user) return '';
    return user.full_name || user.fullName || user.name || user.email?.split('@')[0] || 'User';
  };
  const is_admin = () => {
    if (!user) return false;
    return user.role === 'ADMIN' || user.role === 'admin';
  };

  return (
    <AuthContext.Provider
      value={{
        user,
        isAuthenticated: !!user,
        loading,
        login,
        logout,
        refreshAuth,
        getDisplayName,
        is_admin,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
}



################################################################################
## FILE 147: useWishlist.ts
## Path: fontend/src/hooks/useWishlist.ts
################################################################################





################################################################################
## FILE 148: useProducts.ts
## Path: fontend/src/hooks/useProducts.ts
################################################################################





################################################################################
## FILE 149: useCustomerGuard.ts
## Path: fontend/src/hooks/useCustomerGuard.ts
################################################################################

'use client';

import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';

interface UseCustomerGuardOptions {
  redirectTo?: string;
  onDenied?: () => void;
}

/**
 * Hook để kiểm tra và bảo vệ actions chỉ dành cho customer
 * 
 * Ví dụ sử dụng:
 * const { checkAndExecute, canExecute } = useCustomerGuard({ 
 *   redirectTo: '/login' 
 * });
 * 
 * // Trong handler
 * const handleAddToCart = () => {
 *   checkAndExecute(() => {
 *     // Logic thêm vào giỏ
 *   });
 * };
 */
export function useCustomerGuard(options: UseCustomerGuardOptions = {}) {
  const { user, isCustomer, isAuthenticated, loading } = useAuth();
  const router = useRouter();
  const { redirectTo, onDenied } = options;

  // Có thể thực hiện action không?
  const canExecute = isAuthenticated && isCustomer;

  // Function wrap action
  const checkAndExecute = async (action: () => void | Promise<void>): Promise<boolean> => {
    // Chưa đăng nhập
    if (!isAuthenticated) {
      if (redirectTo) {
        router.push(redirectTo);
      }
      onDenied?.();
      return false;
    }

    // Không phải customer
    if (!isCustomer) {
      console.warn('Action requires CUSTOMER role');
      onDenied?.();
      return false;
    }

    // Thực hiện action
    await action();
    return true;
  };

  // Require customer - redirect nếu không phải
  const requireCustomer = () => {
    if (!loading && !canExecute && redirectTo) {
      router.push(redirectTo);
    }
  };

  return {
    canExecute,
    isCustomer,
    isAuthenticated,
    loading,
    user,
    checkAndExecute,
    requireCustomer,
  };
}



################################################################################
## FILE 150: useCart.ts
## Path: fontend/src/hooks/useCart.ts
################################################################################





################################################################################
## FILE 151: useAuth.ts
## Path: fontend/src/hooks/useAuth.ts
################################################################################





################################################################################
## FILE 152: index.ts
## Path: fontend/src/hooks/index.ts
################################################################################

export * from './useCustomerGuard';




################################################################################
## FILE 153: index.ts
## Path: fontend/src/types/index.ts
################################################################################

// File: fontend/src/types/index.ts

export interface Product {
  id: number;
  product_id?: number;
  name: string;
  product_name?: string;
  price: number;
  image: string;
  image_url?: string;
  rating: number;
  reviews: number;
  tag?: string;
  category?: string;
  category_id?: number;
}

export interface CartItem extends Product {
  quantity: number;
}

export interface Category {
  name: string;
  icon: string;
  count: number;
}

export interface BannerSlide {
  title: string;
  subtitle: string;
  image?: string;
}


